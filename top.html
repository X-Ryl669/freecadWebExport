<!doctype html>
<html>
<style>
body,html{margin:0;padding:0}body{height:100vh;width:30%;box-sizing:border-box;font-family:Roboto,sans-serif;font-size:15px;line-height:1.5;color:#fff;background-color:#000;text-decoration:none;word-spacing:normal;text-align:left;letter-spacing:0;-webkit-font-smoothing:antialiased;overflow-y:hidden;overflow-x:hidden}#viewer{left:300px;width:-webkit-calc(100% - 300px);width:calc(100% - 300px);border:0;background-color:#000}#explorer,#viewer{position:absolute;height:100%}#explorer{margin:0;left:0;background:#000;width:auto;overflow-y:scroll;overflow-x:hidden;padding:7px;z-index:200000}#explorer a{color:#fff;text-decoration:none}#explorer a:hover{color:#ff0;text-decoration:underline}.dark{background:#000;opacity:.6;height:100%}#header{max-width:900px;padding:50px 10px}#header,#image{background:#fff;width:100%;margin-left:auto;margin-right:auto}#image{max-width:920px;padding:0}#container{background:#fff;width:100%;max-width:100%;margin-left:auto;margin-right:auto;padding:10px 10px 40px;overflow:auto}a:visited{color:rgba(0,102,204,.75)}a:hover{color:#1dceff}a.button{font-weight:700;font-size:15px;background:#98fb98;padding:5px;border:1px solid grey}span{line-height:190%}p:first-child{margin-top:0}p.sectionTip,p.subSectionTip{padding-left:10px}#pageMenuContainer{width:380px;padding:0 0 5px;margin-top:5px}p.containerTitle{margin-top:-15px;background:#f5f5f5;border-bottom:1px solid #d3d3d3;border-right:1px solid #d3d3d3;width:120px;padding-left:10px;border-radius:2px;padding-bottom:0;padding-top:0;font-size:10px;border-color:#d3d3d3 #a9a9a9 #a9a9a9 #d3d3d3;border-style:solid;border-width:1px 2px 2px 1px}#contents{position:absolute;width:300px;height:calc(100% - 50px);background:#000;overflow:auto}#contents a{text-decoration:none}ul{list-style:none;margin:0;padding:1em 0 1em 1em}ul a:hover{text-decoration:underline;color:#fff}ul a{text-decoration:none;color:#fff}icon.bodySelect:before{content:" ";width:.4em;height:.4em;margin-left:.1em;margin-bottom:.4em;display:inline-block;border:2px solid transparent;border-radius:50%;background:transparent}icon.bodySelect.checked:before{border:2px solid #fff;background:#fff}icon.bodySelect{border:2px solid #fff;border-radius:75% 15%;position:relative;transform:rotate(45deg);width:1em;height:1em;display:inline-block;margin:.2em .4em}li a{vertical-align:middle;display:inline-block;height:1.8em;line-height:1em;padding-left:.5em}</style>
<body>
<div id='gltfExplorer' class='dark'><ul><li><a href='javascript:selectObject(false)'>Unselect</a></li></ul></div>
<script>(()=>{var e={57:(e,t,i)=>{"use strict";i.r(t),i.d(t,{scenes:()=>us,getDefaultScene:()=>cs,setDefaultScene:()=>ds,scheduleTask:()=>ps,clear:()=>_s,_isString:()=>ms,_apply:()=>fs,_isNumeric:()=>gs,WEBGL_INFO:()=>b,stats:()=>r,math:()=>d,Component:()=>g,CameraFlightAnimation:()=>Ei,Canvas:()=>E,Spinner:()=>x,Clip:()=>Ci,CameraControl:()=>Pi,Geometry:()=>z,BoxGeometry:()=>bt,TorusGeometry:()=>Ti,SphereGeometry:()=>Di,OBBGeometry:()=>Si,AABBGeometry:()=>q,CylinderGeometry:()=>Li,PlaneGeometry:()=>Bi,Input:()=>tt,AmbientLight:()=>Ri,DirLight:()=>xt,PointLight:()=>ki,SpotLight:()=>Ii,CubeTexture:()=>Yi,LightMap:()=>Wi,ReflectionMap:()=>Ki,Shadow:()=>Xi,Model:()=>qi,Mesh:()=>Je,Group:()=>Hi,Object:()=>ue,Material:()=>Q,PhongMaterial:()=>ee,LambertMaterial:()=>Qi,SpecularMaterial:()=>es,MetallicMaterial:()=>rs,EmphasisMaterial:()=>Et,EdgeMaterial:()=>Pt,OutlineMaterial:()=>Tt,Texture:()=>ls,Fresnel:()=>hs,Viewport:()=>it,Camera:()=>yt,Frustum:()=>at,Ortho:()=>rt,Perspective:()=>st,CustomProjection:()=>nt,Scene:()=>oi});class s{constructor(e,t){this.items=e||[],this._lastUniqueId=(t||0)+1}addItem(){let e;if(2===arguments.length){const t=arguments[0];if(e=arguments[1],this.items[t])throw"ID clash: '"+t+"'";return this.items[t]=e,t}for(e=arguments[0]||{};;){const t=this._lastUniqueId++;if(!this.items[t])return this.items[t]=e,t}}removeItem(e){const t=this.items[e];return delete this.items[e],t}}const r={build:{version:"0.8"},client:{browser:navigator&&navigator.userAgent?navigator.userAgent:"n/a"},components:{scenes:0,models:0,meshes:0,objects:0},memory:{meshes:0,positions:0,colors:0,normals:0,uvs:0,indices:0,textures:0,transforms:0,materials:0,programs:0},frame:{frameCount:0,fps:0,useProgram:0,bindTexture:0,bindArray:0,drawElements:0,drawArrays:0,tasksRun:0,tasksScheduled:0}};var a={isArray:function(e){return e&&!e.propertyIsEnumerable("length")&&"object"==typeof e&&"number"==typeof e.length},isString:function(e){return"string"==typeof e||e instanceof String},isNumeric:function(e){return!isNaN(parseFloat(e))&&isFinite(e)},isID:function(e){return a.isString(e)||a.isNumeric(e)},isSameComponent:function(e,t){if(!e||!t)return!1;return(a.isNumeric(e)||a.isString(e)?""+e:e.id)===(a.isNumeric(t)||a.isString(t)?""+t:t.id)},isFunction:function(e){return"function"==typeof e},isObject:function(e){const t={}.constructor;return!!e&&e.constructor===t},copy:function(e){return a.apply(e,{})},apply:function(e,t){for(const i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);return t},apply2:function(e,t){for(const i in e)e.hasOwnProperty(i)&&void 0!==e[i]&&null!==e[i]&&(t[i]=e[i]);return t},applyIf:function(e,t){for(const i in e)e.hasOwnProperty(i)&&(void 0!==t[i]&&null!==t[i]||(t[i]=e[i]));return t},isEmptyObject:function(e){for(const t in e)if(e.hasOwnProperty(t))return!1;return!0},inQuotes:function(e){return a.isNumeric(e)?""+e:`'${e}'`},concat:function(e,t){const i=new e.constructor(e.length+t.length);return i.set(e),i.set(t,e.length),i}};const o=new Float32Array(16),n=new Float32Array(16),l=new Float32Array(4);let h=!1;const u=[];let c=0;const d={MAX_DOUBLE:Number.MAX_VALUE,MIN_DOUBLE:Number.MIN_VALUE,DEGTORAD:.0174532925,RADTODEG:57.295779513,openCache(){h=!0,c=0},cacheVec3:e=>e||(h?u[c++]||(u[c-1]=new Float32Array(3)):new Float32Array(3)),cacheVec4:e=>e||(h?u[vec4CacheLen++]||(u[vec4CacheLen-1]=new Float32Array(4)):new Float32Array(4)),closeCache(){h=!1},vec2:e=>new Float32Array(e||2),vec3:e=>new Float32Array(e||3),vec4:e=>new Float32Array(e||4),mat3:e=>new Float32Array(e||9),mat3ToMat4:(e,t=new Float32Array(16))=>(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=0,t[4]=e[3],t[5]=e[4],t[6]=e[5],t[7]=0,t[8]=e[6],t[9]=e[7],t[10]=e[8],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t),mat4:e=>new Float32Array(e||16),mat4ToMat3(e,t){},createUUID:(()=>{const e=[];for(let t=0;t<256;t++)e[t]=(t<16?"0":"")+t.toString(16);return()=>{const t=4294967295*Math.random()|0,i=4294967295*Math.random()|0,s=4294967295*Math.random()|0,r=4294967295*Math.random()|0;return`${e[255&t]+e[t>>8&255]+e[t>>16&255]+e[t>>24&255]}-${e[255&i]}${e[i>>8&255]}-${e[i>>16&15|64]}${e[i>>24&255]}-${e[63&s|128]}${e[s>>8&255]}-${e[s>>16&255]}${e[s>>24&255]}${e[255&r]}${e[r>>8&255]}${e[r>>16&255]}${e[r>>24&255]}`}})(),clamp:(e,t,i)=>Math.max(t,Math.min(i,e)),fmod(e,t){if(e<t)return console.error("xeogl.math.fmod : Attempting to find modulus within negative range - would be infinite loop - ignoring"),e;for(;t<=e;)e-=t;return e},negateVec4:(e,t)=>(t||(t=e),t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t),addVec4:(e,t,i)=>(i||(i=e),i[0]=e[0]+t[0],i[1]=e[1]+t[1],i[2]=e[2]+t[2],i[3]=e[3]+t[3],i),addVec4Scalar:(e,t,i)=>(i||(i=e),i[0]=e[0]+t,i[1]=e[1]+t,i[2]=e[2]+t,i[3]=e[3]+t,i),addVec3:(e,t,i)=>(i||(i=e),i[0]=e[0]+t[0],i[1]=e[1]+t[1],i[2]=e[2]+t[2],i),addVec3Scalar:(e,t,i)=>(i||(i=e),i[0]=e[0]+t,i[1]=e[1]+t,i[2]=e[2]+t,i),subVec4:(e,t,i)=>(i||(i=e),i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],i[3]=e[3]-t[3],i),subVec3:(e,t,i)=>(i||(i=e),i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],i),subVec2:(e,t,i)=>(i||(i=e),i[0]=e[0]-t[0],i[1]=e[1]-t[1],i),subVec4Scalar:(e,t,i)=>(i||(i=e),i[0]=e[0]-t,i[1]=e[1]-t,i[2]=e[2]-t,i[3]=e[3]-t,i),subScalarVec4:(e,t,i)=>(i||(i=e),i[0]=t-e[0],i[1]=t-e[1],i[2]=t-e[2],i[3]=t-e[3],i),mulVec4:(e,t,i)=>(i||(i=e),i[0]=e[0]*t[0],i[1]=e[1]*t[1],i[2]=e[2]*t[2],i[3]=e[3]*t[3],i),mulVec4Scalar:(e,t,i)=>(i||(i=e),i[0]=e[0]*t,i[1]=e[1]*t,i[2]=e[2]*t,i[3]=e[3]*t,i),mulVec3Scalar:(e,t,i)=>(i||(i=e),i[0]=e[0]*t,i[1]=e[1]*t,i[2]=e[2]*t,i),mulVec2Scalar:(e,t,i)=>(i||(i=e),i[0]=e[0]*t,i[1]=e[1]*t,i),divVec3:(e,t,i)=>(i||(i=e),i[0]=e[0]/t[0],i[1]=e[1]/t[1],i[2]=e[2]/t[2],i),divVec4:(e,t,i)=>(i||(i=e),i[0]=e[0]/t[0],i[1]=e[1]/t[1],i[2]=e[2]/t[2],i[3]=e[3]/t[3],i),divScalarVec3:(e,t,i)=>(i||(i=t),i[0]=e/t[0],i[1]=e/t[1],i[2]=e/t[2],i),divVec3Scalar:(e,t,i)=>(i||(i=e),i[0]=e[0]/t,i[1]=e[1]/t,i[2]=e[2]/t,i),divVec4Scalar:(e,t,i)=>(i||(i=e),i[0]=e[0]/t,i[1]=e[1]/t,i[2]=e[2]/t,i[3]=e[3]/t,i),divScalarVec4:(e,t,i)=>(i||(i=t),i[0]=e/t[0],i[1]=e/t[1],i[2]=e/t[2],i[3]=e/t[3],i),dotVec4:(e,t)=>e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3],cross3Vec4(e,t){const i=e[0],s=e[1],r=e[2],a=t[0],o=t[1],n=t[2];return[s*n-r*o,r*a-i*n,i*o-s*a,0]},cross3Vec3(e,t,i){i||(i=e);const s=e[0],r=e[1],a=e[2],o=t[0],n=t[1],l=t[2];return i[0]=r*l-a*n,i[1]=a*o-s*l,i[2]=s*n-r*o,i},sqLenVec4:e=>d.dotVec4(e,e),lenVec4:e=>Math.sqrt(d.sqLenVec4(e)),dotVec3:(e,t)=>e[0]*t[0]+e[1]*t[1]+e[2]*t[2],dotVec2:(e,t)=>e[0]*t[0]+e[1]*t[1],sqLenVec3:e=>d.dotVec3(e,e),sqLenVec2:e=>d.dotVec2(e,e),lenVec3:e=>Math.sqrt(d.sqLenVec3(e)),distVec3:(()=>{const e=new Float32Array(3);return(t,i)=>d.lenVec3(d.subVec3(t,i,e))})(),lenVec2:e=>Math.sqrt(d.sqLenVec2(e)),distVec2:(()=>{const e=new Float32Array(2);return(t,i)=>d.lenVec2(d.subVec2(t,i,e))})(),rcpVec3:(e,t)=>d.divScalarVec3(1,e,t),normalizeVec4(e,t){const i=1/d.lenVec4(e);return d.mulVec4Scalar(e,i,t)},normalizeVec3(e,t){const i=1/d.lenVec3(e);return d.mulVec3Scalar(e,i,t)},normalizeVec2(e,t){const i=1/d.lenVec2(e);return d.mulVec2Scalar(e,i,t)},angleVec3(e,t){let i=d.dotVec3(e,t)/Math.sqrt(d.sqLenVec3(e)*d.sqLenVec3(t));return i=i<-1?-1:i>1?1:i,Math.acos(i)},vec3FromMat4Scale:(()=>{const e=new Float32Array(3);return(t,i)=>(e[0]=t[0],e[1]=t[1],e[2]=t[2],i[0]=d.lenVec3(e),e[0]=t[4],e[1]=t[5],e[2]=t[6],i[1]=d.lenVec3(e),e[0]=t[8],e[1]=t[9],e[2]=t[10],i[2]=d.lenVec3(e),i)})(),vecToArray:(()=>{function e(e){return Math.round(1e5*e)/1e5}return t=>{for(let i=0,s=(t=Array.prototype.slice.call(t)).length;i<s;i++)t[i]=e(t[i]);return t}})(),dupMat4:e=>e.slice(0,16),mat4To3:e=>[e[0],e[1],e[2],e[4],e[5],e[6],e[8],e[9],e[10]],m4s:e=>[e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e],setMat4ToZeroes:()=>d.m4s(0),setMat4ToOnes:()=>d.m4s(1),diagonalMat4v:e=>new Float32Array([e[0],0,0,0,0,e[1],0,0,0,0,e[2],0,0,0,0,e[3]]),diagonalMat4c:(e,t,i,s)=>d.diagonalMat4v([e,t,i,s]),diagonalMat4s:e=>d.diagonalMat4c(e,e,e,e),identityMat4:(e=new Float32Array(16))=>(e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e),identityMat3:(e=new Float32Array(9))=>(e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e),isIdentityMat4:e=>1===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&0===e[4]&&1===e[5]&&0===e[6]&&0===e[7]&&0===e[8]&&0===e[9]&&1===e[10]&&0===e[11]&&0===e[12]&&0===e[13]&&0===e[14]&&1===e[15],negateMat4:(e,t)=>(t||(t=e),t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t[4]=-e[4],t[5]=-e[5],t[6]=-e[6],t[7]=-e[7],t[8]=-e[8],t[9]=-e[9],t[10]=-e[10],t[11]=-e[11],t[12]=-e[12],t[13]=-e[13],t[14]=-e[14],t[15]=-e[15],t),addMat4:(e,t,i)=>(i||(i=e),i[0]=e[0]+t[0],i[1]=e[1]+t[1],i[2]=e[2]+t[2],i[3]=e[3]+t[3],i[4]=e[4]+t[4],i[5]=e[5]+t[5],i[6]=e[6]+t[6],i[7]=e[7]+t[7],i[8]=e[8]+t[8],i[9]=e[9]+t[9],i[10]=e[10]+t[10],i[11]=e[11]+t[11],i[12]=e[12]+t[12],i[13]=e[13]+t[13],i[14]=e[14]+t[14],i[15]=e[15]+t[15],i),addMat4Scalar:(e,t,i)=>(i||(i=e),i[0]=e[0]+t,i[1]=e[1]+t,i[2]=e[2]+t,i[3]=e[3]+t,i[4]=e[4]+t,i[5]=e[5]+t,i[6]=e[6]+t,i[7]=e[7]+t,i[8]=e[8]+t,i[9]=e[9]+t,i[10]=e[10]+t,i[11]=e[11]+t,i[12]=e[12]+t,i[13]=e[13]+t,i[14]=e[14]+t,i[15]=e[15]+t,i),addScalarMat4:(e,t,i)=>d.addMat4Scalar(t,e,i),subMat4:(e,t,i)=>(i||(i=e),i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],i[3]=e[3]-t[3],i[4]=e[4]-t[4],i[5]=e[5]-t[5],i[6]=e[6]-t[6],i[7]=e[7]-t[7],i[8]=e[8]-t[8],i[9]=e[9]-t[9],i[10]=e[10]-t[10],i[11]=e[11]-t[11],i[12]=e[12]-t[12],i[13]=e[13]-t[13],i[14]=e[14]-t[14],i[15]=e[15]-t[15],i),subMat4Scalar:(e,t,i)=>(i||(i=e),i[0]=e[0]-t,i[1]=e[1]-t,i[2]=e[2]-t,i[3]=e[3]-t,i[4]=e[4]-t,i[5]=e[5]-t,i[6]=e[6]-t,i[7]=e[7]-t,i[8]=e[8]-t,i[9]=e[9]-t,i[10]=e[10]-t,i[11]=e[11]-t,i[12]=e[12]-t,i[13]=e[13]-t,i[14]=e[14]-t,i[15]=e[15]-t,i),subScalarMat4:(e,t,i)=>(i||(i=t),i[0]=e-t[0],i[1]=e-t[1],i[2]=e-t[2],i[3]=e-t[3],i[4]=e-t[4],i[5]=e-t[5],i[6]=e-t[6],i[7]=e-t[7],i[8]=e-t[8],i[9]=e-t[9],i[10]=e-t[10],i[11]=e-t[11],i[12]=e-t[12],i[13]=e-t[13],i[14]=e-t[14],i[15]=e-t[15],i),mulMat4(e,t,i){i||(i=e);const s=e[0],r=e[1],a=e[2],o=e[3],n=e[4],l=e[5],h=e[6],u=e[7],c=e[8],d=e[9],p=e[10],_=e[11],m=e[12],f=e[13],g=e[14],v=e[15],M=t[0],y=t[1],x=t[2],b=t[3],w=t[4],A=t[5],E=t[6],C=t[7],P=t[8],T=t[9],D=t[10],S=t[11],F=t[12],L=t[13],B=t[14],R=t[15];return i[0]=M*s+y*n+x*c+b*m,i[1]=M*r+y*l+x*d+b*f,i[2]=M*a+y*h+x*p+b*g,i[3]=M*o+y*u+x*_+b*v,i[4]=w*s+A*n+E*c+C*m,i[5]=w*r+A*l+E*d+C*f,i[6]=w*a+A*h+E*p+C*g,i[7]=w*o+A*u+E*_+C*v,i[8]=P*s+T*n+D*c+S*m,i[9]=P*r+T*l+D*d+S*f,i[10]=P*a+T*h+D*p+S*g,i[11]=P*o+T*u+D*_+S*v,i[12]=F*s+L*n+B*c+R*m,i[13]=F*r+L*l+B*d+R*f,i[14]=F*a+L*h+B*p+R*g,i[15]=F*o+L*u+B*_+R*v,i},mulMat3(e,t,i){i||(i=new Float32Array(9));const s=e[0],r=e[3],a=e[6],o=e[1],n=e[4],l=e[7],h=e[2],u=e[5],c=e[8],d=t[0],p=t[3],_=t[6],m=t[1],f=t[4],g=t[7],v=t[2],M=t[5],y=t[8];return i[0]=s*d+r*m+a*v,i[3]=s*p+r*f+a*M,i[6]=s*_+r*g+a*y,i[1]=o*d+n*m+l*v,i[4]=o*p+n*f+l*M,i[7]=o*_+n*g+l*y,i[2]=h*d+u*m+c*v,i[5]=h*p+u*f+c*M,i[8]=h*_+u*g+c*y,i},mulMat4Scalar:(e,t,i)=>(i||(i=e),i[0]=e[0]*t,i[1]=e[1]*t,i[2]=e[2]*t,i[3]=e[3]*t,i[4]=e[4]*t,i[5]=e[5]*t,i[6]=e[6]*t,i[7]=e[7]*t,i[8]=e[8]*t,i[9]=e[9]*t,i[10]=e[10]*t,i[11]=e[11]*t,i[12]=e[12]*t,i[13]=e[13]*t,i[14]=e[14]*t,i[15]=e[15]*t,i),mulMat4v4(e,t,i=d.vec4()){const s=t[0],r=t[1],a=t[2],o=t[3];return i[0]=e[0]*s+e[4]*r+e[8]*a+e[12]*o,i[1]=e[1]*s+e[5]*r+e[9]*a+e[13]*o,i[2]=e[2]*s+e[6]*r+e[10]*a+e[14]*o,i[3]=e[3]*s+e[7]*r+e[11]*a+e[15]*o,i},transposeMat4(e,t){const i=e[4],s=e[14],r=e[8],a=e[13],o=e[12],n=e[9];if(!t||e===t){const t=e[1],l=e[2],h=e[3],u=e[6],c=e[7],d=e[11];return e[1]=i,e[2]=r,e[3]=o,e[4]=t,e[6]=n,e[7]=a,e[8]=l,e[9]=u,e[11]=s,e[12]=h,e[13]=c,e[14]=d,e}return t[0]=e[0],t[1]=i,t[2]=r,t[3]=o,t[4]=e[1],t[5]=e[5],t[6]=n,t[7]=a,t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=s,t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15],t},transposeMat3(e,t){if(t===e){const i=e[1],s=e[2],r=e[5];t[1]=e[3],t[2]=e[6],t[3]=i,t[5]=e[7],t[6]=s,t[7]=r}else t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8];return t},determinantMat4(e){const t=e[0],i=e[1],s=e[2],r=e[3],a=e[4],o=e[5],n=e[6],l=e[7],h=e[8],u=e[9],c=e[10],d=e[11],p=e[12],_=e[13],m=e[14],f=e[15];return p*u*n*r-h*_*n*r-p*o*c*r+a*_*c*r+h*o*m*r-a*u*m*r-p*u*s*l+h*_*s*l+p*i*c*l-t*_*c*l-h*i*m*l+t*u*m*l+p*o*s*d-a*_*s*d-p*i*n*d+t*_*n*d+a*i*m*d-t*o*m*d-h*o*s*f+a*u*s*f+h*i*n*f-t*u*n*f-a*i*c*f+t*o*c*f},inverseMat4(e,t){t||(t=e);const i=e[0],s=e[1],r=e[2],a=e[3],o=e[4],n=e[5],l=e[6],h=e[7],u=e[8],c=e[9],d=e[10],p=e[11],_=e[12],m=e[13],f=e[14],g=e[15],v=i*n-s*o,M=i*l-r*o,y=i*h-a*o,x=s*l-r*n,b=s*h-a*n,w=r*h-a*l,A=u*m-c*_,E=u*f-d*_,C=u*g-p*_,P=c*f-d*m,T=c*g-p*m,D=d*g-p*f,S=1/(v*D-M*T+y*P+x*C-b*E+w*A);return t[0]=(n*D-l*T+h*P)*S,t[1]=(-s*D+r*T-a*P)*S,t[2]=(m*w-f*b+g*x)*S,t[3]=(-c*w+d*b-p*x)*S,t[4]=(-o*D+l*C-h*E)*S,t[5]=(i*D-r*C+a*E)*S,t[6]=(-_*w+f*y-g*M)*S,t[7]=(u*w-d*y+p*M)*S,t[8]=(o*T-n*C+h*A)*S,t[9]=(-i*T+s*C-a*A)*S,t[10]=(_*b-m*y+g*v)*S,t[11]=(-u*b+c*y-p*v)*S,t[12]=(-o*P+n*E-l*A)*S,t[13]=(i*P-s*E+r*A)*S,t[14]=(-_*x+m*M-f*v)*S,t[15]=(u*x-c*M+d*v)*S,t},traceMat4:e=>e[0]+e[5]+e[10]+e[15],translationMat4v(e,t){const i=t||d.identityMat4();return i[12]=e[0],i[13]=e[1],i[14]=e[2],i},translationMat3v(e,t){const i=t||d.identityMat3();return i[6]=e[0],i[7]=e[1],i},translationMat4c:(()=>{const e=new Float32Array(3);return(t,i,s,r)=>(e[0]=t,e[1]=i,e[2]=s,d.translationMat4v(e,r))})(),translationMat4s:(e,t)=>d.translationMat4c(e,e,e,t),translateMat4v:(e,t)=>d.translateMat4c(e[0],e[1],e[2],t),OLDtranslateMat4c(e,t,i,s){const r=s[12];s[0]+=r*e,s[4]+=r*t,s[8]+=r*i;const a=s[13];s[1]+=a*e,s[5]+=a*t,s[9]+=a*i;const o=s[14];s[2]+=o*e,s[6]+=o*t,s[10]+=o*i;const n=s[15];return s[3]+=n*e,s[7]+=n*t,s[11]+=n*i,s},translateMat4c(e,t,i,s){const r=s[3];s[0]+=r*e,s[1]+=r*t,s[2]+=r*i;const a=s[7];s[4]+=a*e,s[5]+=a*t,s[6]+=a*i;const o=s[11];s[8]+=o*e,s[9]+=o*t,s[10]+=o*i;const n=s[15];return s[12]+=n*e,s[13]+=n*t,s[14]+=n*i,s},rotationMat4v(e,t,i){const s=d.normalizeVec4([t[0],t[1],t[2],0],[]),r=Math.sin(e),a=Math.cos(e),o=1-a,n=s[0],l=s[1],h=s[2];let u,c,p,_,m,f;return u=n*l,c=l*h,p=h*n,_=n*r,m=l*r,f=h*r,(i=i||d.mat4())[0]=o*n*n+a,i[1]=o*u+f,i[2]=o*p-m,i[3]=0,i[4]=o*u-f,i[5]=o*l*l+a,i[6]=o*c+_,i[7]=0,i[8]=o*p+m,i[9]=o*c-_,i[10]=o*h*h+a,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i},rotationMat4c:(e,t,i,s,r)=>d.rotationMat4v(e,[t,i,s],r),scalingMat4v:(e,t=d.identityMat4())=>(t[0]=e[0],t[5]=e[1],t[10]=e[2],t),scalingMat3v:(e,t=d.identityMat3())=>(t[0]=e[0],t[4]=e[1],t),scalingMat4c:(()=>{const e=new Float32Array(3);return(t,i,s,r)=>(e[0]=t,e[1]=i,e[2]=s,d.scalingMat4v(e,r))})(),scaleMat4c:(e,t,i,s)=>(s[0]*=e,s[4]*=t,s[8]*=i,s[1]*=e,s[5]*=t,s[9]*=i,s[2]*=e,s[6]*=t,s[10]*=i,s[3]*=e,s[7]*=t,s[11]*=i,s),scaleMat4v(e,t){const i=e[0],s=e[1],r=e[2];return t[0]*=i,t[4]*=s,t[8]*=r,t[1]*=i,t[5]*=s,t[9]*=r,t[2]*=i,t[6]*=s,t[10]*=r,t[3]*=i,t[7]*=s,t[11]*=r,t},scalingMat4s:e=>d.scalingMat4c(e,e,e),rotationTranslationMat4(e,t,i=d.mat4()){const s=e[0],r=e[1],a=e[2],o=e[3],n=s+s,l=r+r,h=a+a,u=s*n,c=s*l,p=s*h,_=r*l,m=r*h,f=a*h,g=o*n,v=o*l,M=o*h;return i[0]=1-(_+f),i[1]=c+M,i[2]=p-v,i[3]=0,i[4]=c-M,i[5]=1-(u+f),i[6]=m+g,i[7]=0,i[8]=p+v,i[9]=m-g,i[10]=1-(u+_),i[11]=0,i[12]=t[0],i[13]=t[1],i[14]=t[2],i[15]=1,i},mat4ToEuler(e,t,i=d.vec4()){const s=d.clamp,r=e[0],a=e[4],o=e[8],n=e[1],l=e[5],h=e[9],u=e[2],c=e[6],p=e[10];return"XYZ"===t?(i[1]=Math.asin(s(o,-1,1)),Math.abs(o)<.99999?(i[0]=Math.atan2(-h,p),i[2]=Math.atan2(-a,r)):(i[0]=Math.atan2(c,l),i[2]=0)):"YXZ"===t?(i[0]=Math.asin(-s(h,-1,1)),Math.abs(h)<.99999?(i[1]=Math.atan2(o,p),i[2]=Math.atan2(n,l)):(i[1]=Math.atan2(-u,r),i[2]=0)):"ZXY"===t?(i[0]=Math.asin(s(c,-1,1)),Math.abs(c)<.99999?(i[1]=Math.atan2(-u,p),i[2]=Math.atan2(-a,l)):(i[1]=0,i[2]=Math.atan2(n,r))):"ZYX"===t?(i[1]=Math.asin(-s(u,-1,1)),Math.abs(u)<.99999?(i[0]=Math.atan2(c,p),i[2]=Math.atan2(n,r)):(i[0]=0,i[2]=Math.atan2(-a,l))):"YZX"===t?(i[2]=Math.asin(s(n,-1,1)),Math.abs(n)<.99999?(i[0]=Math.atan2(-h,l),i[1]=Math.atan2(-u,r)):(i[0]=0,i[1]=Math.atan2(o,p))):"XZY"===t&&(i[2]=Math.asin(-s(a,-1,1)),Math.abs(a)<.99999?(i[0]=Math.atan2(c,l),i[1]=Math.atan2(o,r)):(i[0]=Math.atan2(-h,p),i[1]=0)),i},composeMat4:(e,t,i,s=d.mat4())=>(d.quaternionToRotationMat4(t,s),d.scaleMat4v(i,s),d.translateMat4v(e,s),s),decomposeMat4:(()=>{const e=new Float32Array(3),t=new Float32Array(16);return function(i,s,r,a){e[0]=i[0],e[1]=i[1],e[2]=i[2];let o=d.lenVec3(e);e[0]=i[4],e[1]=i[5],e[2]=i[6];const n=d.lenVec3(e);e[8]=i[8],e[9]=i[9],e[10]=i[10];const l=d.lenVec3(e);d.determinantMat4(i)<0&&(o=-o),s[0]=i[12],s[1]=i[13],s[2]=i[14],t.set(i);const h=1/o,u=1/n,c=1/l;return t[0]*=h,t[1]*=h,t[2]*=h,t[4]*=u,t[5]*=u,t[6]*=u,t[8]*=c,t[9]*=c,t[10]*=c,d.mat4ToQuaternion(t,r),a[0]=o,a[1]=n,a[2]=l,this}})(),lookAtMat4v(e,t,i,s){s||(s=d.mat4());const r=e[0],a=e[1],o=e[2],n=i[0],l=i[1],h=i[2],u=t[0],c=t[1],p=t[2];if(r===u&&a===c&&o===p)return d.identityMat4();let _,m,f,g,v,M,y,x,b,w;return _=r-u,m=a-c,f=o-p,w=1/Math.sqrt(_*_+m*m+f*f),_*=w,m*=w,f*=w,g=l*f-h*m,v=h*_-n*f,M=n*m-l*_,w=Math.sqrt(g*g+v*v+M*M),w?(w=1/w,g*=w,v*=w,M*=w):(g=0,v=0,M=0),y=m*M-f*v,x=f*g-_*M,b=_*v-m*g,w=Math.sqrt(y*y+x*x+b*b),w?(w=1/w,y*=w,x*=w,b*=w):(y=0,x=0,b=0),s[0]=g,s[1]=y,s[2]=_,s[3]=0,s[4]=v,s[5]=x,s[6]=m,s[7]=0,s[8]=M,s[9]=b,s[10]=f,s[11]=0,s[12]=-(g*r+v*a+M*o),s[13]=-(y*r+x*a+b*o),s[14]=-(_*r+m*a+f*o),s[15]=1,s},lookAtMat4c:(e,t,i,s,r,a,o,n,l)=>d.lookAtMat4v([e,t,i],[s,r,a],[o,n,l],[]),orthoMat4c(e,t,i,s,r,a,o){o||(o=d.mat4());const n=t-e,l=s-i,h=a-r;return o[0]=2/n,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=2/l,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[10]=-2/h,o[11]=0,o[12]=-(e+t)/n,o[13]=-(s+i)/l,o[14]=-(a+r)/h,o[15]=1,o},frustumMat4v(e,t,i){i||(i=d.mat4());const s=[e[0],e[1],e[2],0],r=[t[0],t[1],t[2],0];d.addVec4(r,s,o),d.subVec4(r,s,n);const a=2*s[2],l=n[0],h=n[1],u=n[2];return i[0]=a/l,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=a/h,i[6]=0,i[7]=0,i[8]=o[0]/l,i[9]=o[1]/h,i[10]=-o[2]/u,i[11]=-1,i[12]=0,i[13]=0,i[14]=-a*r[2]/u,i[15]=0,i},frustumMat4(e,t,i,s,r,a,o){o||(o=d.mat4());const n=t-e,l=s-i,h=a-r;return o[0]=2*r/n,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=2*r/l,o[6]=0,o[7]=0,o[8]=(t+e)/n,o[9]=(s+i)/l,o[10]=-(a+r)/h,o[11]=-1,o[12]=0,o[13]=0,o[14]=-a*r*2/h,o[15]=0,o},perspectiveMat4(e,t,i,s,r){const a=[],o=[];return a[2]=i,o[2]=s,o[1]=a[2]*Math.tan(e/2),a[1]=-o[1],o[0]=o[1]*t,a[0]=-o[0],d.frustumMat4v(a,o,r)},transformPoint3:(e,t,i=d.vec3())=>(i[0]=e[0]*t[0]+e[4]*t[1]+e[8]*t[2]+e[12],i[1]=e[1]*t[0]+e[5]*t[1]+e[9]*t[2]+e[13],i[2]=e[2]*t[0]+e[6]*t[1]+e[10]*t[2]+e[14],i),transformPoint4:(e,t,i=d.vec4())=>(i[0]=e[0]*t[0]+e[4]*t[1]+e[8]*t[2]+e[12]*t[3],i[1]=e[1]*t[0]+e[5]*t[1]+e[9]*t[2]+e[13]*t[3],i[2]=e[2]*t[0]+e[6]*t[1]+e[10]*t[2]+e[14]*t[3],i[3]=e[3]*t[0]+e[7]*t[1]+e[11]*t[2]+e[15]*t[3],i),transformPoints3(e,t,i){const s=i||[],r=t.length;let a,o,n,l;const h=e[0],u=e[1],c=e[2],d=e[3],p=e[4],_=e[5],m=e[6],f=e[7],g=e[8],v=e[9],M=e[10],y=e[11],x=e[12],b=e[13],w=e[14],A=e[15];let E;for(let e=0;e<r;++e)l=t[e],a=l[0],o=l[1],n=l[2],E=s[e]||(s[e]=[0,0,0]),E[0]=h*a+p*o+g*n+x,E[1]=u*a+_*o+v*n+b,E[2]=c*a+m*o+M*n+w,E[3]=d*a+f*o+y*n+A;return s.length=r,s},transformPositions3(e,t,i=t){let s;const r=t.length;let a,o,n;const l=e[0],h=e[1],u=e[2],c=e[3],d=e[4],p=e[5],_=e[6],m=e[7],f=e[8],g=e[9],v=e[10],M=e[11],y=e[12],x=e[13],b=e[14],w=e[15];for(s=0;s<r;s+=3)a=t[s+0],o=t[s+1],n=t[s+2],i[s+0]=l*a+d*o+f*n+y,i[s+1]=h*a+p*o+g*n+x,i[s+2]=u*a+_*o+v*n+b,i[s+3]=c*a+m*o+M*n+w;return i},transformPositions4(e,t,i=t){let s;const r=t.length;let a,o,n;const l=e[0],h=e[1],u=e[2],c=e[3],d=e[4],p=e[5],_=e[6],m=e[7],f=e[8],g=e[9],v=e[10],M=e[11],y=e[12],x=e[13],b=e[14],w=e[15];for(s=0;s<r;s+=4)a=t[s+0],o=t[s+1],n=t[s+2],i[s+0]=l*a+d*o+f*n+y,i[s+1]=h*a+p*o+g*n+x,i[s+2]=u*a+_*o+v*n+b,i[s+3]=c*a+m*o+M*n+w;return i},transformVec3(e,t,i){const s=t[0],r=t[1],a=t[2];return(i=i||this.vec3())[0]=e[0]*s+e[4]*r+e[8]*a,i[1]=e[1]*s+e[5]*r+e[9]*a,i[2]=e[2]*s+e[6]*r+e[10]*a,i},transformVec4(e,t,i){const s=t[0],r=t[1],a=t[2],o=t[3];return(i=i||d.vec4())[0]=e[0]*s+e[4]*r+e[8]*a+e[12]*o,i[1]=e[1]*s+e[5]*r+e[9]*a+e[13]*o,i[2]=e[2]*s+e[6]*r+e[10]*a+e[14]*o,i[3]=e[3]*s+e[7]*r+e[11]*a+e[15]*o,i},rotateVec3X(e,t,i,s){const r=[],a=[];return r[0]=e[0]-t[0],r[1]=e[1]-t[1],r[2]=e[2]-t[2],a[0]=r[0],a[1]=r[1]*Math.cos(i)-r[2]*Math.sin(i),a[2]=r[1]*Math.sin(i)+r[2]*Math.cos(i),s[0]=a[0]+t[0],s[1]=a[1]+t[1],s[2]=a[2]+t[2],s},rotateVec3Y(e,t,i,s){const r=[],a=[];return r[0]=e[0]-t[0],r[1]=e[1]-t[1],r[2]=e[2]-t[2],a[0]=r[2]*Math.sin(i)+r[0]*Math.cos(i),a[1]=r[1],a[2]=r[2]*Math.cos(i)-r[0]*Math.sin(i),s[0]=a[0]+t[0],s[1]=a[1]+t[1],s[2]=a[2]+t[2],s},rotateVec3Z(e,t,i,s){const r=[],a=[];return r[0]=e[0]-t[0],r[1]=e[1]-t[1],r[2]=e[2]-t[2],a[0]=r[0]*Math.cos(i)-r[1]*Math.sin(i),a[1]=r[0]*Math.sin(i)+r[1]*Math.cos(i),a[2]=r[2],s[0]=a[0]+t[0],s[1]=a[1]+t[1],s[2]=a[2]+t[2],s},projectVec4(e,t){const i=1/e[3];return(t=t||d.vec2())[0]=v[0]*i,t[1]=v[1]*i,t},unprojectVec3:(()=>{const e=new Float32Array(16),t=new Float32Array(16),i=new Float32Array(16);return function(s,r,a,o){return this.transformVec3(this.mulMat4(this.inverseMat4(r,e),this.inverseMat4(a,t),i),s,o)}})(),lerpVec3(e,t,i,s,r,a){const o=a||d.vec3(),n=(e-t)/(i-t);return o[0]=s[0]+n*(r[0]-s[0]),o[1]=s[1]+n*(r[1]-s[1]),o[2]=s[2]+n*(r[2]-s[2]),o},flatten(e){const t=[];let i,s,r,a,o;for(i=0,s=e.length;i<s;i++)for(o=e[i],r=0,a=o.length;r<a;r++)t.push(o[r]);return t},identityQuaternion:(e=d.vec4())=>(e[0]=0,e[1]=0,e[2]=0,e[3]=1,e),eulerToQuaternion(e,t,i=d.vec4()){const s=e[0]*d.DEGTORAD/2,r=e[1]*d.DEGTORAD/2,a=e[2]*d.DEGTORAD/2,o=Math.cos(s),n=Math.cos(r),l=Math.cos(a),h=Math.sin(s),u=Math.sin(r),c=Math.sin(a);return"XYZ"===t?(i[0]=h*n*l+o*u*c,i[1]=o*u*l-h*n*c,i[2]=o*n*c+h*u*l,i[3]=o*n*l-h*u*c):"YXZ"===t?(i[0]=h*n*l+o*u*c,i[1]=o*u*l-h*n*c,i[2]=o*n*c-h*u*l,i[3]=o*n*l+h*u*c):"ZXY"===t?(i[0]=h*n*l-o*u*c,i[1]=o*u*l+h*n*c,i[2]=o*n*c+h*u*l,i[3]=o*n*l-h*u*c):"ZYX"===t?(i[0]=h*n*l-o*u*c,i[1]=o*u*l+h*n*c,i[2]=o*n*c-h*u*l,i[3]=o*n*l+h*u*c):"YZX"===t?(i[0]=h*n*l+o*u*c,i[1]=o*u*l+h*n*c,i[2]=o*n*c-h*u*l,i[3]=o*n*l-h*u*c):"XZY"===t&&(i[0]=h*n*l-o*u*c,i[1]=o*u*l-h*n*c,i[2]=o*n*c+h*u*l,i[3]=o*n*l+h*u*c),i},mat4ToQuaternion(e,t=d.vec4()){const i=e[0],s=e[4],r=e[8],a=e[1],o=e[5],n=e[9],l=e[2],h=e[6],u=e[10];let c;const p=i+o+u;return p>0?(c=.5/Math.sqrt(p+1),t[3]=.25/c,t[0]=(h-n)*c,t[1]=(r-l)*c,t[2]=(a-s)*c):i>o&&i>u?(c=2*Math.sqrt(1+i-o-u),t[3]=(h-n)/c,t[0]=.25*c,t[1]=(s+a)/c,t[2]=(r+l)/c):o>u?(c=2*Math.sqrt(1+o-i-u),t[3]=(r-l)/c,t[0]=(s+a)/c,t[1]=.25*c,t[2]=(n+h)/c):(c=2*Math.sqrt(1+u-i-o),t[3]=(a-s)/c,t[0]=(r+l)/c,t[1]=(n+h)/c,t[2]=.25*c),t},vec3PairToQuaternion(e,t,i=d.vec4()){const s=Math.sqrt(d.dotVec3(e,e)*d.dotVec3(t,t));let r=s+d.dotVec3(e,t);return r<1e-8*s?(r=0,Math.abs(e[0])>Math.abs(e[2])?(i[0]=-e[1],i[1]=e[0],i[2]=0):(i[0]=0,i[1]=-e[2],i[2]=e[1])):d.cross3Vec3(e,t,i),i[3]=r,d.normalizeQuaternion(i)},angleAxisToQuaternion(e,t=d.vec4()){const i=e[3]/2,s=Math.sin(i);return t[0]=s*e[0],t[1]=s*e[1],t[2]=s*e[2],t[3]=Math.cos(i),t},quaternionToEuler:(()=>{const e=new Float32Array(16);return(t,i,s)=>(s=s||d.vec3(),d.quaternionToRotationMat4(t,e),d.mat4ToEuler(e,i,s),s)})(),mulQuaternions(e,t,i=d.vec4()){const s=e[0],r=e[1],a=e[2],o=e[3],n=t[0],l=t[1],h=t[2],u=t[3];return i[0]=o*n+s*u+r*h-a*l,i[1]=o*l+r*u+a*n-s*h,i[2]=o*h+a*u+s*l-r*n,i[3]=o*u-s*n-r*l-a*h,i},vec3ApplyQuaternion(e,t,i=d.vec3()){const s=t[0],r=t[1],a=t[2],o=e[0],n=e[1],l=e[2],h=e[3],u=h*s+n*a-l*r,c=h*r+l*s-o*a,p=h*a+o*r-n*s,_=-o*s-n*r-l*a;return i[0]=u*h+_*-o+c*-l-p*-n,i[1]=c*h+_*-n+p*-o-u*-l,i[2]=p*h+_*-l+u*-n-c*-o,i},quaternionToMat4(e,t){t=d.identityMat4(t);const i=e[0],s=e[1],r=e[2],a=e[3],o=2*i,n=2*s,l=2*r,h=o*a,u=n*a,c=l*a,p=o*i,_=n*i,m=l*i,f=n*s,g=l*s,v=l*r;return t[0]=1-(f+v),t[1]=_+c,t[2]=m-u,t[4]=_-c,t[5]=1-(p+v),t[6]=g+h,t[8]=m+u,t[9]=g-h,t[10]=1-(p+f),t},quaternionToRotationMat4(e,t){const i=e[0],s=e[1],r=e[2],a=e[3],o=i+i,n=s+s,l=r+r,h=i*o,u=i*n,c=i*l,d=s*n,p=s*l,_=r*l,m=a*o,f=a*n,g=a*l;return t[0]=1-(d+_),t[4]=u-g,t[8]=c+f,t[1]=u+g,t[5]=1-(h+_),t[9]=p-m,t[2]=c-f,t[6]=p+m,t[10]=1-(h+d),t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},normalizeQuaternion(e,t=e){const i=d.lenVec4([e[0],e[1],e[2],e[3]]);return t[0]=e[0]/i,t[1]=e[1]/i,t[2]=e[2]/i,t[3]=e[3]/i,t},conjugateQuaternion:(e,t=e)=>(t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t),inverseQuaternion:(e,t)=>d.normalizeQuaternion(d.conjugateQuaternion(e,t)),quaternionToAngleAxis(e,t=d.vec4()){const i=(e=d.normalizeQuaternion(e,l))[3],s=2*Math.acos(i),r=Math.sqrt(1-i*i);return r<.001?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=e[0]/r,t[1]=e[1]/r,t[2]=e[2]/r),t[3]=s,t},decompressPosition(e,t,i){i[0]=e[0]*t[0]+t[12],i[1]=e[1]*t[5]+t[13],i[2]=e[2]*t[10]+t[14]},decompressPositions(e,t,i=new Float32Array(e.length)){for(let s=0,r=e.length;s<r;s+=3)i[s+0]=e[s+0]*t[0]+t[12],i[s+1]=e[s+1]*t[5]+t[13],i[s+2]=e[s+2]*t[10]+t[14];return i},decompressUV(e,t,i){i[0]=e[0]*t[0]+t[6],i[1]=e[1]*t[4]+t[7]},decompressUVs(e,t,i=new Float32Array(e.length)){for(let s=0,r=e.length;s<r;s+=3)i[s+0]=e[s+0]*t[0]+t[6],i[s+1]=e[s+1]*t[4]+t[7];return i},octDecodeVec2(e,t){let i=e[0],s=e[1];i=(2*i+1)/255,s=(2*s+1)/255;const r=1-Math.abs(i)-Math.abs(s);r<0&&(i=(1-Math.abs(s))*(i>=0?1:-1),s=(1-Math.abs(i))*(s>=0?1:-1));const a=Math.sqrt(i*i+s*s+r*r);return t[0]=i/a,t[1]=s/a,t[2]=r/a,t},octDecodeVec2s(e,t){for(let i=0,s=0,r=e.length;i<r;i+=2){let r=e[i+0],a=e[i+1];r=(2*r+1)/255,a=(2*a+1)/255;const o=1-Math.abs(r)-Math.abs(a);o<0&&(r=(1-Math.abs(a))*(r>=0?1:-1),a=(1-Math.abs(r))*(a>=0?1:-1));const n=Math.sqrt(r*r+a*a+o*o);t[s+0]=r/n,t[s+1]=a/n,t[s+2]=o/n,s+=3}return t},AABB3:e=>new Float32Array(e||6),AABB2:e=>new Float32Array(e||4),OBB3:e=>new Float32Array(e||32),OBB2:e=>new Float32Array(e||16),transformOBB3(e,t,i=t){let s;const r=t.length;let a,o,n;const l=e[0],h=e[1],u=e[2],c=e[3],d=e[4],p=e[5],_=e[6],m=e[7],f=e[8],g=e[9],v=e[10],M=e[11],y=e[12],x=e[13],b=e[14],w=e[15];for(s=0;s<r;s+=4)a=t[s+0],o=t[s+1],n=t[s+2],i[s+0]=l*a+d*o+f*n+y,i[s+1]=h*a+p*o+g*n+x,i[s+2]=u*a+_*o+v*n+b,i[s+3]=c*a+m*o+M*n+w;return i},getAABB3Diag:(()=>{const e=new Float32Array(3),t=new Float32Array(3),i=new Float32Array(3);return s=>(e[0]=s[0],e[1]=s[1],e[2]=s[2],t[0]=s[3],t[1]=s[4],t[2]=s[5],d.subVec3(t,e,i),Math.abs(d.lenVec3(i)))})(),getAABB3DiagPoint:(()=>{const e=new Float32Array(3),t=new Float32Array(3),i=new Float32Array(3);return(s,r)=>{e[0]=s[0],e[1]=s[1],e[2]=s[2],t[0]=s[3],t[1]=s[4],t[2]=s[5];const a=d.subVec3(t,e,i),o=r[0]-s[0],n=s[3]-r[0],l=r[1]-s[1],h=s[4]-r[1],u=r[2]-s[2],c=s[5]-r[2];return a[0]+=o>n?o:n,a[1]+=l>h?l:h,a[2]+=u>c?u:c,Math.abs(d.lenVec3(a))}})(),getAABB3Center(e,t){const i=t||d.vec3();return i[0]=(e[0]+e[3])/2,i[1]=(e[1]+e[4])/2,i[2]=(e[2]+e[5])/2,i},getAABB2Center(e,t){const i=t||d.vec2();return i[0]=(e[2]+e[0])/2,i[1]=(e[3]+e[1])/2,i},collapseAABB3:(e=d.AABB3())=>(e[0]=d.MAX_DOUBLE,e[1]=d.MAX_DOUBLE,e[2]=d.MAX_DOUBLE,e[3]=-d.MAX_DOUBLE,e[4]=-d.MAX_DOUBLE,e[5]=-d.MAX_DOUBLE,e),AABB3ToOBB3:(e,t=d.OBB3())=>(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=1,t[4]=e[3],t[5]=e[1],t[6]=e[2],t[7]=1,t[8]=e[3],t[9]=e[4],t[10]=e[2],t[11]=1,t[12]=e[0],t[13]=e[4],t[14]=e[2],t[15]=1,t[16]=e[0],t[17]=e[1],t[18]=e[5],t[19]=1,t[20]=e[3],t[21]=e[1],t[22]=e[5],t[23]=1,t[24]=e[3],t[25]=e[4],t[26]=e[5],t[27]=1,t[28]=e[0],t[29]=e[4],t[30]=e[5],t[31]=1,t),positions3ToAABB3:(()=>{const e=new Float32Array(3);return(t,i,s)=>{i=i||d.AABB3();let r,a,o,n=d.MAX_DOUBLE,l=d.MAX_DOUBLE,h=d.MAX_DOUBLE,u=-d.MAX_DOUBLE,c=-d.MAX_DOUBLE,p=-d.MAX_DOUBLE;for(let i=0,_=t.length;i<_;i+=3)s?(e[0]=t[i+0],e[1]=t[i+1],e[2]=t[i+2],d.decompressPosition(e,s,e),r=e[0],a=e[1],o=e[2]):(r=t[i+0],a=t[i+1],o=t[i+2]),r<n&&(n=r),a<l&&(l=a),o<h&&(h=o),r>u&&(u=r),a>c&&(c=a),o>p&&(p=o);return i[0]=n,i[1]=l,i[2]=h,i[3]=u,i[4]=c,i[5]=p,i}})(),OBB3ToAABB3(e,t=d.AABB3()){let i,s,r,a=d.MAX_DOUBLE,o=d.MAX_DOUBLE,n=d.MAX_DOUBLE,l=-d.MAX_DOUBLE,h=-d.MAX_DOUBLE,u=-d.MAX_DOUBLE;for(let t=0,c=e.length;t<c;t+=4)i=e[t+0],s=e[t+1],r=e[t+2],i<a&&(a=i),s<o&&(o=s),r<n&&(n=r),i>l&&(l=i),s>h&&(h=s),r>u&&(u=r);return t[0]=a,t[1]=o,t[2]=n,t[3]=l,t[4]=h,t[5]=u,t},points3ToAABB3(e,t=d.AABB3()){let i,s,r,a=d.MAX_DOUBLE,o=d.MAX_DOUBLE,n=d.MAX_DOUBLE,l=-d.MAX_DOUBLE,h=-d.MAX_DOUBLE,u=-d.MAX_DOUBLE;for(let t=0,c=e.length;t<c;t++)i=e[t][0],s=e[t][1],r=e[t][2],i<a&&(a=i),s<o&&(o=s),r<n&&(n=r),i>l&&(l=i),s>h&&(h=s),r>u&&(u=r);return t[0]=a,t[1]=o,t[2]=n,t[3]=l,t[4]=h,t[5]=u,t},points3ToSphere3:(()=>{const e=new Float32Array(3);return(t,i)=>{i=i||d.vec4();let s,r=0,a=0,o=0;const n=t.length;for(s=0;s<n;s++)r+=t[s][0],a+=t[s][1],o+=t[s][2];i[0]=r/n,i[1]=a/n,i[2]=o/n;let l,h=0;for(s=0;s<n;s++)l=Math.abs(d.lenVec3(d.subVec3(t[s],i,e))),l>h&&(h=l);return i[3]=h,i}})(),OBB3ToSphere3:(()=>{const e=new Float32Array(3),t=new Float32Array(3);return(i,s)=>{s=s||d.vec4();let r,a=0,o=0,n=0;const l=i.length,h=l/4;for(r=0;r<l;r+=4)a+=i[r+0],o+=i[r+1],n+=i[r+2];s[0]=a/h,s[1]=o/h,s[2]=n/h;let u,c=0;for(r=0;r<l;r+=4)e[0]=i[r+0],e[1]=i[r+1],e[2]=i[r+2],u=Math.abs(d.lenVec3(d.subVec3(e,s,t))),u>c&&(c=u);return s[3]=c,s}})(),getSphere3Center:(e,t=d.vec3())=>(t[0]=e[0],t[1]=e[1],t[2]=e[2],t),expandAABB3:(e,t)=>(e[0]>t[0]&&(e[0]=t[0]),e[1]>t[1]&&(e[1]=t[1]),e[2]>t[2]&&(e[2]=t[2]),e[3]<t[3]&&(e[3]=t[3]),e[4]<t[4]&&(e[4]=t[4]),e[5]<t[5]&&(e[5]=t[5]),e),expandAABB3Point3:(e,t)=>(e[0]<t[0]&&(e[0]=t[0]),e[1]<t[1]&&(e[1]=t[1]),e[2]<t[2]&&(e[2]=t[2]),e[3]>t[0]&&(e[3]=t[0]),e[4]>t[1]&&(e[4]=t[1]),e[5]>t[2]&&(e[5]=t[2]),e),collapseAABB2:(e=d.AABB2())=>(e[0]=d.MAX_DOUBLE,e[1]=d.MAX_DOUBLE,e[2]=-d.MAX_DOUBLE,e[3]=-d.MAX_DOUBLE,e),OBB3ToAABB2(e,t=d.AABB2()){let i,s,r,a,o=d.MAX_DOUBLE,n=d.MAX_DOUBLE,l=-d.MAX_DOUBLE,h=-d.MAX_DOUBLE;for(let t=0,u=e.length;t<u;t+=4)i=e[t+0],s=e[t+1],r=e[t+3]||1,a=1/r,i*=a,s*=a,i<o&&(o=i),s<n&&(n=s),i>l&&(l=i),s>h&&(h=s);return t[0]=o,t[1]=n,t[2]=l,t[3]=h,t},expandAABB2:(e,t)=>(e[0]>t[0]&&(e[0]=t[0]),e[1]>t[1]&&(e[1]=t[1]),e[2]<t[2]&&(e[2]=t[2]),e[3]<t[3]&&(e[3]=t[3]),e),expandAABB2Point2:(e,t)=>(e[0]>t[0]&&(e[0]=t[0]),e[1]>t[1]&&(e[1]=t[1]),e[2]<t[0]&&(e[2]=t[0]),e[3]<t[1]&&(e[3]=t[1]),e),AABB2ToCanvas(e,t,i,s=e){const r=.5*(e[0]+1),a=.5*(e[1]+1),o=.5*(e[2]+1),n=.5*(e[3]+1);return s[0]=Math.floor(r*t),s[1]=i-Math.floor(n*i),s[2]=Math.floor(o*t),s[3]=i-Math.floor(a*i),s},tangentQuadraticBezier:(e,t,i,s)=>2*(1-e)*(i-t)+2*e*(s-i),tangentQuadraticBezier3:(e,t,i,s,r)=>-3*t*(1-e)*(1-e)+3*i*(1-e)*(1-e)-6*e*i*(1-e)+6*e*s*(1-e)-3*e*e*s+3*e*e*r,tangentSpline:e=>6*e*e-6*e+(3*e*e-4*e+1)+(-6*e*e+6*e)+(3*e*e-2*e),catmullRomInterpolate(e,t,i,s,r){const a=.5*(i-e),o=.5*(s-t),n=r*r;return(2*t-2*i+a+o)*(r*n)+(-3*t+3*i-2*a-o)*n+a*r+t},b2p0(e,t){const i=1-e;return i*i*t},b2p1:(e,t)=>2*(1-e)*e*t,b2p2:(e,t)=>e*e*t,b2(e,t,i,s){return this.b2p0(e,t)+this.b2p1(e,i)+this.b2p2(e,s)},b3p0(e,t){const i=1-e;return i*i*i*t},b3p1(e,t){const i=1-e;return 3*i*i*e*t},b3p2:(e,t)=>3*(1-e)*e*e*t,b3p3:(e,t)=>e*e*e*t,b3(e,t,i,s,r){return this.b3p0(e,t)+this.b3p1(e,i)+this.b3p2(e,s)+this.b3p3(e,r)},triangleNormal(e,t,i,s=d.vec3()){const r=t[0]-e[0],a=t[1]-e[1],o=t[2]-e[2],n=i[0]-e[0],l=i[1]-e[1],h=i[2]-e[2],u=a*h-o*l,c=o*n-r*h,p=r*l-a*n,_=Math.sqrt(u*u+c*c+p*p);return 0===_?(s[0]=0,s[1]=0,s[2]=0):(s[0]=u/_,s[1]=c/_,s[2]=p/_),s},rayTriangleIntersect:(()=>{const e=new Float32Array(3),t=new Float32Array(3),i=new Float32Array(3),s=new Float32Array(3),r=new Float32Array(3);return(a,o,n,l,h,u)=>{u=u||d.vec3();const c=d.subVec3(l,n,e),p=d.subVec3(h,n,t),_=d.cross3Vec3(o,p,i),m=d.dotVec3(c,_);if(m<1e-6)return null;const f=d.subVec3(a,n,s),g=d.dotVec3(f,_);if(g<0||g>m)return null;const v=d.cross3Vec3(f,c,r),M=d.dotVec3(o,v);if(M<0||g+M>m)return null;const y=d.dotVec3(p,v)/m;return u[0]=a[0]+y*o[0],u[1]=a[1]+y*o[1],u[2]=a[2]+y*o[2],u}})(),rayPlaneIntersect:(()=>{const e=new Float32Array(3),t=new Float32Array(3),i=new Float32Array(3),s=new Float32Array(3);return(r,a,o,n,l,h)=>{h=h||d.vec3(),a=d.normalizeVec3(a,e);const u=d.subVec3(n,o,t),c=d.subVec3(l,o,i),p=d.cross3Vec3(u,c,s);d.normalizeVec3(p,p);const _=-d.dotVec3(o,p),m=-(d.dotVec3(r,p)+_)/d.dotVec3(a,p);return h[0]=r[0]+m*a[0],h[1]=r[1]+m*a[1],h[2]=r[2]+m*a[2],h}})(),cartesianToBarycentric:(()=>{const e=new Float32Array(3),t=new Float32Array(3),i=new Float32Array(3);return(s,r,a,o,n)=>{const l=d.subVec3(o,r,e),h=d.subVec3(a,r,t),u=d.subVec3(s,r,i),c=d.dotVec3(l,l),p=d.dotVec3(l,h),_=d.dotVec3(l,u),m=d.dotVec3(h,h),f=d.dotVec3(h,u),g=c*m-p*p;if(0===g)return null;const v=1/g,M=(m*_-p*f)*v,y=(c*f-p*_)*v;return n[0]=1-M-y,n[1]=y,n[2]=M,n}})(),barycentricInsideTriangle(e){const t=e[1],i=e[2];return i>=0&&t>=0&&i+t<1},barycentricToCartesian(e,t,i,s,r=d.vec3()){const a=e[0],o=e[1],n=e[2];return r[0]=t[0]*a+i[0]*o+s[0]*n,r[1]=t[1]*a+i[1]*o+s[1]*n,r[2]=t[2]*a+i[2]*o+s[2]*n,r},mergeVertices(e,t,i,s){const r={},a=[],o=[],n=t?[]:null,l=i?[]:null,h=[];let u,c,d,p;let _,m,f=0;for(_=0,m=e.length;_<m;_+=3)u=e[_],c=e[_+1],d=e[_+2],p=`${Math.round(1e4*u)}_${Math.round(1e4*c)}_${Math.round(1e4*d)}`,void 0===r[p]&&(r[p]=o.length/3,o.push(u),o.push(c),o.push(d),t&&(n.push(t[_]),n.push(t[_+1]),n.push(t[_+2])),i&&(l.push(i[f]),l.push(i[f+1]))),a[_/3]=r[p],f+=2;for(_=0,m=s.length;_<m;_++)h[_]=a[s[_]];const g={positions:o,indices:h};return n&&(g.normals=n),l&&(g.uv=l),g},buildNormals:(()=>{const e=new Float32Array(3),t=new Float32Array(3),i=new Float32Array(3),s=new Float32Array(3),r=new Float32Array(3),a=new Float32Array(3);return(o,n,l)=>{let h,u;const c=new Array(o.length/3);let p,_,m,f,g,v,M;for(h=0,u=n.length;h<u;h+=3){p=n[h],_=n[h+1],m=n[h+2],e[0]=o[3*p],e[1]=o[3*p+1],e[2]=o[3*p+2],t[0]=o[3*_],t[1]=o[3*_+1],t[2]=o[3*_+2],i[0]=o[3*m],i[1]=o[3*m+1],i[2]=o[3*m+2],d.subVec3(t,e,s),d.subVec3(i,e,r);const l=new Float32Array(3);d.normalizeVec3(d.cross3Vec3(s,r,a),l),c[p]||(c[p]=[]),c[_]||(c[_]=[]),c[m]||(c[m]=[]),c[p].push(l),c[_].push(l),c[m].push(l)}for(l=l&&l.length===o.length?l:new Float32Array(o.length),h=0,u=c.length;h<u;h++){f=c[h].length,g=0,v=0,M=0;for(let e=0;e<f;e++)g+=c[h][e][0],v+=c[h][e][1],M+=c[h][e][2];l[3*h]=g/f,l[3*h+1]=v/f,l[3*h+2]=M/f}return l}})(),buildTangents:(()=>{const e=new Float32Array(3),t=new Float32Array(3),i=new Float32Array(3),s=new Float32Array(3),r=new Float32Array(3),a=new Float32Array(3),o=new Float32Array(3);return(n,l,h)=>{const u=new Float32Array(n.length);for(let c=0;c<l.length;c+=3){let p=l[c];const _=n.subarray(3*p,3*p+3),m=h.subarray(2*p,2*p+2);p=l[c+1];const f=n.subarray(3*p,3*p+3),g=h.subarray(2*p,2*p+2);p=l[c+2];const v=n.subarray(3*p,3*p+3),M=h.subarray(2*p,2*p+2),y=d.subVec3(f,_,e),x=d.subVec3(v,_,t),b=d.subVec2(g,m,i),w=d.subVec2(M,m,s),A=1/(b[0]*w[1]-b[1]*w[0]),E=d.mulVec3Scalar(d.subVec3(d.mulVec3Scalar(y,w[1],r),d.mulVec3Scalar(x,b[1],a),o),A,a);let C;for(let e=0;e<3;e++)C=3*l[c+e],u[C]+=E[0],u[C+1]+=E[1],u[C+2]+=E[2]}return u}})(),buildPickTriangles(e,t,i){const s=t.length,r=i?new Uint16Array(9*s):new Float32Array(9*s),a=new Uint8Array(12*s);let o,n,l,h,u,c,d=0,p=0,_=0;for(let i=0;i<s;i+=3)c=d>>24&255,u=d>>16&255,h=d>>8&255,l=255&d,n=t[i],o=3*n,r[p++]=e[o],r[p++]=e[o+1],r[p++]=e[o+2],a[_++]=l,a[_++]=h,a[_++]=u,a[_++]=c,n=t[i+1],o=3*n,r[p++]=e[o],r[p++]=e[o+1],r[p++]=e[o+2],a[_++]=l,a[_++]=h,a[_++]=u,a[_++]=c,n=t[i+2],o=3*n,r[p++]=e[o],r[p++]=e[o+1],r[p++]=e[o+2],a[_++]=l,a[_++]=h,a[_++]=u,a[_++]=c,d++;return{positions:r,colors:a}},faceToVertexNormals(e,t,i={}){const s=i.smoothNormalsAngleThreshold||20,r={},a=[],o={};let n,l,h,u,c;let p,_,m,f,g,v;for(_=0,f=e.length;_<f;_+=3){p=_/3,l=e[_],h=e[_+1],u=e[_+2],c=`${Math.round(1e4*l)}_${Math.round(1e4*h)}_${Math.round(1e4*u)}`,void 0===r[c]?r[c]=[p]:r[c].push(p);const i=d.normalizeVec3([t[_],t[_+1],t[_+2]]);a[p]=i,n=d.vec4([i[0],i[1],i[2],1]),o[p]=n}for(c in r)if(r.hasOwnProperty(c)){const e=r[c],t=e.length;for(_=0;_<t;_++){const i=e[_];for(n=o[i],m=0;m<t;m++){if(_===m)continue;const t=e[m];g=a[i],v=a[t];Math.abs(d.angleVec3(g,v)/d.DEGTORAD)<s&&(n[0]+=v[0],n[1]+=v[1],n[2]+=v[2],n[3]+=1)}}}for(_=0,f=t.length;_<f;_+=3)n=o[_/3],t[_+0]=n[0]/n[3],t[_+1]=n[1]/n[3],t[_+2]=n[2]/n[3]},canvasPosToWorldRay:(()=>{const e=new Float32Array(16),t=new Float32Array(16),i=new Float32Array(4),s=new Float32Array(4),r=new Float32Array(4),a=new Float32Array(4);return(o,n,l,h)=>{const u=o.scene.canvas.canvas,c=o.viewMatrix,p="ortho"===o.projection?o.ortho.matrix:o.perspective.matrix,_=d.mulMat4(p,c,e),m=d.inverseMat4(_,t),f=u.width,g=u.height,v=(n[0]-f/2)/(f/2),M=-(n[1]-g/2)/(g/2);i[0]=v,i[1]=M,i[2]=-1,i[3]=1,d.transformVec4(m,i,s),d.mulVec4Scalar(s,1/s[3]),r[0]=v,r[1]=M,r[2]=1,r[3]=1,d.transformVec4(m,r,a),d.mulVec4Scalar(a,1/a[3]),l[0]=a[0],l[1]=a[1],l[2]=a[2],d.subVec3(a,s,h),d.normalizeVec3(h)}})(),canvasPosToLocalRay:(()=>{const e=new Float32Array(3),t=new Float32Array(3);return(i,s,r,a,o)=>{d.canvasPosToWorldRay(i,r,e,t),d.worldRayToLocalRay(s,e,t,a,o)}})(),worldRayToLocalRay:(()=>{const e=new Float32Array(16),t=new Float32Array(4),i=new Float32Array(4);return(s,r,a,o,n)=>{const l=s.worldMatrix||s.matrix,h=d.inverseMat4(l,e);t[0]=r[0],t[1]=r[1],t[2]=r[2],t[3]=1,d.transformVec4(h,t,i),o[0]=i[0],o[1]=i[1],o[2]=i[2],d.transformVec3(h,a,n)}})(),buildKDTree:(()=>{const e=new Float32Array;return(t,i)=>{const s=t.length/3,r=new Array(s);for(let e=0;e<s;++e)r[e]=e;return function t(i,s,r,a){const o=new Float32Array(6),n={triangles:null,left:null,right:null,leaf:!1,splitDim:0,aabb:o};let l,h;for(o[0]=o[1]=o[2]=Number.POSITIVE_INFINITY,o[3]=o[4]=o[5]=Number.NEGATIVE_INFINITY,l=0,h=i.length;l<h;++l){var u=3*i[l];for(let e=0;e<3;++e){const t=3*s[u+e];r[t]<o[0]&&(o[0]=r[t]),r[t]>o[3]&&(o[3]=r[t]),r[t+1]<o[1]&&(o[1]=r[t+1]),r[t+1]>o[4]&&(o[4]=r[t+1]),r[t+2]<o[2]&&(o[2]=r[t+2]),r[t+2]>o[5]&&(o[5]=r[t+2])}}if(i.length<20||a>10)return n.triangles=i,n.leaf=!0,n;e[0]=o[3]-o[0],e[1]=o[4]-o[1],e[2]=o[5]-o[2];let c=0;e[1]>e[c]&&(c=1),e[2]>e[c]&&(c=2),n.splitDim=c;const d=(o[c]+o[c+3])/2,p=new Array(i.length);let _=0;const m=new Array(i.length);let f=0;for(l=0,h=i.length;l<h;++l){const e=s[u=3*i[l]],t=3*s[u+1],a=3*s[u+2];r[3*e+c]<=d||r[t+c]<=d||r[a+c]<=d?p[_++]=i[l]:m[f++]=i[l]}return p.length=_,m.length=f,n.left=t(p,s,r,a+1),n.right=t(m,s,r,a+1),n}(r,t,i,0)}})()};const p=new class{constructor(){this._head=[],this._headLength=0,this._tail=[],this._index=0,this._length=0}get length(){return this._length}shift(){if(this._index>=this._headLength){const e=this._head;if(e.length=0,this._head=this._tail,this._tail=e,this._index=0,this._headLength=this._head.length,!this._headLength)return}const e=this._head[this._index];return this._index<0?delete this._head[this._index++]:this._head[this._index++]=void 0,this._length--,e}push(e){return this._length++,this._tail.push(e),this}unshift(e){return this._head[--this._index]=e,this._length++,this}},_={scheduleTask(e,t){p.push(e),p.push(t)},runTasks(e){let t,i,s=(new Date).getTime(),r=0;for(;p.length>0&&s<e;)t=p.shift(),i=p.shift(),i?t.call(i):t(),s=(new Date).getTime(),r++;return r},getNumTasks:()=>p.length},m={},f="xeogl.Component";class g{get type(){return f}constructor(){var e={},t=arguments[0],i=arguments[1],s=null;this.scene=null,"xeogl.Scene"===this.type?(this.scene=this,t&&(e=t)):(t?"xeogl.Scene"===t.type?(this.scene=t,s=this.scene,i&&(e=i)):t instanceof g?(this.scene=t.scene,s=t,i&&(e=i)):(this.scene=ui.getDefaultScene(),s=this.scene,e=t):(this.scene=ui.getDefaultScene(),s=this.scene),this._renderer=this.scene._renderer),this._dontClear=!!e.dontClear,this._model=null,this._renderer=this.scene._renderer,this.meta=e.meta||{},this.id=e.id,this.destroyed=!1,this._attached={},this._attachments=null,this._subIdMap=null,this._subIdEvents=null,this._eventSubs=null,this._events=null,this._eventCallDepth=0,this._adoptees=null,this!==this.scene&&this.scene._addComponent(this),this._updateScheduled=!1,this.init(e),s&&s._adopt(this)}init(){}superTypes(){return[]}_addedToModel(e){this._model=e}_removedFromModel(e){this._model=null}get model(){return this._model}isType(e){return!(!a.isString(e)&&!(e=e.type))&&ui.isComponentType(this.type,e)}fire(e,t,i){this._events||(this._events={}),this._eventSubs||(this._eventSubs={}),!0!==i&&(this._events[e]=t||!0);const s=this._eventSubs[e];let r;if(s)for(const i in s)s.hasOwnProperty(i)&&(r=s[i],this._eventCallDepth++,this._eventCallDepth<300?r.callback.call(r.scope,t):this.error("fire: potential stack overflow from recursive event '"+e+"' - dropping this event"),this._eventCallDepth--)}on(e,t,i){this._events||(this._events={}),this._subIdMap||(this._subIdMap=new s),this._subIdEvents||(this._subIdEvents={}),this._eventSubs||(this._eventSubs={});let r=this._eventSubs[e];r||(r={},this._eventSubs[e]=r);const a=this._subIdMap.addItem();r[a]={callback:t,scope:i||this},this._subIdEvents[a]=e;const o=this._events[e];return void 0!==o&&t.call(i||this,o),a}off(e){if(null==e)return;if(!this._subIdEvents)return;const t=this._subIdEvents[e];if(t){delete this._subIdEvents[e];const i=this._eventSubs[t];i&&delete i[e],this._subIdMap.removeItem(e)}}once(e,t,i){const s=this,r=this.on(e,(function(e){s.off(r),t(e)}),i)}hasSubs(e){return this._eventSubs&&!!this._eventSubs[e]}log(e){e="[LOG]"+this._message(e),window.console.log(e),this.scene.fire("log",e)}_message(e){return" ["+this.type+" "+a.inQuotes(this.id)+"]: "+e}warn(e){e="[WARN]"+this._message(e),window.console.warn(e),this.scene.fire("warn",e)}error(e){e="[ERROR]"+this._message(e),window.console.error(e),this.scene.fire("error",e)}_attach(e){const t=e.name;if(!t)return void this.error("Component 'name' expected");let i=e.component;const s=e.sceneDefault,r=e.sceneSingleton,o=e.type,n=e.on,l=!1!==e.recompiles;let h=!1;if(i)if(a.isNumeric(i)||a.isString(i)){const e=i;if(i=this.scene.components[e],!i)return void this.error("Component not found: "+a.inQuotes(e))}else if(a.isObject(i)){const e=i,t=e.type||o||"xeogl.Component",s=m[t];if(!s)return void this.error("Component type not found: "+t);if(o&&!ui.isComponentType(t,o))return void this.error("Expected a "+o+" type or subtype, not a "+t);i=new s(this.scene,e),h=!0}if(!i)if(!0===r){const e=this.scene.types[o];for(const t in e)if(e.hasOwnProperty){i=e[t];break}if(!i)return this.error("Scene has no default component for '"+t+"'"),null}else if(!0===s&&(i=this.scene[t],!i))return this.error("Scene has no default component for '"+t+"'"),null;if(i){if(i.scene.id!==this.scene.id)return void this.error("Not in same scene: "+i.type+" "+a.inQuotes(i.id));if(o&&!i.isType(o))return void this.error("Expected a "+o+" type or subtype: "+i.type+" "+a.inQuotes(i.id))}this._attachments||(this._attachments={});const u=this._attached[t];let c,d,p;if(u){if(i&&u.id===i.id)return;const e=this._attachments[u.id];for(c=e.subs,d=0,p=c.length;d<p;d++)u.off(c[d]);delete this._attached[t],delete this._attachments[u.id];const s=e.params.onDetached;s&&(a.isFunction(s)?s(u):s.scope?s.callback.call(s.scope,u):s.callback(u)),e.managingLifecycle&&u.destroy()}if(i){const s={params:e,component:i,subs:[],managingLifecycle:h};s.subs.push(i.on("destroyed",(function(){s.params.component=null,this._attach(s.params)}),this)),l&&s.subs.push(i.on("dirty",(function(){this.fire("dirty",this)}),this)),this._attached[t]=i,this._attachments[i.id]=s;const r=e.onAttached;if(r&&(a.isFunction(r)?r(i):r.scope?r.callback.call(r.scope,i):r.callback(i)),n){let e,t,r,o;for(e in n)if(n.hasOwnProperty(e)){if(t=n[e],a.isFunction(t)?(r=t,o=null):(r=t.callback,o=t.scope),!r)continue;s.subs.push(i.on(e,r,o))}}}return l&&this.fire("dirty",this),this.fire(t,i),i}_checkComponent(e,t){if(a.isObject(t)){if(t.type){if(!ui.isComponentType(t.type,e))return void this.error("Expected a "+e+" type or subtype: "+t.type+" "+a.inQuotes(t.id))}else t.type=e;t=new m[t.type](this.scene,t)}else if(a.isID(t)){const e=t;if(!(t=this.scene.components[e]))return void this.error("Component not found: "+a.inQuotes(t.id))}if(t.scene.id===this.scene.id){if(t.isType(e))return t;this.error("Expected a "+e+" type or subtype: "+t.type+" "+a.inQuotes(t.id))}else this.error("Not in same scene: "+t.type+" "+a.inQuotes(t.id))}create(e){let t,i;if(a.isObject(e)?(t=e.type||"xeogl.Component",i=m[t]):a.isString(e)?(t=e,i=m[t]):(i=e,t=e.prototype.type),!i)return void this.error("Component type not found: "+t);if(!ui.isComponentType(t,"xeogl.Component"))return void this.error("Expected a xeogl.Component type or subtype");e&&e.id&&this.components[e.id]&&(this.error("Component "+a.inQuotes(e.id)+" already exists in Scene - ignoring ID, will randomly-generate instead"),e.id=void 0);const s=new i(this,e);return s&&this._adopt(s),s}_adopt(e){this._adoptees||(this._adoptees={}),this._adoptees[e.id]||(this._adoptees[e.id]=e),e.on("destroyed",(function(){delete this._adoptees[e.id]}),this)}_needUpdate(e){this._updateScheduled||(this._updateScheduled=!0,0===e?this._doUpdate():_.scheduleTask(this._doUpdate,this))}_doUpdate(){this._updateScheduled&&(this._updateScheduled=!1,this._update&&this._update())}_update(){}destroy(){if(this.destroyed)return;let e,t,i,s,r,a;if(this._attachments)for(e in this._attachments)if(this._attachments.hasOwnProperty(e)){for(t=this._attachments[e],i=t.component,s=t.subs,r=0,a=s.length;r<a;r++)i.off(s[r]);t.managingLifecycle&&i.destroy()}if(this._adoptees)for(e in this._adoptees)this._adoptees.hasOwnProperty(e)&&(i=this._adoptees[e],i.destroy(),delete this._adoptees[e]);this.scene._removeComponent(this),this._attached={},this._attachments=null,this._subIdMap=null,this._subIdEvents=null,this._eventSubs=null,this._events=null,this._eventCallDepth=0,this._adoptees=null,this._updateScheduled=!1,this.fire("destroyed",this.destroyed=!0)}}m[f]=g;const M=function(){const e=document.createElement("canvas"),t=String.fromCharCode;if(!e.getContext)return{saveAsBMP:function(){},saveAsPNG:function(){},saveAsJPEG:function(){}};const i=!!e.getContext("2d").getImageData,s=!!e.toDataURL,r=!!window.btoa,a=function(e){let i="";const s=e.width,r=e.height;i+="BM";let a=s*r*4+54;i+=t(a%256),a=Math.floor(a/256),i+=t(a%256),a=Math.floor(a/256),i+=t(a%256),a=Math.floor(a/256),i+=t(a%256),i+=t(0,0,0,0,54,0,0,0),i+=t(40,0,0,0);let o=s;i+=t(o%256),o=Math.floor(o/256),i+=t(o%256),o=Math.floor(o/256),i+=t(o%256),o=Math.floor(o/256),i+=t(o%256);let n=r;i+=t(n%256),n=Math.floor(n/256),i+=t(n%256),n=Math.floor(n/256),i+=t(n%256),n=Math.floor(n/256),i+=t(n%256),i+=t(1,0,32,0),i+=t(0,0,0,0);let l=s*r*4;i+=t(l%256),l=Math.floor(l/256),i+=t(l%256),l=Math.floor(l/256),i+=t(l%256),l=Math.floor(l/256),i+=t(l%256),i+=t(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const h=e.data;let u,c,d,p,_="",m=r;do{for(d=s*(m-1)*4,p="",u=0;u<s;u++)c=4*u,p+=t(h[d+c+2],h[d+c+1],h[d+c],h[d+c+3]);_+=p}while(--m);return function(e){let i,s,r="";if("string"==typeof e)r=e;else for(s=e,i=0;i<s.length;i++)r+=t(s[i]);return btoa(r)}(i+_)},o=function(e){window.open(e)||(document.location.href=e)},n=function(e,t){return"data:"+t+";base64,"+e},l=function(e){const t=document.createElement("img");return t.src=e,t},h=function(e,t,i){if(t&&i){const s=document.createElement("canvas");s.width=t,s.height=i,s.style.width=t+"px",s.style.height=i+"px";return s.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,t,t),s}return e};return{saveAsPNG:function(e,t,i,r){if(!s)return!1;const a=h(e,i,r).toDataURL("image/png");return t?l(a):(o(a),!0)},saveAsJPEG:function(e,t,i,r){if(!s)return!1;const a=h(e,i,r).toDataURL("image/jpeg");return 5==a.indexOf("image/jpeg")&&(t?l(a):(o(a),!0))},saveAsBMP:function(e,t,u,c){if(!(s&&i&&r))return!1;const d=function(e){const t=parseInt(e.width),i=parseInt(e.height);return e.getContext("2d").getImageData(0,0,t,i)}(h(e,u,c)),p=a(d);return t?l(n(p,"image/bmp")):(o(n(p,"image/bmp")),!0)}}}();let y=!1;class x extends g{get type(){return"xeogl.Spinner"}init(e){super.init(e),this._canvas=e.canvas,this._injectSpinnerCSS();const t=document.createElement("div"),i=t.style;i["z-index"]="9000",i.position="absolute",t.innerHTML='<div class="sk-fading-circle">                <div class="sk-circle1 sk-circle"></div>                <div class="sk-circle2 sk-circle"></div>                <div class="sk-circle3 sk-circle"></div>                <div class="sk-circle4 sk-circle"></div>                <div class="sk-circle5 sk-circle"></div>                <div class="sk-circle6 sk-circle"></div>                <div class="sk-circle7 sk-circle"></div>                <div class="sk-circle8 sk-circle"></div>                <div class="sk-circle9 sk-circle"></div>                <div class="sk-circle10 sk-circle"></div>                <div class="sk-circle11 sk-circle"></div>                <div class="sk-circle12 sk-circle"></div>                </div>',this._canvas.parentElement.appendChild(t),this._element=t,this._adjustPosition(),this.processes=0}set processes(e){if(e=e||0,this._processes===e)return;if(e<0)return;const t=this._processes;this._processes=e,this._element.style.visibility=this._processes>0?"visible":"hidden",this.fire("processes",this._processes),0===this._processes&&this._processes!==t&&this.fire("zeroProcesses",this._processes)}get processes(){return this._processes}_adjustPosition(){if(!this._canvas||!this._element)return;const e=this._canvas,t=this._element,i=t.style;i.left=e.offsetLeft+.5*e.clientWidth-.5*t.clientWidth+"px",i.top=e.offsetTop+.5*e.clientHeight-.5*t.clientHeight+"px"}_injectSpinnerCSS(){if(y)return;const e=document.createElement("style");e.innerHTML=".sk-fading-circle {        background: transparent;        margin: 20px auto;        width: 50px;        height:50px;        position: relative;        }        .sk-fading-circle .sk-circle {        width: 120%;        height: 120%;        position: absolute;        left: 0;        top: 0;        }        .sk-fading-circle .sk-circle:before {        content: '';        display: block;        margin: 0 auto;        width: 15%;        height: 15%;        background-color: #ff8800;        border-radius: 100%;        -webkit-animation: sk-circleFadeDelay 1.2s infinite ease-in-out both;        animation: sk-circleFadeDelay 1.2s infinite ease-in-out both;        }        .sk-fading-circle .sk-circle2 {        -webkit-transform: rotate(30deg);        -ms-transform: rotate(30deg);        transform: rotate(30deg);    }    .sk-fading-circle .sk-circle3 {        -webkit-transform: rotate(60deg);        -ms-transform: rotate(60deg);        transform: rotate(60deg);    }    .sk-fading-circle .sk-circle4 {        -webkit-transform: rotate(90deg);        -ms-transform: rotate(90deg);        transform: rotate(90deg);    }    .sk-fading-circle .sk-circle5 {        -webkit-transform: rotate(120deg);        -ms-transform: rotate(120deg);        transform: rotate(120deg);    }    .sk-fading-circle .sk-circle6 {        -webkit-transform: rotate(150deg);        -ms-transform: rotate(150deg);        transform: rotate(150deg);    }    .sk-fading-circle .sk-circle7 {        -webkit-transform: rotate(180deg);        -ms-transform: rotate(180deg);        transform: rotate(180deg);    }    .sk-fading-circle .sk-circle8 {        -webkit-transform: rotate(210deg);        -ms-transform: rotate(210deg);        transform: rotate(210deg);    }    .sk-fading-circle .sk-circle9 {        -webkit-transform: rotate(240deg);        -ms-transform: rotate(240deg);        transform: rotate(240deg);    }    .sk-fading-circle .sk-circle10 {        -webkit-transform: rotate(270deg);        -ms-transform: rotate(270deg);        transform: rotate(270deg);    }    .sk-fading-circle .sk-circle11 {        -webkit-transform: rotate(300deg);        -ms-transform: rotate(300deg);        transform: rotate(300deg);    }    .sk-fading-circle .sk-circle12 {        -webkit-transform: rotate(330deg);        -ms-transform: rotate(330deg);        transform: rotate(330deg);    }    .sk-fading-circle .sk-circle2:before {        -webkit-animation-delay: -1.1s;        animation-delay: -1.1s;    }    .sk-fading-circle .sk-circle3:before {        -webkit-animation-delay: -1s;        animation-delay: -1s;    }    .sk-fading-circle .sk-circle4:before {        -webkit-animation-delay: -0.9s;        animation-delay: -0.9s;    }    .sk-fading-circle .sk-circle5:before {        -webkit-animation-delay: -0.8s;        animation-delay: -0.8s;    }    .sk-fading-circle .sk-circle6:before {        -webkit-animation-delay: -0.7s;        animation-delay: -0.7s;    }    .sk-fading-circle .sk-circle7:before {        -webkit-animation-delay: -0.6s;        animation-delay: -0.6s;    }    .sk-fading-circle .sk-circle8:before {        -webkit-animation-delay: -0.5s;        animation-delay: -0.5s;    }    .sk-fading-circle .sk-circle9:before {        -webkit-animation-delay: -0.4s;        animation-delay: -0.4s;    }    .sk-fading-circle .sk-circle10:before {        -webkit-animation-delay: -0.3s;        animation-delay: -0.3s;    }    .sk-fading-circle .sk-circle11:before {        -webkit-animation-delay: -0.2s;        animation-delay: -0.2s;    }    .sk-fading-circle .sk-circle12:before {        -webkit-animation-delay: -0.1s;        animation-delay: -0.1s;    }    @-webkit-keyframes sk-circleFadeDelay {        0%, 39%, 100% { opacity: 0; }        40% { opacity: 1; }    }    @keyframes sk-circleFadeDelay {        0%, 39%, 100% { opacity: 0; }        40% { opacity: 1; }    }",document.body.appendChild(e),y=!0}}const b={WEBGL:!1,SUPPORTED_EXTENSIONS:{}},w=document.createElement("canvas");if(w){const e=w.getContext("webgl",{antialias:!0})||w.getContext("experimental-webgl",{antialias:!0});b.WEBGL=!!e,b.WEBGL&&(b.ANTIALIAS=e.getContextAttributes().antialias,e.getShaderPrecisionFormat?e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT).precision>0?b.FS_MAX_FLOAT_PRECISION="highp":e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT).precision>0?b.FS_MAX_FLOAT_PRECISION="mediump":b.FS_MAX_FLOAT_PRECISION="lowp":b.FS_MAX_FLOAT_PRECISION="mediump",b.DEPTH_BUFFER_BITS=e.getParameter(e.DEPTH_BITS),b.MAX_TEXTURE_SIZE=e.getParameter(e.MAX_TEXTURE_SIZE),b.MAX_CUBE_MAP_SIZE=e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),b.MAX_RENDERBUFFER_SIZE=e.getParameter(e.MAX_RENDERBUFFER_SIZE),b.MAX_TEXTURE_UNITS=e.getParameter(e.MAX_COMBINED_TEXTURE_IMAGE_UNITS),b.MAX_TEXTURE_IMAGE_UNITS=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),b.MAX_VERTEX_ATTRIBS=e.getParameter(e.MAX_VERTEX_ATTRIBS),b.MAX_VERTEX_UNIFORM_VECTORS=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),b.MAX_FRAGMENT_UNIFORM_VECTORS=e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),b.MAX_VARYING_VECTORS=e.getParameter(e.MAX_VARYING_VECTORS),e.getSupportedExtensions().forEach((function(e){b.SUPPORTED_EXTENSIONS[e]=!0})))}const A=["webgl","experimental-webgl","webkit-3d","moz-webgl","moz-glweb20"];class E extends g{get type(){return"xeogl.Canvas"}init(e){if(super.init(e),this.canvas=null,this.gl=null,this.webgl2=!1,this.transparent=!!e.transparent,this.contextAttr=e.contextAttr||{},this.contextAttr.alpha=this.transparent,void 0!==this.contextAttr.preserveDrawingBuffer&&null!==this.contextAttr.preserveDrawingBuffer||(this.contextAttr.preserveDrawingBuffer=!0),this.contextAttr.stencil=!1,this.contextAttr.antialias=!0,this.contextAttr.premultipliedAlpha=!1!==this.contextAttr.premultipliedAlpha,this.contextAttr.antialias=!1!==this.contextAttr.antialias,e.canvas?a.isString(e.canvas)?(this.canvas=document.getElementById(e.canvas),this.canvas||(this.error("Canvas element not found: "+a.inQuotes(e.canvas)+" - creating default canvas instead."),this._createCanvas())):this.canvas=e.canvas:this._createCanvas(),!this.canvas)return void this.error("Faied to create canvas");this.canvas.width=this.canvas.clientWidth,this.canvas.height=this.canvas.clientHeight,this.boundary=[this.canvas.offsetLeft,this.canvas.offsetTop,this.canvas.clientWidth,this.canvas.clientHeight],this._createBackground(),e.simulateWebGLContextLost&&(window.WebGLDebugUtils?this.canvas=WebGLDebugUtils.makeLostContextSimulatingCanvas(this.canvas):this.error("To simulate context loss, please include WebGLDebugUtils")),this._initWebGL(e);const t=this;this.canvas.addEventListener("webglcontextlost",this._webglcontextlostListener=function(e){console.time("webglcontextrestored"),t.scene._webglContextLost(),t.fire("webglcontextlost"),e.preventDefault()},!1),this.canvas.addEventListener("webglcontextrestored",this._webglcontextrestoredListener=function(e){t._initWebGL(),t.gl&&(t.scene._webglContextRestored(t.gl),t.fire("webglcontextrestored",t.gl),e.preventDefault()),console.timeEnd("webglcontextrestored")},!1);let i=null,s=null,o=null,n=null,l=null,h=null,u=null;this._tick=this.scene.on("tick",(function(){const e=t.canvas,a=window.innerWidth!==i||window.innerHeight!==s,c=e.clientWidth!==o||e.clientHeight!==n,d=e.offsetLeft!==l||e.offsetTop!==h,p=e.parentElement;if(a||c||d||p!==u){if(t._spinner._adjustPosition(),c||d){const i=e.clientWidth,s=e.clientHeight;if(c){let t,i=0;for(const e in ui.scenes)ui.scenes.hasOwnProperty(e)&&(t=ui.scenes[e],i+=t.canvas.canvas.clientWidth*t.canvas.canvas.clientHeight);r.memory.pixels=i,e.width=e.clientWidth,e.height=e.clientHeight}const a=t.boundary;a[0]=e.offsetLeft,a[1]=e.offsetTop,a[2]=i,a[3]=s,t.fire("boundary",a),o=i,n=s}a&&(i=window.innerWidth,s=window.innerHeight),d&&(l=e.offsetLeft,h=e.offsetTop),u=p}})),this.canvas.oncontextmenu=function(e){e.preventDefault()},this._spinner=new x(this.scene,{canvas:this.canvas}),this.backgroundColor=e.backgroundColor,this.backgroundImage=e.backgroundImage}_createCanvas(){const e="xeogl-canvas-"+d.createUUID(),t=document.getElementsByTagName("body")[0],i=document.createElement("div"),s=i.style;s.height="100%",s.width="100%",s.padding="0",s.margin="0",s.background="rgba(0,0,0,0);",s.float="left",s.left="0",s.top="0",s.position="absolute",s.opacity="1.0",s["z-index"]="-10000",i.innerHTML+='<canvas id="'+e+'" style="width: 100%; height: 100%; float: left; margin: 0; padding: 0;"></canvas>',t.appendChild(i),this.canvas=document.getElementById(e)}_createBackground(){const e=document.createElement("div"),t=e.style;t.padding="0",t.margin="0",t.background=null,t.backgroundImage=null,t.float="left",t.left="0",t.top="0",t.width="100%",t.height="100%",t.position="absolute",t.opacity=1,t["z-index"]="-20000",this.canvas.parentElement.appendChild(e),this._backgroundElement=e}_getElementXY(e){let t=0,i=0;for(;e;)t+=e.offsetLeft-e.scrollLeft,i+=e.offsetTop-e.scrollTop,e=e.offsetParent;return{x:t,y:i}}_initWebGL(e){if(!this.gl)for(let e=0;!this.gl&&e<A.length;e++)try{this.gl=this.canvas.getContext(A[e],this.contextAttr)}catch(e){}if(this.gl||(this.error("Failed to get a WebGL context"),this.fire("webglContextFailed",!0,!0)),this.gl)if(this.webgl2)this.gl.hint(this.gl.FRAGMENT_SHADER_DERIVATIVE_HINT,this.gl.FASTEST);else if(b.SUPPORTED_EXTENSIONS.OES_standard_derivatives){const e=this.gl.getExtension("OES_standard_derivatives");this.gl.hint(e.FRAGMENT_SHADER_DERIVATIVE_HINT_OES,this.gl.FASTEST)}}getSnapshot(e,t){if(!this.canvas)return this.error("Can't get snapshot - no canvas."),void t(null);if(!t)return this._getSnapshot(e);{const i=this;requestAnimationFrame((function(){i.scene.render(!0),t(i._getSnapshot(e))}))}}_getSnapshot(e){const t=(e=e||{}).width||this.canvas.width,i=e.height||this.canvas.height,s=e.format||"jpeg";let r;switch(s){case"jpeg":r=M.saveAsJPEG(this.canvas,!1,t,i);break;case"png":r=M.saveAsPNG(this.canvas,!0,t,i);break;case"bmp":r=M.saveAsBMP(this.canvas,!0,t,i);break;default:this.error("Unsupported snapshot format: '"+s+"' - supported types are 'jpeg', 'bmp' and 'png' - defaulting to 'jpeg'"),r=M.saveAsJPEG(this.canvas,!0,t,i)}return r.src}readPixels(e,t,i,s){return this.scene._renderer.readPixels(e,t,i,s)}loseWebGLContext(){this.canvas.loseContext&&this.canvas.loseContext()}set backgroundColor(e){if(e){if((this._backgroundColor=this._backgroundColor||d.vec4()).set(e||[0,0,0,1]),!this._backgroundImageSrc){const e="rgb("+Math.round(255*this._backgroundColor[0])+", "+Math.round(255*this._backgroundColor[1])+","+Math.round(255*this._backgroundColor[2])+")";this._backgroundElement.style.background=e}}else this._backgroundColor=null}get backgroundColor(){return this._backgroundColor}set backgroundImage(e){if(e)if(a.isString(e)){if(e!==this._backgroundImageSrc&&(this._backgroundElement.style.backgroundImage="url('"+e+"')",this._backgroundImageSrc=e,!this._backgroundImageSrc)){const e="rgb("+Math.round(255*this._backgroundColor[0])+", "+Math.round(255*this._backgroundColor[1])+","+Math.round(255*this._backgroundColor[2])+")";this._backgroundElement.style.background=e}}else this.error("Value for 'backgroundImage' should be a string")}get backgroundImage(){return this._backgroundImageSrc}get spinner(){return this._spinner}destroy(){this.scene.off(this._tick),this.canvas.removeEventListener("webglcontextlost",this._webglcontextlostListener),this.canvas.removeEventListener("webglcontextrestored",this._webglcontextrestoredListener),this.canvas=null,this.gl=null,super.destroy()}}m["xeogl.Canvas"]=E;class C{constructor(){this.reset()}reset(){this.lastProgramId=null,this.backfaces=!1,this.frontface=!0,this.textureUnit=0,this.drawElements=0,this.drawArrays=0,this.useProgram=0,this.bindTexture=0,this.bindArray=0,this.pass=0,this.shadowViewMatrix=null,this.shadowProjMatrix=null,this.pickViewMatrix=null,this.pickProjMatrix=null,this.pickmeshIndex=1}}class P{constructor(e,t,i){i=i||{},this.gl=t,this.allocated=!1,this.canvas=e,this.buffer=null,this.bound=!1,this.size=i.size}setSize(e){this.size=e}webglContextRestored(e){this.gl=e,this.buffer=null,this.allocated=!1,this.bound=!1}bind(){if(this._touch(),this.bound)return;const e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,this.buffer.framebuf),this.bound=!0}_touch(){let e,t;const i=this.gl;if(this.size?(e=this.size[0],t=this.size[1]):(e=this.canvas.clientWidth,t=this.canvas.clientHeight),this.buffer){if(this.buffer.width===e&&this.buffer.height===t)return;i.deleteTexture(this.buffer.texture),i.deleteFramebuffer(this.buffer.framebuf),i.deleteRenderbuffer(this.buffer.renderbuf)}const s=i.createTexture();i.bindTexture(i.TEXTURE_2D,s),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,e,t,0,i.RGBA,i.UNSIGNED_BYTE,null),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE);const r=i.createRenderbuffer();i.bindRenderbuffer(i.RENDERBUFFER,r),i.renderbufferStorage(i.RENDERBUFFER,i.DEPTH_COMPONENT16,e,t);const a=i.createFramebuffer();if(i.bindFramebuffer(i.FRAMEBUFFER,a),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,s,0),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,r),i.bindTexture(i.TEXTURE_2D,null),i.bindRenderbuffer(i.RENDERBUFFER,null),i.bindFramebuffer(i.FRAMEBUFFER,null),i.bindFramebuffer(i.FRAMEBUFFER,a),!i.isFramebuffer(a))throw"Invalid framebuffer";i.bindFramebuffer(i.FRAMEBUFFER,null);const o=i.checkFramebufferStatus(i.FRAMEBUFFER);switch(o){case i.FRAMEBUFFER_COMPLETE:break;case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT";case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT";case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS";case i.FRAMEBUFFER_UNSUPPORTED:throw"Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED";default:throw"Incomplete framebuffer: "+o}this.buffer={framebuf:a,renderbuf:r,texture:s,width:e,height:t},this.bound=!1}clear(){if(!this.bound)throw"Render buffer not bound";const e=this.gl;e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT)}read(e,t){const i=e,s=this.canvas.height-t,r=new Uint8Array(4),a=this.gl;return a.readPixels(i,s,1,1,a.RGBA,a.UNSIGNED_BYTE,r),r}unbind(){const e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,null),this.bound=!1}getTexture(){const e=this;return{renderBuffer:this,bind:function(t){return!(!e.buffer||!e.buffer.texture)&&(e.gl.activeTexture(e.gl["TEXTURE"+t]),e.gl.bindTexture(e.gl.TEXTURE_2D,e.buffer.texture),!0)},unbind:function(t){e.buffer&&e.buffer.texture&&(e.gl.activeTexture(e.gl["TEXTURE"+t]),e.gl.bindTexture(e.gl.TEXTURE_2D,null))}}}destroy(){if(this.allocated){const e=this.gl;e.deleteTexture(this.buffer.texture),e.deleteFramebuffer(this.buffer.framebuf),e.deleteRenderbuffer(this.buffer.renderbuf),this.allocated=!1,this.buffer=null,this.bound=!1}}}const T=new s({});class D{constructor(e){this.id=T.addItem({});for(const t in e)e.hasOwnProperty(t)&&(this[t]=e[t])}destroy(){T.removeItem(this.id)}}class S{constructor(e,t,i,s,r,a){switch(this._gl=e,this.type=t,this.allocated=!1,i.constructor){case Uint8Array:this.itemType=e.UNSIGNED_BYTE,this.itemByteSize=1;break;case Int8Array:this.itemType=e.BYTE,this.itemByteSize=1;break;case Uint16Array:this.itemType=e.UNSIGNED_SHORT,this.itemByteSize=2;break;case Int16Array:this.itemType=e.SHORT,this.itemByteSize=2;break;case Uint32Array:this.itemType=e.UNSIGNED_INT,this.itemByteSize=4;break;case Int32Array:this.itemType=e.INT,this.itemByteSize=4;break;default:this.itemType=e.FLOAT,this.itemByteSize=4}this.usage=a,this.length=0,this.numItems=0,this.itemSize=r,this._allocate(i)}_allocate(e){if(this.allocated=!1,this._handle=this._gl.createBuffer(),!this._handle)throw"Failed to allocate WebGL ArrayBuffer";this._handle&&(this._gl.bindBuffer(this.type,this._handle),this._gl.bufferData(this.type,e,this.usage),this._gl.bindBuffer(this.type,null),this.length=e.length,this.numItems=this.length/this.itemSize,this.allocated=!0)}setData(e,t){this.allocated&&(e.length>this.length?(this.destroy(),this._allocate(e,e.length)):(this._gl.bindBuffer(this.type,this._handle),t||0===t?this._gl.bufferSubData(this.type,t*this.itemByteSize,e):this._gl.bufferData(this.type,e,this.usage),this._gl.bindBuffer(this.type,null)))}bind(){this.allocated&&this._gl.bindBuffer(this.type,this._handle)}unbind(){this.allocated&&this._gl.bindBuffer(this.type,null)}destroy(){this.allocated&&(this._gl.deleteBuffer(this._handle),this._handle=null,this.allocated=!1)}}const F=B?Number.MAX_SAFE_INTEGER/6:256e3,L=r.memory;var B=b.SUPPORTED_EXTENSIONS.OES_element_index_uint;const R=new D({});class k{constructor(e,t,i,s,r,a){this.scene=e,this.gl=e.canvas.gl,this.contextLost=!1,this.geometries={},this.geometryIndicesOffsets={},this.newGeometries=[],this.geometryVertexBufs={},this.needRebuild=!1,this.needAppend=!1,this.positions=t?[]:null,this.normals=i?[]:null,this.colors=s?[]:null,this.uv=r?[]:null,this.quantized=a,this.vertexBufs=null}addGeometry(e){e.positions&&e.indices?(this.geometries[e.id]=e,this.geometryIndicesOffsets[e.id]=0,this.newGeometries.push(e),this.needAppend=!0):this.scene.warn("Ignoring geometry with no positions or indices: "+e.id)}getIndicesOffset(e){return(this.needRebuild||this.needAppend)&&this.build(),this.geometryIndicesOffsets[e.id]}getVertexBufs(e){return this.geometries[e.id]?((this.needRebuild||this.needAppend)&&this.build(),this.geometryVertexBufs[e.id]):R}setPositions(e){const t=this.geometryVertexBufs[e.id];if(!t)return;if(!e.positions)return;const i=t.positionsBuf;i&&i.setData(e.positions,3*this.geometryIndicesOffsets[e.id])}setNormals(e){const t=this.geometryVertexBufs[e.id];if(!t)return;if(!e.normals)return;const i=t.normalsBuf;i&&i.setData(e.normals,3*this.geometryIndicesOffsets[e.id])}setUVs(e){const t=this.geometryVertexBufs[e.id];if(!t)return;if(!e.uv)return;const i=t.uvBuf;i&&i.setData(e.uv,2*this.geometryIndicesOffsets[e.id])}setColors(e){const t=this.geometryVertexBufs[e.id];if(!t)return;if(!e.color)return;const i=t.colorsBuf;i&&i.setData(e.colors,4*this.geometryIndicesOffsets[e.id])}removeGeometry(e){const t=e.id;this.geometries[t]&&(delete this.geometries[t],delete this.geometryIndicesOffsets[t],e.indicesBufCombined&&e.indicesBufCombined.destroy(),this.needRebuild=!0)}webglContextLost(){this.contextLost=!0}webglContextRestored(){if(this.contextLost){for(const e in this.geometries)this.geometries.hasOwnProperty(e)&&(this.geometries[e].indicesBufCombined=null);this.build(),this.contextLost=!1}}build(){const e=this.scene.canvas.gl;let t,i;this.geometryVertexBufs={};let s=0;this.vertexBufs=null;let r=0,a=0,o=0,n=0;for(t in this.geometries)this.geometries.hasOwnProperty(t)&&(i=this.geometries[t],this.positions&&(r+=i.positions.length),this.normals&&(a+=i.normals.length),this.uv&&(o+=i.uv.length),this.colors&&(n+=i.uv.length));for(t in this.geometries)if(this.geometries.hasOwnProperty(t)){i=this.geometries[t];if((!this.vertexBufs||this.positions.length+i.positions.length>F)&&(this.vertexBufs&&this.createBufs(this.vertexBufs),this.vertexBufs=new D({positionsBuf:null,normalsBuf:null,uvBuf:null,colorsBuf:null,quantized:this.quantized}),s=0),this.geometryVertexBufs[t]=this.vertexBufs,this.positions)for(var l=0,h=i.positions.length;l<h;l++)this.positions.push(i.positions[l]);if(this.normals)for(l=0,h=i.normals.length;l<h;l++)this.normals.push(i.normals[l]);if(this.colors)for(l=0,h=i.colors.length;l<h;l++)this.colors.push(i.colors[l]);if(this.uv)for(l=0,h=i.uv.length;l<h;l++)this.uv.push(i.uv[l]);let r;if(this.geometryIndicesOffsets[t]=s,s){r=new(B?Uint32Array:Uint16Array)(i.indices);for(l=0,h=r.length;l<h;l++)r[l]+=s,r[l]>F/3&&console.error("out of range: "+r[l])}else r=i.indices;i.indicesBufCombined?i.indicesBufCombined.setData(r):i.indicesBufCombined=new S(e,e.ELEMENT_ARRAY_BUFFER,r,r.length,1,e.STATIC_DRAW),s+=i.positions.length/3}this.vertexBufs&&this.createBufs(this.vertexBufs),this.needRebuild=!1,this.needAppend=!1}createBufs(e){const t=this.scene.canvas.gl;let i;this.positions&&(i=this.quantized?new Uint16Array(this.positions):new Float32Array(this.positions),e.positionsBuf=new S(t,t.ARRAY_BUFFER,i,i.length,3,t.STATIC_DRAW),L.positions+=e.positionsBuf.numItems,this.positions=[]),this.normals&&(i=this.quantized?new Int8Array(this.normals):new Float32Array(this.normals),e.normalsBuf=new S(t,t.ARRAY_BUFFER,i,i.length,3,t.STATIC_DRAW),L.normals+=e.normalsBuf.numItems,this.normals=[]),this.colors&&(i=new Float32Array(this.colors),e.colorsBuf=new S(t,t.ARRAY_BUFFER,i,i.length,4,t.STATIC_DRAW),L.colors+=e.colorsBuf.numItems,this.colors=[]),this.uv&&(i=this.quantized?new Uint16Array(this.uv):new Float32Array(this.uv),e.uvBuf=new S(t,t.ARRAY_BUFFER,i,i.length,2,t.STATIC_DRAW),L.uvs+=e.uvBuf.numItems,this.uv=[])}}const I=r.memory;var V=b.SUPPORTED_EXTENSIONS.OES_element_index_uint;const N=V?Uint32Array:Uint16Array,U=new D({}),O=d.AABB3();class z extends g{get type(){return"xeogl.Geometry"}init(e){super.init(e);this._state=new D({combined:!!e.combined,quantized:!!e.quantized,autoVertexNormals:!!e.autoVertexNormals,primitive:null,primitiveName:null,positions:null,normals:null,colors:null,uv:null,indices:null,positionsDecodeMatrix:null,uvDecodeMatrix:null,positionsBuf:null,normalsBuf:null,colorsbuf:null,uvBuf:null,indicesBuf:null,indicesBufCombined:null,hash:""}),this._edgeThreshold=e.edgeThreshold||2,this._edgesIndicesBuf=null,this._pickTrianglePositionsBuf=null,this._pickTriangleColorsBuf=null,this._boundaryDirty=!0,this._aabb=null,this._aabbDirty=!0,this._obb=null,this._obbDirty=!0;const t=this._state,i=this.scene.canvas.gl;switch(e.primitive=e.primitive||"triangles",e.primitive){case"points":t.primitive=i.POINTS,t.primitiveName=e.primitive;break;case"lines":t.primitive=i.LINES,t.primitiveName=e.primitive;break;case"line-loop":t.primitive=i.LINE_LOOP,t.primitiveName=e.primitive;break;case"line-strip":t.primitive=i.LINE_STRIP,t.primitiveName=e.primitive;break;case"triangles":t.primitive=i.TRIANGLES,t.primitiveName=e.primitive;break;case"triangle-strip":t.primitive=i.TRIANGLE_STRIP,t.primitiveName=e.primitive;break;case"triangle-fan":t.primitive=i.TRIANGLE_FAN,t.primitiveName=e.primitive;break;default:this.error("Unsupported value for 'primitive': '"+e.primitive+"' - supported values are 'points', 'lines', 'line-loop', 'line-strip', 'triangles', 'triangle-strip' and 'triangle-fan'. Defaulting to 'triangles'."),t.primitive=i.TRIANGLES,t.primitiveName=e.primitive}if(e.positions)if(this._state.quantized){var s=G(e.positions,3),r=j(e.positions,s.min,s.max);t.positions=r.quantized,t.positionsDecodeMatrix=r.decode}else t.positions=e.positions.constructor===Float32Array?e.positions:new Float32Array(e.positions);if(e.colors&&(t.colors=e.colors.constructor===Float32Array?e.colors:new Float32Array(e.colors)),e.uv)if(this._state.quantized){s=G(e.uv,2),r=Y(e.uv,s.min,s.max);t.uv=r.quantized,t.uvDecodeMatrix=r.decode}else t.uv=e.uv.constructor===Float32Array?e.uv:new Float32Array(e.uv);if(e.normals&&(this._state.quantized?t.normals=function(e){const t=new Int8Array(2*e.length/3);let i,s,r,a,o,n,l;for(n=0,l=0;n<e.length;n+=3,l+=2)r=i=W(e,n,"floor","floor"),s=K(i),a=o=X(e,n,s),i=W(e,n,"ceil","floor"),s=K(i),a=X(e,n,s),a>o&&(r=i,o=a),i=W(e,n,"floor","ceil"),s=K(i),a=X(e,n,s),a>o&&(r=i,o=a),i=W(e,n,"ceil","ceil"),s=K(i),a=X(e,n,s),a>o&&(r=i,o=a),t[l]=r[0],t[l+1]=r[1];return t}(e.normals):t.normals=e.normals.constructor===Float32Array?e.normals:new Float32Array(e.normals)),e.indices){if(!V&&e.indices.constructor===Uint32Array)return void this.error("This WebGL implementation does not support Uint32Array");t.indices=e.indices.constructor===Uint32Array||e.indices.constructor===Uint16Array?e.indices:new N(e.indices)}t.indices&&(t.indicesBuf=new S(i,i.ELEMENT_ARRAY_BUFFER,t.indices,t.indices.length,1,i.STATIC_DRAW),I.indices+=t.indicesBuf.numItems),this._buildHash(),I.meshes++,this._state.combined&&(this._sceneVertexBufs=((e,t)=>{const i=!!t.positions,s=!!t.quantized,r=!!t.normals,a=!!t.colors,o=!!t.uv,n=[e.id,i?"p":"",s?"c":"",r?"n":"",a?"c":"",o?"u":""].join(";");e._sceneVertexBufs||(e._sceneVertexBufs={});let l=e._sceneVertexBufs[n];return l||(l=new k(e,i,r,a,o,s),e._sceneVertexBufs[n]=l),l})(this.scene,this._state),this._sceneVertexBufs.addGeometry(this._state)),this._buildVBOs(),this.fire("created",this.created=!0)}_buildVBOs(){const e=this._state,t=this.scene.canvas.gl;e.indices&&(e.indicesBuf=new S(t,t.ELEMENT_ARRAY_BUFFER,e.indices,e.indices.length,1,t.STATIC_DRAW),I.indices+=e.indicesBuf.numItems),e.combined?e.indices:(e.positions&&(e.positionsBuf=new S(t,t.ARRAY_BUFFER,e.positions,e.positions.length,3,t.STATIC_DRAW),I.positions+=e.positionsBuf.numItems),e.normals&&(e.normalsBuf=new S(t,t.ARRAY_BUFFER,e.normals,e.normals.length,3,t.STATIC_DRAW),I.normals+=e.normalsBuf.numItems),e.colors&&(e.colorsBuf=new S(t,t.ARRAY_BUFFER,e.colors,e.colors.length,4,t.STATIC_DRAW),I.colors+=e.colorsBuf.numItems),e.uv&&(e.uvBuf=new S(t,t.ARRAY_BUFFER,e.uv,e.uv.length,2,t.STATIC_DRAW),I.uvs+=e.uvBuf.numItems))}_buildHash(){const e=this._state,t=["/g"];t.push("/"+e.primitive+";"),e.positions&&t.push("p"),e.colors&&t.push("c"),(e.normals||e.autoVertexNormals)&&t.push("n"),e.uv&&t.push("u"),e.quantized&&t.push("cp"),t.push(";"),e.hash=t.join("")}_getEdgesIndices(){return this._edgesIndicesBuf||this._buildEdgesIndices(),this._edgesIndicesBuf}_getPickTrianglePositions(){return this._pickTrianglePositionsBuf||this._buildPickTriangleVBOs(),this._pickTrianglePositionsBuf}_getPickTriangleColors(){return this._pickTriangleColorsBuf||this._buildPickTriangleVBOs(),this._pickTriangleColorsBuf}_buildEdgesIndices(){const e=this._state;if(!e.positions||!e.indices)return;const t=this.scene.canvas.gl,i=H(e.positions,e.indices,e.positionsDecodeMatrix,this._edgeThreshold,e.combined);if(e.combined){const t=this._sceneVertexBufs.getIndicesOffset(e);for(let e=0,s=i.length;e<s;e++)i[e]+=t}this._edgesIndicesBuf=new S(t,t.ELEMENT_ARRAY_BUFFER,i,i.length,1,t.STATIC_DRAW),I.indices+=this._edgesIndicesBuf.numItems}_buildPickTriangleVBOs(){const e=this._state;if(!e.positions||!e.indices)return;const t=this.scene.canvas.gl,i=d.buildPickTriangles(e.positions,e.indices,e.quantized),s=i.positions,r=i.colors;this._pickTrianglePositionsBuf=new S(t,t.ARRAY_BUFFER,s,s.length,3,t.STATIC_DRAW),this._pickTriangleColorsBuf=new S(t,t.ARRAY_BUFFER,r,r.length,4,t.STATIC_DRAW,!0),I.positions+=this._pickTrianglePositionsBuf.numItems,I.colors+=this._pickTriangleColorsBuf.numItems}_buildPickVertexVBOs(){}_webglContextLost(){this._sceneVertexBufs&&this._sceneVertexBufs.webglContextLost()}_webglContextRestored(){this._sceneVertexBufs&&this._sceneVertexBufs.webglContextRestored(),this._buildVBOs(),this._edgesIndicesBuf=null,this._pickVertexPositionsBuf=null,this._pickTrianglePositionsBuf=null,this._pickTriangleColorsBuf=null,this._pickVertexPositionsBuf=null,this._pickVertexColorsBuf=null}get primitive(){return this._state.primitiveName}get quantized(){return this._state.quantized}get combined(){return this._state.combined}get positions(){if(this._state.positions)return this._state.quantized?(this._decompressedPositions||(this._decompressedPositions=new Float32Array(this._state.positions.length),d.decompressPositions(this._state.positions,this._state.positionsDecodeMatrix,this._decompressedPositions)),this._decompressedPositions):this._state.positions}set positions(e){const t=this._state,i=t.positions;if(i)if(i.length===e.length){if(this._state.quantized){const i=G(e,3),s=j(e,i.min,i.max);e=s.quantized,t.positionsDecodeMatrix=s.decode}i.set(e),t.positionsBuf&&t.positionsBuf.setData(i),this._state.combined&&this._sceneVertexBufs.setPositions(t),this._setBoundaryDirty(),this._renderer.imageDirty()}else this.error("can't update geometry positions - new positions are wrong length");else this.error("can't update geometry positions - geometry has no positions")}get normals(){if(this._state.normals){if(!this._state.quantized)return this._state.normals;if(!this._decompressedNormals){const e=this._state.normals.length,t=e+e/2;this._decompressedNormals=new Float32Array(t),d.octDecodeVec2s(this._state.normals,this._decompressedNormals)}return this._decompressedNormals}}set normals(e){if(this._state.quantized)return void this.error("can't update geometry normals - quantized geometry is immutable");const t=this._state,i=t.normals;i?i.length===e.length?(i.set(e),t.normalsBuf&&t.normalsBuf.setData(i),this._state.combined&&this._sceneVertexBufs.setNormals(t),this._renderer.imageDirty()):this.error("can't update geometry normals - new normals are wrong length"):this.error("can't update geometry normals - geometry has no normals")}get uv(){if(this._state.uv)return this._state.quantized?(this._decompressedUV||(this._decompressedUV=new Float32Array(this._state.uv.length),d.decompressUVs(this._state.uv,this._state.uvDecodeMatrix,this._decompressedUV)),this._decompressedUV):this._state.uv}set uv(e){if(this._state.quantized)return void this.error("can't update geometry UVs - quantized geometry is immutable");const t=this._state,i=t.uv;i?i.length===e.length?(i.set(e),t.uvBuf&&t.uvBuf.setData(i),this._state.combined&&this._sceneVertexBufs.setUVs(t),this._renderer.imageDirty()):this.error("can't update geometry UVs - new UVs are wrong length"):this.error("can't update geometry UVs - geometry has no UVs")}get colors(){return this._state.colors}set colors(e){if(this._state.quantized)return void this.error("can't update geometry colors - quantized geometry is immutable");const t=this._state,i=t.colors;i?i.length===e.length?(i.set(e),t.colorsBuf&&t.colorsBuf.setData(i),this._state.combined&&this._sceneVertexBufs.setColors(t),this._renderer.imageDirty()):this.error("can't update geometry colors - new colors are wrong length"):this.error("can't update geometry colors - geometry has no colors")}get indices(){return this._state.indices}get aabb(){return this._aabbDirty&&(this._aabb||(this._aabb=d.AABB3()),d.positions3ToAABB3(this._state.positions,this._aabb,this._state.positionsDecodeMatrix),this._aabbDirty=!1),this._aabb}get obb(){return this._obbDirty&&(this._obb||(this._obb=d.OBB3()),d.positions3ToAABB3(this._state.positions,O,this._state.positionsDecodeMatrix),d.AABB3ToOBB3(O,this._obb),this._obbDirty=!1),this._obb}get kdtree(){const e=this._state;if(e.indices&&e.positions)return this._kdtree||(this._kdtree=d.buildKDTree(e.indices,e.positions,this._state.positionsDecodeMatrix)),this._kdtree;this.error("Can't provide a KD-tree: no indices/positions")}_setBoundaryDirty(){this._boundaryDirty||(this._boundaryDirty=!0,this._aabbDirty=!0,this._obbDirty=!0,this.fire("boundary"))}_getState(){return this._state}_getVertexBufs(){return this._state&&this._state.combined?this._sceneVertexBufs.getVertexBufs(this._state):U}destroy(){super.destroy();const e=this._state;e.indicesBuf&&e.indicesBuf.destroy(),this._edgesIndicesBuf&&this._edgesIndicesBuf.destroy(),this._pickTrianglePositionsBuf&&this._pickTrianglePositionsBuf.destroy(),this._pickTriangleColorsBuf&&this._pickTriangleColorsBuf.destroy(),this._pickVertexPositionsBuf&&this._pickVertexPositionsBuf.destroy(),this._pickVertexColorsBuf&&this._pickVertexColorsBuf.destroy(),this._state.combined&&this._sceneVertexBufs.removeGeometry(e),e.destroy(),I.meshes--}}function G(e,t){const i=new Float32Array(t),s=new Float32Array(t);let r,a;for(r=0;r<t;r++)i[r]=Number.MAX_VALUE,s[r]=-Number.MAX_VALUE;for(r=0;r<e.length;r+=t)for(a=0;a<t;a++)i[a]=Math.min(i[a],e[r+a]),s[a]=Math.max(s[a],e[r+a]);return{min:i,max:s}}var j=function(){const e=d.mat4(),t=d.mat4();return function(i,s,r){const a=new Uint16Array(i.length),o=new Float32Array([65535/(r[0]-s[0]),65535/(r[1]-s[1]),65535/(r[2]-s[2])]);let n;for(n=0;n<i.length;n+=3)a[n+0]=Math.floor((i[n+0]-s[0])*o[0]),a[n+1]=Math.floor((i[n+1]-s[1])*o[1]),a[n+2]=Math.floor((i[n+2]-s[2])*o[2]);d.identityMat4(e),d.translationMat4v(s,e),d.identityMat4(t),d.scalingMat4v([(r[0]-s[0])/65535,(r[1]-s[1])/65535,(r[2]-s[2])/65535],t);return{quantized:a,decode:d.mulMat4(e,t,d.identityMat4())}}}(),Y=function(){const e=d.mat3(),t=d.mat3();return function(i,s,r){const a=new Uint16Array(i.length),o=new Float32Array([65535/(r[0]-s[0]),65535/(r[1]-s[1])]);let n;for(n=0;n<i.length;n+=2)a[n+0]=Math.floor((i[n+0]-s[0])*o[0]),a[n+1]=Math.floor((i[n+1]-s[1])*o[1]);d.identityMat3(e),d.translationMat3v(s,e),d.identityMat3(t),d.scalingMat3v([(r[0]-s[0])/65535,(r[1]-s[1])/65535],t);return{quantized:a,decode:d.mulMat3(e,t,d.identityMat3())}}}();function W(e,t,i,s){let r=e[t]/(Math.abs(e[t])+Math.abs(e[t+1])+Math.abs(e[t+2])),a=e[t+1]/(Math.abs(e[t])+Math.abs(e[t+1])+Math.abs(e[t+2]));if(e[t+2]<0){let e=r,t=a;e=(1-Math.abs(a))*(r>=0?1:-1),t=(1-Math.abs(r))*(a>=0?1:-1),r=e,a=t}return new Int8Array([Math[i](127.5*r+(r<0?-1:0)),Math[s](127.5*a+(a<0?-1:0))])}function K(e){let t=e[0],i=e[1];t/=t<0?127:128,i/=i<0?127:128;const s=1-Math.abs(t)-Math.abs(i);s<0&&(t=(1-Math.abs(i))*(t>=0?1:-1),i=(1-Math.abs(t))*(i>=0?1:-1));const r=Math.sqrt(t*t+i*i+s*s);return[t/r,i/r,s/r]}function X(e,t,i){return e[t]*i[0]+e[t+1]*i[1]+e[t+2]*i[2]}var H=function(){const e=[],t=[],i=[],s=[];const r=[];let a=0;const o=new Uint16Array(3),n=new Uint16Array(3),l=new Uint16Array(3),h=d.vec3(),u=d.vec3(),c=d.vec3(),p=d.vec3(),_=d.vec3(),m=d.vec3(),f=d.vec3();return function(g,v,M,y,x){!function(r,a){const o={};let n,l,h,u;const c=Math.pow(10,4);let d,p,_=0;for(d=0,p=r.length;d<p;d+=3)n=r[d],l=r[d+1],h=r[d+2],u=Math.round(n*c)+"_"+Math.round(l*c)+"_"+Math.round(h*c),void 0===o[u]&&(o[u]=_/3,e[_++]=n,e[_++]=l,e[_++]=h),t[d/3]=o[u];for(d=0,p=a.length;d<p;d++)s[d]=t[a[d]],i[s[d]]=a[d]}(g,v),function(t,i){a=0;for(let g=0,v=t;g<v;g+=3){const t=3*s[g],v=3*s[g+1],M=3*s[g+2];i?(o[0]=e[t],o[1]=e[t+1],o[2]=e[t+2],n[0]=e[v],n[1]=e[v+1],n[2]=e[v+2],l[0]=e[M],l[1]=e[M+1],l[2]=e[M+2],d.decompressPosition(o,i,h),d.decompressPosition(n,i,u),d.decompressPosition(l,i,c)):(h[0]=e[t],h[1]=e[t+1],h[2]=e[t+2],u[0]=e[v],u[1]=e[v+1],u[2]=e[v+2],c[0]=e[M],c[1]=e[M+1],c[2]=e[M+2]),d.subVec3(c,u,p),d.subVec3(h,u,_),d.cross3Vec3(p,_,m),d.normalizeVec3(m,f);const y=r[a]||(r[a]={normal:d.vec3()});y.normal[0]=f[0],y.normal[1]=f[1],y.normal[2]=f[2],a++}}(v.length,M);const b=[],w=Math.cos(d.DEGTORAD*y),A={};let E,C,P,T,D,S,F,L,B,R,k,I=!1;for(let e=0,t=v.length;e<t;e+=3){const t=e/3;for(let i=0;i<3;i++)E=s[e+i],C=s[e+(i+1)%3],P=Math.min(E,C),T=Math.max(E,C),D=P+","+T,void 0===A[D]?A[D]={index1:P,index2:T,face1:t,face2:void 0}:A[D].face2=t}for(D in A)S=A[D],void 0!==S.face2&&(F=r[S.face1].normal,L=r[S.face2].normal,B=d.dotVec3(F,L),B>w)||(R=i[S.index1],k=i[S.index2],(!I&&R>65535||k>65535)&&(I=!0),b.push(R),b.push(k));return I||x?new Uint32Array(b):new Uint16Array(b)}}();m["xeogl.Geometry"]=z;class q extends z{get type(){return"xeogl.AABBGeometry"}init(e){super.init(a.apply(e,{combined:!0,quantized:!0,primitive:e.primitive||"lines",indices:[0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7],positions:e.positions||[1,1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1]})),e.target?this.target=e.target:e.targetAABB&&(this.targetAABB=e.targetAABB)}set target(e){let t=!1;const i=this;this._attach({name:"target",type:"xeogl.Component",component:e,sceneDefault:!1,on:{boundary:function(){t||(t=!0,_.scheduleTask((function(){i._setPositionsFromAABB(i._attached.target.aabb),t=!1})))}},onAttached:function(){i._setPositionsFromAABB(i._attached.target.aabb)}})}get target(){return this._attached.target}set targetAABB(e){e&&(this._attached.target&&(this.target=null),this._setPositionsFromAABB(e))}_setPositionsFromAABB(e){this.positions=[e[3],e[4],e[5],e[3],e[1],e[5],e[0],e[1],e[5],e[0],e[4],e[5],e[3],e[4],e[2],e[3],e[1],e[2],e[0],e[1],e[2],e[0],e[4],e[2]]}}m["xeogl.AABBGeometry"]=q;class Q extends g{get type(){return"xeogl.Material"}init(e){super.init(e),r.memory.materials++}destroy(){super.destroy(),r.memory.materials--}}m["xeogl.Material"]=Q;const Z="xeogl.PhongMaterial",$={opaque:0,mask:1,blend:2},J=["opaque","mask","blend"];class ee extends Q{get type(){return Z}init(e){super.init(e),this._state=new D({type:"PhongMaterial",ambient:d.vec3([1,1,1]),diffuse:d.vec3([1,1,1]),specular:d.vec3([1,1,1]),emissive:d.vec3([0,0,0]),alpha:null,shininess:null,reflectivity:null,alphaMode:null,alphaCutoff:null,lineWidth:null,pointSize:null,backfaces:null,frontface:null,hash:null}),this.ambient=e.ambient,this.diffuse=e.diffuse,this.specular=e.specular,this.emissive=e.emissive,this.alpha=e.alpha,this.shininess=e.shininess,this.reflectivity=e.reflectivity,this.lineWidth=e.lineWidth,this.pointSize=e.pointSize,e.ambientMap&&(this._ambientMap=this._checkComponent("xeogl.Texture",e.ambientMap)),e.diffuseMap&&(this._diffuseMap=this._checkComponent("xeogl.Texture",e.diffuseMap)),e.specularMap&&(this._specularMap=this._checkComponent("xeogl.Texture",e.specularMap)),e.emissiveMap&&(this._emissiveMap=this._checkComponent("xeogl.Texture",e.emissiveMap)),e.alphaMap&&(this._alphaMap=this._checkComponent("xeogl.Texture",e.alphaMap)),e.reflectivityMap&&(this._reflectivityMap=this._checkComponent("xeogl.Texture",e.reflectivityMap)),e.normalMap&&(this._normalMap=this._checkComponent("xeogl.Texture",e.normalMap)),e.occlusionMap&&(this._occlusionMap=this._checkComponent("xeogl.Texture",e.occlusionMap)),e.diffuseFresnel&&(this._diffuseFresnel=this._checkComponent("xeogl.Fresnel",e.diffuseFresnel)),e.specularFresnel&&(this._specularFresnel=this._checkComponent("xeogl.Fresnel",e.specularFresnel)),e.emissiveFresnel&&(this._emissiveFresnel=this._checkComponent("xeogl.Fresnel",e.emissiveFresnel)),e.alphaFresnel&&(this._alphaFresnel=this._checkComponent("xeogl.Fresnel",e.alphaFresnel)),e.reflectivityFresnel&&(this._reflectivityFresnel=this._checkComponent("xeogl.Fresnel",e.reflectivityFresnel)),this.alphaMode=e.alphaMode,this.alphaCutoff=e.alphaCutoff,this.backfaces=e.backfaces,this.frontface=e.frontface,this._makeHash()}_makeHash(){const e=this._state,t=["/p"];this._normalMap&&(t.push("/nm"),this._normalMap.hasMatrix&&t.push("/mat")),this._ambientMap&&(t.push("/am"),this._ambientMap.hasMatrix&&t.push("/mat"),t.push("/"+this._ambientMap.encoding)),this._diffuseMap&&(t.push("/dm"),this._diffuseMap.hasMatrix&&t.push("/mat"),t.push("/"+this._diffuseMap.encoding)),this._specularMap&&(t.push("/sm"),this._specularMap.hasMatrix&&t.push("/mat")),this._emissiveMap&&(t.push("/em"),this._emissiveMap.hasMatrix&&t.push("/mat"),t.push("/"+this._emissiveMap.encoding)),this._alphaMap&&(t.push("/opm"),this._alphaMap.hasMatrix&&t.push("/mat")),this._reflectivityMap&&(t.push("/rm"),this._reflectivityMap.hasMatrix&&t.push("/mat")),this._occlusionMap&&(t.push("/ocm"),this._occlusionMap.hasMatrix&&t.push("/mat")),this._diffuseFresnel&&t.push("/df"),this._specularFresnel&&t.push("/sf"),this._emissiveFresnel&&t.push("/ef"),this._alphaFresnel&&t.push("/of"),this._reflectivityFresnel&&t.push("/rf"),t.push(";"),e.hash=t.join("")}set ambient(e){let t=this._state.ambient;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.ambient=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=.2,t[1]=.2,t[2]=.2),this._renderer.imageDirty()}get ambient(){return this._state.ambient}set diffuse(e){let t=this._state.diffuse;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.diffuse=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1),this._renderer.imageDirty()}get diffuse(){return this._state.diffuse}set specular(e){let t=this._state.specular;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.specular=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1),this._renderer.imageDirty()}get specular(){return this._state.specular}set emissive(e){let t=this._state.emissive;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.emissive=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=0,t[1]=0,t[2]=0),this._renderer.imageDirty()}get emissive(){return this._state.emissive}set alpha(e){e=null!=e?e:1,this._state.alpha!==e&&(this._state.alpha=e,this._renderer.imageDirty())}get alpha(){return this._state.alpha}set shininess(e){this._state.shininess=void 0!==e?e:80,this._renderer.imageDirty()}get shininess(){return this._state.shininess}set lineWidth(e){this._state.lineWidth=e||1,this._renderer.imageDirty()}get lineWidth(){return this._state.lineWidth}set pointSize(e){this._state.pointSize=e||1,this._renderer.imageDirty()}get pointSize(){return this._state.pointSize}set reflectivity(e){this._state.reflectivity=void 0!==e?e:1,this._renderer.imageDirty()}get reflectivity(){return this._state.reflectivity}get normalMap(){return this._normalMap}get ambientMap(){return this._ambientMap}get diffuseMap(){return this._diffuseMap}get specularMap(){return this._specularMap}get emissiveMap(){return this._emissiveMap}get alphaMap(){return this._alphaMap}get reflectivityMap(){return this._reflectivityMap}get occlusionMap(){return this._occlusionMap}get diffuseFresnel(){return this._diffuseFresnel}get specularFresnel(){return this._specularFresnel}get emissiveFresnel(){return this._emissiveFresnel}get alphaFresnel(){return this._alphaFresnel}get reflectivityFresnel(){return this._reflectivityFresnel}set alphaMode(e){let t=$[e=e||"opaque"];void 0===t&&(this.error("Unsupported value for 'alphaMode': "+e+" - defaulting to 'opaque'"),t="opaque"),this._state.alphaMode!==t&&(this._state.alphaMode=t,this._renderer.imageDirty())}get alphaMode(){return J[this._state.alphaMode]}set alphaCutoff(e){null==e&&(e=.5),this._state.alphaCutoff!==e&&(this._state.alphaCutoff=e)}get alphaCutoff(){return this._state.alphaCutoff}set backfaces(e){e=!!e,this._state.backfaces!==e&&(this._state.backfaces=e,this._renderer.imageDirty())}get backfaces(){return this._state.backfaces}set frontface(e){e="cw"!==e,this._state.frontface!==e&&(this._state.frontface=e,this._renderer.imageDirty())}get frontface(){return this._state.frontface?"ccw":"cw"}destroy(){super.destroy(),this._state.destroy()}}m[Z]=ee;const te=new Float32Array(4),ie=new Float32Array(4),se=new Float32Array(4),re=new Float32Array([1,0,0]),ae=new Float32Array([0,1,0]),oe=new Float32Array([0,0,1]),ne=new Float32Array(3),le=new Float32Array(3),he=d.identityMat4();class ue extends g{get type(){return"xeogl.Object"}init(e){if(super.init(e),this._guid=e.guid,this._parent=null,this._childList=[],this._childMap={},this._childIDs=null,this._aabb=null,this._aabbDirty=!0,this.scene._aabbDirty=!0,this._scale=d.vec3(),this._quaternion=d.identityQuaternion(),this._rotation=d.vec3(),this._position=d.vec3(),this._worldMatrix=d.identityMat4(),this._worldNormalMatrix=d.identityMat4(),this._localMatrixDirty=!0,this._worldMatrixDirty=!0,this._worldNormalMatrixDirty=!0,e.matrix?this.matrix=e.matrix:(this.scale=e.scale,this.position=e.position,e.quaternion||(this.rotation=e.rotation)),e.entityType&&(this._entityType=e.entityType,this.scene._entityTypeAssigned(this,this._entityType)),this.visible=e.visible,this.culled=e.culled,this.pickable=e.pickable,this.clippable=e.clippable,this.collidable=e.collidable,this.castShadow=e.castShadow,this.receiveShadow=e.receiveShadow,this.outlined=e.outlined,this.solid=e.solid,this.ghosted=e.ghosted,this.highlighted=e.highlighted,this.selected=e.selected,this.edges=e.edges,this.aabbVisible=e.aabbVisible,this.layer=e.layer,this.colorize=e.colorize,this.opacity=e.opacity,e.children){const t=e.children;for(let i=0,s=t.length;i<s;i++)this.addChild(t[i],e.inheritStates)}e.parent&&e.parent.addChild(this),this.scene._objectCreated(this)}_setLocalMatrixDirty(){this._localMatrixDirty=!0,this._setWorldMatrixDirty()}_setWorldMatrixDirty(){if(this._worldMatrixDirty=!0,this._worldNormalMatrixDirty=!0,this._childList)for(let e=0,t=this._childList.length;e<t;e++)this._childList[e]._setWorldMatrixDirty()}_buildWorldMatrix(){const e=this.matrix;if(this._parent)d.mulMat4(this._parent.worldMatrix,e,this._worldMatrix);else for(let t=0,i=e.length;t<i;t++)this._worldMatrix[t]=e[t];this._worldMatrixDirty=!1}_buildWorldNormalMatrix(){this._worldMatrixDirty&&this._buildWorldMatrix(),this._worldNormalMatrix||(this._worldNormalMatrix=d.mat4()),d.inverseMat4(this._worldMatrix,this._worldNormalMatrix),d.transposeMat4(this._worldNormalMatrix),this._worldNormalMatrixDirty=!1}_setSubtreeAABBsDirty(e){if(e._aabbDirty=!0,e.fire("boundary",!0),e._childList)for(let t=0,i=e._childList.length;t<i;t++)this._setSubtreeAABBsDirty(e._childList[t])}_setAABBDirty(){if(this._setSubtreeAABBsDirty(this),this.collidable)for(let e=this;e;e=e._parent)e._aabbDirty=!0,e.fire("boundary",!0)}_updateAABB(){if(this.scene._aabbDirty=!0,this._aabb||(this._aabb=d.AABB3()),this._buildMeshAABB)this._buildMeshAABB(this.worldMatrix,this._aabb);else{let e;d.collapseAABB3(this._aabb);for(let t=0,i=this._childList.length;t<i;t++)e=this._childList[t],e.collidable&&d.expandAABB3(this._aabb,e.aabb);this._aabbCenter||(this._aabbCenter=new Float32Array(3)),d.getAABB3Center(this._aabb,this._aabbCenter)}this._aabbDirty=!1}addChild(e,t){if(a.isNumeric(e)||a.isString(e)){const t=e;if(!(e=this.scene.objects[t]))return void this.warn("Object not found: "+a.inQuotes(t))}else{if(a.isObject(e))throw"addChild( * ) not implemented";if(!e.isType("xeogl.Object"))return void this.error("Not a xeogl.Object: "+e.id);if(e._parent){if(e._parent.id===this.id)return void this.warn("Already a child object: "+e.id);e._parent.removeChild(e)}}e.id;if(e.scene.id===this.scene.id)return delete this.scene.rootObjects[e.id],this._childList.push(e),this._childMap[e.id]=e,this._childIDs=null,e._parent=this,t&&(e.visible=this.visible,e.culled=this.culled,e.ghosted=this.ghosted,e.highlited=this.highlighted,e.selected=this.selected,e.edges=this.edges,e.outlined=this.outlined,e.clippable=this.clippable,e.pickable=this.pickable,e.collidable=this.collidable,e.castShadow=this.castShadow,e.receiveShadow=this.receiveShadow,e.colorize=this.colorize,e.opacity=this.opacity),e._setWorldMatrixDirty(),e._setAABBDirty(),e;this.error("Object not in same Scene: "+e.id)}removeChild(e){for(let t=0,i=this._childList.length;t<i;t++)if(this._childList[t].id===e.id)return e._parent=null,this._childList=this._childList.splice(t,1),delete this._childMap[e.id],this._childIDs=null,this.scene.rootObjects[e.id]=e,e._setWorldMatrixDirty(),e._setAABBDirty(),void this._setAABBDirty()}removeChildren(){let e;for(let t=0,i=this._childList.length;t<i;t++)e=this._childList[t],e._parent=null,this.scene.rootObjects[e.id]=e,e._setWorldMatrixDirty(),e._setAABBDirty();this._childList=[],this._childMap={},this._childIDs=null,this._setAABBDirty()}rotate(e,t){return te[0]=e[0],te[1]=e[1],te[2]=e[2],te[3]=t*d.DEGTORAD,d.angleAxisToQuaternion(te,ie),d.mulQuaternions(this.quaternion,ie,se),this.quaternion=se,this._setLocalMatrixDirty(),this._setAABBDirty(),this._renderer.imageDirty(),this}rotateOnWorldAxis(e,t){return te[0]=e[0],te[1]=e[1],te[2]=e[2],te[3]=t*d.DEGTORAD,d.angleAxisToQuaternion(te,ie),d.mulQuaternions(ie,this.quaternion,ie),this}rotateX(e){return this.rotate(re,e)}rotateY(e){return this.rotate(ae,e)}rotateZ(e){return this.rotate(oe,e)}translate(e,t){return d.vec3ApplyQuaternion(this.quaternion,e,ne),d.mulVec3Scalar(ne,t,le),d.addVec3(this.position,le,this.position),this._setLocalMatrixDirty(),this._setAABBDirty(),this._renderer.imageDirty(),this}translateX(e){return this.translate(re,e)}translateY(e){return this.translate(ae,e)}translateZ(e){return this.translate(oe,e)}get guid(){return this._guid}get entityType(){return this._entityType}get numChildren(){return this._childList.length}get children(){return this._childList}get childMap(){return this._childMap}get childIDs(){return this._childIDs||(this._childIDs=Object.keys(this._childMap)),this._childIDs}set parent(e){if(a.isNumeric(e)||a.isString(e)){const t=e;if(!(e=this.scene.objects[t]))return void this.warn("Group not found: "+a.inQuotes(t))}e.scene.id===this.scene.id?this._parent&&this._parent.id===e.id?this.warn("Already a child of Group: "+e.id):e.addChild(this):this.error("Group not in same Scene: "+e.id)}get parent(){return this._parent}set position(e){this._position.set(e||[0,0,0]),this._setLocalMatrixDirty(),this._setAABBDirty(),this._renderer.imageDirty()}get position(){return this._position}set rotation(e){this._rotation.set(e||[0,0,0]),d.eulerToQuaternion(this._rotation,"XYZ",this._quaternion),this._setLocalMatrixDirty(),this._setAABBDirty(),this._renderer.imageDirty()}get rotation(){return this._rotation}set quaternion(e){this._quaternion.set(e||[0,0,0,1]),d.quaternionToEuler(this._quaternion,"XYZ",this._rotation),this._setLocalMatrixDirty(),this._setAABBDirty(),this._renderer.imageDirty()}get quaternion(){return this._quaternion}set scale(e){this._scale.set(e||[1,1,1]),this._setLocalMatrixDirty(),this._setAABBDirty(),this._renderer.imageDirty()}get scale(){return this._scale}set matrix(e){this.__localMatrix||(this.__localMatrix=d.identityMat4()),this.__localMatrix.set(e||he),d.decomposeMat4(this.__localMatrix,this._position,this._quaternion,this._scale),this._localMatrixDirty=!1,this._setWorldMatrixDirty(),this._setAABBDirty(),this._renderer.imageDirty()}get matrix(){return this._localMatrixDirty&&(this.__localMatrix||(this.__localMatrix=d.identityMat4()),d.composeMat4(this._position,this._quaternion,this._scale,this.__localMatrix),this._localMatrixDirty=!1),this.__localMatrix}get worldMatrix(){return this._worldMatrixDirty&&this._buildWorldMatrix(),this._worldMatrix}get worldNormalMatrix(){return this._worldNormalMatrixDirty&&this._buildWorldNormalMatrix(),this._worldNormalMatrix}get aabb(){return this._aabbDirty&&this._updateAABB(),this._aabb}get center(){return this._aabbDirty&&this._updateAABB(),this._aabbCenter}set visible(e){e=!1!==e,this._visible=e;for(let t=0,i=this._childList.length;t<i;t++)this._childList[t].visible=e;this._entityType&&this.scene._entityVisibilityUpdated(this,e)}get visible(){return this._visible}set highlighted(e){e=!!e,this._highlighted=e;for(let t=0,i=this._childList.length;t<i;t++)this._childList[t].highlighted=e;this._entityType&&this.scene._entityHighlightedUpdated(this,e)}get highlighted(){return this._highlighted}set ghosted(e){e=!!e,this._ghosted=e;for(let t=0,i=this._childList.length;t<i;t++)this._childList[t].ghosted=e;this._entityType&&this.scene._entityGhostedUpdated(this,e)}get ghosted(){return this._ghosted}set selected(e){e=!!e,this._selected=e;for(let t=0,i=this._childList.length;t<i;t++)this._childList[t].selected=e;this._entityType&&this.scene._entitySelectedUpdated(this,e)}get selected(){return this._selected}set edges(e){e=!!e,this._edges=e;for(let t=0,i=this._childList.length;t<i;t++)this._childList[t].edges=e}get edges(){return this._edges}set culled(e){e=!!e,this._culled=e;for(let t=0,i=this._childList.length;t<i;t++)this._childList[t].culled=e}get culled(){return this._culled}set clippable(e){e=!1!==e,this._clippable=e;for(let t=0,i=this._childList.length;t<i;t++)this._childList[t].clippable=e}get clippable(){return this._clippable}set collidable(e){e=!1!==e,this._collidable=e;for(let t=0,i=this._childList.length;t<i;t++)this._childList[t].collidable=e}get collidable(){return this._collidable}set pickable(e){e=!1!==e,this._pickable=e;for(let t=0,i=this._childList.length;t<i;t++)this._childList[t].pickable=e}get pickable(){return this._pickable}set colorize(e){let t=this._colorize;t||(t=this._colorize=new Float32Array(4),t[3]=1),e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1);for(let e=0,i=this._childList.length;e<i;e++)this._childList[e].colorize=t}get colorize(){return this._colorize.slice(0,3)}set opacity(e){let t=this._colorize;t||(t=this._colorize=new Float32Array(4),t[0]=1,t[1]=1,t[2]=1),t[3]=null!=e?e:1;for(let t=0,i=this._childList.length;t<i;t++)this._childList[t].opacity=e}get opacity(){return this._colorize[3]}set outlined(e){e=!!e,this._outlined=e;for(let t=0,i=this._childList.length;t<i;t++)this._childList[t].outlined=e}get outlined(){return this._outlined}set castShadow(e){e=!!e,this._castShadow=e;for(let t=0,i=this._childList.length;t<i;t++)this._childList[t].castShadow=e}get castShadow(){return this._castShadow}set receiveShadow(e){e=!!e,this._receiveShadow=e;for(let t=0,i=this._childList.length;t<i;t++)this._childList[t].receiveShadow=e}get receiveShadow(){return this._receiveShadow}set aabbVisible(e){(e||this._aabbHelper)&&(this._aabbHelper||(this._aabbHelper=new Je(this,{geometry:new q(this,{target:this}),material:new ee(this,{diffuse:[.5,1,.5],emissive:[.5,1,.5],lineWidth:2})})),this._aabbHelper.visible=e)}get aabbVisible(){return!!this._aabbHelper&&this._aabbHelper.visible}destroy(){if(super.destroy(),this._parent&&this._parent.removeChild(this),this._entityType){const e=this.scene;e._entityTypeRemoved(this,this._entityType),this._visible&&e._entityVisibilityUpdated(this,!1),this._ghosted&&e._entityGhostedUpdated(this,!1),this._selected&&e._entitySelectedUpdated(this,!1),this._highlighted&&e._entityHighlightedUpdated(this,!1)}if(this._childList.length){const e=this._childList.splice();let t;for(let i=0,s=e.length;i<s;i++)t=e[i],t.destroy()}this._childList=[],this._childMap={},this._childIDs=null,this._setAABBDirty(),this.scene._aabbDirty=!0,this.scene._objectDestroyed(this)}}m["xeogl.Object"]=ue;const ce=function(e){"LambertMaterial"===e._material._state.type?(this.vertex=function(e){const t=e.scene._clipsState,i=e.scene._lightsState,s=e._geometry._state,r=e._state.billboard,a=e._state.stationary,o=t.clips.length>0,n=!!s.quantized;let l,h,u;const c=[];c.push("// Lambertian drawing vertex shader"),c.push("attribute vec3 position;"),c.push("uniform mat4 modelMatrix;"),c.push("uniform mat4 viewMatrix;"),c.push("uniform mat4 projMatrix;"),c.push("uniform vec4 colorize;"),n&&c.push("uniform mat4 positionsDecodeMatrix;");o&&c.push("varying vec4 vWorldPosition;");if(c.push("uniform vec4 lightAmbient;"),c.push("uniform vec4 materialColor;"),s.normals){for(c.push("attribute vec3 normal;"),c.push("uniform mat4 modelNormalMatrix;"),c.push("uniform mat4 viewNormalMatrix;"),l=0,h=i.lights.length;l<h;l++)u=i.lights[l],"ambient"!==u.type&&(c.push("uniform vec4 lightColor"+l+";"),"dir"===u.type&&c.push("uniform vec3 lightDir"+l+";"),"point"===u.type&&c.push("uniform vec3 lightPos"+l+";"),"spot"===u.type&&(c.push("uniform vec3 lightPos"+l+";"),c.push("uniform vec3 lightDir"+l+";")));n&&(c.push("vec3 octDecode(vec2 oct) {"),c.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),c.push("    if (v.z < 0.0) {"),c.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),c.push("    }"),c.push("    return normalize(v);"),c.push("}"))}c.push("varying vec4 vColor;"),"points"===s.primitiveName&&c.push("uniform float pointSize;");"spherical"!==r&&"cylindrical"!==r||(c.push("void billboard(inout mat4 mat) {"),c.push("   mat[0][0] = 1.0;"),c.push("   mat[0][1] = 0.0;"),c.push("   mat[0][2] = 0.0;"),"spherical"===r&&(c.push("   mat[1][0] = 0.0;"),c.push("   mat[1][1] = 1.0;"),c.push("   mat[1][2] = 0.0;")),c.push("   mat[2][0] = 0.0;"),c.push("   mat[2][1] = 0.0;"),c.push("   mat[2][2] =1.0;"),c.push("}"));c.push("void main(void) {"),c.push("vec4 localPosition = vec4(position, 1.0); "),c.push("vec4 worldPosition;"),n&&c.push("localPosition = positionsDecodeMatrix * localPosition;");s.normals&&(n?c.push("vec4 localNormal = vec4(octDecode(normal.xy), 0.0); "):c.push("vec4 localNormal = vec4(normal, 0.0); "),c.push("mat4 modelNormalMatrix2 = modelNormalMatrix;"),c.push("mat4 viewNormalMatrix2 = viewNormalMatrix;"));c.push("mat4 viewMatrix2 = viewMatrix;"),c.push("mat4 modelMatrix2 = modelMatrix;"),a&&c.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===r||"cylindrical"===r?(c.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),c.push("billboard(modelMatrix2);"),c.push("billboard(viewMatrix2);"),c.push("billboard(modelViewMatrix);"),s.normals&&(c.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),c.push("billboard(modelNormalMatrix2);"),c.push("billboard(viewNormalMatrix2);"),c.push("billboard(modelViewNormalMatrix);")),c.push("worldPosition = modelMatrix2 * localPosition;"),c.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(c.push("worldPosition = modelMatrix2 * localPosition;"),c.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));s.normals&&c.push("vec3 viewNormal = normalize((viewNormalMatrix2 * modelNormalMatrix2 * localNormal).xyz);");if(c.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),c.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),c.push("float lambertian = 1.0;"),s.normals)for(l=0,h=i.lights.length;l<h;l++)if(u=i.lights[l],"ambient"!==u.type){if("dir"===u.type)"view"===u.space?c.push("viewLightDir = normalize(lightDir"+l+");"):c.push("viewLightDir = normalize((viewMatrix2 * vec4(lightDir"+l+", 0.0)).xyz);");else if("point"===u.type)"view"===u.space?c.push("viewLightDir = normalize(lightPos"+l+" - viewPosition.xyz);"):c.push("viewLightDir = normalize((viewMatrix2 * vec4(lightPos"+l+", 0.0)).xyz);");else{if("spot"!==u.type)continue;"view"===u.space?c.push("viewLightDir = normalize(lightDir"+l+");"):c.push("viewLightDir = normalize((viewMatrix2 * vec4(lightDir"+l+", 0.0)).xyz);")}c.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),c.push("reflectedColor += lambertian * (lightColor"+l+".rgb * lightColor"+l+".a);")}c.push("vColor = vec4((reflectedColor * materialColor.rgb), materialColor.a) * colorize;"),o&&c.push("vWorldPosition = worldPosition;");"points"===s.primitiveName&&c.push("gl_PointSize = pointSize;");return c.push("   gl_Position = projMatrix * viewPosition;"),c.push("}"),c}(e),this.fragment=function(e){const t=e.scene,i=t._clipsState,s=(e._material._state,e._geometry._state);let r,a;const o=i.clips.length>0,n=t.gammaOutput,l=[];if(l.push("// Lambertian drawing fragment shader"),l.push("precision lowp float;"),o)for(l.push("varying vec4 vWorldPosition;"),l.push("uniform bool clippable;"),r=0,a=i.clips.length;r<a;r++)l.push("uniform bool clipActive"+r+";"),l.push("uniform vec3 clipPos"+r+";"),l.push("uniform vec3 clipDir"+r+";");l.push("varying vec4 vColor;"),n&&(l.push("uniform float gammaFactor;"),l.push("    vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),l.push("    return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),l.push("}"));if(l.push("void main(void) {"),o){for(l.push("if (clippable) {"),l.push("  float dist = 0.0;"),r=0,a=i.clips.length;r<a;r++)l.push("if (clipActive"+r+") {"),l.push("   dist += clamp(dot(-clipDir"+r+".xyz, vWorldPosition.xyz - clipPos"+r+".xyz), 0.0, 1000.0);"),l.push("}");l.push("  if (dist > 0.0) { discard; }"),l.push("}")}"points"===s.primitiveName&&(l.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),l.push("float r = dot(cxy, cxy);"),l.push("if (r > 1.0) {"),l.push("   discard;"),l.push("}"));n?l.push("gl_FragColor = linearToGamma(vColor, gammaFactor);"):l.push("gl_FragColor = vColor;");return l.push("}"),l}(e)):(this.vertex=function(e){const t=e.scene,i=e._material,s=e._state,r=t._clipsState,a=e._geometry._state,o=(e._material._state,t._lightsState);let n,l,h;const u=s.billboard,c=s.stationary,d=function(e){if(!e._geometry._state.uv)return!1;const t=e._material;return!!(t._ambientMap||t._occlusionMap||t._baseColorMap||t._diffuseMap||t._alphaMap||t._specularMap||t._glossinessMap||t._specularGlossinessMap||t._emissiveMap||t._metallicMap||t._roughnessMap||t._metallicRoughnessMap||t._reflectivityMap||t._normalMap)}(e),p=_e(e),_=r.clips.length>0,m=pe(e),f=!!a.quantized,g=[];p&&i._normalMap&&g.push("#extension GL_OES_standard_derivatives : enable");g.push("// Drawing vertex shader"),g.push("attribute  vec3 position;"),f&&g.push("uniform mat4 positionsDecodeMatrix;");g.push("uniform  mat4 modelMatrix;"),g.push("uniform  mat4 viewMatrix;"),g.push("uniform  mat4 projMatrix;"),g.push("varying  vec3 vViewPosition;"),_&&g.push("varying vec4 vWorldPosition;");o.lightMaps.length>0&&g.push("varying    vec3 vWorldNormal;");if(p){for(g.push("attribute  vec3 normal;"),g.push("uniform    mat4 modelNormalMatrix;"),g.push("uniform    mat4 viewNormalMatrix;"),g.push("varying    vec3 vViewNormal;"),n=0,l=o.lights.length;n<l;n++)h=o.lights[n],"ambient"!==h.type&&("dir"===h.type&&g.push("uniform vec3 lightDir"+n+";"),"point"===h.type&&g.push("uniform vec3 lightPos"+n+";"),"spot"===h.type&&(g.push("uniform vec3 lightPos"+n+";"),g.push("uniform vec3 lightDir"+n+";")),"dir"===h.type&&"view"===h.space||g.push("varying vec4 vViewLightReverseDirAndDist"+n+";"));f&&(g.push("vec3 octDecode(vec2 oct) {"),g.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),g.push("    if (v.z < 0.0) {"),g.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),g.push("    }"),g.push("    return normalize(v);"),g.push("}"))}d&&(g.push("attribute vec2 uv;"),g.push("varying vec2 vUV;"),f&&g.push("uniform mat3 uvDecodeMatrix;"));a.colors&&(g.push("attribute vec4 color;"),g.push("varying vec4 vColor;"));"points"===a.primitiveName&&g.push("uniform float pointSize;");"spherical"!==u&&"cylindrical"!==u||(g.push("void billboard(inout mat4 mat) {"),g.push("   mat[0][0] = 1.0;"),g.push("   mat[0][1] = 0.0;"),g.push("   mat[0][2] = 0.0;"),"spherical"===u&&(g.push("   mat[1][0] = 0.0;"),g.push("   mat[1][1] = 1.0;"),g.push("   mat[1][2] = 0.0;")),g.push("   mat[2][0] = 0.0;"),g.push("   mat[2][1] = 0.0;"),g.push("   mat[2][2] =1.0;"),g.push("}"));m&&g.push("const mat4 texUnitConverter = mat4(0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.5, 0.5, 0.5, 1.0);");g.push("void main(void) {"),g.push("vec4 localPosition = vec4(position, 1.0); "),g.push("vec4 worldPosition;"),f&&g.push("localPosition = positionsDecodeMatrix * localPosition;");p&&(f?g.push("vec4 localNormal = vec4(octDecode(normal.xy), 0.0); "):g.push("vec4 localNormal = vec4(normal, 0.0); "),g.push("mat4 modelNormalMatrix2    = modelNormalMatrix;"),g.push("mat4 viewNormalMatrix2     = viewNormalMatrix;"));g.push("mat4 viewMatrix2           = viewMatrix;"),g.push("mat4 modelMatrix2          = modelMatrix;"),c&&g.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===u||"cylindrical"===u?(g.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),g.push("billboard(modelMatrix2);"),g.push("billboard(viewMatrix2);"),g.push("billboard(modelViewMatrix);"),p&&(g.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),g.push("billboard(modelNormalMatrix2);"),g.push("billboard(viewNormalMatrix2);"),g.push("billboard(modelViewNormalMatrix);")),g.push("worldPosition = modelMatrix2 * localPosition;"),g.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(g.push("worldPosition = modelMatrix2 * localPosition;"),g.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));if(p)for(g.push("vec3 worldNormal = (modelNormalMatrix2 * localNormal).xyz; "),o.lightMaps.length>0&&g.push("vWorldNormal = worldNormal;"),g.push("vViewNormal = normalize((viewNormalMatrix2 * vec4(worldNormal, 1.0)).xyz);"),g.push("vec3 tmpVec3;"),g.push("float lightDist;"),n=0,l=o.lights.length;n<l;n++)h=o.lights[n],"ambient"!==h.type&&("dir"===h.type&&"world"===h.space&&(g.push("tmpVec3 = vec3(viewMatrix2 * vec4(lightDir"+n+", 0.0) ).xyz;"),g.push("vViewLightReverseDirAndDist"+n+" = vec4(-tmpVec3, 0.0);")),"point"===h.type&&("world"===h.space?(g.push("tmpVec3 = (viewMatrix2 * vec4(lightPos"+n+", 1.0)).xyz - viewPosition.xyz;"),g.push("lightDist = abs(length(tmpVec3));")):(g.push("tmpVec3 = lightPos"+n+".xyz - viewPosition.xyz;"),g.push("lightDist = abs(length(tmpVec3));")),g.push("vViewLightReverseDirAndDist"+n+" = vec4(tmpVec3, lightDist);")));d&&(f?g.push("vUV = (uvDecodeMatrix * vec3(uv, 1.0)).xy;"):g.push("vUV = uv;"));a.colors&&g.push("vColor = color;");"points"===a.primitiveName&&g.push("gl_PointSize = pointSize;");_&&g.push("vWorldPosition = worldPosition;");if(g.push("   vViewPosition = viewPosition.xyz;"),g.push("   gl_Position = projMatrix * viewPosition;"),g.push("const mat4 texUnitConverter = mat4(0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.5, 0.5, 0.5, 1.0);"),m)for(g.push("vec4 tempx; "),n=0,l=o.lights.length;n<l;n++)o.lights[n].shadow&&g.push("vShadowPosFromLight"+n+" = texUnitConverter * shadowProjMatrix"+n+" * (shadowViewMatrix"+n+" * worldPosition); ");return g.push("}"),g}(e),this.fragment=function(e){const t=e.scene,i=t.canvas.gl,s=e._material,r=e._geometry._state,a=e.scene._clipsState,o=e.scene._lightsState,n=e._material._state,l=a.clips.length>0,h=_e(e),u=r.uv,c="PhongMaterial"===n.type,d="MetallicMaterial"===n.type,p="SpecularMaterial"===n.type,_=pe(e),m=(t.gammaInput,t.gammaOutput);let f,g;const v=[];v.push("// Fragment vertex shader"),h&&s._normalMap&&v.push("#extension GL_OES_standard_derivatives : enable");v.push("precision "+function(e){if(!e.getShaderPrecisionFormat)return"mediump";if(e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT).precision>0)return"highp";if(e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT).precision>0)return"mediump";return"lowp"}(i)+" float;"),_&&(v.push("float unpackDepth (vec4 color) {"),v.push("  const vec4 bitShift = vec4(1.0, 1.0/256.0, 1.0/(256.0 * 256.0), 1.0/(256.0*256.0*256.0));"),v.push("  return dot(color, bitShift);"),v.push("}"));v.push("uniform float gammaFactor;"),v.push("vec4 linearToLinear( in vec4 value ) {"),v.push("  return value;"),v.push("}"),v.push("vec4 sRGBToLinear( in vec4 value ) {"),v.push("  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );"),v.push("}"),v.push("vec4 gammaToLinear( in vec4 value) {"),v.push("  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );"),v.push("}"),m&&(v.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),v.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),v.push("}"));if(l){v.push("varying vec4 vWorldPosition;"),v.push("uniform bool clippable;");for(var M=0;M<a.clips.length;M++)v.push("uniform bool clipActive"+M+";"),v.push("uniform vec3 clipPos"+M+";"),v.push("uniform vec3 clipDir"+M+";")}h&&(o.lightMaps.length>0&&(v.push("uniform samplerCube lightMap;"),v.push("uniform mat4 viewNormalMatrix;")),o.reflectionMaps.length>0&&v.push("uniform samplerCube reflectionMap;"),(o.lightMaps.length>0||o.reflectionMaps.length>0)&&v.push("uniform mat4 viewMatrix;"),v.push("#define PI 3.14159265359"),v.push("#define RECIPROCAL_PI 0.31830988618"),v.push("#define RECIPROCAL_PI2 0.15915494"),v.push("#define EPSILON 1e-6"),v.push("#define saturate(a) clamp( a, 0.0, 1.0 )"),v.push("vec3 inverseTransformDirection(in vec3 dir, in mat4 matrix) {"),v.push("   return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );"),v.push("}"),v.push("struct IncidentLight {"),v.push("   vec3 color;"),v.push("   vec3 direction;"),v.push("};"),v.push("struct ReflectedLight {"),v.push("   vec3 diffuse;"),v.push("   vec3 specular;"),v.push("};"),v.push("struct Geometry {"),v.push("   vec3 position;"),v.push("   vec3 viewNormal;"),v.push("   vec3 worldNormal;"),v.push("   vec3 viewEyeDir;"),v.push("};"),v.push("struct Material {"),v.push("   vec3    diffuseColor;"),v.push("   float   specularRoughness;"),v.push("   vec3    specularColor;"),v.push("   float   shine;"),v.push("};"),c&&((o.lightMaps.length>0||o.reflectionMaps.length>0)&&(v.push("void computePhongLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),o.lightMaps.length>0&&(v.push("   vec3 irradiance = "+de[o.lightMaps[0].encoding]+"(textureCube(lightMap, geometry.worldNormal)).rgb;"),v.push("   irradiance *= PI;"),v.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),v.push("   reflectedLight.diffuse += irradiance * diffuseBRDFContrib;")),o.reflectionMaps.length>0&&(v.push("   vec3 reflectVec             = reflect(-geometry.viewEyeDir, geometry.viewNormal);"),v.push("   vec3 radiance               = textureCube(reflectionMap, reflectVec).rgb * 0.2;"),v.push("   reflectedLight.specular     += radiance;")),v.push("}")),v.push("void computePhongLighting(const in IncidentLight directLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),v.push("   float dotNL     = saturate(dot(geometry.viewNormal, directLight.direction));"),v.push("   vec3 irradiance = dotNL * directLight.color * PI;"),v.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),v.push("   reflectedLight.specular += directLight.color * material.specularColor * pow(max(dot(reflect(-directLight.direction, -geometry.viewNormal), geometry.viewEyeDir), 0.0), material.shine);"),v.push("}")),(d||p)&&(v.push("float GGXRoughnessToBlinnExponent(const in float ggxRoughness) {"),v.push("   float r = ggxRoughness + 0.0001;"),v.push("   return (2.0 / (r * r) - 2.0);"),v.push("}"),v.push("float getSpecularMIPLevel(const in float blinnShininessExponent, const in int maxMIPLevel) {"),v.push("   float maxMIPLevelScalar = float( maxMIPLevel );"),v.push("   float desiredMIPLevel = maxMIPLevelScalar - 0.79248 - 0.5 * log2( ( blinnShininessExponent * blinnShininessExponent ) + 1.0 );"),v.push("   return clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );"),v.push("}"),o.reflectionMaps.length>0&&(v.push("vec3 getLightProbeIndirectRadiance(const in vec3 reflectVec, const in float blinnShininessExponent, const in int maxMIPLevel) {"),v.push("   float mipLevel = 0.5 * getSpecularMIPLevel(blinnShininessExponent, maxMIPLevel);"),v.push("   vec3 envMapColor = "+de[o.reflectionMaps[0].encoding]+"(textureCube(reflectionMap, reflectVec, mipLevel)).rgb;"),v.push("  return envMapColor;"),v.push("}")),v.push("vec3 F_Schlick(const in vec3 specularColor, const in float dotLH) {"),v.push("   float fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );"),v.push("   return ( 1.0 - specularColor ) * fresnel + specularColor;"),v.push("}"),v.push("float G_GGX_Smith(const in float alpha, const in float dotNL, const in float dotNV) {"),v.push("   float a2 = ( alpha * alpha );"),v.push("   float gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),v.push("   float gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),v.push("   return 1.0 / ( gl * gv );"),v.push("}"),v.push("float G_GGX_SmithCorrelated(const in float alpha, const in float dotNL, const in float dotNV) {"),v.push("   float a2 = ( alpha * alpha );"),v.push("   float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),v.push("   float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),v.push("   return 0.5 / max( gv + gl, EPSILON );"),v.push("}"),v.push("float D_GGX(const in float alpha, const in float dotNH) {"),v.push("   float a2 = ( alpha * alpha );"),v.push("   float denom = ( dotNH * dotNH) * ( a2 - 1.0 ) + 1.0;"),v.push("   return RECIPROCAL_PI * a2 / ( denom * denom);"),v.push("}"),v.push("vec3 BRDF_Specular_GGX(const in IncidentLight incidentLight, const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),v.push("   float alpha = ( roughness * roughness );"),v.push("   vec3 halfDir = normalize( incidentLight.direction + geometry.viewEyeDir );"),v.push("   float dotNL = saturate( dot( geometry.viewNormal, incidentLight.direction ) );"),v.push("   float dotNV = saturate( dot( geometry.viewNormal, geometry.viewEyeDir ) );"),v.push("   float dotNH = saturate( dot( geometry.viewNormal, halfDir ) );"),v.push("   float dotLH = saturate( dot( incidentLight.direction, halfDir ) );"),v.push("   vec3  F = F_Schlick( specularColor, dotLH );"),v.push("   float G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );"),v.push("   float D = D_GGX( alpha, dotNH );"),v.push("   return F * (G * D);"),v.push("}"),v.push("vec3 BRDF_Specular_GGX_Environment(const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),v.push("   float dotNV = saturate(dot(geometry.viewNormal, geometry.viewEyeDir));"),v.push("   const vec4 c0 = vec4( -1, -0.0275, -0.572,  0.022);"),v.push("   const vec4 c1 = vec4(  1,  0.0425,   1.04, -0.04);"),v.push("   vec4 r = roughness * c0 + c1;"),v.push("   float a004 = min(r.x * r.x, exp2(-9.28 * dotNV)) * r.x + r.y;"),v.push("   vec2 AB    = vec2(-1.04, 1.04) * a004 + r.zw;"),v.push("   return specularColor * AB.x + AB.y;"),v.push("}"),(o.lightMaps.length>0||o.reflectionMaps.length>0)&&(v.push("void computePBRLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),o.lightMaps.length>0&&(v.push("   vec3 irradiance = sRGBToLinear(textureCube(lightMap, geometry.worldNormal)).rgb;"),v.push("   irradiance *= PI;"),v.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),v.push("   reflectedLight.diffuse += irradiance * diffuseBRDFContrib;")),o.reflectionMaps.length>0&&(v.push("   vec3 reflectVec             = reflect(-geometry.viewEyeDir, geometry.viewNormal);"),v.push("   reflectVec                  = inverseTransformDirection(reflectVec, viewMatrix);"),v.push("   float blinnExpFromRoughness = GGXRoughnessToBlinnExponent(material.specularRoughness);"),v.push("   vec3 radiance               = getLightProbeIndirectRadiance(reflectVec, blinnExpFromRoughness, 8);"),v.push("   vec3 specularBRDFContrib    = BRDF_Specular_GGX_Environment(geometry, material.specularColor, material.specularRoughness);"),v.push("   reflectedLight.specular     += radiance * specularBRDFContrib;")),v.push("}")),v.push("void computePBRLighting(const in IncidentLight incidentLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),v.push("   float dotNL     = saturate(dot(geometry.viewNormal, incidentLight.direction));"),v.push("   vec3 irradiance = dotNL * incidentLight.color * PI;"),v.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),v.push("   reflectedLight.specular += irradiance * BRDF_Specular_GGX(incidentLight, geometry, material.specularColor, material.specularRoughness);"),v.push("}")));v.push("varying vec3 vViewPosition;"),r.colors&&v.push("varying vec4 vColor;");u&&(h&&s._normalMap||s._ambientMap||s._baseColorMap||s._diffuseMap||s._emissiveMap||s._metallicMap||s._roughnessMap||s._metallicRoughnessMap||s._specularMap||s._glossinessMap||s._specularGlossinessMap||s._occlusionMap||s._alphaMap)&&v.push("varying vec2 vUV;");h&&(o.lightMaps.length>0&&v.push("varying vec3 vWorldNormal;"),v.push("varying vec3 vViewNormal;"));n.ambient&&v.push("uniform vec3 materialAmbient;");n.baseColor&&v.push("uniform vec3 materialBaseColor;");void 0!==n.alpha&&null!==n.alpha&&v.push("uniform vec4 materialAlphaModeCutoff;");n.emissive&&v.push("uniform vec3 materialEmissive;");n.diffuse&&v.push("uniform vec3 materialDiffuse;");void 0!==n.glossiness&&null!==n.glossiness&&v.push("uniform float materialGlossiness;");void 0!==n.shininess&&null!==n.shininess&&v.push("uniform float materialShininess;");n.specular&&v.push("uniform vec3 materialSpecular;");void 0!==n.metallic&&null!==n.metallic&&v.push("uniform float materialMetallic;");void 0!==n.roughness&&null!==n.roughness&&v.push("uniform float materialRoughness;");void 0!==n.specularF0&&null!==n.specularF0&&v.push("uniform float materialSpecularF0;");u&&s._ambientMap&&(v.push("uniform sampler2D ambientMap;"),s._ambientMap._state.matrix&&v.push("uniform mat4 ambientMapMatrix;"));u&&s._baseColorMap&&(v.push("uniform sampler2D baseColorMap;"),s._baseColorMap._state.matrix&&v.push("uniform mat4 baseColorMapMatrix;"));u&&s._diffuseMap&&(v.push("uniform sampler2D diffuseMap;"),s._diffuseMap._state.matrix&&v.push("uniform mat4 diffuseMapMatrix;"));u&&s._emissiveMap&&(v.push("uniform sampler2D emissiveMap;"),s._emissiveMap._state.matrix&&v.push("uniform mat4 emissiveMapMatrix;"));h&&u&&s._metallicMap&&(v.push("uniform sampler2D metallicMap;"),s._metallicMap._state.matrix&&v.push("uniform mat4 metallicMapMatrix;"));h&&u&&s._roughnessMap&&(v.push("uniform sampler2D roughnessMap;"),s._roughnessMap._state.matrix&&v.push("uniform mat4 roughnessMapMatrix;"));h&&u&&s._metallicRoughnessMap&&(v.push("uniform sampler2D metallicRoughnessMap;"),s._metallicRoughnessMap._state.matrix&&v.push("uniform mat4 metallicRoughnessMapMatrix;"));h&&s._normalMap&&(v.push("uniform sampler2D normalMap;"),s._normalMap._state.matrix&&v.push("uniform mat4 normalMapMatrix;"),v.push("vec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm, vec2 uv ) {"),v.push("      vec3 q0 = vec3( dFdx( eye_pos.x ), dFdx( eye_pos.y ), dFdx( eye_pos.z ) );"),v.push("      vec3 q1 = vec3( dFdy( eye_pos.x ), dFdy( eye_pos.y ), dFdy( eye_pos.z ) );"),v.push("      vec2 st0 = dFdx( uv.st );"),v.push("      vec2 st1 = dFdy( uv.st );"),v.push("      vec3 S = normalize( q0 * st1.t - q1 * st0.t );"),v.push("      vec3 T = normalize( -q0 * st1.s + q1 * st0.s );"),v.push("      vec3 N = normalize( surf_norm );"),v.push("      vec3 mapN = texture2D( normalMap, uv ).xyz * 2.0 - 1.0;"),v.push("      mat3 tsn = mat3( S, T, N );"),v.push("      return normalize( tsn * mapN );"),v.push("}"));u&&s._occlusionMap&&(v.push("uniform sampler2D occlusionMap;"),s._occlusionMap._state.matrix&&v.push("uniform mat4 occlusionMapMatrix;"));u&&s._alphaMap&&(v.push("uniform sampler2D alphaMap;"),s._alphaMap._state.matrix&&v.push("uniform mat4 alphaMapMatrix;"));h&&u&&s._specularMap&&(v.push("uniform sampler2D specularMap;"),s._specularMap._state.matrix&&v.push("uniform mat4 specularMapMatrix;"));h&&u&&s._glossinessMap&&(v.push("uniform sampler2D glossinessMap;"),s._glossinessMap._state.matrix&&v.push("uniform mat4 glossinessMapMatrix;"));h&&u&&s._specularGlossinessMap&&(v.push("uniform sampler2D materialSpecularGlossinessMap;"),s._specularGlossinessMap._state.matrix&&v.push("uniform mat4 materialSpecularGlossinessMapMatrix;"));h&&(s._diffuseFresnel||s._specularFresnel||s._alphaFresnel||s._emissiveFresnel||s._reflectivityFresnel)&&(v.push("float fresnel(vec3 eyeDir, vec3 normal, float edgeBias, float centerBias, float power) {"),v.push("    float fr = abs(dot(eyeDir, normal));"),v.push("    float finalFr = clamp((fr - edgeBias) / (centerBias - edgeBias), 0.0, 1.0);"),v.push("    return pow(finalFr, power);"),v.push("}"),s._diffuseFresnel&&(v.push("uniform float  diffuseFresnelCenterBias;"),v.push("uniform float  diffuseFresnelEdgeBias;"),v.push("uniform float  diffuseFresnelPower;"),v.push("uniform vec3   diffuseFresnelCenterColor;"),v.push("uniform vec3   diffuseFresnelEdgeColor;")),s._specularFresnel&&(v.push("uniform float  specularFresnelCenterBias;"),v.push("uniform float  specularFresnelEdgeBias;"),v.push("uniform float  specularFresnelPower;"),v.push("uniform vec3   specularFresnelCenterColor;"),v.push("uniform vec3   specularFresnelEdgeColor;")),s._alphaFresnel&&(v.push("uniform float  alphaFresnelCenterBias;"),v.push("uniform float  alphaFresnelEdgeBias;"),v.push("uniform float  alphaFresnelPower;"),v.push("uniform vec3   alphaFresnelCenterColor;"),v.push("uniform vec3   alphaFresnelEdgeColor;")),s._reflectivityFresnel&&(v.push("uniform float  materialSpecularF0FresnelCenterBias;"),v.push("uniform float  materialSpecularF0FresnelEdgeBias;"),v.push("uniform float  materialSpecularF0FresnelPower;"),v.push("uniform vec3   materialSpecularF0FresnelCenterColor;"),v.push("uniform vec3   materialSpecularF0FresnelEdgeColor;")),s._emissiveFresnel&&(v.push("uniform float  emissiveFresnelCenterBias;"),v.push("uniform float  emissiveFresnelEdgeBias;"),v.push("uniform float  emissiveFresnelPower;"),v.push("uniform vec3   emissiveFresnelCenterColor;"),v.push("uniform vec3   emissiveFresnelEdgeColor;")));if(v.push("uniform vec4   lightAmbient;"),h)for(M=0,f=o.lights.length;M<f;M++)g=o.lights[M],"ambient"!==g.type&&(v.push("uniform vec4 lightColor"+M+";"),"point"===g.type&&v.push("uniform vec3 lightAttenuation"+M+";"),"dir"===g.type&&"view"===g.space&&v.push("uniform vec3 lightDir"+M+";"),"point"===g.type&&"view"===g.space?v.push("uniform vec3 lightPos"+M+";"):v.push("varying vec4 vViewLightReverseDirAndDist"+M+";"));if(_)for(M=0,f=o.lights.length;M<f;M++)o.lights[M].shadow&&(v.push("varying vec4 vShadowPosFromLight"+M+";"),v.push("uniform sampler2D shadowMap"+M+";"));if(v.push("uniform vec4 colorize;"),v.push("void main(void) {"),l){v.push("if (clippable) {"),v.push("  float dist = 0.0;");for(M=0;M<a.clips.length;M++)v.push("if (clipActive"+M+") {"),v.push("   dist += clamp(dot(-clipDir"+M+".xyz, vWorldPosition.xyz - clipPos"+M+".xyz), 0.0, 1000.0);"),v.push("}");v.push("  if (dist > 0.0) { discard; }"),v.push("}")}"points"===r.primitiveName&&(v.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),v.push("float r = dot(cxy, cxy);"),v.push("if (r > 1.0) {"),v.push("   discard;"),v.push("}"));v.push("float occlusion = 1.0;"),n.ambient?v.push("vec3 ambientColor = materialAmbient;"):v.push("vec3 ambientColor = vec3(1.0, 1.0, 1.0);");n.diffuse?v.push("vec3 diffuseColor = materialDiffuse;"):n.baseColor?v.push("vec3 diffuseColor = materialBaseColor;"):v.push("vec3 diffuseColor = vec3(1.0, 1.0, 1.0);");r.colors&&v.push("diffuseColor *= vColor.rgb;");n.emissive?v.push("vec3 emissiveColor = materialEmissive;"):v.push("vec3  emissiveColor = vec3(0.0, 0.0, 0.0);");n.specular?v.push("vec3 specular = materialSpecular;"):v.push("vec3 specular = vec3(1.0, 1.0, 1.0);");void 0!==n.alpha?v.push("float alpha = materialAlphaModeCutoff[0];"):v.push("float alpha = 1.0;");r.colors&&v.push("alpha *= vColor.a;");void 0!==n.glossiness?v.push("float glossiness = materialGlossiness;"):v.push("float glossiness = 1.0;");void 0!==n.metallic?v.push("float metallic = materialMetallic;"):v.push("float metallic = 1.0;");void 0!==n.roughness?v.push("float roughness = materialRoughness;"):v.push("float roughness = 1.0;");void 0!==n.specularF0?v.push("float specularF0 = materialSpecularF0;"):v.push("float specularF0 = 1.0;");u&&(h&&s._normalMap||s._ambientMap||s._baseColorMap||s._diffuseMap||s._occlusionMap||s._emissiveMap||s._metallicMap||s._roughnessMap||s._metallicRoughnessMap||s._specularMap||s._glossinessMap||s._specularGlossinessMap||s._alphaMap)&&(v.push("vec4 texturePos = vec4(vUV.s, vUV.t, 1.0, 1.0);"),v.push("vec2 textureCoord;"));u&&s._ambientMap&&(s._ambientMap._state.matrix?v.push("textureCoord = (ambientMapMatrix * texturePos).xy;"):v.push("textureCoord = texturePos.xy;"),v.push("vec4 ambientTexel = texture2D(ambientMap, textureCoord).rgb;"),v.push("ambientTexel = "+de[s._ambientMap._state.encoding]+"(ambientTexel);"),v.push("ambientColor *= ambientTexel.rgb;"));u&&s._diffuseMap&&(s._diffuseMap._state.matrix?v.push("textureCoord = (diffuseMapMatrix * texturePos).xy;"):v.push("textureCoord = texturePos.xy;"),v.push("vec4 diffuseTexel = texture2D(diffuseMap, textureCoord);"),v.push("diffuseTexel = "+de[s._diffuseMap._state.encoding]+"(diffuseTexel);"),v.push("diffuseColor *= diffuseTexel.rgb;"),v.push("alpha *= diffuseTexel.a;"));u&&s._baseColorMap&&(s._baseColorMap._state.matrix?v.push("textureCoord = (baseColorMapMatrix * texturePos).xy;"):v.push("textureCoord = texturePos.xy;"),v.push("vec4 baseColorTexel = texture2D(baseColorMap, textureCoord);"),v.push("baseColorTexel = "+de[s._baseColorMap._state.encoding]+"(baseColorTexel);"),v.push("diffuseColor *= baseColorTexel.rgb;"),v.push("alpha *= baseColorTexel.a;"));u&&s._emissiveMap&&(s._emissiveMap._state.matrix?v.push("textureCoord = (emissiveMapMatrix * texturePos).xy;"):v.push("textureCoord = texturePos.xy;"),v.push("vec4 emissiveTexel = texture2D(emissiveMap, textureCoord);"),v.push("emissiveTexel = "+de[s._emissiveMap._state.encoding]+"(emissiveTexel);"),v.push("emissiveColor *= emissiveTexel.rgb;"));u&&s._alphaMap&&(s._alphaMap._state.matrix?v.push("textureCoord = (alphaMapMatrix * texturePos).xy;"):v.push("textureCoord = texturePos.xy;"),v.push("alpha *= texture2D(alphaMap, textureCoord).r;"));u&&s._occlusionMap&&(s._occlusionMap._state.matrix?v.push("textureCoord = (occlusionMapMatrix * texturePos).xy;"):v.push("textureCoord = texturePos.xy;"),v.push("occlusion *= texture2D(occlusionMap, textureCoord).r;"));if(h&&(o.lights.length>0||o.lightMaps.length>0||o.reflectionMaps.length>0)){for(u&&s._normalMap?(s._normalMap._state.matrix?v.push("textureCoord = (normalMapMatrix * texturePos).xy;"):v.push("textureCoord = texturePos.xy;"),v.push("vec3 viewNormal = perturbNormal2Arb( vViewPosition, normalize(vViewNormal), textureCoord );")):v.push("vec3 viewNormal = normalize(vViewNormal);"),u&&s._specularMap&&(s._specularMap._state.matrix?v.push("textureCoord = (specularMapMatrix * texturePos).xy;"):v.push("textureCoord = texturePos.xy;"),v.push("specular *= texture2D(specularMap, textureCoord).rgb;")),u&&s._glossinessMap&&(s._glossinessMap._state.matrix?v.push("textureCoord = (glossinessMapMatrix * texturePos).xy;"):v.push("textureCoord = texturePos.xy;"),v.push("glossiness *= texture2D(glossinessMap, textureCoord).r;")),u&&s._specularGlossinessMap&&(s._specularGlossinessMap._state.matrix?v.push("textureCoord = (materialSpecularGlossinessMapMatrix * texturePos).xy;"):v.push("textureCoord = texturePos.xy;"),v.push("vec4 specGlossRGB = texture2D(materialSpecularGlossinessMap, textureCoord).rgba;"),v.push("specular *= specGlossRGB.rgb;"),v.push("glossiness *= specGlossRGB.a;")),u&&s._metallicMap&&(s._metallicMap._state.matrix?v.push("textureCoord = (metallicMapMatrix * texturePos).xy;"):v.push("textureCoord = texturePos.xy;"),v.push("metallic *= texture2D(metallicMap, textureCoord).r;")),u&&s._roughnessMap&&(s._roughnessMap._state.matrix?v.push("textureCoord = (roughnessMapMatrix * texturePos).xy;"):v.push("textureCoord = texturePos.xy;"),v.push("roughness *= texture2D(roughnessMap, textureCoord).r;")),u&&s._metallicRoughnessMap&&(s._metallicRoughnessMap._state.matrix?v.push("textureCoord = (metallicRoughnessMapMatrix * texturePos).xy;"):v.push("textureCoord = texturePos.xy;"),v.push("vec3 metalRoughRGB = texture2D(metallicRoughnessMap, textureCoord).rgb;"),v.push("metallic *= metalRoughRGB.b;"),v.push("roughness *= metalRoughRGB.g;")),v.push("vec3 viewEyeDir = normalize(-vViewPosition);"),s._diffuseFresnel&&(v.push("float diffuseFresnel = fresnel(viewEyeDir, viewNormal, diffuseFresnelEdgeBias, diffuseFresnelCenterBias, diffuseFresnelPower);"),v.push("diffuseColor *= mix(diffuseFresnelEdgeColor, diffuseFresnelCenterColor, diffuseFresnel);")),s._specularFresnel&&(v.push("float specularFresnel = fresnel(viewEyeDir, viewNormal, specularFresnelEdgeBias, specularFresnelCenterBias, specularFresnelPower);"),v.push("specular *= mix(specularFresnelEdgeColor, specularFresnelCenterColor, specularFresnel);")),s._alphaFresnel&&(v.push("float alphaFresnel = fresnel(viewEyeDir, viewNormal, alphaFresnelEdgeBias, alphaFresnelCenterBias, alphaFresnelPower);"),v.push("alpha *= mix(alphaFresnelEdgeColor.r, alphaFresnelCenterColor.r, alphaFresnel);")),s._emissiveFresnel&&(v.push("float emissiveFresnel = fresnel(viewEyeDir, viewNormal, emissiveFresnelEdgeBias, emissiveFresnelCenterBias, emissiveFresnelPower);"),v.push("emissiveColor *= mix(emissiveFresnelEdgeColor, emissiveFresnelCenterColor, emissiveFresnel);")),v.push("if (materialAlphaModeCutoff[1] == 1.0 && alpha < materialAlphaModeCutoff[2]) {"),v.push("   discard;"),v.push("}"),v.push("IncidentLight  light;"),v.push("Material       material;"),v.push("Geometry       geometry;"),v.push("ReflectedLight reflectedLight = ReflectedLight(vec3(0.0,0.0,0.0), vec3(0.0,0.0,0.0));"),v.push("vec3           viewLightDir;"),c&&(v.push("material.diffuseColor      = diffuseColor;"),v.push("material.specularColor     = specular;"),v.push("material.shine             = materialShininess;")),p&&(v.push("float oneMinusSpecularStrength = 1.0 - max(max(specular.r, specular.g ),specular.b);"),v.push("material.diffuseColor      = diffuseColor * oneMinusSpecularStrength;"),v.push("material.specularRoughness = clamp( 1.0 - glossiness, 0.04, 1.0 );"),v.push("material.specularColor     = specular;")),d&&(v.push("float dielectricSpecular = 0.16 * specularF0 * specularF0;"),v.push("material.diffuseColor      = diffuseColor * (1.0 - dielectricSpecular) * (1.0 - metallic);"),v.push("material.specularRoughness = clamp(roughness, 0.04, 1.0);"),v.push("material.specularColor     = mix(vec3(dielectricSpecular), diffuseColor, metallic);")),v.push("geometry.position      = vViewPosition;"),o.lightMaps.length>0&&v.push("geometry.worldNormal   = normalize(vWorldNormal);"),v.push("geometry.viewNormal    = viewNormal;"),v.push("geometry.viewEyeDir    = viewEyeDir;"),c&&(o.lightMaps.length>0||o.reflectionMaps.length>0)&&v.push("computePhongLightMapping(geometry, material, reflectedLight);"),(p||d)&&(o.lightMaps.length>0||o.reflectionMaps.length>0)&&v.push("computePBRLightMapping(geometry, material, reflectedLight);"),v.push("float shadow = 1.0;"),v.push("float shadowAcneRemover = 0.0007;"),v.push("vec3 fragmentDepth;"),v.push("float texelSize = 1.0 / 1024.0;"),v.push("float amountInLight = 0.0;"),v.push("vec3 shadowCoord;"),v.push("vec4 rgbaDepth;"),v.push("float depth;"),M=0,f=o.lights.length;M<f;M++)g=o.lights[M],"ambient"!==g.type&&("dir"===g.type&&"view"===g.space?v.push("viewLightDir = -normalize(lightDir"+M+");"):"point"===g.type&&"view"===g.space?v.push("viewLightDir = normalize(lightPos"+M+" - vViewPosition);"):v.push("viewLightDir = normalize(vViewLightReverseDirAndDist"+M+".xyz);"),_&&g.shadow?(v.push("shadow = 0.0;"),v.push("fragmentDepth = vShadowPosFromLight"+M+".xyz;"),v.push("fragmentDepth.z -= shadowAcneRemover;"),v.push("for (int x = -3; x <= 3; x++) {"),v.push("  for (int y = -3; y <= 3; y++) {"),v.push("      float texelDepth = unpackDepth(texture2D(shadowMap"+M+", fragmentDepth.xy + vec2(x, y) * texelSize));"),v.push("      if (fragmentDepth.z < texelDepth) {"),v.push("          shadow += 1.0;"),v.push("      }"),v.push("  }"),v.push("}"),v.push("light.color =  lightColor"+M+".rgb * (lightColor"+M+".a * (shadow / 49.0));")):v.push("light.color =  lightColor"+M+".rgb * (lightColor"+M+".a );"),v.push("light.direction = viewLightDir;"),c&&v.push("computePhongLighting(light, geometry, material, reflectedLight);"),(p||d)&&v.push("computePBRLighting(light, geometry, material, reflectedLight);"));c?(v.push("ambientColor *= (lightAmbient.rgb * lightAmbient.a);"),v.push("vec3 outgoingLight =  ((occlusion * (( reflectedLight.diffuse + reflectedLight.specular)))) + emissiveColor;")):v.push("vec3 outgoingLight = (occlusion * (reflectedLight.diffuse)) + (shadow * occlusion * reflectedLight.specular) + emissiveColor;")}else v.push("ambientColor *= (lightAmbient.rgb * lightAmbient.a);"),v.push("vec3 outgoingLight = emissiveColor + ambientColor;");v.push("gl_FragColor = vec4(outgoingLight, alpha) * colorize;"),m&&v.push("gl_FragColor = linearToGamma(gl_FragColor, gammaFactor);");return v.push("}"),v}(e))},de={linear:"linearToLinear",sRGB:"sRGBToLinear",gamma:"gammaToLinear"};function pe(e){if(!e._state.receiveShadow)return!1;const t=e.scene._lightsState.lights;if(!t||0===t.length)return!1;for(let e=0,i=t.length;e<i;e++)if(t[e].shadow)return!0;return!1}function _e(e){const t=e._geometry._state.primitiveName;return!(!e._geometry._state.autoVertexNormals&&!e._geometry._state.normals||"triangles"!==t&&"triangle-strip"!==t&&"triangle-fan"!==t)}class me{constructor(e,t,i){if(this.allocated=!1,this.compiled=!1,this.handle=e.createShader(t),this.handle){if(this.allocated=!0,e.shaderSource(this.handle,i),e.compileShader(this.handle),this.compiled=e.getShaderParameter(this.handle,e.COMPILE_STATUS),!this.compiled&&!e.isContextLost()){const t=i.split("\n"),s=[];for(let e=0;e<t.length;e++)s.push(e+1+": "+t[e]+"\n");this.errors=[],this.errors.push(""),this.errors.push(e.getShaderInfoLog(this.handle)),this.errors=this.errors.concat(s.join(""))}}else this.errors=["Failed to allocate"]}destroy(){}}class fe{constructor(e,t){this.bindTexture=function(i,s){return!!i.bind(s)&&(e.uniform1i(t,s),!0)}}}class ge{constructor(e,t){this._gl=e,this.location=t}bindArrayBuffer(e,t){e&&(e.bind(),this._gl.enableVertexAttribArray(this.location),this._gl.vertexAttribPointer(this.location,t===this._gl.BYTE?2:e.itemSize,t||this._gl.FLOAT,t===this._gl.BYTE,0,0))}}const ve=new s({});function Me(e){const t=[];let i,s;for(let r=0,a=e.length;r<a;r++)i=e[r],s=i.indexOf("/"),s>0&&"/"===i.charAt(s+1)&&(i=i.substring(0,s)),t.push(i);return t.join("\n")}class ye{constructor(e,t){this.id=ve.addItem({}),this.source=t,this.init(e)}init(e){if(this.gl=e,this.allocated=!1,this.compiled=!1,this.linked=!1,this.validated=!1,this.errors=null,this.uniforms={},this.samplers={},this.attributes={},this._vertexShader=new me(e,e.VERTEX_SHADER,Me(this.source.vertex)),this._fragmentShader=new me(e,e.FRAGMENT_SHADER,Me(this.source.fragment)),!this._vertexShader.allocated)return void(this.errors=["Vertex shader failed to allocate"].concat(this._vertexShader.errors));if(!this._fragmentShader.allocated)return void(this.errors=["Fragment shader failed to allocate"].concat(this._fragmentShader.errors));if(this.allocated=!0,!this._vertexShader.compiled)return void(this.errors=["Vertex shader failed to compile"].concat(this._vertexShader.errors));if(!this._fragmentShader.compiled)return void(this.errors=["Fragment shader failed to compile"].concat(this._fragmentShader.errors));let t,i,s,r,a;if(this.compiled=!0,this.handle=e.createProgram(),!this.handle)return void(this.errors=["Failed to allocate program"]);if(e.attachShader(this.handle,this._vertexShader.handle),e.attachShader(this.handle,this._fragmentShader.handle),e.linkProgram(this.handle),this.linked=e.getProgramParameter(this.handle,e.LINK_STATUS),this.validated=!0,!this.linked||!this.validated)return this.errors=[],this.errors.push(""),this.errors.push(e.getProgramInfoLog(this.handle)),this.errors.push("\nVertex shader:\n"),this.errors=this.errors.concat(shaderSource.vertex),this.errors.push("\nFragment shader:\n"),void(this.errors=this.errors.concat(shaderSource.fragment));const o=e.getProgramParameter(this.handle,e.ACTIVE_UNIFORMS);for(i=0;i<o;++i)s=e.getActiveUniform(this.handle,i),s&&(r=s.name,"\0"===r[r.length-1]&&(r=r.substr(0,r.length-1)),a=e.getUniformLocation(this.handle,r),s.type===e.SAMPLER_2D||s.type===e.SAMPLER_CUBE||35682===s.type?this.samplers[r]=new fe(e,a):this.uniforms[r]=a);const n=e.getProgramParameter(this.handle,e.ACTIVE_ATTRIBUTES);for(i=0;i<n;i++)t=e.getActiveAttrib(this.handle,i),t&&(a=e.getAttribLocation(this.handle,t.name),this.attributes[t.name]=new ge(e,a));this.allocated=!0}bind(){this.allocated&&this.gl.useProgram(this.handle)}getLocation(e){if(this.allocated)return this.uniforms[e]}getAttribute(e){if(this.allocated)return this.attributes[e]}bindTexture(e,t,i){if(!this.allocated)return!1;const s=this.samplers[e];return!!s&&s.bindTexture(t,i)}destroy(){this.allocated&&(ve.removeItem(this.id),this.gl.deleteProgram(this.handle),this.gl.deleteShader(this._vertexShader.handle),this.gl.deleteShader(this._fragmentShader.handle),this.handle=null,this.attributes=null,this.uniforms=null,this.samplers=null,this.allocated=!1)}}const xe=new s({}),be=function(e,t){this.id=xe.addItem({}),this._hash=e,this._scene=t.scene,this._useCount=0,this._shaderSource=new ce(t),this._allocate(t)},we={};be.get=function(e){const t=e.scene,i=[t.canvas.canvas.id,(t.gammaInput?"gi;":";")+(t.gammaOutput?"go":""),t._lightsState.getHash(),t._clipsState.getHash(),e._geometry._state.hash,e._material._state.hash,e._state.hash].join(";");let s=we[i];if(!s){if(s=new be(i,e),s.errors)return console.log(s.errors.join("\n")),null;we[i]=s,r.memory.programs++}return s._useCount++,s},be.prototype.put=function(){0==--this._useCount&&(xe.removeItem(this.id),this._program&&this._program.destroy(),delete we[this._hash],r.memory.programs--)},be.prototype.webglContextRestored=function(){this._program=null},be.prototype.drawMesh=function(e,t){this._program||this._allocate(t);const i=b.MAX_TEXTURE_UNITS,s=t.scene,r=t._material,a=s.canvas.gl,o=this._program,n=t._state,l=t._material._state,h=t._geometry._state;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),l.id!==this._lastMaterialId){e.textureUnit=this._baseTextureUnit;const t=l.backfaces;e.backfaces!==t&&(t?a.disable(a.CULL_FACE):a.enable(a.CULL_FACE),e.backfaces=t);const s=l.frontface;switch(e.frontface!==s&&(s?a.frontFace(a.CCW):a.frontFace(a.CW),e.frontface=s),e.lineWidth!==l.lineWidth&&(a.lineWidth(l.lineWidth),e.lineWidth=l.lineWidth),this._uPointSize&&a.uniform1f(this._uPointSize,l.pointSize),l.type){case"LambertMaterial":this._uMaterialAmbient&&a.uniform3fv(this._uMaterialAmbient,l.ambient),this._uMaterialColor&&a.uniform4f(this._uMaterialColor,l.color[0],l.color[1],l.color[2],l.alpha),this._uMaterialEmissive&&a.uniform3fv(this._uMaterialEmissive,l.emissive);break;case"PhongMaterial":this._uMaterialShininess&&a.uniform1f(this._uMaterialShininess,l.shininess),this._uMaterialAmbient&&a.uniform3fv(this._uMaterialAmbient,l.ambient),this._uMaterialDiffuse&&a.uniform3fv(this._uMaterialDiffuse,l.diffuse),this._uMaterialSpecular&&a.uniform3fv(this._uMaterialSpecular,l.specular),this._uMaterialEmissive&&a.uniform3fv(this._uMaterialEmissive,l.emissive),this._uAlphaModeCutoff&&a.uniform4f(this._uAlphaModeCutoff,1*l.alpha,1===l.alphaMode?1:0,l.alphaCutoff,0),r._ambientMap&&r._ambientMap._state.texture&&this._uMaterialAmbientMap&&(o.bindTexture(this._uMaterialAmbientMap,r._ambientMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uMaterialAmbientMapMatrix&&a.uniformMatrix4fv(this._uMaterialAmbientMapMatrix,!1,r._ambientMap._state.matrix)),r._diffuseMap&&r._diffuseMap._state.texture&&this._uDiffuseMap&&(o.bindTexture(this._uDiffuseMap,r._diffuseMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uDiffuseMapMatrix&&a.uniformMatrix4fv(this._uDiffuseMapMatrix,!1,r._diffuseMap._state.matrix)),r._specularMap&&r._specularMap._state.texture&&this._uSpecularMap&&(o.bindTexture(this._uSpecularMap,r._specularMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uSpecularMapMatrix&&a.uniformMatrix4fv(this._uSpecularMapMatrix,!1,r._specularMap._state.matrix)),r._emissiveMap&&r._emissiveMap._state.texture&&this._uEmissiveMap&&(o.bindTexture(this._uEmissiveMap,r._emissiveMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uEmissiveMapMatrix&&a.uniformMatrix4fv(this._uEmissiveMapMatrix,!1,r._emissiveMap._state.matrix)),r._alphaMap&&r._alphaMap._state.texture&&this._uAlphaMap&&(o.bindTexture(this._uAlphaMap,r._alphaMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uAlphaMapMatrix&&a.uniformMatrix4fv(this._uAlphaMapMatrix,!1,r._alphaMap._state.matrix)),r._reflectivityMap&&r._reflectivityMap._state.texture&&this._uReflectivityMap&&(o.bindTexture(this._uReflectivityMap,r._reflectivityMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,this._uReflectivityMapMatrix&&a.uniformMatrix4fv(this._uReflectivityMapMatrix,!1,r._reflectivityMap._state.matrix)),r._normalMap&&r._normalMap._state.texture&&this._uNormalMap&&(o.bindTexture(this._uNormalMap,r._normalMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uNormalMapMatrix&&a.uniformMatrix4fv(this._uNormalMapMatrix,!1,r._normalMap._state.matrix)),r._occlusionMap&&r._occlusionMap._state.texture&&this._uOcclusionMap&&(o.bindTexture(this._uOcclusionMap,r._occlusionMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uOcclusionMapMatrix&&a.uniformMatrix4fv(this._uOcclusionMapMatrix,!1,r._occlusionMap._state.matrix)),r._diffuseFresnel&&(this._uDiffuseFresnelEdgeBias&&a.uniform1f(this._uDiffuseFresnelEdgeBias,r._diffuseFresnel.edgeBias),this._uDiffuseFresnelCenterBias&&a.uniform1f(this._uDiffuseFresnelCenterBias,r._diffuseFresnel.centerBias),this._uDiffuseFresnelEdgeColor&&a.uniform3fv(this._uDiffuseFresnelEdgeColor,r._diffuseFresnel.edgeColor),this._uDiffuseFresnelCenterColor&&a.uniform3fv(this._uDiffuseFresnelCenterColor,r._diffuseFresnel.centerColor),this._uDiffuseFresnelPower&&a.uniform1f(this._uDiffuseFresnelPower,r._diffuseFresnel.power)),r._specularFresnel&&(this._uSpecularFresnelEdgeBias&&a.uniform1f(this._uSpecularFresnelEdgeBias,r._specularFresnel.edgeBias),this._uSpecularFresnelCenterBias&&a.uniform1f(this._uSpecularFresnelCenterBias,r._specularFresnel.centerBias),this._uSpecularFresnelEdgeColor&&a.uniform3fv(this._uSpecularFresnelEdgeColor,r._specularFresnel.edgeColor),this._uSpecularFresnelCenterColor&&a.uniform3fv(this._uSpecularFresnelCenterColor,r._specularFresnel.centerColor),this._uSpecularFresnelPower&&a.uniform1f(this._uSpecularFresnelPower,r._specularFresnel.power)),r._alphaFresnel&&(this._uAlphaFresnelEdgeBias&&a.uniform1f(this._uAlphaFresnelEdgeBias,r._alphaFresnel.edgeBias),this._uAlphaFresnelCenterBias&&a.uniform1f(this._uAlphaFresnelCenterBias,r._alphaFresnel.centerBias),this._uAlphaFresnelEdgeColor&&a.uniform3fv(this._uAlphaFresnelEdgeColor,r._alphaFresnel.edgeColor),this._uAlphaFresnelCenterColor&&a.uniform3fv(this._uAlphaFresnelCenterColor,r._alphaFresnel.centerColor),this._uAlphaFresnelPower&&a.uniform1f(this._uAlphaFresnelPower,r._alphaFresnel.power)),r._reflectivityFresnel&&(this._uReflectivityFresnelEdgeBias&&a.uniform1f(this._uReflectivityFresnelEdgeBias,r._reflectivityFresnel.edgeBias),this._uReflectivityFresnelCenterBias&&a.uniform1f(this._uReflectivityFresnelCenterBias,r._reflectivityFresnel.centerBias),this._uReflectivityFresnelEdgeColor&&a.uniform3fv(this._uReflectivityFresnelEdgeColor,r._reflectivityFresnel.edgeColor),this._uReflectivityFresnelCenterColor&&a.uniform3fv(this._uReflectivityFresnelCenterColor,r._reflectivityFresnel.centerColor),this._uReflectivityFresnelPower&&a.uniform1f(this._uReflectivityFresnelPower,r._reflectivityFresnel.power)),r._emissiveFresnel&&(this._uEmissiveFresnelEdgeBias&&a.uniform1f(this._uEmissiveFresnelEdgeBias,r._emissiveFresnel.edgeBias),this._uEmissiveFresnelCenterBias&&a.uniform1f(this._uEmissiveFresnelCenterBias,r._emissiveFresnel.centerBias),this._uEmissiveFresnelEdgeColor&&a.uniform3fv(this._uEmissiveFresnelEdgeColor,r._emissiveFresnel.edgeColor),this._uEmissiveFresnelCenterColor&&a.uniform3fv(this._uEmissiveFresnelCenterColor,r._emissiveFresnel.centerColor),this._uEmissiveFresnelPower&&a.uniform1f(this._uEmissiveFresnelPower,r._emissiveFresnel.power));break;case"MetallicMaterial":this._uBaseColor&&a.uniform3fv(this._uBaseColor,l.baseColor),this._uMaterialMetallic&&a.uniform1f(this._uMaterialMetallic,l.metallic),this._uMaterialRoughness&&a.uniform1f(this._uMaterialRoughness,l.roughness),this._uMaterialSpecularF0&&a.uniform1f(this._uMaterialSpecularF0,l.specularF0),this._uMaterialEmissive&&a.uniform3fv(this._uMaterialEmissive,l.emissive),this._uAlphaModeCutoff&&a.uniform4f(this._uAlphaModeCutoff,1*l.alpha,1===l.alphaMode?1:0,l.alphaCutoff,0);const t=r._baseColorMap;t&&t._state.texture&&this._uBaseColorMap&&(o.bindTexture(this._uBaseColorMap,t._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uBaseColorMapMatrix&&a.uniformMatrix4fv(this._uBaseColorMapMatrix,!1,t._state.matrix));const s=r._metallicMap;s&&s._state.texture&&this._uMetallicMap&&(o.bindTexture(this._uMetallicMap,s._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uMetallicMapMatrix&&a.uniformMatrix4fv(this._uMetallicMapMatrix,!1,s._state.matrix));const n=r._roughnessMap;n&&n._state.texture&&this._uRoughnessMap&&(o.bindTexture(this._uRoughnessMap,n._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uRoughnessMapMatrix&&a.uniformMatrix4fv(this._uRoughnessMapMatrix,!1,n._state.matrix));const h=r._metallicRoughnessMap;h&&h._state.texture&&this._uMetallicRoughnessMap&&(o.bindTexture(this._uMetallicRoughnessMap,h._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uMetallicRoughnessMapMatrix&&a.uniformMatrix4fv(this._uMetallicRoughnessMapMatrix,!1,h._state.matrix)),(u=r._emissiveMap)&&u._state.texture&&this._uEmissiveMap&&(o.bindTexture(this._uEmissiveMap,u._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uEmissiveMapMatrix&&a.uniformMatrix4fv(this._uEmissiveMapMatrix,!1,u._state.matrix)),(c=r._occlusionMap)&&r._occlusionMap._state.texture&&this._uOcclusionMap&&(o.bindTexture(this._uOcclusionMap,c._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uOcclusionMapMatrix&&a.uniformMatrix4fv(this._uOcclusionMapMatrix,!1,c._state.matrix)),(d=r._alphaMap)&&d._state.texture&&this._uAlphaMap&&(o.bindTexture(this._uAlphaMap,d._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uAlphaMapMatrix&&a.uniformMatrix4fv(this._uAlphaMapMatrix,!1,d._state.matrix)),(p=r._normalMap)&&p._state.texture&&this._uNormalMap&&(o.bindTexture(this._uNormalMap,p._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uNormalMapMatrix&&a.uniformMatrix4fv(this._uNormalMapMatrix,!1,p._state.matrix));break;case"SpecularMaterial":this._uMaterialDiffuse&&a.uniform3fv(this._uMaterialDiffuse,l.diffuse),this._uMaterialSpecular&&a.uniform3fv(this._uMaterialSpecular,l.specular),this._uMaterialGlossiness&&a.uniform1f(this._uMaterialGlossiness,l.glossiness),this._uMaterialReflectivity&&a.uniform1f(this._uMaterialReflectivity,l.reflectivity),this._uMaterialEmissive&&a.uniform3fv(this._uMaterialEmissive,l.emissive),this._uAlphaModeCutoff&&a.uniform4f(this._uAlphaModeCutoff,1*l.alpha,1===l.alphaMode?1:0,l.alphaCutoff,0);const _=r._diffuseMap;_&&_._state.texture&&this._uDiffuseMap&&(o.bindTexture(this._uDiffuseMap,_._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uDiffuseMapMatrix&&a.uniformMatrix4fv(this._uDiffuseMapMatrix,!1,_._state.matrix));const m=r._specularMap;m&&m._state.texture&&this._uSpecularMap&&(o.bindTexture(this._uSpecularMap,m._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uSpecularMapMatrix&&a.uniformMatrix4fv(this._uSpecularMapMatrix,!1,m._state.matrix));const f=r._glossinessMap;f&&f._state.texture&&this._uGlossinessMap&&(o.bindTexture(this._uGlossinessMap,f._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uGlossinessMapMatrix&&a.uniformMatrix4fv(this._uGlossinessMapMatrix,!1,f._state.matrix));const g=r._specularGlossinessMap;var u,c,d,p;g&&g._state.texture&&this._uSpecularGlossinessMap&&(o.bindTexture(this._uSpecularGlossinessMap,g._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uSpecularGlossinessMapMatrix&&a.uniformMatrix4fv(this._uSpecularGlossinessMapMatrix,!1,g._state.matrix)),(u=r._emissiveMap)&&u._state.texture&&this._uEmissiveMap&&(o.bindTexture(this._uEmissiveMap,u._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uEmissiveMapMatrix&&a.uniformMatrix4fv(this._uEmissiveMapMatrix,!1,u._state.matrix)),(c=r._occlusionMap)&&c._state.texture&&this._uOcclusionMap&&(o.bindTexture(this._uOcclusionMap,c._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uOcclusionMapMatrix&&a.uniformMatrix4fv(this._uOcclusionMapMatrix,!1,c._state.matrix)),(d=r._alphaMap)&&d._state.texture&&this._uAlphaMap&&(o.bindTexture(this._uAlphaMap,d._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uAlphaMapMatrix&&a.uniformMatrix4fv(this._uAlphaMapMatrix,!1,d._state.matrix)),(p=r._normalMap)&&p._state.texture&&this._uNormalMap&&(o.bindTexture(this._uNormalMap,p._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uNormalMapMatrix&&a.uniformMatrix4fv(this._uNormalMapMatrix,!1,p._state.matrix))}this._lastMaterialId=l.id}if(a.uniformMatrix4fv(this._uModelMatrix,a.FALSE,t.worldMatrix),this._uModelNormalMatrix&&a.uniformMatrix4fv(this._uModelNormalMatrix,a.FALSE,t.worldNormalMatrix),this._uClippable&&a.uniform1i(this._uClippable,n.clippable),this._uColorize){const e=n.colorize,t=this._lastColorize;t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]||(a.uniform4fv(this._uColorize,e),t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3])}if(h.combined){const i=t._geometry._getVertexBufs();i.id!==this._lastVertexBufsId&&(i.positionsBuf&&this._aPosition&&(this._aPosition.bindArrayBuffer(i.positionsBuf,i.quantized?a.UNSIGNED_SHORT:a.FLOAT),e.bindArray++),i.normalsBuf&&this._aNormal&&(this._aNormal.bindArrayBuffer(i.normalsBuf,i.quantized?a.BYTE:a.FLOAT),e.bindArray++),i.uvBuf&&this._aUV&&(this._aUV.bindArrayBuffer(i.uvBuf,h.quantized?a.UNSIGNED_SHORT:a.FLOAT),e.bindArray++),i.colorsBuf&&this._aColor&&(this._aColor.bindArrayBuffer(i.colorsBuf),e.bindArray++),i.flagsBuf&&this._aFlags&&(this._aFlags.bindArrayBuffer(i.flagsBuf,a.UNSIGNED_SHORT),e.bindArray++),this._lastVertexBufsId=i.id)}h.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,h.positionsDecodeMatrix),this._uUVDecodeMatrix&&a.uniformMatrix3fv(this._uUVDecodeMatrix,!1,h.uvDecodeMatrix),h.combined?h.indicesBufCombined&&(h.indicesBufCombined.bind(),e.bindArray++):(this._aPosition&&(this._aPosition.bindArrayBuffer(h.positionsBuf,h.quantized?a.UNSIGNED_SHORT:a.FLOAT),e.bindArray++),this._aNormal&&(this._aNormal.bindArrayBuffer(h.normalsBuf,h.quantized?a.BYTE:a.FLOAT),e.bindArray++),this._aUV&&(this._aUV.bindArrayBuffer(h.uvBuf,h.quantized?a.UNSIGNED_SHORT:a.FLOAT),e.bindArray++),this._aColor&&(this._aColor.bindArrayBuffer(h.colorsBuf),e.bindArray++),this._aFlags&&(this._aFlags.bindArrayBuffer(h.flagsBuf),e.bindArray++),h.indicesBuf?(h.indicesBuf.bind(),e.bindArray++):h.positions),this._lastGeometryId=h.id),h.combined?h.indicesBufCombined&&(a.drawElements(h.primitive,h.indicesBufCombined.numItems,h.indicesBufCombined.itemType,0),e.drawElements++):h.indicesBuf?(a.drawElements(h.primitive,h.indicesBuf.numItems,h.indicesBuf.itemType,0),e.drawElements++):h.positions&&(a.drawArrays(a.TRIANGLES,0,h.positions.numItems),e.drawArrays++)},be.prototype._allocate=function(e){const t=e.scene.canvas.gl,i=e._material,s=e.scene._lightsState,r=e.scene._clipsState,a=e._material._state;if(this._program=new ye(t,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const o=this._program;this._uPositionsDecodeMatrix=o.getLocation("positionsDecodeMatrix"),this._uUVDecodeMatrix=o.getLocation("uvDecodeMatrix"),this._uModelMatrix=o.getLocation("modelMatrix"),this._uModelNormalMatrix=o.getLocation("modelNormalMatrix"),this._uViewMatrix=o.getLocation("viewMatrix"),this._uViewNormalMatrix=o.getLocation("viewNormalMatrix"),this._uProjMatrix=o.getLocation("projMatrix"),this._uGammaFactor=o.getLocation("gammaFactor"),this._uLightAmbient=[],this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[],this._uShadowViewMatrix=[],this._uShadowProjMatrix=[];const n=s.lights;let l;for(var h=0,u=n.length;h<u;h++){switch(l=n[h],l.type){case"ambient":this._uLightAmbient[h]=o.getLocation("lightAmbient");break;case"dir":this._uLightColor[h]=o.getLocation("lightColor"+h),this._uLightPos[h]=null,this._uLightDir[h]=o.getLocation("lightDir"+h);break;case"point":this._uLightColor[h]=o.getLocation("lightColor"+h),this._uLightPos[h]=o.getLocation("lightPos"+h),this._uLightDir[h]=null,this._uLightAttenuation[h]=o.getLocation("lightAttenuation"+h);break;case"spot":this._uLightColor[h]=o.getLocation("lightColor"+h),this._uLightPos[h]=o.getLocation("lightPos"+h),this._uLightDir[h]=o.getLocation("lightDir"+h),this._uLightAttenuation[h]=o.getLocation("lightAttenuation"+h)}l.shadow&&(this._uShadowViewMatrix[h]=o.getLocation("shadowViewMatrix"+h),this._uShadowProjMatrix[h]=o.getLocation("shadowProjMatrix"+h))}s.lightMaps.length>0&&(this._uLightMap="lightMap"),s.reflectionMaps.length>0&&(this._uReflectionMap="reflectionMap"),this._uClips=[];for(h=0,u=r.clips.length;h<u;h++)this._uClips.push({active:o.getLocation("clipActive"+h),pos:o.getLocation("clipPos"+h),dir:o.getLocation("clipDir"+h)});switch(this._uPointSize=o.getLocation("pointSize"),a.type){case"LambertMaterial":this._uMaterialColor=o.getLocation("materialColor"),this._uMaterialEmissive=o.getLocation("materialEmissive"),this._uAlphaModeCutoff=o.getLocation("materialAlphaModeCutoff");break;case"PhongMaterial":this._uMaterialAmbient=o.getLocation("materialAmbient"),this._uMaterialDiffuse=o.getLocation("materialDiffuse"),this._uMaterialSpecular=o.getLocation("materialSpecular"),this._uMaterialEmissive=o.getLocation("materialEmissive"),this._uAlphaModeCutoff=o.getLocation("materialAlphaModeCutoff"),this._uMaterialShininess=o.getLocation("materialShininess"),i._ambientMap&&(this._uMaterialAmbientMap="ambientMap",this._uMaterialAmbientMapMatrix=o.getLocation("ambientMapMatrix")),i._diffuseMap&&(this._uDiffuseMap="diffuseMap",this._uDiffuseMapMatrix=o.getLocation("diffuseMapMatrix")),i._specularMap&&(this._uSpecularMap="specularMap",this._uSpecularMapMatrix=o.getLocation("specularMapMatrix")),i._emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=o.getLocation("emissiveMapMatrix")),i._alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=o.getLocation("alphaMapMatrix")),i._reflectivityMap&&(this._uReflectivityMap="reflectivityMap",this._uReflectivityMapMatrix=o.getLocation("reflectivityMapMatrix")),i._normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=o.getLocation("normalMapMatrix")),i._occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=o.getLocation("occlusionMapMatrix")),i._diffuseFresnel&&(this._uDiffuseFresnelEdgeBias=o.getLocation("diffuseFresnelEdgeBias"),this._uDiffuseFresnelCenterBias=o.getLocation("diffuseFresnelCenterBias"),this._uDiffuseFresnelEdgeColor=o.getLocation("diffuseFresnelEdgeColor"),this._uDiffuseFresnelCenterColor=o.getLocation("diffuseFresnelCenterColor"),this._uDiffuseFresnelPower=o.getLocation("diffuseFresnelPower")),i._specularFresnel&&(this._uSpecularFresnelEdgeBias=o.getLocation("specularFresnelEdgeBias"),this._uSpecularFresnelCenterBias=o.getLocation("specularFresnelCenterBias"),this._uSpecularFresnelEdgeColor=o.getLocation("specularFresnelEdgeColor"),this._uSpecularFresnelCenterColor=o.getLocation("specularFresnelCenterColor"),this._uSpecularFresnelPower=o.getLocation("specularFresnelPower")),i._alphaFresnel&&(this._uAlphaFresnelEdgeBias=o.getLocation("alphaFresnelEdgeBias"),this._uAlphaFresnelCenterBias=o.getLocation("alphaFresnelCenterBias"),this._uAlphaFresnelEdgeColor=o.getLocation("alphaFresnelEdgeColor"),this._uAlphaFresnelCenterColor=o.getLocation("alphaFresnelCenterColor"),this._uAlphaFresnelPower=o.getLocation("alphaFresnelPower")),i._reflectivityFresnel&&(this._uReflectivityFresnelEdgeBias=o.getLocation("reflectivityFresnelEdgeBias"),this._uReflectivityFresnelCenterBias=o.getLocation("reflectivityFresnelCenterBias"),this._uReflectivityFresnelEdgeColor=o.getLocation("reflectivityFresnelEdgeColor"),this._uReflectivityFresnelCenterColor=o.getLocation("reflectivityFresnelCenterColor"),this._uReflectivityFresnelPower=o.getLocation("reflectivityFresnelPower")),i._emissiveFresnel&&(this._uEmissiveFresnelEdgeBias=o.getLocation("emissiveFresnelEdgeBias"),this._uEmissiveFresnelCenterBias=o.getLocation("emissiveFresnelCenterBias"),this._uEmissiveFresnelEdgeColor=o.getLocation("emissiveFresnelEdgeColor"),this._uEmissiveFresnelCenterColor=o.getLocation("emissiveFresnelCenterColor"),this._uEmissiveFresnelPower=o.getLocation("emissiveFresnelPower"));break;case"MetallicMaterial":this._uBaseColor=o.getLocation("materialBaseColor"),this._uMaterialMetallic=o.getLocation("materialMetallic"),this._uMaterialRoughness=o.getLocation("materialRoughness"),this._uMaterialSpecularF0=o.getLocation("materialSpecularF0"),this._uMaterialEmissive=o.getLocation("materialEmissive"),this._uAlphaModeCutoff=o.getLocation("materialAlphaModeCutoff"),i._baseColorMap&&(this._uBaseColorMap="baseColorMap",this._uBaseColorMapMatrix=o.getLocation("baseColorMapMatrix")),i._metallicMap&&(this._uMetallicMap="metallicMap",this._uMetallicMapMatrix=o.getLocation("metallicMapMatrix")),i._roughnessMap&&(this._uRoughnessMap="roughnessMap",this._uRoughnessMapMatrix=o.getLocation("roughnessMapMatrix")),i._metallicRoughnessMap&&(this._uMetallicRoughnessMap="metallicRoughnessMap",this._uMetallicRoughnessMapMatrix=o.getLocation("metallicRoughnessMapMatrix")),i._emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=o.getLocation("emissiveMapMatrix")),i._occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=o.getLocation("occlusionMapMatrix")),i._alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=o.getLocation("alphaMapMatrix")),i._normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=o.getLocation("normalMapMatrix"));break;case"SpecularMaterial":this._uMaterialDiffuse=o.getLocation("materialDiffuse"),this._uMaterialSpecular=o.getLocation("materialSpecular"),this._uMaterialGlossiness=o.getLocation("materialGlossiness"),this._uMaterialReflectivity=o.getLocation("reflectivityFresnel"),this._uMaterialEmissive=o.getLocation("materialEmissive"),this._uAlphaModeCutoff=o.getLocation("materialAlphaModeCutoff"),i._diffuseMap&&(this._uDiffuseMap="diffuseMap",this._uDiffuseMapMatrix=o.getLocation("diffuseMapMatrix")),i._specularMap&&(this._uSpecularMap="specularMap",this._uSpecularMapMatrix=o.getLocation("specularMapMatrix")),i._glossinessMap&&(this._uGlossinessMap="glossinessMap",this._uGlossinessMapMatrix=o.getLocation("glossinessMapMatrix")),i._specularGlossinessMap&&(this._uSpecularGlossinessMap="materialSpecularGlossinessMap",this._uSpecularGlossinessMapMatrix=o.getLocation("materialSpecularGlossinessMapMatrix")),i._emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=o.getLocation("emissiveMapMatrix")),i._occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=o.getLocation("occlusionMapMatrix")),i._alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=o.getLocation("alphaMapMatrix")),i._normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=o.getLocation("normalMapMatrix"))}this._aPosition=o.getAttribute("position"),this._aNormal=o.getAttribute("normal"),this._aUV=o.getAttribute("uv"),this._aColor=o.getAttribute("color"),this._aFlags=o.getAttribute("flags"),this._uClippable=o.getLocation("clippable"),this._uColorize=o.getLocation("colorize"),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,this._lastColorize=new Float32Array(4),this._baseTextureUnit=0},be.prototype._bindProgram=function(e){const t=b.MAX_TEXTURE_UNITS,i=this._scene,s=i.canvas.gl,r=i._lightsState,a=i._clipsState;r.lights;let o;const n=this._program;n.bind(),e.useProgram++,e.textureUnit=0,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,this._lastColorize[0]=-1,this._lastColorize[1]=-1,this._lastColorize[2]=-1,this._lastColorize[3]=-1;const l=i.camera,h=l._state;s.uniformMatrix4fv(this._uViewMatrix,!1,h.matrix),s.uniformMatrix4fv(this._uViewNormalMatrix,!1,h.normalMatrix),s.uniformMatrix4fv(this._uProjMatrix,!1,l._project._state.matrix);for(var u=0,c=r.lights.length;u<c;u++)if(o=r.lights[u],this._uLightAmbient[u])s.uniform4f(this._uLightAmbient[u],o.color[0],o.color[1],o.color[2],o.intensity);else if(this._uLightColor[u]&&s.uniform4f(this._uLightColor[u],o.color[0],o.color[1],o.color[2],o.intensity),this._uLightPos[u]&&(s.uniform3fv(this._uLightPos[u],o.pos),this._uLightAttenuation[u]&&s.uniform1f(this._uLightAttenuation[u],o.attenuation)),this._uLightDir[u]&&s.uniform3fv(this._uLightDir[u],o.dir),o.shadow){this._uShadowViewMatrix[u]&&s.uniformMatrix4fv(this._uShadowViewMatrix[u],!1,o.getShadowViewMatrix()),this._uShadowProjMatrix[u]&&s.uniformMatrix4fv(this._uShadowProjMatrix[u],!1,o.getShadowProjMatrix());const i=o.getShadowRenderBuf();i&&(n.bindTexture("shadowMap"+u,i.getTexture(),e.textureUnit),e.textureUnit=(e.textureUnit+1)%t,e.bindTexture++)}if(r.lightMaps.length>0&&r.lightMaps[0].texture&&this._uLightMap&&(n.bindTexture(this._uLightMap,r.lightMaps[0].texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%t,e.bindTexture++),r.reflectionMaps.length>0&&r.reflectionMaps[0].texture&&this._uReflectionMap&&(n.bindTexture(this._uReflectionMap,r.reflectionMaps[0].texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%t,e.bindTexture++),a.clips.length>0){const e=i._clipsState.clips;let t,r,a,o,n;for(u=0,c=this._uClips.length;u<c;u++)t=this._uClips[u],r=t.active,a=e[u],r&&s.uniform1i(r,a.active),o=t.pos,o&&s.uniform3fv(t.pos,a.pos),n=t.dir,n&&s.uniform3fv(t.dir,a.dir)}this._uGammaFactor&&s.uniform1f(this._uGammaFactor,i.gammaFactor),this._baseTextureUnit=e.textureUnit};class Ae{constructor(e){this.vertex=function(e){const t=e.scene,i=t._lightsState,s=function(e){const t=e._geometry._state.primitiveName;if((e._geometry._state.autoVertexNormals||e._geometry._state.normals)&&("triangles"===t||"triangle-strip"===t||"triangle-fan"===t))return!0;return!1}(e),r=t._clipsState.clips.length>0,a=!!e._geometry._state.quantized,o=e._state.billboard,n=e._state.stationary,l=[];let h,u,c;l.push("// EmphasisFillShaderSource vertex shader"),l.push("attribute vec3 position;"),l.push("uniform mat4 modelMatrix;"),l.push("uniform mat4 viewMatrix;"),l.push("uniform mat4 projMatrix;"),l.push("uniform vec4 colorize;"),a&&l.push("uniform mat4 positionsDecodeMatrix;");r&&l.push("varying vec4 vWorldPosition;");if(l.push("uniform vec4   lightAmbient;"),l.push("uniform vec4   fillColor;"),s){for(l.push("attribute vec3 normal;"),l.push("uniform mat4 modelNormalMatrix;"),l.push("uniform mat4 viewNormalMatrix;"),h=0,u=i.lights.length;h<u;h++)c=i.lights[h],"ambient"!==c.type&&(l.push("uniform vec4 lightColor"+h+";"),"dir"===c.type&&l.push("uniform vec3 lightDir"+h+";"),"point"===c.type&&l.push("uniform vec3 lightPos"+h+";"),"spot"===c.type&&l.push("uniform vec3 lightPos"+h+";"));a&&(l.push("vec3 octDecode(vec2 oct) {"),l.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),l.push("    if (v.z < 0.0) {"),l.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),l.push("    }"),l.push("    return normalize(v);"),l.push("}"))}l.push("varying vec4 vColor;"),("spherical"===o||"cylindrical"===o)&&(l.push("void billboard(inout mat4 mat) {"),l.push("   mat[0][0] = 1.0;"),l.push("   mat[0][1] = 0.0;"),l.push("   mat[0][2] = 0.0;"),"spherical"===o&&(l.push("   mat[1][0] = 0.0;"),l.push("   mat[1][1] = 1.0;"),l.push("   mat[1][2] = 0.0;")),l.push("   mat[2][0] = 0.0;"),l.push("   mat[2][1] = 0.0;"),l.push("   mat[2][2] =1.0;"),l.push("}"));l.push("void main(void) {"),l.push("vec4 localPosition = vec4(position, 1.0); "),l.push("vec4 worldPosition;"),a&&l.push("localPosition = positionsDecodeMatrix * localPosition;");s&&(a?l.push("vec4 localNormal = vec4(octDecode(normal.xy), 0.0); "):l.push("vec4 localNormal = vec4(normal, 0.0); "),l.push("mat4 modelNormalMatrix2 = modelNormalMatrix;"),l.push("mat4 viewNormalMatrix2 = viewNormalMatrix;"));l.push("mat4 viewMatrix2 = viewMatrix;"),l.push("mat4 modelMatrix2 = modelMatrix;"),n&&l.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===o||"cylindrical"===o?(l.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),l.push("billboard(modelMatrix2);"),l.push("billboard(viewMatrix2);"),l.push("billboard(modelViewMatrix);"),s&&(l.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),l.push("billboard(modelNormalMatrix2);"),l.push("billboard(viewNormalMatrix2);"),l.push("billboard(modelViewNormalMatrix);")),l.push("worldPosition = modelMatrix2 * localPosition;"),l.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(l.push("worldPosition = modelMatrix2 * localPosition;"),l.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));s&&l.push("vec3 viewNormal = normalize((viewNormalMatrix2 * modelNormalMatrix2 * localNormal).xyz);");if(l.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),l.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),l.push("float lambertian = 1.0;"),s)for(h=0,u=i.lights.length;h<u;h++)if(c=i.lights[h],"ambient"!==c.type){if("dir"===c.type)"view"===c.space?l.push("viewLightDir = normalize(lightDir"+h+");"):l.push("viewLightDir = normalize((viewMatrix2 * vec4(lightDir"+h+", 0.0)).xyz);");else{if("point"!==c.type)continue;"view"===c.space?l.push("viewLightDir = normalize(lightPos"+h+" - viewPosition.xyz);"):l.push("viewLightDir = normalize((viewMatrix2 * vec4(lightPos"+h+", 0.0)).xyz);")}l.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),l.push("reflectedColor += lambertian * (lightColor"+h+".rgb * lightColor"+h+".a);")}l.push("vColor = vec4(reflectedColor * fillColor.rgb, fillColor.a);"),r&&l.push("vWorldPosition = worldPosition;");"points"===e._geometry._state.primitiveName&&l.push("gl_PointSize = pointSize;");return l.push("   gl_Position = projMatrix * viewPosition;"),l.push("}"),l}(e),this.fragment=function(e){const t=e.scene._clipsState,i=e.scene.gammaOutput,s=t.clips.length>0;let r,a;const o=[];o.push("// Lambertian drawing fragment shader"),o.push("precision lowp float;"),i&&(o.push("uniform float gammaFactor;"),o.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),o.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),o.push("}"));if(s)for(o.push("varying vec4 vWorldPosition;"),o.push("uniform bool clippable;"),r=0,a=t.clips.length;r<a;r++)o.push("uniform bool clipActive"+r+";"),o.push("uniform vec3 clipPos"+r+";"),o.push("uniform vec3 clipDir"+r+";");if(o.push("varying vec4 vColor;"),o.push("void main(void) {"),s){for(o.push("if (clippable) {"),o.push("  float dist = 0.0;"),r=0,a=t.clips.length;r<a;r++)o.push("if (clipActive"+r+") {"),o.push("   dist += clamp(dot(-clipDir"+r+".xyz, vWorldPosition.xyz - clipPos"+r+".xyz), 0.0, 1000.0);"),o.push("}");o.push("  if (dist > 0.0) { discard; }"),o.push("}")}"points"===e._geometry._state.primitiveName&&(o.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),o.push("float r = dot(cxy, cxy);"),o.push("if (r > 1.0) {"),o.push("   discard;"),o.push("}"));o.push("gl_FragColor = vColor;"),i?o.push("gl_FragColor = linearToGamma(vColor, gammaFactor);"):o.push("gl_FragColor = vColor;");return o.push("}"),o}(e)}}const Ee=new s({}),Ce=function(e,t){this.id=Ee.addItem({}),this._hash=e,this._scene=t.scene,this._useCount=0,this._shaderSource=new Ae(t),this._allocate(t)},Pe={};Ce.get=function(e){const t=[e.scene.id,e.scene.gammaOutput?"go":"",e.scene._clipsState.getHash(),e._geometry.normals?"n":"",e._geometry._state.quantized?"cp":"",e._state.hash].join(";");let i=Pe[t];return i||(i=new Ce(t,e),Pe[t]=i,r.memory.programs++),i._useCount++,i},Ce.prototype.put=function(){0==--this._useCount&&(Ee.removeItem(this.id),this._program&&this._program.destroy(),delete Pe[this._hash],r.memory.programs--)},Ce.prototype.webglContextRestored=function(){this._program=null},Ce.prototype.drawMesh=function(e,t,i){this._program||this._allocate(t);const s=this._scene.canvas.gl,r=0===i?t._ghostMaterial._state:1===i?t._highlightMaterial._state:t._selectedMaterial._state,a=t._state,o=t._geometry._state;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),r.id!==this._lastMaterialId){const t=r.fillColor,i=r.backfaces;e.backfaces!==i&&(i?s.disable(s.CULL_FACE):s.enable(s.CULL_FACE),e.backfaces=i),s.uniform4f(this._uFillColor,t[0],t[1],t[2],r.fillAlpha),this._lastMaterialId=r.id}if(s.uniformMatrix4fv(this._uModelMatrix,s.FALSE,t.worldMatrix),this._uModelNormalMatrix&&s.uniformMatrix4fv(this._uModelNormalMatrix,s.FALSE,t.worldNormalMatrix),this._uClippable&&s.uniform1i(this._uClippable,a.clippable),o.combined){const i=t._geometry._getVertexBufs();i.id!==this._lastVertexBufsId&&(i.positionsBuf&&this._aPosition&&(this._aPosition.bindArrayBuffer(i.positionsBuf,i.quantized?s.UNSIGNED_SHORT:s.FLOAT),e.bindArray++),i.normalsBuf&&this._aNormal&&(this._aNormal.bindArrayBuffer(i.normalsBuf,i.quantized?s.BYTE:s.FLOAT),e.bindArray++),this._lastVertexBufsId=i.id)}o.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,o.positionsDecodeMatrix),this._uUVDecodeMatrix&&s.uniformMatrix3fv(this._uUVDecodeMatrix,!1,o.uvDecodeMatrix),o.combined?o.indicesBufCombined&&(o.indicesBufCombined.bind(),e.bindArray++):(this._aPosition&&(this._aPosition.bindArrayBuffer(o.positionsBuf,o.quantized?s.UNSIGNED_SHORT:s.FLOAT),e.bindArray++),this._aNormal&&(this._aNormal.bindArrayBuffer(o.normalsBuf,o.quantized?s.BYTE:s.FLOAT),e.bindArray++),o.indicesBuf?(o.indicesBuf.bind(),e.bindArray++):o.positions),this._lastGeometryId=o.id),o.combined?o.indicesBufCombined&&(s.drawElements(o.primitive,o.indicesBufCombined.numItems,o.indicesBufCombined.itemType,0),e.drawElements++):o.indicesBuf?(s.drawElements(o.primitive,o.indicesBuf.numItems,o.indicesBuf.itemType,0),e.drawElements++):o.positions&&(s.drawArrays(s.TRIANGLES,0,o.positions.numItems),e.drawArrays++)},Ce.prototype._allocate=function(e){const t=e.scene._lightsState,i=e.scene._clipsState,s=e.scene.canvas.gl;if(this._program=new ye(s,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const r=this._program;this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uModelMatrix=r.getLocation("modelMatrix"),this._uModelNormalMatrix=r.getLocation("modelNormalMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uViewNormalMatrix=r.getLocation("viewNormalMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uLightAmbient=[],this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];for(var a=0,o=t.lights.length;a<o;a++){switch(t.lights[a].type){case"ambient":this._uLightAmbient[a]=r.getLocation("lightAmbient");break;case"dir":this._uLightColor[a]=r.getLocation("lightColor"+a),this._uLightPos[a]=null,this._uLightDir[a]=r.getLocation("lightDir"+a);break;case"point":this._uLightColor[a]=r.getLocation("lightColor"+a),this._uLightPos[a]=r.getLocation("lightPos"+a),this._uLightDir[a]=null,this._uLightAttenuation[a]=r.getLocation("lightAttenuation"+a)}}this._uClips=[];for(a=0,o=i.clips.length;a<o;a++)this._uClips.push({active:r.getLocation("clipActive"+a),pos:r.getLocation("clipPos"+a),dir:r.getLocation("clipDir"+a)});this._uFillColor=r.getLocation("fillColor"),this._aPosition=r.getAttribute("position"),this._aNormal=r.getAttribute("normal"),this._uClippable=r.getLocation("clippable"),this._uGammaFactor=r.getLocation("gammaFactor"),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null},Ce.prototype._bindProgram=function(e){const t=this._scene,i=t.canvas.gl,s=t._clipsState,r=t._lightsState,a=t.camera,o=a._state;let n;this._program.bind(),e.useProgram++,e.textureUnit=0,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,this._lastIndicesBufId=null,i.uniformMatrix4fv(this._uViewMatrix,!1,o.matrix),i.uniformMatrix4fv(this._uViewNormalMatrix,!1,o.normalMatrix),i.uniformMatrix4fv(this._uProjMatrix,!1,a.project._state.matrix);for(var l=0,h=r.lights.length;l<h;l++)n=r.lights[l],this._uLightAmbient[l]?i.uniform4f(this._uLightAmbient[l],n.color[0],n.color[1],n.color[2],n.intensity):(this._uLightColor[l]&&i.uniform4f(this._uLightColor[l],n.color[0],n.color[1],n.color[2],n.intensity),this._uLightPos[l]&&(i.uniform3fv(this._uLightPos[l],n.pos),this._uLightAttenuation[l]&&i.uniform1f(this._uLightAttenuation[l],n.attenuation)),this._uLightDir[l]&&i.uniform3fv(this._uLightDir[l],n.dir));if(s.clips.length>0){const e=t._clipsState.clips;let s,r,a,o,n;for(l=0,h=this._uClips.length;l<h;l++)s=this._uClips[l],r=s.active,a=e[l],r&&i.uniform1i(r,a.active),o=s.pos,o&&i.uniform3fv(s.pos,a.pos),n=s.dir,n&&i.uniform3fv(s.dir,a.dir)}this._uGammaFactor&&i.uniform1f(this._uGammaFactor,t.gammaFactor)};class Te{constructor(e){this.vertex=function(e){const t=e.scene._clipsState.clips.length>0,i=!!e._geometry._state.quantized,s=e._state.billboard,r=e._state.stationary,a=[];a.push("// Edges drawing vertex shader"),a.push("attribute vec3 position;"),a.push("uniform mat4 modelMatrix;"),a.push("uniform mat4 viewMatrix;"),a.push("uniform mat4 projMatrix;"),a.push("uniform vec4 edgeColor;"),i&&a.push("uniform mat4 positionsDecodeMatrix;");t&&a.push("varying vec4 vWorldPosition;");a.push("varying vec4 vColor;"),("spherical"===s||"cylindrical"===s)&&(a.push("void billboard(inout mat4 mat) {"),a.push("   mat[0][0] = 1.0;"),a.push("   mat[0][1] = 0.0;"),a.push("   mat[0][2] = 0.0;"),"spherical"===s&&(a.push("   mat[1][0] = 0.0;"),a.push("   mat[1][1] = 1.0;"),a.push("   mat[1][2] = 0.0;")),a.push("   mat[2][0] = 0.0;"),a.push("   mat[2][1] = 0.0;"),a.push("   mat[2][2] =1.0;"),a.push("}"));a.push("void main(void) {"),a.push("vec4 localPosition = vec4(position, 1.0); "),a.push("vec4 worldPosition;"),i&&a.push("localPosition = positionsDecodeMatrix * localPosition;");a.push("mat4 viewMatrix2 = viewMatrix;"),a.push("mat4 modelMatrix2 = modelMatrix;"),r&&a.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===s||"cylindrical"===s?(a.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),a.push("billboard(modelMatrix2);"),a.push("billboard(viewMatrix2);"),a.push("billboard(modelViewMatrix);"),a.push("worldPosition = modelMatrix2 * localPosition;"),a.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(a.push("worldPosition = modelMatrix2 * localPosition;"),a.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));a.push("vColor = edgeColor;"),t&&a.push("vWorldPosition = worldPosition;");return a.push("   gl_Position = projMatrix * viewPosition;"),a.push("}"),a}(e),this.fragment=function(e){const t=e.scene._clipsState,i=e.scene.gammaOutput,s=t.clips.length>0;let r,a;const o=[];o.push("// Edges drawing fragment shader"),o.push("precision lowp float;"),i&&(o.push("uniform float gammaFactor;"),o.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),o.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),o.push("}"));if(s)for(o.push("varying vec4 vWorldPosition;"),o.push("uniform bool clippable;"),r=0,a=t.clips.length;r<a;r++)o.push("uniform bool clipActive"+r+";"),o.push("uniform vec3 clipPos"+r+";"),o.push("uniform vec3 clipDir"+r+";");if(o.push("varying vec4 vColor;"),o.push("void main(void) {"),s){for(o.push("if (clippable) {"),o.push("  float dist = 0.0;"),r=0,a=t.clips.length;r<a;r++)o.push("if (clipActive"+r+") {"),o.push("   dist += clamp(dot(-clipDir"+r+".xyz, vWorldPosition.xyz - clipPos"+r+".xyz), 0.0, 1000.0);"),o.push("}");o.push("  if (dist > 0.0) { discard; }"),o.push("}")}o.push("gl_FragColor = vColor;"),i?o.push("gl_FragColor = linearToGamma(vColor, gammaFactor);"):o.push("gl_FragColor = vColor;");return o.push("}"),o}(e)}}const De=new s({}),Se=function(e,t){this.id=De.addItem({}),this._hash=e,this._scene=t.scene,this._useCount=0,this._shaderSource=new Te(t),this._allocate(t)},Fe={};Se.get=function(e){const t=[e.scene.id,e.scene.gammaOutput?"go":"",e.scene._clipsState.getHash(),e._geometry._state.quantized?"cp":"",e._state.hash].join(";");let i=Fe[t];return i||(i=new Se(t,e),Fe[t]=i,r.memory.programs++),i._useCount++,i},Se.prototype.put=function(){0==--this._useCount&&(De.removeItem(this.id),this._program&&this._program.destroy(),delete Fe[this._hash],r.memory.programs--)},Se.prototype.webglContextRestored=function(){this._program=null},Se.prototype.drawMesh=function(e,t,i){this._program||this._allocate(t);const s=this._scene.canvas.gl;let r;const a=t._state,o=t._geometry,n=o._state;switch(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),i){case 0:r=t._ghostMaterial._state;break;case 1:r=t._highlightMaterial._state;break;case 2:r=t._selectedMaterial._state;break;case 3:default:r=t._edgeMaterial._state}if(r.id!==this._lastMaterialId){const t=r.backfaces;if(e.backfaces!==t&&(t?s.disable(s.CULL_FACE):s.enable(s.CULL_FACE),e.backfaces=t),e.lineWidth!==r.edgeWidth&&(s.lineWidth(r.edgeWidth),e.lineWidth=r.edgeWidth),this._uEdgeColor){const e=r.edgeColor,t=r.edgeAlpha;s.uniform4f(this._uEdgeColor,e[0],e[1],e[2],t)}this._lastMaterialId=r.id}if(s.uniformMatrix4fv(this._uModelMatrix,s.FALSE,t.worldMatrix),this._uModelNormalMatrix&&s.uniformMatrix4fv(this._uModelNormalMatrix,s.FALSE,t.worldNormalMatrix),this._uClippable&&s.uniform1i(this._uClippable,a.clippable),n.combined){const i=t._geometry._getVertexBufs();i.id!==this._lastVertexBufsId&&(i.positionsBuf&&this._aPosition&&(this._aPosition.bindArrayBuffer(i.positionsBuf,i.quantized?s.UNSIGNED_SHORT:s.FLOAT),e.bindArray++),this._lastVertexBufsId=i.id)}let l;n.primitive===s.TRIANGLES?l=o._getEdgesIndices():n.primitive===s.LINES&&(l=n.indicesBuf),l&&(n.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,n.positionsDecodeMatrix),n.combined||this._aPosition&&(this._aPosition.bindArrayBuffer(n.positionsBuf,n.quantized?s.UNSIGNED_SHORT:s.FLOAT),e.bindArray++),l.bind(),e.bindArray++,this._lastGeometryId=n.id),s.drawElements(s.LINES,l.numItems,l.itemType,0),e.drawElements++)},Se.prototype._allocate=function(e){const t=e.scene.canvas.gl,i=e.scene._clipsState;if(this._program=new ye(t,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uModelMatrix=s.getLocation("modelMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uClips=[];for(let e=0,t=i.clips.length;e<t;e++)this._uClips.push({active:s.getLocation("clipActive"+e),pos:s.getLocation("clipPos"+e),dir:s.getLocation("clipDir"+e)});this._uEdgeColor=s.getLocation("edgeColor"),this._aPosition=s.getAttribute("position"),this._uClippable=s.getLocation("clippable"),this._uGammaFactor=s.getLocation("gammaFactor"),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null},Se.prototype._bindProgram=function(e){const t=this._program,i=this._scene,s=i.canvas.gl,r=i._clipsState,a=i.camera,o=a._state;if(t.bind(),e.useProgram++,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,s.uniformMatrix4fv(this._uViewMatrix,!1,o.matrix),s.uniformMatrix4fv(this._uProjMatrix,!1,a.project._state.matrix),r.clips.length>0){const e=r.clips;let t,i,a,o,n;for(let r=0,l=this._uClips.length;r<l;r++)t=this._uClips[r],i=t.active,a=e[r],i&&s.uniform1i(i,a.active),o=t.pos,o&&s.uniform3fv(t.pos,a.pos),n=t.dir,n&&s.uniform3fv(t.dir,a.dir)}this._uGammaFactor&&s.uniform1f(this._uGammaFactor,i.gammaFactor)};class Le{constructor(e){this.vertex=function(e){const t=e.scene._clipsState.clips.length>0,i=!!e._geometry._state.quantized,s=e._state.billboard,r=e._state.stationary,a=[];a.push("// Vertices drawing vertex shader"),a.push("attribute vec3 position;"),a.push("uniform mat4 modelMatrix;"),a.push("uniform mat4 viewMatrix;"),a.push("uniform mat4 projMatrix;"),a.push("uniform vec4 vertexColor;"),a.push("uniform float vertexSize;"),i&&a.push("uniform mat4 positionsDecodeMatrix;");t&&a.push("varying vec4 vWorldPosition;");a.push("varying vec4 vColor;"),("spherical"===s||"cylindrical"===s)&&(a.push("void billboard(inout mat4 mat) {"),a.push("   mat[0][0] = 1.0;"),a.push("   mat[0][1] = 0.0;"),a.push("   mat[0][2] = 0.0;"),"spherical"===s&&(a.push("   mat[1][0] = 0.0;"),a.push("   mat[1][1] = 1.0;"),a.push("   mat[1][2] = 0.0;")),a.push("   mat[2][0] = 0.0;"),a.push("   mat[2][1] = 0.0;"),a.push("   mat[2][2] =1.0;"),a.push("}"));a.push("void main(void) {"),a.push("vec4 localPosition = vec4(position, 1.0); "),a.push("vec4 worldPosition;"),i&&a.push("localPosition = positionsDecodeMatrix * localPosition;");a.push("mat4 viewMatrix2 = viewMatrix;"),a.push("mat4 modelMatrix2 = modelMatrix;"),r&&a.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===s||"cylindrical"===s?(a.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),a.push("billboard(modelMatrix2);"),a.push("billboard(viewMatrix2);"),a.push("billboard(modelViewMatrix);"),a.push("worldPosition = modelMatrix2 * localPosition;"),a.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(a.push("worldPosition = modelMatrix2 * localPosition;"),a.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));a.push("vColor = vertexColor;"),a.push("gl_PointSize = vertexSize;"),t&&a.push("vWorldPosition = worldPosition;");return a.push("   gl_Position = projMatrix * viewPosition;"),a.push("}"),a}(e),this.fragment=function(e){const t=e.scene._clipsState,i=e.scene.gammaOutput,s=t.clips.length>0;let r,a;const o=[];o.push("// Vertices drawing fragment shader"),o.push("precision lowp float;"),i&&(o.push("uniform float gammaFactor;"),o.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),o.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),o.push("}"));if(s)for(o.push("varying vec4 vWorldPosition;"),o.push("uniform bool clippable;"),r=0,a=t.clips.length;r<a;r++)o.push("uniform bool clipActive"+r+";"),o.push("uniform vec3 clipPos"+r+";"),o.push("uniform vec3 clipDir"+r+";");if(o.push("varying vec4 vColor;"),o.push("void main(void) {"),s){for(o.push("if (clippable) {"),o.push("  float dist = 0.0;"),r=0,a=t.clips.length;r<a;r++)o.push("if (clipActive"+r+") {"),o.push("   dist += clamp(dot(-clipDir"+r+".xyz, vWorldPosition.xyz - clipPos"+r+".xyz), 0.0, 1000.0);"),o.push("}");o.push("  if (dist > 0.0) { discard; }"),o.push("}")}o.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),o.push("float r = dot(cxy, cxy);"),o.push("if (r > 1.0) {"),o.push("   discard;"),o.push("}"),o.push("gl_FragColor = vColor;"),i?o.push("gl_FragColor = linearToGamma(vColor, gammaFactor);"):o.push("gl_FragColor = vColor;");return o.push("}"),o}(e)}}const Be=new s({}),Re=function(e,t){this.id=Be.addItem({}),this._hash=e,this._scene=t.scene,this._shaderSource=new Le(t),this._allocate(t)},ke={};Re.get=function(e){const t=[e.scene.id,e.scene.gammaOutput?"go":"",e.scene._clipsState.getHash(),e._geometry._state.quantized?"cp":"",e._state.hash].join(";");let i=ke[t];return i||(i=new Re(t,e),ke[t]=i,r.memory.programs++),i._useCount++,i},Re.prototype.put=function(){0==--this._useCount&&(this._scene.off(this._onWebglcontextrestored),Be.removeItem(this.id),this._program&&this._program.destroy(),delete ke[this._hash],r.memory.programs--)},Re.prototype.webglContextRestored=function(){this._program=null},Re.prototype.drawMesh=function(e,t,i){this._program||this._allocate(t);const s=this._scene.canvas.gl,r=0===i?t._ghostMaterial._state:1===i?t._highlightMaterial._state:t._selectedMaterial._state,a=t._state,o=t._geometry._state;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e,t)),r.id!==this._lastMaterialId){const t=r.backfaces;if(e.backfaces!==t&&(t?s.disable(s.CULL_FACE):s.enable(s.CULL_FACE),e.backfaces=t),this._uVertexSize&&s.uniform1f(this._uVertexSize,r.vertexSize),this._uVertexColor){const e=r.vertexColor,t=r.vertexAlpha;s.uniform4f(this._uVertexColor,e[0],e[1],e[2],t)}this._lastMaterialId=r.id}if(s.uniformMatrix4fv(this._uModelMatrix,s.FALSE,t.worldMatrix),this._uModelNormalMatrix&&s.uniformMatrix4fv(this._uModelNormalMatrix,s.FALSE,t.worldNormalMatrix),this._uClippable&&s.uniform1i(this._uClippable,a.clippable),o.combined){const i=t._geometry._getVertexBufs();i.id!==this._lastVertexBufsId&&(i.positionsBuf&&this._aPosition&&(this._aPosition.bindArrayBuffer(i.positionsBuf,i.quantized?s.UNSIGNED_SHORT:s.FLOAT),e.bindArray++),this._lastVertexBufsId=i.id)}o.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,o.positionsDecodeMatrix),o.combined?o.indicesBufCombined&&(o.indicesBufCombined.bind(),e.bindArray++):(this._aPosition&&(this._aPosition.bindArrayBuffer(o.positionsBuf,o.quantized?s.UNSIGNED_SHORT:s.FLOAT),e.bindArray++),o.indicesBuf?(o.indicesBuf.bind(),e.bindArray++):o.positions),this._lastGeometryId=o.id),o.combined?o.indicesBufCombined&&(s.drawElements(s.POINTS,o.indicesBufCombined.numItems,o.indicesBufCombined.itemType,0),e.drawElements++):o.indicesBuf?(s.drawElements(s.POINTS,o.indicesBuf.numItems,o.indicesBuf.itemType,0),e.drawElements++):o.positions&&(s.drawArrays(s.POINTS,0,o.positions.numItems),e.drawArrays++)},Re.prototype._allocate=function(e){const t=e.scene._clipsState,i=e.scene.canvas.gl;if(this._program=new ye(i,this._shaderSource),this._useCount=0,this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uModelMatrix=s.getLocation("modelMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uClips=[];for(let e=0,i=t.clips.length;e<i;e++)this._uClips.push({active:s.getLocation("clipActive"+e),pos:s.getLocation("clipPos"+e),dir:s.getLocation("clipDir"+e)});this._uVertexColor=s.getLocation("vertexColor"),this._uVertexSize=s.getLocation("vertexSize"),this._aPosition=s.getAttribute("position"),this._uClippable=s.getLocation("clippable"),this._uGammaFactor=s.getLocation("gammaFactor"),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null},Re.prototype._bindProgram=function(e,t){const i=this._scene,s=i.canvas.gl,r=i._clipsState,a=this._program,o=i.camera,n=o._state;if(a.bind(),e.useProgram++,e.textureUnit=0,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,s.uniformMatrix4fv(this._uViewMatrix,!1,n.matrix),s.uniformMatrix4fv(this._uProjMatrix,!1,o.project._state.matrix),r.clips.length>0){const e=r.clips;let t,i,a,o,n;for(let r=0,l=this._uClips.length;r<l;r++)t=this._uClips[r],i=t.active,a=e[r],i&&s.uniform1i(i,a.active),o=t.pos,o&&s.uniform3fv(t.pos,a.pos),n=t.dir,n&&s.uniform3fv(t.dir,a.dir)}this._uGammaFactor&&s.uniform1f(this._uGammaFactor,i.gammaFactor)};class Ie{constructor(e){this.vertex=function(e){scene.lights.lights;const t=e._state.billboard,i=[];i.push("// Shadow drawing vertex shader"),i.push("attribute vec3 position;"),i.push("uniform mat4 modelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),cfg.quantizedGeometry&&i.push("uniform mat4 positionsDecodeMatrix;");cfg.clipping&&i.push("varying vec4 vWorldPosition;");"points"===e._geometry._state.primitiveName&&i.push("uniform float pointSize;");"spherical"!==t&&"cylindrical"!==t||(i.push("void billboard(inout mat4 mat) {"),i.push("   mat[0][0] = 1.0;"),i.push("   mat[0][1] = 0.0;"),i.push("   mat[0][2] = 0.0;"),"spherical"===t&&(i.push("   mat[1][0] = 0.0;"),i.push("   mat[1][1] = 1.0;"),i.push("   mat[1][2] = 0.0;")),i.push("   mat[2][0] = 0.0;"),i.push("   mat[2][1] = 0.0;"),i.push("   mat[2][2] =1.0;"),i.push("}"));i.push("void main(void) {"),i.push("vec4 localPosition = vec4(position, 1.0); "),i.push("vec4 worldPosition;"),cfg.quantizedGeometry&&i.push("localPosition = positionsDecodeMatrix * localPosition;");i.push("mat4 viewMatrix2 = viewMatrix;"),i.push("mat4 modelMatrix2 = modelMatrix;"),e._state.stationary&&i.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===t||"cylindrical"===t?(i.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),i.push("billboard(modelMatrix2);"),i.push("billboard(viewMatrix2);"),i.push("billboard(modelViewMatrix);"),cfg.normals&&(i.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),i.push("billboard(modelNormalMatrix2);"),i.push("billboard(viewNormalMatrix2);"),i.push("billboard(modelViewNormalMatrix);")),i.push("worldPosition = modelMatrix2 * localPosition;"),i.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(i.push("worldPosition = modelMatrix2 * localPosition;"),i.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));cfg.clipping&&i.push("vWorldPosition = worldPosition;");"points"===e._geometry._state.primitiveName&&i.push("gl_PointSize = pointSize;");return i.push("   gl_Position = projMatrix * viewPosition;"),i.push("}"),i}(e),this.fragment=function(e){let t;const i=[];if(i.push("// Shadow fragment shader"),i.push("precision "+function(e){if(!e.getShaderPrecisionFormat)return"mediump";if(e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT).precision>0)return"highp";if(e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT).precision>0)return"mediump";return"lowp"}(gl)+" float;"),cfg.clipping)for(i.push("varying vec4 vWorldPosition;"),i.push("uniform bool clippable;"),t=0;t<scene.clips.clips.length;t++)i.push("uniform bool clipActive"+t+";"),i.push("uniform vec3 clipPos"+t+";"),i.push("uniform vec3 clipDir"+t+";");if(i.push("vec4 packDepth (float depth) {"),i.push("  const vec4 bitShift = vec4(1.0, 256.0, 256.0 * 256.0, 256.0 * 256.0 * 256.0);"),i.push("  const vec4 bitMask = vec4(1.0/256.0, 1.0/256.0, 1.0/256.0, 0.0);"),i.push("  vec4 comp = fract(depth * bitShift);"),i.push("  comp -= comp.gbaa * bitMask;"),i.push("  return comp;"),i.push("}"),i.push("void main(void) {"),cfg.clipping){for(i.push("if (clippable) {"),i.push("  float dist = 0.0;"),t=0;t<scene.clips.clips.length;t++)i.push("if (clipActive"+t+") {"),i.push("   dist += clamp(dot(-clipDir"+t+".xyz, vWorldPosition.xyz - clipPos"+t+".xyz), 0.0, 1000.0);"),i.push("}");i.push("  if (dist > 0.0) { discard; }"),cfg.solid&&(i.push("  if (gl_FrontFacing == false) {"),i.push("     gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);"),i.push("     return;"),i.push("  }")),i.push("}")}"points"===e._geometry._state.primitiveName&&(i.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),i.push("float r = dot(cxy, cxy);"),i.push("if (r > 1.0) {"),i.push("   discard;"),i.push("}"));return i.push("gl_FragColor = packDepth(gl_FragCoord.z);"),i.push("}"),i}(e)}}const Ve=function(e,t){if(this._hash=e,this._shaderSource=new Ie(t),this._program=new ye(t.scene.canvas.gl,this._shaderSource),this._scene=scene,this._useCount=0,this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uModelMatrix=i.getLocation("modelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uClips={};for(let e=0,s=t.scene._clipsState.clips.length;e<s;e++)this._uClips.push({active:i.getLocation("clipActive"+e),pos:i.getLocation("clipPos"+e),dir:i.getLocation("clipDir"+e)});this._aPosition=i.getAttribute("position"),this._uClippable=i.getLocation("clippable"),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null},Ne={};Ve.get=function(e){const t=[e.scene.canvas.canvas.id,e.scene._clipsState.getHash(),e._geometry._state.hash,e._state.hash].join(";");let i=Ne[t];return i||(i=new Ve(t,e),Ne[t]=i),i._useCount++,i},Ve.prototype.put=function(){--this._useCount&&(this._program.destroy(),delete Ne[this._hash])},Ve.prototype._bindProgram=function(e){const t=this._scene,i=t.canvas.gl,s=t._clipsState;if(this._program.bind(),e.useProgram++,this._lastLightId=null,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,s.clips.length>0){let e,t,r,a,o;for(let n=0,l=this._uClips.length;n<l;n++)e=this._uClips[n],t=e.active,r=s.clips[n],t&&i.uniform1i(t,r.active),a=e.pos,a&&i.uniform3fv(e.pos,r.pos),o=e.dir,o&&i.uniform3fv(e.dir,r.dir)}},Ve.prototype.webglContextRestored=function(){this._program=null},Ve.prototype.drawMesh=function(e,t,i){const s=this._scene.canvas.gl,r=t._material._state,a=(t._state,t._geometry._state);if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),e.textureUnit=0,i.id!==this._lastLightId&&(s.uniformMatrix4fv(this._uViewMatrix,!1,i.getShadowViewMatrix()),s.uniformMatrix4fv(this._uProjMatrix,!1,i.getShadowProjMatrix()),this._lastLightId=i.id),r.id!==this._lastMaterialId){const t=r.backfaces;e.backfaces!==t&&(t?s.disable(s.CULL_FACE):s.enable(s.CULL_FACE),e.backfaces=t);const i=r.frontface;e.frontface!==i&&(i?s.frontFace(s.CCW):s.frontFace(s.CW),e.frontface=i),e.lineWidth!==r.lineWidth&&(s.lineWidth(r.lineWidth),e.lineWidth=r.lineWidth),this._uPointSize&&s.uniform1i(this._uPointSize,r.pointSize),this._lastMaterialId=r.id}if(s.uniformMatrix4fv(this._uModelMatrix,s.FALSE,t.worldMatrix),this._uClippable&&s.uniform1i(this._uClippable,t._state.clippable),a.combined){const i=t.vertexBufs;i.id!==this._lastVertexBufsId&&(i.positionsBuf&&this._aPosition&&(this._aPosition.bindArrayBuffer(i.positionsBuf,i.quantized?s.UNSIGNED_SHORT:s.FLOAT),e.bindArray++),this._lastVertexBufsId=i.id)}a.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,a.positionsDecodeMatrix),a.combined?a.indicesBufCombined&&(a.indicesBufCombined.bind(),e.bindArray++):(this._aPosition&&(this._aPosition.bindArrayBuffer(a.positionsBuf,a.quantized?s.UNSIGNED_SHORT:s.FLOAT),e.bindArray++),a.indicesBuf&&(a.indicesBuf.bind(),e.bindArray++)),this._lastGeometryId=a.id),a.combined?a.indicesBufCombined&&(s.drawElements(a.primitive,a.indicesBufCombined.numItems,a.indicesBufCombined.itemType,0),e.drawElements++):a.indicesBuf?(s.drawElements(a.primitive,a.indicesBuf.numItems,a.indicesBuf.itemType,0),e.drawElements++):a.positions&&(s.drawArrays(s.TRIANGLES,0,a.positions.numItems),e.drawArrays++)};class Ue{constructor(e){this.vertex=function(e){const t=e.scene._clipsState.clips.length>0,i=!!e._geometry._state.quantized,s=function(e){const t=e._geometry._state.primitiveName;if((e._geometry._state.autoVertexNormals||e._geometry._state.normals)&&("triangles"===t||"triangle-strip"===t||"triangle-fan"===t))return!0;return!1}(e),r=e._state.billboard,a=e._state.stationary,o=[];o.push("// Outline effect vertex shader"),o.push("attribute vec3 position;"),o.push("uniform mat4 modelMatrix;"),o.push("uniform mat4 viewMatrix;"),o.push("uniform mat4 projMatrix;"),o.push("uniform float width;"),i&&o.push("uniform mat4 positionsDecodeMatrix;");t&&o.push("varying vec4 vWorldPosition;");s&&(o.push("attribute vec3 normal;"),i&&(o.push("vec3 octDecode(vec2 oct) {"),o.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),o.push("    if (v.z < 0.0) {"),o.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),o.push("    }"),o.push("    return normalize(v);"),o.push("}")));"spherical"!==r&&"cylindrical"!==r||(o.push("void billboard(inout mat4 mat) {"),o.push("   mat[0][0] = 1.0;"),o.push("   mat[0][1] = 0.0;"),o.push("   mat[0][2] = 0.0;"),"spherical"===r&&(o.push("   mat[1][0] = 0.0;"),o.push("   mat[1][1] = 1.0;"),o.push("   mat[1][2] = 0.0;")),o.push("   mat[2][0] = 0.0;"),o.push("   mat[2][1] = 0.0;"),o.push("   mat[2][2] =1.0;"),o.push("}"));o.push("void main(void) {"),o.push("vec4 localPosition = vec4(position, 1.0); "),o.push("vec4 worldPosition;"),i&&o.push("localPosition = positionsDecodeMatrix * localPosition;");s&&(i?o.push("vec3 localNormal = octDecode(normal.xy); "):o.push("vec3 localNormal = normal; "),o.push("  localPosition.xyz += (normalize(normal) * (width * 0.0005));"));o.push("mat4 viewMatrix2 = viewMatrix;"),o.push("mat4 modelMatrix2 = modelMatrix;"),a&&o.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===r||"cylindrical"===r?(o.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),o.push("billboard(modelMatrix2);"),o.push("billboard(viewMatrix2);"),o.push("billboard(modelViewMatrix);"),o.push("worldPosition = modelMatrix2 * localPosition;"),o.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(o.push("worldPosition = modelMatrix2 * localPosition;"),o.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));t&&o.push("vWorldPosition = worldPosition;");return o.push("   gl_Position = projMatrix * viewPosition;"),o.push("}"),o}(e),this.fragment=function(e){const t=e.scene._clipsState,i=t.clips.length>0,s=[];if(s.push("precision lowp float;"),s.push("uniform vec4  color;"),i){s.push("uniform bool clippable;"),s.push("varying vec4 vWorldPosition;");for(var r=0;r<t.clips.length;r++)s.push("uniform bool clipActive"+r+";"),s.push("uniform vec3 clipPos"+r+";"),s.push("uniform vec3 clipDir"+r+";")}if(s.push("void main(void) {"),i){s.push("if (clippable) {"),s.push("  float dist = 0.0;");for(r=0;r<t.clips.length;r++)s.push("if (clipActive"+r+") {"),s.push("   dist += clamp(dot(-clipDir"+r+".xyz, vWorldPosition.xyz - clipPos"+r+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return s.push("   gl_FragColor = color;"),s.push("}"),s}(e)}}const Oe=new s({}),ze=function(e,t){this._init(e,t)},Ge={};ze.get=function(e){const t=[e.scene.canvas.canvas.id,e.scene.gammaOutput?"go":"",e.scene._clipsState.getHash(),e._geometry._state.hash,e._state.hash].join(";");let i=Ge[t];return i||(i=new ze(t,e),Ge[t]=i,r.memory.programs++),i._useCount++,i},ze.prototype.put=function(){0==--this._useCount&&(Oe.removeItem(this.id),this._program.destroy(),delete Ge[this._hash],r.memory.programs--)},ze.prototype._init=function(e,t){if(this.id=Oe.addItem({}),this._scene=t.scene,this._hash=e,this._shaderSource=new Ue(t),this._program=new ye(t.scene.canvas.gl,this._shaderSource),this._useCount=0,this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uModelMatrix=i.getLocation("modelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uClips=[];for(let e=0,s=t.scene._clipsState.clips.length;e<s;e++)this._uClips.push({active:i.getLocation("clipActive"+e),pos:i.getLocation("clipPos"+e),dir:i.getLocation("clipDir"+e)});this._uColor=i.getLocation("color"),this._uWidth=i.getLocation("width"),this._aPosition=i.getAttribute("position"),this._aNormal=i.getAttribute("normal"),this._uClippable=i.getLocation("clippable"),this._uGammaFactor=i.getLocation("gammaFactor"),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null},ze.prototype._bindProgram=function(e){const t=this._scene,i=t.canvas.gl,s=this._program,r=t._clipsState;if(s.bind(),e.useProgram++,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,i.uniformMatrix4fv(this._uViewMatrix,!1,t.viewTransform.matrix),i.uniformMatrix4fv(this._uProjMatrix,!1,t.projTransform.matrix),r.clips.length>0){let e,t,s,a,o;for(let n=0,l=this._uClips.length;n<l;n++)e=this._uClips[n],t=e.active,s=r.clips[n],t&&i.uniform1i(t,s.active),a=e.pos,a&&i.uniform3fv(e.pos,s.pos),o=e.dir,o&&i.uniform3fv(e.dir,s.dir)}this._uGammaFactor&&i.uniform1f(this._uGammaFactor,t.gammaFactor)},ze.prototype.drawMesh=function(e,t){const i=this._scene.canvas.gl,s=t.outlineMaterial,r=t._state,a=t._geometry._state;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),s.id!==this._lastMaterialId){if(this._uWidth&&i.uniform1f(this._uWidth,s.width),this._uColor){const e=s.color,t=s.alpha;i.uniform4f(this._uColor,e[0],e[1],e[2],t)}this._lastMaterialId=s.id}if(i.uniformMatrix4fv(this._uModelMatrix,i.FALSE,t.worldMatrix),this._uModelNormalMatrix&&i.uniformMatrix4fv(this._uModelNormalMatrix,i.FALSE,t.worldNormalMatrix),this._uClippable&&i.uniform1i(this._uClippable,r.clippable),a.combined){const s=t._geometry._getVertexBufs();s.id!==this._lastVertexBufsId&&(s.positionsBuf&&this._aPosition&&(this._aPosition.bindArrayBuffer(s.positionsBuf,s.quantized?i.UNSIGNED_SHORT:i.FLOAT),e.bindArray++),s.normalsBuf&&this._aNormal&&(this._aNormal.bindArrayBuffer(s.normalsBuf,s.quantized?i.BYTE:i.FLOAT),e.bindArray++),this._lastVertexBufsId=s.id)}a.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&i.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,a.positionsDecodeMatrix),this._uUVDecodeMatrix&&i.uniformMatrix3fv(this._uUVDecodeMatrix,!1,a.uvDecodeMatrix),a.combined?a.indicesBufCombined&&(a.indicesBufCombined.bind(),e.bindArray++):(this._aPosition&&(this._aPosition.bindArrayBuffer(a.positionsBuf,a.quantized?i.UNSIGNED_SHORT:i.FLOAT),e.bindArray++),this._aNormal&&(this._aNormal.bindArrayBuffer(a.normalsBuf,a.quantized?i.BYTE:i.FLOAT),e.bindArray++),a.indicesBuf?(a.indicesBuf.bind(),e.bindArray++):a.positions),this._lastGeometryId=a.id),a.combined?a.indicesBufCombined&&(i.drawElements(a.primitive,a.indicesBufCombined.numItems,a.indicesBufCombined.itemType,0),e.drawElements++):a.indicesBuf?(i.drawElements(a.primitive,a.indicesBuf.numItems,a.indicesBuf.itemType,0),e.drawElements++):a.positions&&(i.drawArrays(i.TRIANGLES,0,a.positions.numItems),e.drawArrays++)};class je{constructor(e){this.vertex=function(e){const t=e.scene._clipsState.clips.length>0,i=!!e._geometry._state.quantized,s=e._state.billboard,r=e._state.stationary,a=[];a.push("// mesh picking vertex shader"),a.push("attribute vec3 position;"),a.push("uniform mat4 modelMatrix;"),a.push("uniform mat4 viewMatrix;"),a.push("uniform mat4 viewNormalMatrix;"),a.push("uniform mat4 projMatrix;"),a.push("varying vec4 vViewPosition;"),i&&a.push("uniform mat4 positionsDecodeMatrix;");t&&a.push("varying vec4 vWorldPosition;");"spherical"!==s&&"cylindrical"!==s||(a.push("void billboard(inout mat4 mat) {"),a.push("   mat[0][0] = 1.0;"),a.push("   mat[0][1] = 0.0;"),a.push("   mat[0][2] = 0.0;"),"spherical"===s&&(a.push("   mat[1][0] = 0.0;"),a.push("   mat[1][1] = 1.0;"),a.push("   mat[1][2] = 0.0;")),a.push("   mat[2][0] = 0.0;"),a.push("   mat[2][1] = 0.0;"),a.push("   mat[2][2] =1.0;"),a.push("}"));a.push("void main(void) {"),a.push("vec4 localPosition = vec4(position, 1.0); "),i&&a.push("localPosition = positionsDecodeMatrix * localPosition;");a.push("mat4 viewMatrix2 = viewMatrix;"),a.push("mat4 modelMatrix2 = modelMatrix;"),r&&a.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"!==s&&"cylindrical"!==s||(a.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),a.push("billboard(modelMatrix2);"),a.push("billboard(viewMatrix2);"));a.push("   vec4 worldPosition = modelMatrix2 * localPosition;"),a.push("   vec4 viewPosition = viewMatrix2 * worldPosition;"),t&&a.push("   vWorldPosition = worldPosition;");return a.push("   gl_Position = projMatrix * viewPosition;"),a.push("}"),a}(e),this.fragment=function(e){const t=e.scene._clipsState,i=t.clips.length>0,s=[];if(s.push("// mesh picking fragment shader"),s.push("precision lowp float;"),s.push("uniform vec4 pickColor;"),i){s.push("uniform bool clippable;"),s.push("varying vec4 vWorldPosition;");for(var r=0;r<t.clips.length;r++)s.push("uniform bool clipActive"+r+";"),s.push("uniform vec3 clipPos"+r+";"),s.push("uniform vec3 clipDir"+r+";")}if(s.push("void main(void) {"),i){s.push("if (clippable) {"),s.push("  float dist = 0.0;");for(r=0;r<t.clips.length;r++)s.push("if (clipActive"+r+") {"),s.push("   dist += clamp(dot(-clipDir"+r+".xyz, vWorldPosition.xyz - clipPos"+r+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return s.push("   gl_FragColor = pickColor; "),s.push("}"),s}(e)}}const Ye=function(e,t){this._hash=e,this._shaderSource=new je(t),this._scene=t.scene,this._useCount=0,this._allocate(t)},We={};Ye.get=function(e){const t=[e.scene.canvas.canvas.id,e.scene._clipsState.getHash(),e._geometry._state.hash,e._state.hash].join(";");let i=We[t];if(!i){if(i=new Ye(t,e),i.errors)return console.log(i.errors.join("\n")),null;We[t]=i,r.memory.programs++}return i._useCount++,i},Ye.prototype.put=function(){0==--this._useCount&&(this._program&&this._program.destroy(),delete We[this._hash],r.memory.programs--)},Ye.prototype.webglContextRestored=function(){this._program=null},Ye.prototype.drawMesh=function(e,t){this._program||this._allocate(t);const i=this._scene.canvas.gl,s=t._material._state,r=(t._state,t._geometry._state);if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),s.id!==this._lastMaterialId){const t=s.backfaces;e.backfaces!==t&&(t?i.disable(i.CULL_FACE):i.enable(i.CULL_FACE),e.backfaces=t);const r=s.frontface;e.frontface!==r&&(r?i.frontFace(i.CCW):i.frontFace(i.CW),e.frontface=r),e.lineWidth!==s.lineWidth&&(i.lineWidth(s.lineWidth),e.lineWidth=s.lineWidth),this._uPointSize&&i.uniform1i(this._uPointSize,s.pointSize),this._lastMaterialId=s.id}if(i.uniformMatrix4fv(this._uModelMatrix,i.FALSE,t.worldMatrix),r.combined){const s=t._geometry._getVertexBufs();s.id!==this._lastVertexBufsId&&(s.positionsBuf&&this._aPosition&&(this._aPosition.bindArrayBuffer(s.positionsBuf,s.quantized?i.UNSIGNED_SHORT:i.FLOAT),e.bindArray++),this._lastVertexBufsId=s.id)}this._uClippable&&i.uniform1i(this._uClippable,t._state.clippable),r.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&i.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,r.positionsDecodeMatrix),r.combined?r.indicesBufCombined&&(r.indicesBufCombined.bind(),e.bindArray++):(this._aPosition&&(this._aPosition.bindArrayBuffer(r.positionsBuf,r.quantized?i.UNSIGNED_SHORT:i.FLOAT),e.bindArray++),r.indicesBuf&&(r.indicesBuf.bind(),e.bindArray++)),this._lastGeometryId=r.id);const a=e.pickmeshIndex>>24&255,o=e.pickmeshIndex>>16&255,n=e.pickmeshIndex>>8&255,l=255&e.pickmeshIndex;e.pickmeshIndex++,i.uniform4f(this._uPickColor,l/255,n/255,o/255,a/255),r.combined?r.indicesBufCombined&&(i.drawElements(r.primitive,r.indicesBufCombined.numItems,r.indicesBufCombined.itemType,0),e.drawElements++):r.indicesBuf?(i.drawElements(r.primitive,r.indicesBuf.numItems,r.indicesBuf.itemType,0),e.drawElements++):r.positions&&i.drawArrays(i.TRIANGLES,0,r.positions.numItems)},Ye.prototype._allocate=function(e){const t=e.scene.canvas.gl;if(this._program=new ye(t,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uModelMatrix=i.getLocation("modelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uClips=[];for(let t=0,s=e.scene._clipsState.clips.length;t<s;t++)this._uClips.push({active:i.getLocation("clipActive"+t),pos:i.getLocation("clipPos"+t),dir:i.getLocation("clipDir"+t)});this._aPosition=i.getAttribute("position"),this._uClippable=i.getLocation("clippable"),this._uPickColor=i.getLocation("pickColor"),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null},Ye.prototype._bindProgram=function(e){this._program||this._allocate(mesh);const t=this._scene,i=t.canvas.gl,s=t._clipsState,r=t.camera,a=r._state;if(this._program.bind(),e.useProgram++,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,i.uniformMatrix4fv(this._uViewMatrix,!1,e.pickViewMatrix||a.matrix),i.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix||r.project._state.matrix),s.clips.length>0){let e,t,r,a,o;for(let n=0,l=this._uClips.length;n<l;n++)e=this._uClips[n],t=e.active,r=s.clips[n],t&&i.uniform1i(t,r.active),a=e.pos,a&&i.uniform3fv(e.pos,r.pos),o=e.dir,o&&i.uniform3fv(e.dir,r.dir)}};class Ke{constructor(e){this.vertex=function(e){const t=e.scene._clipsState.clips.length>0,i=!!e._geometry._state.quantized,s=(e._state.billboard,e._state.stationary,[]);s.push("// Surface picking vertex shader"),s.push("attribute vec3 position;"),s.push("attribute vec4 color;"),s.push("uniform mat4 modelMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),t&&(s.push("uniform bool clippable;"),s.push("varying vec4 vWorldPosition;"));s.push("varying vec4 vColor;"),i&&s.push("uniform mat4 positionsDecodeMatrix;");s.push("void main(void) {"),s.push("vec4 localPosition = vec4(position, 1.0); "),i&&s.push("localPosition = positionsDecodeMatrix * localPosition;");s.push("   vec4 worldPosition = modelMatrix * localPosition; "),s.push("   vec4 viewPosition = viewMatrix * worldPosition;"),t&&s.push("   vWorldPosition = worldPosition;");return s.push("   vColor = color;"),s.push("   gl_Position = projMatrix * viewPosition;"),s.push("}"),s}(e),this.fragment=function(e){const t=e.scene._clipsState,i=t.clips.length>0,s=[];if(s.push("// Surface picking fragment shader"),s.push("precision lowp float;"),s.push("varying vec4 vColor;"),i){s.push("uniform bool clippable;"),s.push("varying vec4 vWorldPosition;");for(var r=0;r<t.clips.length;r++)s.push("uniform bool clipActive"+r+";"),s.push("uniform vec3 clipPos"+r+";"),s.push("uniform vec3 clipDir"+r+";")}if(s.push("void main(void) {"),i){s.push("if (clippable) {"),s.push("  float dist = 0.0;");for(r=0;r<t.clips.length;r++)s.push("if (clipActive"+r+") {"),s.push("   dist += clamp(dot(-clipDir"+r+".xyz, vWorldPosition.xyz - clipPos"+r+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return s.push("   gl_FragColor = vColor;"),s.push("}"),s}(e)}}const Xe=function(e,t){const i=t.scene.canvas.gl;if(this._hash=e,this._shaderSource=new Ke(t),this._program=new ye(i,this._shaderSource),this._scene=t.scene,this._useCount=0,this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uModelMatrix=s.getLocation("modelMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uClips=[];for(let e=0,i=t.scene._clipsState.clips.length;e<i;e++)this._uClips.push({active:s.getLocation("clipActive"+e),pos:s.getLocation("clipPos"+e),dir:s.getLocation("clipDir"+e)});this._aPosition=s.getAttribute("position"),this._aColor=s.getAttribute("color"),this._uClippable=s.getLocation("clippable")},He={};Xe.get=function(e,t){const i=[t.scene.canvas.canvas.id,t.scene._clipsState.getHash(),t._geometry._state.quantized?"cp":"",t._state.hash].join(";");let s=He[i];if(!s){if(s=new Xe(i,t),s.errors)return console.log(s.errors.join("\n")),null;He[i]=s,r.memory.programs++}return s._useCount++,s},Xe.prototype.put=function(){0==--this._useCount&&(this._program&&this._program.destroy(),delete He[this._hash],r.memory.programs--)},Xe.prototype.webglContextRestored=function(){this._program=null},Xe.prototype._bindProgram=function(e){const t=this._scene,i=t.canvas.gl,s=t._clipsState,r=t.camera,a=r._state;if(this._program.bind(),e.useProgram++,this._lastVertexBufsId=null,this._lastGeometryId=null,i.uniformMatrix4fv(this._uViewMatrix,!1,a.matrix),i.uniformMatrix4fv(this._uProjMatrix,!1,r.project._state.matrix),s.clips.length>0){const e=s.clips;let t,r,a,o,n;for(let s=0,l=this._uClips.length;s<l;s++)t=this._uClips[s],r=t.active,a=e[s],r&&i.uniform1i(r,a.active),o=t.pos,o&&i.uniform3fv(t.pos,a.pos),n=t.dir,n&&i.uniform3fv(t.dir,a.dir)}},Xe.prototype.drawMesh=function(e,t){const i=this._scene.canvas.gl,s=t._geometry._state;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),i.uniformMatrix4fv(this._uModelMatrix,i.FALSE,t.worldMatrix),this._uClippable&&i.uniform1i(this._uClippable,t._state.clippable),s.id!==this._lastGeometryId){const e=s.getVertexPickPositions();this._uPositionsDecodeMatrix?(i.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,s.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(e,s.quantized?i.UNSIGNED_SHORT:i.FLOAT)):this._aPosition.bindArrayBuffer(e);const t=s.getVertexPickColors();t.bind(),i.enableVertexAttribArray(this._aColor.location),this._gl.vertexAttribPointer(this._aColor.location,t.itemSize,t.itemType,!0,0,0),this._lastGeometryId=s.id}i.drawArrays(s.primitive,0,positions.numItems/3)};class qe{constructor(e){this.vertex=function(e){const t=e.scene._clipsState.clips.length>0,i=!!e._geometry._state.quantized,s=(e._state.billboard,e._state.stationary,[]);s.push("// Surface picking vertex shader"),s.push("attribute vec3 position;"),s.push("attribute vec4 color;"),s.push("uniform mat4 modelMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),t&&(s.push("uniform bool clippable;"),s.push("varying vec4 vWorldPosition;"));s.push("varying vec4 vColor;"),i&&s.push("uniform mat4 positionsDecodeMatrix;");s.push("void main(void) {"),s.push("vec4 localPosition = vec4(position, 1.0); "),i&&s.push("localPosition = positionsDecodeMatrix * localPosition;");s.push("   vec4 worldPosition = modelMatrix * localPosition; "),s.push("   vec4 viewPosition = viewMatrix * worldPosition;"),t&&s.push("   vWorldPosition = worldPosition;");return s.push("   vColor = color;"),s.push("   gl_Position = projMatrix * viewPosition;"),s.push("}"),s}(e),this.fragment=function(e){const t=e.scene._clipsState,i=t.clips.length>0,s=[];if(s.push("// Surface picking fragment shader"),s.push("precision lowp float;"),s.push("varying vec4 vColor;"),i){s.push("uniform bool clippable;"),s.push("varying vec4 vWorldPosition;");for(var r=0;r<t.clips.length;r++)s.push("uniform bool clipActive"+r+";"),s.push("uniform vec3 clipPos"+r+";"),s.push("uniform vec3 clipDir"+r+";")}if(s.push("void main(void) {"),i){s.push("if (clippable) {"),s.push("  float dist = 0.0;");for(r=0;r<t.clips.length;r++)s.push("if (clipActive"+r+") {"),s.push("   dist += clamp(dot(-clipDir"+r+".xyz, vWorldPosition.xyz - clipPos"+r+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return s.push("   gl_FragColor = vColor;"),s.push("}"),s}(e)}}const Qe=function(e,t){this._hash=e,this._scene=t.scene,this._useCount=0,this._shaderSource=new qe(t),this._allocate(t)},Ze={};Qe.get=function(e){const t=[e.scene.canvas.canvas.id,e.scene._clipsState.getHash(),e._geometry._state.quantized?"cp":"",e._state.hash].join(";");let i=Ze[t];if(!i){if(i=new Qe(t,e),i.errors)return console.log(i.errors.join("\n")),null;Ze[t]=i,r.memory.programs++}return i._useCount++,i},Qe.prototype.put=function(){0==--this._useCount&&(this._program&&this._program.destroy(),delete Ze[this._hash],r.memory.programs--)},Qe.prototype.webglContextRestored=function(){this._program=null},Qe.prototype.drawMesh=function(e,t){this._program||this._allocate(t);const i=this._scene,s=i.canvas.gl,r=i._clipsState,a=t._material._state,o=(t._state,t._geometry),n=t._geometry._state,l=a.backfaces,h=a.frontface,u=o._getPickTrianglePositions(),c=o._getPickTriangleColors(),d=i.camera,p=d._state;if(this._program.bind(),e.useProgram++,s.uniformMatrix4fv(this._uViewMatrix,!1,e.pickViewMatrix||p.matrix),s.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix||d.project._state.matrix),r.clips.length>0){const e=r.clips;let t,i,a,o,n;for(let r=0,l=this._uClips.length;r<l;r++)t=this._uClips[r],i=t.active,a=e[r],i&&s.uniform1i(i,a.active),o=t.pos,o&&s.uniform3fv(t.pos,a.pos),n=t.dir,n&&s.uniform3fv(t.dir,a.dir)}e.backfaces!==l&&(l?s.disable(s.CULL_FACE):s.enable(s.CULL_FACE),e.backfaces=l),e.frontface!==h&&(h?s.frontFace(s.CCW):s.frontFace(s.CW),e.frontface=h),this._lastMaterialId=a.id,s.uniformMatrix4fv(this._uModelMatrix,s.FALSE,t.worldMatrix),this._uClippable&&s.uniform1i(this._uClippable,t._state.clippable),this._uPositionsDecodeMatrix?(s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,n.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(u,n.quantized?s.UNSIGNED_SHORT:s.FLOAT)):this._aPosition.bindArrayBuffer(u),c.bind(),s.enableVertexAttribArray(this._aColor.location),s.vertexAttribPointer(this._aColor.location,c.itemSize,c.itemType,!0,0,0),s.drawArrays(n.primitive,0,u.numItems/3)},Qe.prototype._allocate=function(e){const t=e.scene.canvas.gl;if(this._program=new ye(t,this._shaderSource),this._useCount=0,this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uModelMatrix=i.getLocation("modelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uClips=[];for(let t=0,s=e.scene._clipsState.clips.length;t<s;t++)this._uClips.push({active:i.getLocation("clipActive"+t),pos:i.getLocation("clipPos"+t),dir:i.getLocation("clipDir"+t)});this._aPosition=i.getAttribute("position"),this._aColor=i.getAttribute("color"),this._uClippable=i.getLocation("clippable")};const $e=d.OBB3();class Je extends ue{get type(){return"xeogl.Mesh"}static _compareState(e,t){return e._state.layer-t._state.layer||e._drawRenderer.id-t._drawRenderer.id||e._material._state.id-t._material._state.id||e._vertexBufs.id-t._vertexBufs.id||e._geometry._state.id-t._geometry._state.id}init(e){this._state=new D({visible:!0,culled:!1,pickable:null,clippable:null,colorize:null,collidable:null,castShadow:null,receiveShadow:null,outlined:null,ghosted:!1,highlighted:!1,selected:!1,edges:!1,layer:null,billboard:this._checkBillboard(e.billboard),stationary:!!e.stationary,hash:""}),this._drawRenderer=null,this._emphasisFillRenderer=null,this._emphasisEdgesRenderer=null,this._emphasisVerticesRenderer=null,this._pickMeshRenderer=null,this._pickTriangleRenderer=null,this._worldPositions=null,this._worldPositionsDirty=!0,this._geometry=e.geometry?this._checkComponent("xeogl.Geometry",e.geometry):this.scene.geometry,this._vertexBufs=this._geometry._getVertexBufs(),this._material=e.material?this._checkComponent("xeogl.Material",e.material):this.scene.material,this._ghostMaterial=e.ghostMaterial?this._checkComponent("xeogl.EmphasisMaterial",e.ghostMaterial):this.scene.ghostMaterial,this._outlineMaterial=e.outlineMaterial?this._checkComponent("xeogl.EmphasisMaterial",e.outlineMaterial):this.scene.outlineMaterial,this._highlightMaterial=e.highlightMaterial?this._checkComponent("xeogl.EmphasisMaterial",e.highlightMaterial):this.scene.highlightMaterial,this._selectedMaterial=e.selectedMaterial?this._checkComponent("xeogl.EmphasisMaterial",e.selectedMaterial):this.scene.selectedMaterial,this._edgeMaterial=e.edgeMaterial?this._checkComponent("xeogl.EdgeMaterial",e.edgeMaterial):this.scene.edgeMaterial,this._compile(),super.init(e),this.scene._meshCreated(this)}_checkBillboard(e){return"spherical"!==(e=e||"none")&&"cylindrical"!==e&&"none"!==e&&(this.error("Unsupported value for 'billboard': "+e+" - accepted values are 'spherical', 'cylindrical' and 'none' - defaulting to 'none'."),e="none"),e}_compile(){this._putRenderers(),this._makeHash(),this._drawRenderer=be.get(this),this._emphasisFillRenderer=Ce.get(this),this._emphasisEdgesRenderer=Se.get(this),this._emphasisVerticesRenderer=Re.get(this),this._pickMeshRenderer=Ye.get(this),this._renderer.meshListDirty()}_webglContextRestored(){this._drawRenderer&&this._drawRenderer.webglContextRestored(),this._emphasisFillRenderer&&this._emphasisFillRenderer.webglContextRestored(),this._emphasisEdgesRenderer&&this._emphasisEdgesRenderer.webglContextRestored(),this._emphasisVerticesRenderer&&this._emphasisVerticesRenderer.webglContextRestored(),this._pickMeshRenderer&&this._pickMeshRenderer.webglContextRestored(),this._pickTriangleRenderer&&this._pickMeshRenderer.webglContextRestored()}_makeHash(){const e=[],t=this._state;t.stationary&&e.push("/s"),"none"===t.billboard?e.push("/n"):"spherical"===t.billboard?e.push("/s"):"cylindrical"===t.billboard&&e.push("/c"),t.receiveShadow&&e.push("/rs"),e.push(";"),this._state.hash=e.join("")}_buildMeshAABB(e,t){d.transformOBB3(e,this._geometry.obb,$e),d.OBB3ToAABB3($e,t)}_getSceneHash(){return(this.scene.gammaInput?"gi;":";")+(this.scene.gammaOutput?"go":"")}_draw(e){(this._drawRenderer||(this._drawRenderer=be.get(this)))&&this._drawRenderer.drawMesh(e,this)}_drawGhostFill(e){(this._emphasisFillRenderer||(this._emphasisFillRenderer=Ce.get(this)))&&this._emphasisFillRenderer.drawMesh(e,this,0)}_drawGhostEdges(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=Se.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,0)}_drawGhostVertices(e){(this._emphasisVerticesRenderer||(this._emphasisVerticesRenderer=Re.get(this)))&&this._emphasisVerticesRenderer.drawMesh(e,this,0)}_drawHighlightFill(e){(this._emphasisFillRenderer||(this._emphasisFillRenderer=Ce.get(this)))&&this._emphasisFillRenderer.drawMesh(e,this,1)}_drawHighlightEdges(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=Se.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,1)}_drawHighlightVertices(e){(this._emphasisVerticesRenderer||(this._emphasisVerticesRenderer=Re.get(this)))&&this._emphasisVerticesRenderer.drawMesh(e,this,1)}_drawSelectedFill(e){(this._emphasisFillRenderer||(this._emphasisFillRenderer=Ce.get(this)))&&this._emphasisFillRenderer.drawMesh(e,this,2)}_drawSelectedEdges(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=Se.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,2)}_drawSelectedVertices(e){(this._emphasisVerticesRenderer||(this._emphasisVerticesRenderer=Re.get(this)))&&this._emphasisVerticesRenderer.drawMesh(e,this,2)}_drawEdges(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=Se.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,3)}_drawShadow(e,t){(this._shadowRenderer||(this._shadowRenderer=Ve.get(this)))&&this._shadowRenderer.drawMesh(e,this,t)}_drawOutline(e){(this._shadowRenderer||(this._outlineRenderer=ze.get(this)))&&this._outlineRenderer.drawMesh(e,this)}_pickMesh(e){(this._pickMeshRenderer||(this._pickMeshRenderer=Ye.get(this)))&&this._pickMeshRenderer.drawMesh(e,this)}_pickTriangle(e){(this._pickTriangleRenderer||(this._pickTriangleRenderer=Qe.get(this)))&&this._pickTriangleRenderer.drawMesh(e,this)}_pickVertex(e){(this._pickVertexRenderer||(this._pickVertexRenderer=Xe.get(this)))&&this._pickVertexRenderer.drawMesh(e,this)}_getOutlineRenderer(){return this._outlineRenderer=ze.get(this),!this._outlineRenderer.errors||(this.errors=(this.errors||[]).concat(this._outlineRenderer.errors),this.error(this._outlineRenderer.errors.join("\n")),!1)}_putRenderers(){this._drawRenderer&&(this._drawRenderer.put(),this._drawRenderer=null),this._emphasisFillRenderer&&(this._emphasisFillRenderer.put(),this._emphasisFillRenderer=null),this._emphasisEdgesRenderer&&(this._emphasisEdgesRenderer.put(),this._emphasisEdgesRenderer=null),this._emphasisVerticesRenderer&&(this._emphasisVerticesRenderer.put(),this._emphasisVerticesRenderer=null),this._outlineRenderer&&(this._outlineRenderer.put(),this._outlineRenderer=null),this._shadowRenderer&&(this._shadowRenderer.put(),this._shadowRenderer=null),this._pickMeshRenderer&&(this._pickMeshRenderer.put(),this._pickMeshRenderer=null),this._pickTriangleRenderer&&(this._pickTriangleRenderer.put(),this._pickTriangleRenderer=null),this._pickVertexRenderer&&(this._pickVertexRenderer.put(),this._pickVertexRenderer=null)}get worldPositions(){if(this._worldPositionsDirty){const e=this._geometry.positions;this._worldPositions||(this._worldPositions=new Float32Array(e.length)),d.transformPositions3(this.worldMatrix,e,this._worldPositions),this._worldPositionsDirty=!1}return this._worldPositions}set worldPositions(e){(e=null===e)&&(this._worldPositions=null,this._worldPositionsDirty=!0)}get geometry(){return this._geometry}get material(){return this._material}get ghostMaterial(){return this._ghostMaterial}get highlightMaterial(){return this._highlightMaterial}get selectedMaterial(){return this._selectedMaterial}get edgeMaterial(){return this._edgeMaterial}get outlineMaterial(){return this._outlineMaterial}set visible(e){e=!1!==e,this._state.visible=e,this._entityType&&this.scene._entityVisibilityUpdated(this,e),this._renderer.imageDirty()}get visible(){return this._state.visible}set ghosted(e){e=!!e,this._state.ghosted!==e&&(this._state.ghosted=e,this._entityType&&this.scene._entityGhostedUpdated(this,e),this._renderer.imageDirty())}get ghosted(){return this._state.ghosted}set highlighted(e){(e=!!e)!==this._state.highlighted&&(this._state.highlighted=e,this._entityType&&this.scene._entityHighlightedUpdated(this,e),this._renderer.imageDirty())}get highlighted(){return this._state.highlighted}set selected(e){(e=!!e)!==this._state.selected&&(this._state.selected=e,this._entityType&&this.scene._entitySelectedUpdated(this,e),this._renderer.imageDirty())}get selected(){return this._state.selected}set edges(e){(e=!!e)!==this._state.edges&&(this._state.edges=e,this._renderer.imageDirty())}get edges(){return this._state.edges}set culled(e){this._state.culled=!!e,this._renderer.imageDirty()}get culled(){return this._state.culled}set pickable(e){e=!1!==e,this._state.pickable!==e&&(this._state.pickable=e)}get pickable(){return this._state.pickable}set clippable(e){e=!1!==e,this._state.clippable!==e&&(this._state.clippable=e,this._renderer.imageDirty())}get clippable(){return this._state.clippable}set collidable(e){(e=!1!==e)!==this._state.collidable&&(this._state.collidable=e)}get collidable(){return this._state.collidable}set castShadow(e){}get castShadow(){return this._state.castShadow}set receiveShadow(e){}get receiveShadow(){return this._state.receiveShadow}set outlined(e){(e=!!e)!==this._state.outlined&&(this._state.outlined=e,this._renderer.imageDirty())}get outlined(){return this._state.outlined}set colorize(e){let t=this._state.colorize;t||(t=this._state.colorize=new Float32Array(4),t[3]=1),e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1),this._renderer.imageDirty()}get colorize(){return this._state.colorize}set opacity(e){let t=this._state.colorize;t||(t=this._state.colorize=new Float32Array(4),t[0]=1,t[1]=1,t[2]=1),t[3]=null!=e?e:1,this._renderer.imageDirty()}get opacity(){return this._state.colorize[3]}set layer(e){e=e||0,(e=Math.round(e))!==this._state.layer&&(this._state.layer=e,this._renderer.needStateSort())}get layer(){return this._state.layer}get stationary(){return this._state.stationary}get billboard(){return this._state.billboard}destroy(){super.destroy(),this._putRenderers(),this._renderer.meshListDirty(),this.scene._meshDestroyed(this)}}m["xeogl.Mesh"]=Je;const et=function(e,t){t=t||{};const i=new C,s=e.canvas.canvas,a=e.canvas.gl,o=!0===t.transparent,n=[];let l=0;const h=[];let u=0,c=!0,p=!0,_=!0;this.imageForceDirty=!0;let m=!0,f=null,g=null;function v(){c&&(!function(){l=0;for(const t in e.meshes)e.meshes.hasOwnProperty(t)&&(n[l++]=e.meshes[t]);for(let e=l,t=n.length;e<t;e++)n[e]=null;n.length=l}(),c=!1,p=!0),p&&(n.sort(Je._compareState),p=!1,_=!0)}this.meshListDirty=function(){c=!0,p=!0},this.needStateSort=function(){p=!0},this.shadowsDirty=function(){},this.imageDirty=function(){_=!0},this.setImageForceDirty=function(){this.imageForceDirty=!0},this.setBlendOneMinusSrcAlpha=function(e){m=e},this.webglContextLost=function(){},this.webglContextRestored=function(e){f&&f.webglContextRestored(e),g&&g.webglContextRestored(e),_=!0},this.clear=function(t){t=t||{};const i=e.viewport.boundary;if(a.viewport(i[0],i[1],i[2],i[3]),o)a.clearColor(0,0,0,0);else{const e=t.ambientColor||this.lights.getAmbientColor();a.clearColor(e[0],e[1],e[2],1)}a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT|a.STENCIL_BUFFER_BIT)},this.render=function(e){e=e||{},v(),(_||this.imageForceDirty||e.force)&&(M(e),r.frame.frameCount++,_=!1,this.imageForceDirty=!1)};var M=function(){const t=[],s=[],h=[],u=[],c=[],d=[],p=[],_=[],f=[],g=[],v=[],M=[],y=[],x=[],w=[],A=[],E=[],C=[],P=[],T=[],D=[],S=[],F=[],L=[];let B=0;return function(R){b.SUPPORTED_EXTENSIONS.OES_element_index_uint&&a.getExtension("OES_element_index_uint"),b.SUPPORTED_EXTENSIONS.OES_standard_derivatives&&a.getExtension("OES_standard_derivatives");const k=e._lightsState.getAmbientColor();i.reset(),i.pass=R.pass;const I=e.viewport.boundary;let V,N,U,O,z,G;a.viewport(I[0],I[1],I[2],I[3]),o?a.clearColor(0,0,0,0):a.clearColor(k[0],k[1],k[2],1),a.enable(a.DEPTH_TEST),a.frontFace(a.CCW),a.enable(a.CULL_FACE),a.depthMask(!0);const j=Date.now();!1!==R.clear&&a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT|a.STENCIL_BUFFER_BIT);let Y=0,W=0,K=0,X=0,H=0,q=0,Q=0,Z=0,$=0,J=0,ee=0,te=0,ie=0,se=0,re=0,ae=0,oe=0,ne=0,le=0,he=0,ue=0,ce=0,de=0;for(B=0,V=0,N=l;V<N;V++)if(U=n[V],O=U._state,z=U._material._state,!0!==O.culled&&!1!==O.visible&&0!==z.alpha){if(O.ghosted){const e=U._ghostMaterial._state;e.edges&&(e.edgeAlpha<1?d[q++]=U:h[K++]=U),e.vertices&&(e.vertexAlpha<1?c[H++]=U:s[W++]=U),e.fill&&(e.fillAlpha<1?u[X++]=U:t[Y++]=U)}else G=2===z.alphaMode||O.xray||O.colorize[3]<1,G?L[B++]=U:O.outlined?D[Q++]=U:U._draw(i);if(O.selected){const e=U._selectedMaterial._state;e.edges&&(e.edgeAlpha<1?C[ue++]=U:w[ne++]=U),e.vertices&&(e.vertexAlpha<1?E[he++]=U:x[oe++]=U),e.fill&&(e.fillAlpha<1?A[le++]=U:y[ae++]=U),O.selected&&(F[$++]=U)}if(O.highlighted){const e=U._highlightMaterial._state;e.edges&&(e.edgeAlpha<1?M[re++]=U:f[te++]=U),e.vertices&&(e.vertexAlpha<1?v[se++]=U:_[ee++]=U),e.fill&&(e.fillAlpha<1?g[ie++]=U:p[J++]=U),O.highlighted&&(S[Z++]=U)}if(O.edges){U._edgeMaterial._state.edgeAlpha<1?T[de++]=U:P[ce++]=U}}if(Q>0){for(a.enable(a.STENCIL_TEST),a.stencilFunc(a.ALWAYS,1,1),a.stencilOp(a.KEEP,a.KEEP,a.REPLACE),a.stencilMask(1),a.clearStencil(0),a.clear(a.STENCIL_BUFFER_BIT),V=0;V<Q;V++)D[V]._draw(i);for(a.stencilFunc(a.EQUAL,0,1),a.stencilOp(a.KEEP,a.KEEP,a.KEEP),a.stencilMask(0),a.disable(a.CULL_FACE),V=0;V<Q;V++)D[V]._drawOutline(i);a.disable(a.STENCIL_TEST)}if(ce>0)for(V=0;V<ce;V++)P[V]._drawEdges(i);if(Y>0)for(V=0;V<Y;V++)t[V]._drawGhostFill(i);if(K>0)for(V=0;V<K;V++)h[V]._drawGhostEdges(i);if(W>0)for(V=0;V<W;V++)s[V]._drawGhostVertices(i);if(X>0||q>0||H>0||B>0){if(a.enable(a.CULL_FACE),a.enable(a.BLEND),m?a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA):(a.blendEquation(a.FUNC_ADD),a.blendFuncSeparate(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA,a.ONE,a.ONE_MINUS_SRC_ALPHA)),i.backfaces=!1,H>0)for(V=0;V<H;V++)c[V]._drawGhostVertices(i);if(q>0)for(V=0;V<q;V++)d[V]._drawGhostEdges(i);if(X>0)for(V=0;V<X;V++)u[V]._drawGhostFill(i);for(Q=0,V=0;V<B;V++)U=L[V],U._state.outlined?D[Q++]=U:U._draw(i);a.disable(a.BLEND)}if(J>0||te>0||ee>0){if(i.lastProgramId=null,a.clear(a.DEPTH_BUFFER_BIT),ee>0)for(V=0;V<ee;V++)_[V]._drawHighlightVertices(i);if(te>0)for(V=0;V<te;V++)f[V]._drawHighlightEdges(i);if(J>0)for(V=0;V<J;V++)p[V]._drawHighlightFill(i)}if(ie>0||re>0||se>0){if(i.lastProgramId=null,a.clear(a.DEPTH_BUFFER_BIT),a.enable(a.CULL_FACE),a.enable(a.BLEND),a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA),se>0)for(V=0;V<se;V++)v[V]._drawHighlightVertices(i);if(re>0)for(V=0;V<re;V++)M[V]._drawHighlightEdges(i);if(ie>0)for(V=0;V<ie;V++)g[V]._drawHighlightFill(i);a.disable(a.BLEND)}if(ae>0||ne>0||oe>0){if(i.lastProgramId=null,a.clear(a.DEPTH_BUFFER_BIT),oe>0)for(V=0;V<oe;V++)x[V]._drawSelectedVertices(i);if(ne>0)for(V=0;V<ne;V++)w[V]._drawSelectedEdges(i);if(ae>0)for(V=0;V<ae;V++)y[V]._drawSelectedFill(i)}if(le>0||ue>0||he>0){if(i.lastProgramId=null,a.clear(a.DEPTH_BUFFER_BIT),a.enable(a.CULL_FACE),a.enable(a.BLEND),a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA),he>0)for(V=0;V<he;V++)E[V]._drawSelectedVertices(i);if(ue>0)for(V=0;V<ue;V++)C[V]._drawSelectedEdges(i);if(le>0)for(V=0;V<le;V++)A[V]._drawSelectedFill(i);a.disable(a.BLEND)}const pe=Date.now(),_e=r.frame;_e.renderTime=(pe-j)/1e3,_e.drawElements=i.drawElements,_e.drawElements=i.drawElements,_e.useProgram=i.useProgram,_e.bindTexture=i.bindTexture,_e.bindArray=i.bindArray;const me=b.MAX_TEXTURE_UNITS;for(let e=0;e<me;e++)a.activeTexture(a.TEXTURE0+e);a.bindTexture(a.TEXTURE_CUBE_MAP,null),a.bindTexture(a.TEXTURE_2D,null)}}();this.pick=function(){const t=d.vec3(),r=d.mat4(),o=d.vec3([0,1,0]),c=d.frustumMat4(-1,1,-1,1,.1,1e4);return function(p){let _,m,g,M,y;v(),b.SUPPORTED_EXTENSIONS.OES_element_index_uint&&a.getExtension("OES_element_index_uint");let x=null,w=null;p.canvasPos?(_=p.canvasPos[0],m=p.canvasPos[1]):(g=p.origin||d.vec3([0,0,0]),M=p.direction||d.vec3([0,0,1]),y=d.addVec3(g,M,t),x=d.lookAtMat4v(g,y,o,r),w=c,_=.5*s.clientWidth,m=.5*s.clientHeight),f=f||new P(s,a),f.bind();const A=function(t,s,r,o,c){i.reset(),i.backfaces=!0,i.frontface=!0,i.pickViewMatrix=r,i.pickProjMatrix=o,i.pickMeshIndex=1;const d=e.viewport.boundary;let p,_,m;a.viewport(d[0],d[1],d[2],d[3]),a.clearColor(0,0,0,0),a.enable(a.DEPTH_TEST),a.disable(a.CULL_FACE),a.disable(a.BLEND),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT),u=0;const g=c.includeMeshIds,v=c.excludeMeshIds;for(p=0,_=l;p<_;p++)m=n[p],!0!==m._state.culled&&!1!==m._state.visible&&!1!==m._state.pickable&&(g&&!g[m.id]||v&&v[m.id]||(h[u++]=m,m._pickMesh(i)));const M=f.read(Math.round(t),Math.round(s));let y=M[0]+256*M[1]+256*M[2]*256+256*M[3]*256*256;return y--,y>=0?h[y]:null}(_,m,x,w,p);if(!A)return f.unbind(),null;const E={mesh:A};return p.pickSurface&&(E.primIndex=function(t,s,r,o,n){i.reset(),i.backfaces=!0,i.frontface=!0,i.pickViewMatrix=o,i.pickProjMatrix=n;const l=e.viewport.boundary;a.viewport(l[0],l[1],l[2],l[3]),a.clearColor(0,0,0,0),a.enable(a.DEPTH_TEST),a.disable(a.CULL_FACE),a.disable(a.BLEND),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT),t._pickTriangle(i);const h=f.read(s,r);let u=h[0]+256*h[1]+256*h[2]*256+256*h[3]*256*256;return u*=3,u}(A,_,m,x,w)),x&&(E.origin=g,E.direction=M),f.unbind(),E}}(),this.readPixels=function(e,t,i,r){let o,n,l,h;for(g=g||(g=new P(s,a)),g.bind(),g.clear(),this.render({force:!0,opaqueOnly:r}),n=0;n<i;n++)l=2*n,h=4*n,o=g.read(e[l],e[l+1]),t[h]=o[0],t[h+1]=o[1],t[h+2]=o[2],t[h+3]=o[3];g.unbind(),_=!0},this.destroy=function(){f&&f.destroy(),g&&g.destroy()}};class tt extends g{get type(){return"xeogl.Input"}init(e){super.init(e);const t=this;this.KEY_BACKSPACE=8,this.KEY_TAB=9,this.KEY_ENTER=13,this.KEY_SHIFT=16,this.KEY_CTRL=17,this.KEY_ALT=18,this.KEY_PAUSE_BREAK=19,this.KEY_CAPS_LOCK=20,this.KEY_ESCAPE=27,this.KEY_PAGE_UP=33,this.KEY_PAGE_DOWN=34,this.KEY_END=35,this.KEY_HOME=36,this.KEY_LEFT_ARROW=37,this.KEY_UP_ARROW=38,this.KEY_RIGHT_ARROW=39,this.KEY_DOWN_ARROW=40,this.KEY_INSERT=45,this.KEY_DELETE=46,this.KEY_NUM_0=48,this.KEY_NUM_1=49,this.KEY_NUM_2=50,this.KEY_NUM_3=51,this.KEY_NUM_4=52,this.KEY_NUM_5=53,this.KEY_NUM_6=54,this.KEY_NUM_7=55,this.KEY_NUM_8=56,this.KEY_NUM_9=57,this.KEY_A=65,this.KEY_B=66,this.KEY_C=67,this.KEY_D=68,this.KEY_E=69,this.KEY_F=70,this.KEY_G=71,this.KEY_H=72,this.KEY_I=73,this.KEY_J=74,this.KEY_K=75,this.KEY_L=76,this.KEY_M=77,this.KEY_N=78,this.KEY_O=79,this.KEY_P=80,this.KEY_Q=81,this.KEY_R=82,this.KEY_S=83,this.KEY_T=84,this.KEY_U=85,this.KEY_V=86,this.KEY_W=87,this.KEY_X=88,this.KEY_Y=89,this.KEY_Z=90,this.KEY_LEFT_WINDOW=91,this.KEY_RIGHT_WINDOW=92,this.KEY_SELECT_KEY=93,this.KEY_NUMPAD_0=96,this.KEY_NUMPAD_1=97,this.KEY_NUMPAD_2=98,this.KEY_NUMPAD_3=99,this.KEY_NUMPAD_4=100,this.KEY_NUMPAD_5=101,this.KEY_NUMPAD_6=102,this.KEY_NUMPAD_7=103,this.KEY_NUMPAD_8=104,this.KEY_NUMPAD_9=105,this.KEY_MULTIPLY=106,this.KEY_ADD=107,this.KEY_SUBTRACT=109,this.KEY_DECIMAL_POINT=110,this.KEY_DIVIDE=111,this.KEY_F1=112,this.KEY_F2=113,this.KEY_F3=114,this.KEY_F4=115,this.KEY_F5=116,this.KEY_F6=117,this.KEY_F7=118,this.KEY_F8=119,this.KEY_F9=120,this.KEY_F10=121,this.KEY_F11=122,this.KEY_F12=123,this.KEY_NUM_LOCK=144,this.KEY_SCROLL_LOCK=145,this.KEY_SEMI_COLON=186,this.KEY_EQUAL_SIGN=187,this.KEY_COMMA=188,this.KEY_DASH=189,this.KEY_PERIOD=190,this.KEY_FORWARD_SLASH=191,this.KEY_GRAVE_ACCENT=192,this.KEY_OPEN_BRACKET=219,this.KEY_BACK_SLASH=220,this.KEY_CLOSE_BRACKET=221,this.KEY_SINGLE_QUOTE=222,this.KEY_SPACE=32,this.KEY_BACKSPACE=8,this.KEY_TAB=9,this.KEY_ENTER=13,this.KEY_SHIFT=16,this.KEY_CTRL=17,this.KEY_ALT=18,this.KEY_PAUSE_BREAK=19,this.KEY_CAPS_LOCK=20,this.KEY_ESCAPE=27,this.KEY_PAGE_UP=33,this.KEY_PAGE_DOWN=34,this.KEY_END=35,this.KEY_HOME=36,this.KEY_LEFT_ARROW=37,this.KEY_UP_ARROW=38,this.KEY_RIGHT_ARROW=39,this.KEY_DOWN_ARROW=40,this.KEY_INSERT=45,this.KEY_DELETE=46,this.KEY_NUM_0=48,this.KEY_NUM_1=49,this.KEY_NUM_2=50,this.KEY_NUM_3=51,this.KEY_NUM_4=52,this.KEY_NUM_5=53,this.KEY_NUM_6=54,this.KEY_NUM_7=55,this.KEY_NUM_8=56,this.KEY_NUM_9=57,this.KEY_A=65,this.KEY_B=66,this.KEY_C=67,this.KEY_D=68,this.KEY_E=69,this.KEY_F=70,this.KEY_G=71,this.KEY_H=72,this.KEY_I=73,this.KEY_J=74,this.KEY_K=75,this.KEY_L=76,this.KEY_M=77,this.KEY_N=78,this.KEY_O=79,this.KEY_P=80,this.KEY_Q=81,this.KEY_R=82,this.KEY_S=83,this.KEY_T=84,this.KEY_U=85,this.KEY_V=86,this.KEY_W=87,this.KEY_X=88,this.KEY_Y=89,this.KEY_Z=90,this.KEY_LEFT_WINDOW=91,this.KEY_RIGHT_WINDOW=92,this.KEY_SELECT_KEY=93,this.KEY_NUMPAD_0=96,this.KEY_NUMPAD_1=97,this.KEY_NUMPAD_2=98,this.KEY_NUMPAD_3=99,this.KEY_NUMPAD_4=100,this.KEY_NUMPAD_5=101,this.KEY_NUMPAD_6=102,this.KEY_NUMPAD_7=103,this.KEY_NUMPAD_8=104,this.KEY_NUMPAD_9=105,this.KEY_MULTIPLY=106,this.KEY_ADD=107,this.KEY_SUBTRACT=109,this.KEY_DECIMAL_POINT=110,this.KEY_DIVIDE=111,this.KEY_F1=112,this.KEY_F2=113,this.KEY_F3=114,this.KEY_F4=115,this.KEY_F5=116,this.KEY_F6=117,this.KEY_F7=118,this.KEY_F8=119,this.KEY_F9=120,this.KEY_F10=121,this.KEY_F11=122,this.KEY_F12=123,this.KEY_NUM_LOCK=144,this.KEY_SCROLL_LOCK=145,this.KEY_SEMI_COLON=186,this.KEY_EQUAL_SIGN=187,this.KEY_COMMA=188,this.KEY_DASH=189,this.KEY_PERIOD=190,this.KEY_FORWARD_SLASH=191,this.KEY_GRAVE_ACCENT=192,this.KEY_OPEN_BRACKET=219,this.KEY_BACK_SLASH=220,this.KEY_CLOSE_BRACKET=221,this.KEY_SINGLE_QUOTE=222,this.KEY_SPACE=32,this._element=e.element,this.altDown=!1,this.ctrlDown=!1,this.mouseDownLeft=!1,this.mouseDownMiddle=!1,this.mouseDownRight=!1,this.keyDown=[],this.enabled=!0,this.mouseover=!1,document.addEventListener("keydown",this._keyDownListener=function(e){t.enabled&&("INPUT"!==e.target.tagName&&"TEXTAREA"!==e.target.tagName&&(e.ctrlKey?t.ctrlDown=!0:e.altKey?t.altDown=!0:(t.keyDown[e.keyCode]=!0,t.fire("keydown",e.keyCode,!0))),t.mouseover&&e.preventDefault())},!0),document.addEventListener("keyup",this._keyUpListener=function(e){t.enabled&&"INPUT"!==e.target.tagName&&"TEXTAREA"!==e.target.tagName&&(e.ctrlKey?t.ctrlDown=!1:e.altKey?t.altDown=!1:(t.keyDown[e.keyCode]=!1,t.fire("keyup",e.keyCode,!0)))}),e.element.addEventListener("mouseenter",this._mouseEnterListener=function(e){if(!t.enabled)return;t.mouseover=!0;const i=t._getClickCoordsWithinElement(e);t.fire("mouseenter",i,!0)}),e.element.addEventListener("mouseleave",this._mouseLeaveListener=function(e){if(!t.enabled)return;t.mouseover=!1;const i=t._getClickCoordsWithinElement(e);t.fire("mouseleave",i,!0)}),e.element.addEventListener("mousedown",this._mouseDownListener=function(i){if(!t.enabled)return;switch(i.which){case 1:t.mouseDownLeft=!0;break;case 2:t.mouseDownMiddle=!0;break;case 3:t.mouseDownRight=!0}const s=t._getClickCoordsWithinElement(i);e.element.focus(),t.fire("mousedown",s,!0),t.mouseover&&i.preventDefault()}),document.addEventListener("mouseup",this._mouseUpListener=function(e){if(!t.enabled)return;switch(e.which){case 1:t.mouseDownLeft=!1;break;case 2:t.mouseDownMiddle=!1;break;case 3:t.mouseDownRight=!1}const i=t._getClickCoordsWithinElement(e);t.fire("mouseup",i,!0),t.mouseover&&e.preventDefault()},!0),document.addEventListener("dblclick",this._dblClickListener=function(e){if(!t.enabled)return;switch(e.which){case 1:t.mouseDownLeft=!1,t.mouseDownRight=!1;break;case 2:t.mouseDownMiddle=!1;break;case 3:t.mouseDownLeft=!1,t.mouseDownRight=!1}const i=t._getClickCoordsWithinElement(e);t.fire("dblclick",i,!0),t.mouseover&&e.preventDefault()}),e.element.addEventListener("mousemove",this._mouseMoveListener=function(e){if(!t.enabled)return;const i=t._getClickCoordsWithinElement(e);t.fire("mousemove",i,!0),t.mouseover&&e.preventDefault()}),e.element.addEventListener("wheel",this._mouseWheelListener=function(e,i){if(!t.enabled)return;const s=Math.max(-1,Math.min(1,40*-e.deltaY));t.fire("mousewheel",s,!0)},{passive:!0}),function(){let e,i;t.on("mousedown",(function(t){e=t[0],i=t[1]})),t.on("mouseup",(function(s){e>=s[0]-2&&e<=s[0]+2&&i>=s[1]-2&&i<=s[1]+2&&t.fire("mouseclicked",s,!0)}))}(),function(){const e={"landscape-primary":90,"landscape-secondary":-90,"portrait-secondary":180,"portrait-primary":0};let i,s;const r=d.vec3(),a=d.vec3(),o={orientation:null,orientationAngle:0},n={orientationAngle:0,acceleration:null,accelerationIncludingGravity:a,rotationRate:d.vec3(),interval:0},l={alpha:0,beta:0,gamma:0,absolute:!1};window.OrientationChangeEvent&&window.addEventListener("orientationchange",t._orientationchangedListener=function(){i=window.screen.orientation||window.screen.mozOrientation||window.msOrientation||null,s=i&&e[i]||0,o.orientation=i,o.orientationAngle=s,t.fire("orientationchange",o)},!1),window.DeviceMotionEvent&&window.addEventListener("devicemotion",t._deviceMotionListener=function(e){n.interval=e.interval,n.orientationAngle=s;const i=e.acceleration;i?(r[0]=i.x,r[1]=i.y,r[2]=i.z,n.acceleration=r):n.acceleration=null;const o=e.accelerationIncludingGravity;o?(a[0]=o.x,a[1]=o.y,a[2]=o.z,n.accelerationIncludingGravity=a):n.accelerationIncludingGravity=null,n.rotationRate=e.rotationRate,t.fire("devicemotion",n)},!1),window.DeviceOrientationEvent&&window.addEventListener("deviceorientation",t._deviceOrientListener=function(e){l.gamma=e.gamma,l.beta=e.beta,l.alpha=e.alpha,l.absolute=e.absolute,t.fire("deviceorientation",l)},!1)}()}_getClickCoordsWithinElement(e){const t=[0,0];if(e){let i=e.target,s=0,r=0;for(;i.offsetParent;)s+=i.offsetLeft,r+=i.offsetTop,i=i.offsetParent;t[0]=e.pageX-s,t[1]=e.pageY-r}else e=window.event,t.x=e.x,t.y=e.y;return t}setEnabled(e){this.enabled!==e&&this.fire("enabled",this.enabled=e)}destroy(){super.destroy(),document.removeEventListener("keydown",this._keyDownListener),document.removeEventListener("keyup",this._keyUpListener),this._element.removeEventListener("mouseenter",this._mouseEnterListener),this._element.removeEventListener("mouseleave",this._mouseLeaveListener),this._element.removeEventListener("mousedown",this._mouseDownListener),document.removeEventListener("mouseup",this._mouseDownListener),document.removeEventListener("dblclick",this._dblClickListener),this._element.removeEventListener("mousemove",this._mouseMoveListener),this._element.removeEventListener("wheel",this._mouseWheelListener),window.OrientationChangeEvent&&window.removeEventListener("orientationchange",this._orientationchangedListener),window.DeviceMotionEvent&&window.removeEventListener("devicemotion",this._deviceMotionListener),window.DeviceOrientationEvent&&window.addEventListener("deviceorientation",this._deviceOrientListener)}}class it extends g{get type(){return"xeogl.Viewport"}init(e){super.init(e),this._state=new D({boundary:[0,0,100,100]}),this.boundary=e.boundary,this.autoBoundary=e.autoBoundary}set boundary(e){if(!this._autoBoundary){if(!e){const t=this.scene.canvas.boundary;e=[0,0,t[2],t[3]]}this._state.boundary=e,this._renderer.imageDirty(),this.fire("boundary",this._state.boundary)}}get boundary(){return this._state.boundary}set autoBoundary(e){(e=!!e)!==this._autoBoundary&&(this._autoBoundary=e,this._autoBoundary?this._onCanvasSize=this.scene.canvas.on("boundary",(function(e){const t=e[2],i=e[3];this._state.boundary=[0,0,t,i],this._renderer.imageDirty(),this.fire("boundary",this._state.boundary)}),this):this._onCanvasSize&&(this.scene.canvas.off(this._onCanvasSize),this._onCanvasSize=null),this.fire("autoBoundary",this._autoBoundary))}get autoBoundary(){return this._autoBoundary}_getState(){return this._state}destroy(){super.destroy(),this._state.destroy()}}m["xeogl.Viewport"]=it;class st extends g{get type(){return"xeogl.Perspective"}init(e){super.init(e),this._state=new D({matrix:d.mat4()}),this._dirty=!1,this._fov=60,this._near=.1,this._far=1e4,this._canvasResized=this.scene.canvas.on("boundary",this._needUpdate,this),this.fov=e.fov,this.fovAxis=e.fovAxis,this.near=e.near,this.far=e.far}_update(){const e=this.scene.viewport.boundary,t=e[2]/e[3];let i=this._fov;const s=this._fovAxis;("x"==s||"min"==s&&t<1||"max"==s&&t>1)&&(i/=t),i=Math.min(i,120),d.perspectiveMat4(i*(Math.PI/180),t,this._near,this._far,this._state.matrix),this._renderer.imageDirty(),this.fire("matrix",this._state.matrix)}set fov(e){this._fov=null!=e?e:60,this._needUpdate(0),this.fire("fov",this._fov)}get fov(){return this._fov}set fovAxis(e){e=e||"min",this._fovAxis!==e&&("x"!==e&&"y"!==e&&"min"!==e&&(this.error("Unsupported value for 'fovAxis': "+e+" - defaulting to 'min'"),e="min"),this._fovAxis=e,this._needUpdate(0),this.fire("fovAxis",this._fovAxis))}get fovAxis(){return this._fovAxis}set near(e){this._near=null!=e?e:.1,this._needUpdate(0),this.fire("near",this._near)}get near(){return this._near}set far(e){this._far=null!=e?e:1e4,this._needUpdate(0),this.fire("far",this._far)}get far(){return this._far}get matrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}destroy(){super.destroy(),this._state.destroy(),super.destroy(),this.scene.canvas.off(this._canvasResized)}}m["xeogl.Perspective"]=st;class rt extends g{get type(){return"xeogl.Ortho"}init(e){super.init(e),this._state=new D({matrix:d.mat4()}),this.scale=e.scale,this.near=e.near,this.far=e.far,this._onCanvasBoundary=this.scene.canvas.on("boundary",this._needUpdate,this)}_update(){const e=this.scene,t=.5*this._scale,i=e.viewport.boundary,s=i[2],r=i[3],a=s/r;let o,n,l,h;s>r?(o=-t,n=t,l=t/a,h=-t/a):(o=-t*a,n=t*a,l=t,h=-t),d.orthoMat4c(o,n,h,l,this._near,this._far,this._state.matrix),this._renderer.imageDirty(),this.fire("matrix",this._state.matrix)}set scale(e){null==e&&(e=1),e<=0&&(e=.01),this._scale=e,this._needUpdate(),this.fire("scale",this._scale)}get scale(){return this._scale}set near(e){this._near=null!=e?e:.1,this._needUpdate(),this.fire("near",this._near)}get near(){return this._near}set far(e){this._far=null!=e?e:1e4,this._needUpdate(),this.fire("far",this._far)}get far(){return this._far}get matrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}destroy(){super.destroy(),this._state.destroy(),this.scene.canvas.off(this._onCanvasBoundary)}}m["xeogl.Ortho"]=rt;class at extends g{get type(){return"xeogl.Frustum"}init(e){super.init(e),this._state=new D({matrix:d.mat4()}),this._left=-1,this._right=1,this._bottom=-1,this._top=1,this._near=.1,this._far=5e3,this.left=e.left,this.right=e.right,this.bottom=e.bottom,this.top=e.top,this.near=e.near,this.far=e.far}_update(){d.frustumMat4(this._left,this._right,this._bottom,this._top,this._near,this._far,this._state.matrix),this._renderer.imageDirty(),this.fire("matrix",this._state.matrix)}set left(e){this._left=null!=e?e:-1,this._needUpdate(),this.fire("left",this._left)}get left(){return this._left}set right(e){this._right=null!=e?e:1,this._needUpdate(),this.fire("right",this._right)}get right(){return this._right}set top(e){this._top=null!=e?e:1,this._needUpdate(),this.fire("top",this._top)}get top(){return this._top}set bottom(e){this._bottom=null!=e?e:-1,this._needUpdate(),this.fire("bottom",this._bottom)}get bottom(){return this._bottom}set near(e){this._near=null!=e?e:.1,this._needUpdate(),this.fire("near",this._near)}get near(){return this._near}set far(e){this._far=null!=e?e:1e4,this._needUpdate(),this.fire("far",this._far)}get far(){return this._far}get matrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}destroy(){super.destroy(),this._state.destroy(),super.destroy()}}m["xeogl.Frustum"]=at;const ot="xeogl.CustomProjection";class nt extends g{get type(){return ot}init(e){super.init(e),this._state=new D({matrix:d.mat4()}),this.matrix=e.matrix}set matrix(e){this._state.matrix.set(e||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this.fire("far",this._state.matrix)}get matrix(){return this._state.matrix}destroy(){super.destroy(),this._state.destroy()}}m[ot]=nt;const lt=d.vec3(),ht=d.vec3(),ut=d.vec3(),ct=d.vec3(),dt=d.vec3(),pt=d.vec3(),_t=d.mat4(),mt=d.mat4(),ft=d.vec3(),gt=d.vec3(),vt=d.vec3(),Mt=d.vec3();class yt extends g{get type(){return"xeogl.Camera"}init(e){super.init(e),this._state=new D({deviceMatrix:d.mat4(),hasDeviceMatrix:!1,matrix:d.mat4(),normalMatrix:d.mat4()}),this._perspective=new st(this),this._ortho=new rt(this),this._frustum=new at(this),this._customProjection=new nt(this),this._project=this._perspective,this._eye=d.vec3([0,0,10]),this._look=d.vec3([0,0,0]),this._up=d.vec3([0,1,0]),this._worldUp=d.vec3([0,1,0]),this._worldRight=d.vec3([1,0,0]),this._worldForward=d.vec3([0,0,-1]),this.deviceMatrix=e.deviceMatrix,this.eye=e.eye,this.look=e.look,this.up=e.up,this.worldAxis=e.worldAxis,this.gimbalLock=e.gimbalLock,this.constrainPitch=e.constrainPitch,this.projection=e.projection,this._perspective.on("matrix",()=>{"perspective"===this._projectionType&&this.fire("projMatrix",this._perspective.matrix)}),this._ortho.on("matrix",()=>{"ortho"===this._projectionType&&this.fire("projMatrix",this._ortho.matrix)}),this._frustum.on("matrix",()=>{"frustum"===this._projectionType&&this.fire("projMatrix",this._frustum.matrix)}),this._customProjection.on("matrix",()=>{"customProjection"===this._projectionType&&this.fire("projMatrix",this._customProjection.matrix)})}_update(){const e=this._state;let t;"ortho"===this.projection?(d.subVec3(this._eye,this._look,ft),d.normalizeVec3(ft,gt),d.mulVec3Scalar(gt,1e3,vt),d.addVec3(this._look,vt,Mt),t=Mt):t=this._eye,e.hasDeviceMatrix?(d.lookAtMat4v(t,this._look,this._up,mt),d.mulMat4(e.deviceMatrix,mt,e.matrix)):d.lookAtMat4v(t,this._look,this._up,e.matrix),d.inverseMat4(this._state.matrix,this._state.normalMatrix),d.transposeMat4(this._state.normalMatrix),this._renderer.imageDirty(),this.fire("matrix",this._state.matrix),this.fire("viewMatrix",this._state.matrix)}orbitYaw(e){let t=d.subVec3(this._eye,this._look,lt);d.rotationMat4v(.0174532925*e,this._gimbalLock?this._worldUp:this._up,_t),t=d.transformPoint3(_t,t,ht),this.eye=d.addVec3(this._look,t,ut),this.up=d.transformPoint3(_t,this._up,ct)}orbitPitch(e){let t=d.subVec3(this._eye,this._look,lt);const i=d.cross3Vec3(d.normalizeVec3(t,ht),d.normalizeVec3(this._up,ut));d.rotationMat4v(.0174532925*e,i,_t),t=d.transformPoint3(_t,t,ct);const s=d.transformPoint3(_t,this._up,dt);if(this._constrainPitch&&(e=d.dotVec3(s,this._worldUp)/d.DEGTORAD)<1)return;this.up=s,this.eye=d.addVec3(t,this._look,pt)}yaw(e){let t=d.subVec3(this._look,this._eye,lt);d.rotationMat4v(.0174532925*e,this._gimbalLock?this._worldUp:this._up,_t),t=d.transformPoint3(_t,t,ht),this.look=d.addVec3(t,this._eye,ut),this._gimbalLock&&(this.up=d.transformPoint3(_t,this._up,ct))}pitch(e){let t=d.subVec3(this._look,this._eye,lt);const i=d.cross3Vec3(d.normalizeVec3(t,ht),d.normalizeVec3(this._up,ut));d.rotationMat4v(.0174532925*e,i,_t);const s=d.transformPoint3(_t,this._up,pt);if(this._constrainPitch&&(e=d.dotVec3(s,this._worldUp)/d.DEGTORAD)<1)return;this.up=s,t=d.transformPoint3(_t,t,ct),this.look=d.addVec3(t,this._eye,dt)}pan(e){const t=d.subVec3(this._eye,this._look,lt),i=[0,0,0];let s;if(0!==e[0]){const r=d.cross3Vec3(d.normalizeVec3(t,[]),d.normalizeVec3(this._up,ht));s=d.mulVec3Scalar(r,e[0]),i[0]+=s[0],i[1]+=s[1],i[2]+=s[2]}0!==e[1]&&(s=d.mulVec3Scalar(d.normalizeVec3(this._up,ut),e[1]),i[0]+=s[0],i[1]+=s[1],i[2]+=s[2]),0!==e[2]&&(s=d.mulVec3Scalar(d.normalizeVec3(t,ct),e[2]),i[0]+=s[0],i[1]+=s[1],i[2]+=s[2]),this.eye=d.addVec3(this._eye,i,dt),this.look=d.addVec3(this._look,i,pt)}zoom(e){const t=d.subVec3(this._eye,this._look,lt),i=Math.abs(d.lenVec3(t,ht)),s=Math.abs(i+e);if(s<.5)return;const r=d.normalizeVec3(t,ut);this.eye=d.addVec3(this._look,d.mulVec3Scalar(r,s),ct)}set eye(e){this._eye.set(e||[0,0,10]),this._needUpdate(0),this.fire("eye",this._eye)}get eye(){return this._eye}set look(e){this._look.set(e||[0,0,0]),this._needUpdate(0),this.fire("look",this._look)}get look(){return this._look}set up(e){this._up.set(e||[0,1,0]),this._needUpdate(0),this.fire("up",this._up)}get up(){return this._up}set deviceMatrix(e){this._state.deviceMatrix.set(e||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this._state.hasDeviceMatrix=!!e,this._needUpdate(0),this.fire("deviceMatrix",this._state.deviceMatrix)}get deviceMatrix(){return this._state.deviceMatrix}set worldAxis(e){e=e||[1,0,0,0,1,0,0,0,1],this._worldAxis?this._worldAxis.set(e):this._worldAxis=new Float32Array(e),this._worldRight[0]=this._worldAxis[0],this._worldRight[1]=this._worldAxis[1],this._worldRight[2]=this._worldAxis[2],this._worldUp[0]=this._worldAxis[3],this._worldUp[1]=this._worldAxis[4],this._worldUp[2]=this._worldAxis[5],this._worldForward[0]=this._worldAxis[6],this._worldForward[1]=this._worldAxis[7],this._worldForward[2]=this._worldAxis[8],this.fire("worldAxis",this._worldAxis)}get worldAxis(){return this._worldAxis}get worldUp(){return this._worldUp}get worldRight(){return this._worldRight}get worldForward(){return this._worldForward}set gimbalLock(e){this._gimbalLock=!1!==e,this.fire("gimbalLock",this._gimbalLock)}get gimbalLock(){return this._gimbalLock}set constrainPitch(e){this._constrainPitch=!!e,this.fire("constrainPitch",this._constrainPitch)}get constrainPitch(){return this._constrainPitch}get eyeLookDist(){return d.lenVec3(d.subVec3(this._look,this._eye,lt))}get matrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}get viewMatrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}get normalMatrix(){return this._updateScheduled&&this._doUpdate(),this._state.normalMatrix}get viewNormalMatrix(){return this._updateScheduled&&this._doUpdate(),this._state.normalMatrix}get projMatrix(){return this[this.projection].matrix}get perspective(){return this._perspective}get ortho(){return this._ortho}get frustum(){return this._frustum}get customProjection(){return this._customProjection}set projection(e){e=e||"perspective",this._projectionType!==e&&("perspective"===e?this._project=this._perspective:"ortho"===e?this._project=this._ortho:"frustum"===e?this._project=this._frustum:"customProjection"===e?this._project=this._customProjection:(this.error("Unsupported value for 'projection': "+e+" defaulting to 'perspective'"),this._project=this._perspective,e="perspective"),this._projectionType=e,this._renderer.imageDirty(),this._update(),this.fire("dirty"))}get projection(){return this._projectionType}get project(){return this._project}get view(){return this}destroy(){super.destroy(),this._state.destroy()}}m["xeogl.Camera"]=yt;class xt extends g{get type(){return"xeogl.DirLight"}init(e){super.init(e);const t=this;this._shadowRenderBuf=null,this._shadowViewMatrix=null,this._shadowProjMatrix=null,this._shadowViewMatrixDirty=!0,this._shadowProjMatrixDirty=!0,this._state=new D({type:"dir",dir:d.vec3([1,1,1]),color:d.vec3([.7,.7,.8]),intensity:1,space:e.space||"view",shadow:!1,shadowDirty:!0,getShadowViewMatrix:function(){d.vec3();const e=d.vec3([0,1,0]);return function(){if(t._shadowViewMatrixDirty){t._shadowViewMatrix||(t._shadowViewMatrix=d.identityMat4());const i=t._state.dir;d.lookAtMat4v([-i[0],-i[1],-i[2]],[0,0,0],e,t._shadowViewMatrix),t._shadowViewMatrixDirty=!1}return t._shadowViewMatrix}}(),getShadowProjMatrix:function(){return t._shadowProjMatrixDirty&&(t._shadowProjMatrix||(t._shadowProjMatrix=d.identityMat4()),d.orthoMat4c(-10,10,-10,10,0,1e3,t._shadowProjMatrix),t._shadowProjMatrixDirty=!1),t._shadowProjMatrix},getShadowRenderBuf:function(){return t._shadowRenderBuf||(t._shadowRenderBuf=new P(t.scene.canvas.canvas,t.scene.canvas.gl)),t._shadowRenderBuf}}),this.dir=e.dir,this.color=e.color,this.intensity=e.intensity,this.shadow=e.shadow,this.scene._lightCreated(this)}set dir(e){this._state.dir.set(e||[1,1,1]),this._shadowViewMatrixDirty=!0,this._renderer.imageDirty()}get dir(){return this._state.dir}set color(e){this._state.color.set(e||[.7,.7,.8]),this._renderer.imageDirty()}get color(){return this._state.color}set intensity(e){e=void 0!==e?e:1,this._state.intensity=e,this._renderer.imageDirty()}get intensity(){return this._state.intensity}set shadow(e){e=!!e,this._state.shadow!==e&&(this._state.shadow=e,this._shadowViewMatrixDirty=!0,this._renderer.imageDirty())}get shadow(){return this._state.shadow}destroy(){super.destroy(),this._state.destroy(),this._shadowRenderBuf&&this._shadowRenderBuf.destroy(),this.scene._lightDestroyed(this)}}m["xeogl.DirLight"]=xt;class bt extends z{get type(){return"xeogl.BoxGeometry"}init(e){let t=e.xSize||1;t<0&&(this.error("negative xSize not allowed - will invert"),t*=-1);let i=e.ySize||1;i<0&&(this.error("negative ySize not allowed - will invert"),i*=-1);let s=e.zSize||1;s<0&&(this.error("negative zSize not allowed - will invert"),s*=-1);const r=e.center,o=r?r[0]:0,n=r?r[1]:0,l=r?r[2]:0,h=-t+o,u=-i+n,c=-s+l,d=t+o,p=i+n,_=s+l;super.init(a.apply(e,{positions:[d,p,_,h,p,_,h,u,_,d,u,_,d,p,_,d,u,_,d,u,c,d,p,c,d,p,_,d,p,c,h,p,c,h,p,_,h,p,_,h,p,c,h,u,c,h,u,_,h,u,c,d,u,c,d,u,_,h,u,_,d,u,c,h,u,c,h,p,c,d,p,c],normals:[0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1],uv:[1,0,0,0,0,1,1,1,0,0,0,1,1,1,1,0,1,1,1,0,0,0,0,1,1,0,0,0,0,1,1,1,0,1,1,1,1,0,0,0,0,1,1,1,1,0,0,0],indices:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23],tangents:null})),this.box=!0}}m["xeogl.BoxGeometry"]=bt;const wt={default:{edges:!0,edgeColor:[.2,.2,.2],edgeAlpha:.5,edgeWidth:1,vertices:!1,vertexColor:[.4,.4,.4],vertexAlpha:.7,vertexSize:4,fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2},defaultWhiteBG:{edgeColor:[.2,.2,.2],edgeAlpha:1,edgeWidth:1,vertices:!1,vertexColor:[.4,.4,.4],vertexAlpha:.7,vertexSize:4,fill:!0,fillColor:[1,1,1],fillAlpha:.6},defaultLightBG:{edges:!0,edgeColor:[.2,.2,.2],edgeAlpha:.5,edgeWidth:1,vertices:!1,vertexColor:[.4,.4,.4],vertexAlpha:.7,vertexSize:4,fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2},defaultDarkBG:{edges:!0,edgeColor:[.5,.5,.5],edgeAlpha:.5,edgeWidth:1,vertices:!1,vertexColor:[.4,.4,.4],vertexAlpha:.7,vertexSize:4,fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2},phosphorous:{edges:!0,edgeColor:[.9,.9,.9],edgeAlpha:.5,edgeWidth:2,vertices:!1,vertexColor:[.4,.4,.4],vertexAlpha:.7,vertexSize:1,fill:!0,fillColor:[0,0,0],fillAlpha:.4},sunset:{edges:!0,edgeColor:[.9,.9,.9],edgeAlpha:.5,edgeWidth:1,vertices:!1,vertexColor:[.4,.4,.4],vertexAlpha:.7,vertexSize:1,fill:!0,fillColor:[.9,.9,.6],fillAlpha:.2},vectorscope:{edges:!0,edgeColor:[.2,1,.2],edgeAlpha:1,edgeWidth:2,vertices:!0,vertexColor:[.7,1,.7],vertexAlpha:.9,vertexSize:8,fill:!0,fillColor:[0,0,0],fillAlpha:.7},battlezone:{edges:!0,edgeColor:[.2,1,.2],edgeAlpha:1,edgeWidth:3,vertices:!1,vertexColor:[.8,1,.8],vertexAlpha:.9,vertexSize:8,fill:!0,fillColor:[0,0,0],fillAlpha:1},sepia:{edges:!0,edgeColor:[.529411792755127,.4577854573726654,.4100345969200134],edgeAlpha:1,edgeWidth:1,vertices:!1,vertexColor:[.7,1,.7],vertexAlpha:.9,vertexSize:4,fill:!0,fillColor:[.970588207244873,.7965892553329468,.6660899519920349],fillAlpha:.4},yellowHighlight:{edges:!0,edgeColor:[.529411792755127,.4577854573726654,.4100345969200134],edgeAlpha:1,edgeWidth:1,vertices:!1,vertexColor:[.7,1,.7],vertexAlpha:.9,vertexSize:4,fill:!0,fillColor:[1,1,0],fillAlpha:.5},greenSelected:{edges:!0,edgeColor:[.4577854573726654,.529411792755127,.4100345969200134],edgeAlpha:1,edgeWidth:1,vertices:!1,vertexColor:[.7,1,.7],vertexAlpha:.9,vertexSize:4,fill:!0,fillColor:[0,1,0],fillAlpha:.5},gamegrid:{edges:!0,edgeColor:[.4,.4,1.6],edgeAlpha:.8,edgeWidth:3,vertices:!1,vertexColor:[.7,1,.7],vertexAlpha:.9,vertexSize:4,fill:!0,fillColor:[.2,.2,.7],fillAlpha:.9}},At="xeogl.EmphasisMaterial";class Et extends Q{static get presets(){return wt}get type(){return At}init(e){super.init(e),this._state=new D({type:"EmphasisMaterial",edges:null,edgeColor:null,edgeAlpha:null,edgeWidth:null,vertices:null,vertexColor:null,vertexAlpha:null,vertexSize:null,fill:null,fillColor:null,fillAlpha:null,backfaces:!0}),this._preset="default",e.preset?(this.preset=e.preset,void 0!==e.edges&&(this.edges=e.edges),e.edgeColor&&(this.edgeColor=e.edgeColor),void 0!==e.edgeAlpha&&(this.edgeAlpha=e.edgeAlpha),void 0!==e.edgeWidth&&(this.edgeWidth=e.edgeWidth),void 0!==e.vertices&&(this.vertices=e.vertices),e.vertexColor&&(this.vertexColor=e.vertexColor),void 0!==e.vertexAlpha&&(this.vertexAlpha=e.vertexAlpha),e.vertexSize&&(this.vertexSize=e.vertexSize),void 0!==e.fill&&(this.fill=e.fill),e.fillColor&&(this.fillColor=e.fillColor),void 0!==e.fillAlpha&&(this.fillAlpha=e.fillAlpha),void 0!==e.backfaces&&(this.backfaces=e.backfaces)):(this.edges=e.edges,this.edgeColor=e.edgeColor,this.edgeAlpha=e.edgeAlpha,this.edgeWidth=e.edgeWidth,this.vertices=e.vertices,this.vertexColor=e.vertexColor,this.vertexAlpha=e.vertexAlpha,this.vertexSize=e.vertexSize,this.fill=e.fill,this.fillColor=e.fillColor,this.fillAlpha=e.fillAlpha,this.backfaces=e.backfaces)}set edges(e){e=!1!==e,this._state.edges!==e&&(this._state.edges=e,this._renderer.imageDirty())}get edges(){return this._state.edges}set edgeColor(e){let t=this._state.edgeColor;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.edgeColor=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=.2,t[1]=.2,t[2]=.2),this._renderer.imageDirty()}get edgeColor(){return this._state.edgeColor}set edgeAlpha(e){e=null!=e?e:.5,this._state.edgeAlpha!==e&&(this._state.edgeAlpha=e,this._renderer.imageDirty())}get edgeAlpha(){return this._state.edgeAlpha}set edgeWidth(e){this._state.edgeWidth=e||1,this._renderer.imageDirty()}get edgeWidth(){return this._state.edgeWidth}set vertices(e){e=!!e,this._state.vertices!==e&&(this._state.vertices=e,this._renderer.imageDirty())}get vertices(){return this._state.vertices}set vertexColor(e){let t=this._state.vertexColor;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.vertexColor=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=.4,t[1]=.4,t[2]=.4),this._renderer.imageDirty()}get vertexColor(){return this._state.vertexColor}set vertexAlpha(e){e=null!=e?e:.7,this._state.vertexAlpha!==e&&(this._state.vertexAlpha=e,this._renderer.imageDirty())}get vertexAlpha(){return this._state.vertexAlpha}set vertexSize(e){this._state.vertexSize=e||4,this._renderer.imageDirty()}get vertexSize(){return this._state.vertexSize}set fill(e){e=!1!==e,this._state.fill!==e&&(this._state.fill=e,this._renderer.imageDirty())}get fill(){return this._state.fill}set fillColor(e){let t=this._state.fillColor;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.fillColor=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=.4,t[1]=.4,t[2]=.4),this._renderer.imageDirty()}get fillColor(){return this._state.fillColor}set fillAlpha(e){e=null!=e?e:.2,this._state.fillAlpha!==e&&(this._state.fillAlpha=e,this._renderer.imageDirty())}get fillAlpha(){return this._state.fillAlpha}set backfaces(e){e=!!e,this._state.backfaces!==e&&(this._state.backfaces=e,this._renderer.imageDirty())}get backfaces(){return this._state.backfaces}set preset(e){if(e=e||"default",this._preset===e)return;const t=wt[e];t?(this.edges=t.edges,this.edgeColor=t.edgeColor,this.edgeAlpha=t.edgeAlpha,this.edgeWidth=t.edgeWidth,this.vertices=t.vertices,this.vertexColor=t.vertexColor,this.vertexAlpha=t.vertexAlpha,this.vertexSize=t.vertexSize,this.fill=t.fill,this.fillColor=t.fillColor,this.fillAlpha=t.fillAlpha,this._preset=e):this.error("unsupported preset: '"+e+"' - supported values are "+Object.keys(wt).join(", "))}get preset(){return this._preset}destroy(){super.destroy(),this._state.destroy()}}m[At]=Et;const Ct={default:{edgeColor:[0,0,0],edgeAlpha:1,edgeWidth:1},defaultWhiteBG:{edgeColor:[.2,.2,.2],edgeAlpha:1,edgeWidth:1},defaultLightBG:{edgeColor:[.2,.2,.2],edgeAlpha:1,edgeWidth:1},defaultDarkBG:{edgeColor:[.5,.5,.5],edgeAlpha:1,edgeWidth:1}};class Pt extends Q{static get presets(){return Ct}get type(){return"xeogl.EdgeMaterial"}init(e){super.init(e),this._state=new D({type:"EdgeMaterial",edgeColor:null,edgeAlpha:null,edgeWidth:null}),this._preset="default",e.preset?(this.preset=e.preset,e.edgeColor&&(this.edgeColor=e.edgeColor),void 0!==e.edgeAlpha&&(this.edgeAlpha=e.edgeAlpha),void 0!==e.edgeWidth&&(this.edgeWidth=e.edgeWidth)):(this.edgeColor=e.edgeColor,this.edgeAlpha=e.edgeAlpha,this.edgeWidth=e.edgeWidth)}set edgeColor(e){let t=this._state.edgeColor;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.edgeColor=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=.2,t[1]=.2,t[2]=.2),this._renderer.imageDirty()}get edgeColor(){return this._state.edgeColor}set edgeAlpha(e){e=null!=e?e:1,this._state.edgeAlpha!==e&&(this._state.edgeAlpha=e,this._renderer.imageDirty())}get edgeAlpha(){return this._state.edgeAlpha}set edgeWidth(e){this._state.edgeWidth=e||1,this._renderer.imageDirty()}get edgeWidth(){return this._state.edgeWidth}set preset(e){if(e=e||"default",this._preset===e)return;const t=Ct[e];t?(this.edgeColor=t.edgeColor,this.edgeAlpha=t.edgeAlpha,this.edgeWidth=t.edgeWidth,this._preset=e):this.error("unsupported preset: '"+e+"' - supported values are "+Object.keys(Ct).join(", "))}get preset(){return this._preset}destroy(){super.destroy(),this._state.destroy()}}m["xeogl.EdgeMaterial"]=Pt;class Tt extends Q{get type(){return"xeogl.OutlineMaterial"}init(e){super.init(e),this._state=new D({type:"OutlineMaterial",color:null,alpha:null,width:null}),this.color=e.color,this.alpha=e.alpha,this.width=e.width}set color(e){let t=this._state.color;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.color=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=.2,t[2]=.2),this._renderer.imageDirty()}get color(){return this._state.color}set alpha(e){e=null!=e?e:1,this._state.alpha!==e&&(this._state.alpha=e,this._renderer.imageDirty())}get alpha(){return this._state.alpha}set width(e){this._state.width=e||4,this._renderer.imageDirty()}get width(){return this._state.width}destroy(){super.destroy(),this._state.destroy()}}m["xeogl.OutlineMaterial"]=Tt;const Dt=d.vec3(),St=d.vec3(),Ft=d.vec3(),Lt=d.vec3(),Bt=d.vec3(),Rt=d.vec3(),kt=d.vec4(),It=d.vec3(),Vt=d.vec3(),Nt=d.vec3(),Ut=d.vec3(),Ot=d.vec3(),zt=d.vec3(),Gt=d.vec3(),jt=d.vec3(),Yt=d.vec3(),Wt=d.vec4(),Kt=d.vec4(),Xt=d.vec4(),Ht=d.vec3(),qt=d.vec3(),Qt=d.vec3(),Zt=d.vec3(),$t=d.vec3(),Jt=d.vec3(),ei=d.vec3(),ti=d.vec3(),ii=d.vec3(),si=d.vec3(),ri=d.vec3();function ai(e,t){const i={};let s,r;for(let a=0,o=t.length;a<o;a++)s=t[a],r=e.meshes[s],r?i[s]=!0:e.warn("pick(): Mesh not found: "+s);return i}class oi extends g{get type(){return"xeogl.Scene"}init(e){super.init(e);const t=this,i=!!e.transparent;this.loading=0,this.startTime=(new Date).getTime(),this.models={},this.objects={},this.guidObjects={},this.entityTypes={},this.entities={},this.visibleEntities={},this.ghostedEntities={},this.highlightedEntities={},this.selectedEntities={},this._objectGUIDs=null,this._entityIds=null,this._visibleEntityIds=null,this._ghostedEntityIds=null,this._highlightedEntityIds=null,this._selectedEntityIds=null,this.meshes={},this._needRecompileMeshes=!1,this.types={},this.components={},this.rootObjects={},this.clips={},this.lights={},this.lightMaps={},this.reflectionMaps={},this.canvas=new E(this,{dontClear:!0,canvas:e.canvas,transparent:i,backgroundColor:e.backgroundColor,backgroundImage:e.backgroundImage,webgl2:!1!==e.webgl2,contextAttr:e.contextAttr||{},simulateWebGLContextLost:e.simulateWebGLContextLost}),this.canvas.on("boundary",(function(){t._renderer.imageDirty()})),this.canvas.on("webglContextFailed",(function(){alert("xeogl failed to find WebGL!")})),this._renderer=new et(this,{transparent:i}),this._clipsState=new function(){this.clips=[];let e=null;this.getHash=function(){if(e)return e;const t=this.clips;if(0===t.length)return this.hash=";";let i;const s=[];for(let e=0,r=t.length;e<r;e++)i=t[e],s.push("cp");return s.push(";"),e=s.join(""),e},this.addClip=function(t){this.clips.push(t),e=null},this.removeClip=function(t){for(let i=0,s=this.clips.length;i<s;i++)if(this.clips[i].id===t.id)return this.clips.splice(i,1),void(e=null)}},this._lightsState=new function(){const e=d.vec3([0,0,0]),t=d.vec3();this.lights=[],this.reflectionMaps=[],this.lightMaps=[];let i=null,s=null;this.getHash=function(){if(i)return i;const e=[],t=this.lights;let s;for(let i=0,r=t.length;i<r;i++)s=t[i],e.push("/"),e.push(s.type),e.push("world"===s.space?"w":"v"),s.shadow&&e.push("sh");return this.lightMaps.length>0&&e.push("/lm"),this.reflectionMaps.length>0&&e.push("/rm"),e.push(";"),i=e.join(""),i},this.addLight=function(e){this.lights.push(e),s=null,i=null},this.removeLight=function(e){for(let t=0,r=this.lights.length;t<r;t++){if(this.lights[t].id===e.id)return this.lights.splice(t,1),s&&s.id===e.id&&(s=null),void(i=null)}},this.addReflectionMap=function(e){this.reflectionMaps.push(e),i=null},this.removeReflectionMap=function(e){for(let t=0,s=this.reflectionMaps.length;t<s;t++)if(this.reflectionMaps[t].id===e.id)return this.reflectionMaps.splice(t,1),void(i=null)},this.addLightMap=function(e){this.lightMaps.push(e),i=null},this.removeLightMap=function(e){for(let t=0,s=this.lightMaps.length;t<s;t++)if(this.lightMaps[t].id===e.id)return this.lightMaps.splice(t,1),void(i=null)},this.getAmbientColor=function(){if(!s)for(let e=0,t=this.lights.length;e<t;e++){const t=this.lights[e];if("ambient"===t.type){s=t;break}}if(s){const e=s.color,i=s.intensity;return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t}return e}},this.input=new tt(this,{dontClear:!0,element:this.canvas.canvas}),ui._addScene(this);const s=e.components;if(s){let e,t,i;for(let r=0,a=s.length;r<a;r++)e=s[r],t=e.type,t&&(i=window[t],i&&new i(this,e))}this._initDefaults(),this._viewport=new it(this,{id:"default.viewport",autoBoundary:!0,dontClear:!0}),this._camera=new yt(this,{id:"default.camera",dontClear:!0}),new xt(this,{dir:[.8,-.6,-.8],color:[1,1,1],intensity:1,space:"view"}),new xt(this,{dir:[-.8,-.4,-.4],color:[1,1,1],intensity:1,space:"view"}),new xt(this,{dir:[.2,-.8,.8],color:[.6,.6,.6],intensity:1,space:"view"});this._viewport;const r=this._renderer;this._camera.on("dirty",(function(){r.imageDirty()})),this.ticksPerRender=e.ticksPerRender,this.passes=e.passes,this.clearEachPass=e.clearEachPass,this.gammaInput=e.gammaInput,this.gammaOutput=e.gammaOutput,this.gammaFactor=e.gammaFactor}_initDefaults(){let e;e=this.geometry,e=this.material,e=this.ghostMaterial,e=this.outlineMaterial}_addComponent(e){if(e.id&&this.components[e.id]&&(this.error("Component "+a.inQuotes(e.id)+" already exists in Scene - ignoring ID, will randomly-generate instead"),e.id=null),!e.id)for(void 0===window.nextID&&(window.nextID=0),e.id="_"+window.nextID++;this.components[e.id];)e.id=d.createUUID();this.components[e.id]=e;const t=e.type;let i=this.types[e.type];i||(i=this.types[t]={}),i[e.id]=e}_removeComponent(e){delete this.components[e.id];const t=this.types[e.type];t&&(delete t[e.id],a.isEmptyObject(t)&&delete this.types[e.type])}_clipCreated(e){this.clips[e.id]=e,this.scene._clipsState.addClip(e._state),this._needRecompileMeshes=!0}_lightCreated(e){this.lights[e.id]=e,this.scene._lightsState.addLight(e._state),this._needRecompileMeshes=!0}_lightMapCreated(e){this.lightMaps[e.id]=e,this.scene._lightsState.addLightMap(e._state),this._needRecompileMeshes=!0}_reflectionMapCreated(e){this.reflectionMaps[e.id]=e,this.scene._lightsState.addReflectionMap(e._state),this._needRecompileMeshes=!0}_objectCreated(e){this.objects[e.id]=e,e.guid&&(this.guidObjects[e.id]=e,this._objectGUIDs=null),e.parent||(this.rootObjects[e.id]=e),r.components.objects++}_meshCreated(e){this.meshes[e.id]=e,r.components.meshes++}_modelCreated(e){this.models[e.id]=e,r.components.models++}_clipDestroyed(e){delete this.clips[e.id],this.scene._clipsState.removeClip(e._state),this._needRecompileMeshes=!0}_lightDestroyed(e){delete this.lights[e.id],this.scene._lightsState.removeLight(e._state),this._needRecompileMeshes=!0}_lightMapDestroyed(e){delete this.lightMaps[e.id],this.scene._lightsState.removeLightMap(e._state),this._needRecompileMeshes=!0}_reflectionMapDestroyed(e){delete this.reflectionMaps[e.id],this.scene._lightsState.removeReflectionMap(e._state),this._needRecompileMeshes=!0}_objectDestroyed(e){delete this.objects[e.id],e.guid&&(delete this.guidObjects[e.guid],this._objectGUIDs=null),e.parent||delete this.rootObjects[e.id],r.components.objects--}_meshDestroyed(e){r.components.meshes--,delete this.meshes[e.id],r.components.meshes--}_modelDestroyed(e){this.models[e.id]=e,r.components.models++}_entityTypeAssigned(e,t){this.entities[e.id]=e;let i=this.entityTypes[t];i||(i={},this.entityTypes[t]=i),i[e.id]=e,this._entityIds=null,this._entityTypeIds=null}_entityTypeRemoved(e,t){delete this.entities[e.id];const i=this.entityTypes[t];i&&delete i[e.id],this._entityIds=null,this._entityTypeIds=null}_entityVisibilityUpdated(e,t){t?this.visibleEntities[e.id]=e:delete this.visibleEntities[e.id],this._visibleEntityIds=null}_entityGhostedUpdated(e,t){t?this.ghostedEntities[e.id]=e:delete this.ghostedEntities[e.id],this._ghostedEntityIds=null}_entityHighlightedUpdated(e,t){t?this.highlightedEntities[e.id]=e:delete this.highlightedEntities[e.id],this._highlightedEntityIds=null}_entitySelectedUpdated(e,t){t?this.selectedEntities[e.id]=e:delete this.selectedEntities[e.id],this._selectedEntityIds=null}_webglContextLost(){this.canvas.spinner.processes++;for(const e in this.components)if(this.components.hasOwnProperty(e)){const t=this.components[e];t._webglContextLost&&t._webglContextLost()}this._renderer.webglContextLost()}_webglContextRestored(){const e=this.canvas.gl;for(const t in this.components)if(this.components.hasOwnProperty(t)){const i=this.components[t];i._webglContextRestored&&i._webglContextRestored(e)}this._renderer.webglContextRestored(e),this.canvas.spinner.processes--}render(e){const t={sceneId:null,pass:0};if(this._needRecompileMeshes&&(this._recompileMeshes(),this._needRecompileMeshes=!1),this.loading>0||this.canvas.spinner.processes>0)return void(this.canvas.canvas.style.opacity=0);let i=Number.parseFloat(this.canvas.canvas.style.opacity);i<1&&(i+=.1,this.canvas.canvas.style.opacity=i),t.sceneId=this.id;const s=this._passes,r=this._clearEachPass;let a,o;for(a=0;a<s;a++)t.pass=a,this.fire("rendering",t,!0),o=r||0===a,this._renderer.render({pass:a,clear:o,force:e}),this.fire("rendered",t,!0);this._saveAmbientColor()}_recompileMeshes(){for(const e in this.meshes)this.meshes.hasOwnProperty(e)&&this.meshes[e]._compile()}_saveAmbientColor(){const e=this.canvas;if(e.transparent||e.backgroundImage||e.backgroundColor)this._lastAmbientColor=null;else{const t=this._lightsState.getAmbientColor();this._lastAmbientColor&&this._lastAmbientColor[0]===t[0]&&this._lastAmbientColor[1]===t[1]&&this._lastAmbientColor[2]===t[2]&&this._lastAmbientColor[3]===t[3]||(e.backgroundColor=t,this._lastAmbientColor||(this._lastAmbientColor=d.vec4([0,0,0,1])),this._lastAmbientColor.set(t))}}get objectGUIDs(){return this._objectGUIDs||(this._objectGUIDs=Object.keys(this.guidObjects)),this._objectGUIDs}get entityTypeIds(){return this._entityTypeIds||(this._entityTypeIds=Object.keys(this.entityTypes)),this._entityTypeIds}get entityIds(){return this._entityIds||(this._entityIds=Object.keys(this.entities)),this._entityIds}get visibleEntityIds(){return this._visibleEntityIds||(this._visibleEntityIds=Object.keys(this.visibleEntities)),this._visibleEntityIds}get ghostedEntityIds(){return this._ghostedEntityIds||(this._ghostedEntityIds=Object.keys(this.ghostedEntities)),this._ghostedEntityIds}get highlightedEntityIds(){return this._highlightedEntityIds||(this._highlightedEntityIds=Object.keys(this.highlightedEntities)),this._highlightedEntityIds}get selectedEntityIds(){return this._selectedEntityIds||(this._selectedEntityIds=Object.keys(this.selectedEntities)),this._selectedEntityIds}set ticksPerRender(e){null==e?e=1:(!a.isNumeric(e)||e<=0)&&(this.error("Unsupported value for 'ticksPerRender': '"+e+"' - should be an integer greater than zero."),e=1),e!==this._ticksPerRender&&(this._ticksPerRender=e)}get ticksPerRender(){return this._ticksPerRender}set passes(e){null==e?e=1:(!a.isNumeric(e)||e<=0)&&(this.error("Unsupported value for 'passes': '"+e+"' - should be an integer greater than zero."),e=1),e!==this._passes&&(this._passes=e,this._renderer.imageDirty())}get passes(){return this._passes}set clearEachPass(e){(e=!!e)!==this._clearEachPass&&(this._clearEachPass=e,this._renderer.imageDirty())}get clearEachPass(){return this._clearEachPass}set gammaInput(e){(e=!1!==e)!==this._renderer.gammaInput&&(this._renderer.gammaInput=e,this._needRecompileMeshes=!0)}get gammaInput(){return this._renderer.gammaInput}set gammaOutput(e){(e=!1!==e)!==this._renderer.gammaOutput&&(this._renderer.gammaOutput=e,this._needRecompileMeshes=!0)}get gammaOutput(){return this._renderer.gammaOutput}set gammaFactor(e){(e=null==e?2.2:e)!==this._renderer.gammaFactor&&(this._renderer.gammaFactor=e,this._renderer.imageDirty())}get gammaFactor(){return this._renderer.gammaFactor}get geometry(){return this.components["default.geometry"]||new bt(this,{id:"default.geometry",dontClear:!0})}get material(){return this.components["default.material"]||new ee(this,{id:"default.material",emissive:[.4,.4,.4],dontClear:!0})}get ghostMaterial(){return this.components["default.ghostMaterial"]||new Et(this,{id:"default.ghostMaterial",preset:"sepia",dontClear:!0})}get highlightMaterial(){return this.components["default.highlightMaterial"]||new Et(this,{id:"default.highlightMaterial",preset:"yellowHighlight",dontClear:!0})}get selectedMaterial(){return this.components["default.selectedMaterial"]||new Et(this,{id:"default.selectedMaterial",preset:"greenSelected",dontClear:!0})}get edgeMaterial(){return this.components["default.edgeMaterial"]||new Pt(this,{id:"default.edgeMaterial",preset:"default",edgeColor:[0,0,0],edgeAlpha:1,edgeWidth:1,dontClear:!0})}get outlineMaterial(){return this.components["default.outlineMaterial"]||new Tt(this,{id:"default.outlineMaterial",dontClear:!0})}get viewport(){return this._viewport}get camera(){return this._camera}get center(){if(this._aabbDirty||!this._center){this._center&&this._center||(this._center=d.vec3());const e=this.aabb;this._center[0]=(e[0]+e[3])/2,this._center[1]=(e[1]+e[4])/2,this._center[2]=(e[2]+e[5])/2}return this._center}get aabb(){if(this._aabbDirty){this._aabb||(this._aabb=d.AABB3());let e,t=d.MAX_DOUBLE,i=d.MAX_DOUBLE,s=d.MAX_DOUBLE,r=-d.MAX_DOUBLE,a=-d.MAX_DOUBLE,o=-d.MAX_DOUBLE;const n=this.meshes;let l;for(const h in n)if(n.hasOwnProperty(h)){if(l=n[h],!l.collidable)continue;e=l.aabb,e[0]<t&&(t=e[0]),e[1]<i&&(i=e[1]),e[2]<s&&(s=e[2]),e[3]>r&&(r=e[3]),e[4]>a&&(a=e[4]),e[5]>o&&(o=e[5])}this._aabb[0]=t,this._aabb[1]=i,this._aabb[2]=s,this._aabb[3]=r,this._aabb[4]=a,this._aabb[5]=o,this._aabbDirty=!1}return this._aabb}_setBoundaryDirty(){this._aabbDirty=!0,this.fire("boundary")}pick(e){if(0===this.canvas.boundary[2]||0===this.canvas.boundary[3])return this.error("Picking not allowed while canvas has zero width or height"),null;(e=e||{}).pickSurface=e.pickSurface||e.rayPick,e.canvasPos||e.origin&&e.direction||this.warn("picking without canvasPos or ray origin and direction");const t=e.includeMeshes||e.include;t&&(e.includeMeshIds=ai(this,t));const i=e.excludeMeshes||e.exclude;i&&(e.excludeMeshIds=ai(this,i));const s=this._renderer.pick(e);if(s){if(s.object=s.mesh,e.pickSurface&&void 0!==s.primIndex&&s.primIndex>-1){const t=s.mesh.geometry._state;if("triangles"===t.primitiveName){s.primitive="triangle";const i=s.primIndex,n=t.indices,l=t.positions;let h,u,c,p;if(n){var r=n[i+0],a=n[i+1],o=n[i+2];Rt[0]=r,Rt[1]=a,Rt[2]=o,s.indices=Rt,h=3*r,u=3*a,c=3*o}else h=3*i,u=h+3,c=u+3;if(Ft[0]=l[h+0],Ft[1]=l[h+1],Ft[2]=l[h+2],Lt[0]=l[u+0],Lt[1]=l[u+1],Lt[2]=l[u+2],Bt[0]=l[c+0],Bt[1]=l[c+1],Bt[2]=l[c+2],t.quantized){const e=t.positionsDecodeMatrix;e&&(d.decompressPosition(Ft,e,Ft),d.decompressPosition(Lt,e,Lt),d.decompressPosition(Bt,e,Bt))}e.canvasPos?(p=e.canvasPos,s.canvasPos=e.canvasPos,d.canvasPosToLocalRay(this.camera,s.mesh,p,Dt,St)):e.origin&&e.direction&&d.worldRayToLocalRay(s.mesh,e.origin,e.direction,Dt,St),d.normalizeVec3(St),d.rayPlaneIntersect(Dt,St,Ft,Lt,Bt,kt),s.localPos=kt,s.position=kt,Wt[0]=kt[0],Wt[1]=kt[1],Wt[2]=kt[2],Wt[3]=1,d.transformVec4(s.mesh.worldMatrix,Wt,Kt),It[0]=Kt[0],It[1]=Kt[1],It[2]=Kt[2],s.worldPos=It,d.transformVec4(s.mesh.scene.camera.matrix,Kt,Xt),Vt[0]=Xt[0],Vt[1]=Xt[1],Vt[2]=Xt[2],s.viewPos=Vt,d.cartesianToBarycentric(kt,Ft,Lt,Bt,Nt),s.bary=Nt;const _=t.normals;if(_){if(t.quantized){const e=2*r,t=2*a,i=2*o;d.octDecodeVec2(_.subarray(e,e+2),Ut),d.octDecodeVec2(_.subarray(t,t+2),Ot),d.octDecodeVec2(_.subarray(i,i+2),zt)}else Ut[0]=_[h],Ut[1]=_[h+1],Ut[2]=_[h+2],Ot[0]=_[u],Ot[1]=_[u+1],Ot[2]=_[u+2],zt[0]=_[c],zt[1]=_[c+1],zt[2]=_[c+2];const e=d.addVec3(d.addVec3(d.mulVec3Scalar(Ut,Nt[0],Ht),d.mulVec3Scalar(Ot,Nt[1],qt),Qt),d.mulVec3Scalar(zt,Nt[2],Zt),$t);s.normal=d.transformVec3(s.mesh.worldNormalMatrix,e,Jt)}const m=t.uv;if(m){if(Gt[0]=m[2*r],Gt[1]=m[2*r+1],jt[0]=m[2*a],jt[1]=m[2*a+1],Yt[0]=m[2*o],Yt[1]=m[2*o+1],t.quantized){const e=t.uvDecodeMatrix;e&&(d.decompressUV(Gt,e,Gt),d.decompressUV(jt,e,jt),d.decompressUV(Yt,e,Yt))}s.uv=d.addVec3(d.addVec3(d.mulVec2Scalar(Gt,Nt[0],ei),d.mulVec2Scalar(jt,Nt[1],ti),ii),d.mulVec2Scalar(Yt,Nt[2],si),ri)}}}return s.mesh.fire("picked",s),s}}getAABB(e){if(void 0===e)return this.aabb;if(a.isString(e)){const t=this.objects[e];if(t)return t.aabb;e=[e]}if(0===e.length)return this.aabb;let t,i=1e5,s=1e5,r=1e5,o=-1e5,n=-1e5,l=-1e5;if(this.withObjects(e,e=>{const a=e.aabb;a[0]<i&&(i=a[0]),a[1]<s&&(s=a[1]),a[2]<r&&(r=a[2]),a[3]>o&&(o=a[3]),a[4]>n&&(n=a[4]),a[5]>l&&(l=a[5]),t=!0}),t){const e=new d.AABB3;return e[0]=i,e[1]=s,e[2]=r,e[3]=o,e[4]=n,e[5]=l,e}return this.aabb}clear(){var e;for(const t in this.components)this.components.hasOwnProperty(t)&&((e=this.components[t])._dontClear||e.destroy())}clearLights(){const e=Object.keys(this.lights);for(let t=0,i=e.length;t<i;t++)this.lights[e[t]].destroy()}clearClips(){const e=Object.keys(this.clips);for(let t=0,i=e.length;t<i;t++)this.clips[e[t]].destroy()}setVisible(e,t){return this.withObjects(e,e=>{const i=e.visible!==t;return e.visible=t,i})}setCulled(e,t){return this.withObjects(e,e=>{const i=e.culled!==t;return e.culled=t,i})}setSelected(e,t){return this.withObjects(e,e=>{const i=e.selected!==t;return e.selected=t,i})}setHighlighted(e,t){return this.withObjects(e,e=>{const i=e.highlighted!==t;return e.highlighted=t,i})}setGhosted(e,t){return this.withObjects(e,e=>{const i=e.ghosted!==t;return e.ghosted=t,i})}setEdges(e,t){return this.withObjects(e,e=>{const i=e.edges!==t;return e.edges=t,i})}setOutlined(e,t){return this.withObjects(e,e=>{const i=e.outlined!==t;return e.outlined=t,i})}setColorize(e,t){return this.withObjects(e,e=>{e.colorize=t})}setOpacity(e,t){return this.withObjects(e,e=>{e.opacity=t})}setPickable(e,t){return this.withObjects(e,e=>{const i=e.pickable!==t;return e.pickable=t,i})}withObjects(e,t){a.isString(e)&&(e=[e]);let i=!1;for(let s=0,r=e.length;s<r;s++){const r=e[s];let a=this.objects[r];if(a)i=t(a)||i;else if(a=this.guidObjects[r],a)i=t(a)||i;else{const e=this.entityTypes[r];if(e)for(const s in e)e.hasOwnProperty(s)&&(i=t(e[s])||i)}}return i}destroy(){super.destroy();for(const e in this.components)this.components.hasOwnProperty(e)&&this.components[e].destroy();this.canvas.gl=null,this.models=null,this.objects=null,this.guidObjects=null,this.entityTypes=null,this.entities=null,this.visibleEntities=null,this.ghostedEntities=null,this.highlightedEntities=null,this.selectedEntities=null,this.clips=null,this.lights=null,this.lightMaps=null,this.reflectionMaps=null,this._objectGUIDs=null,this._entityIds=null,this._visibleEntityIds=null,this._ghostedEntityIds=null,this._highlightedEntityIds=null,this._selectedEntityIds=null,this.meshes=null,this.types=null,this.components=null,this.rootObjects=null,this.canvas=null,this._renderer=null,this.input=null,this._viewport=null,this._camera=null}}m["xeogl.Scene"]=oi;const ni={},li=new s;let hi=null;const ui={version:null,scenes:{},_superTypes:{},getDefaultScene:()=>(hi||(hi=new oi({id:"default.scene"})),hi),setDefaultScene:e=>(hi=e,hi),_addScene(e){if(e.id){if(ui.scenes[e.id])return void console.error(`[ERROR] Scene ${a.inQuotes(e.id)} already exists`)}else e.id=li.addItem({});ui.scenes[e.id]=e;const t=e.ticksPerRender;ni[e.id]={ticksPerRender:t,renderCountdown:t},r.components.scenes++,e.on("destroyed",()=>{li.removeItem(e.id),delete ui.scenes[e.id],delete ni[e.id],r.components.scenes--})},clear(){let e;for(const t in ui.scenes)ui.scenes.hasOwnProperty(t)&&(e=ui.scenes[t],"default.scene"===t?e.clear():(e.destroy(),delete ui.scenes[e.id]))},isComponentType:function(e,t="xeogl.Component"){if(e===t)return!0;var i=m[e];if(!i)return!1;var s=m[t];if(!s)return!1;return function(e,t){var i=e.prototype;for(;null!==i;){if(i===t.prototype)return!0;i=i.__proto__}return!1}(i,s)}};const ci={},di={sceneId:null,time:null,startTime:null,prevTime:null,deltaTime:null},pi=[];let _i,mi=0,fi=0;const gi=function(){let e=Date.now();if(mi>0){_i=e-mi;var t=1e3/_i;fi+=t,pi.push(t),pi.length>=30&&(fi-=pi.shift()),r.frame.fps=Math.round(fi/pi.length)}!function(e){const t=_.runTasks(e+10),i=_.getNumTasks();r.frame.tasksRun=t,r.frame.tasksScheduled=i,r.frame.tasksBudget=10}(e),function(e){for(var t in di.time=e,ui.scenes)if(ui.scenes.hasOwnProperty(t)){var i=ui.scenes[t];di.sceneId=t,di.startTime=i.startTime,di.deltaTime=null!=di.prevTime?di.time-di.prevTime:0,i.fire("tick",di,!0)}di.prevTime=e}(e),function(){const e=ui.scenes;let t,i,s,r;for(r in e)e.hasOwnProperty(r)&&(t=e[r],i=ci[r],i||(i=ci[r]={}),s=t.ticksPerRender,i.ticksPerRender!==s&&(i.ticksPerRender=s,i.renderCountdown=s),0==--i.renderCountdown&&(t.render(!1),i.renderCountdown=s))}(),mi=e,window.requestAnimationFrame(gi)};window.requestAnimationFrame(gi);const vi="xeogl.CameraFlightAnimation",Mi=d.vec3(),yi=d.vec3(),xi=d.vec3(),bi=d.vec3(),wi=d.vec3(),Ai=d.vec3();class Ei extends g{get type(){return vi}init(e){super.init(e),this._aabbHelper=new Je(this,{geometry:new q(this),material:new ee(this,{diffuse:[0,0,0],ambient:[0,0,0],specular:[0,0,0],emissive:[.5,1,.5],lineWidth:2}),visible:!1,collidable:!1}),this._look1=d.vec3(),this._eye1=d.vec3(),this._up1=d.vec3(),this._look2=d.vec3(),this._eye2=d.vec3(),this._up2=d.vec3(),this._orthoScale1=1,this._orthoScale2=1,this._flying=!1,this._flyEyeLookUp=!1,this._flyingEye=!1,this._flyingLook=!1,this._callback=null,this._callbackScope=null,this._time1=null,this._time2=null,this.easing=!1!==e.easing,this.duration=e.duration,this.fit=e.fit,this.fitFOV=e.fitFOV,this.trail=e.trail}flyTo(e,t,i){e=e||this.scene,this._flying&&this.stop(),this._flying=!1,this._callback=t,this._callbackScope=i;const s=this.scene.camera;let r,o,n,l,h;if(this._eye1[0]=s.eye[0],this._eye1[1]=s.eye[1],this._eye1[2]=s.eye[2],this._look1[0]=s.look[0],this._look1[1]=s.look[1],this._look1[2]=s.look[2],this._up1[0]=s.up[0],this._up1[1]=s.up[1],this._up1[2]=s.up[2],this._orthoScale1=s.ortho.scale,this._orthoScale2=e.orthoScale||this._orthoScale1,e.aabb)r=e.aabb;else if(6===e.length)r=e;else if(e.eye&&e.look||e.up)o=e.eye,n=e.look,l=e.up;else if(e.eye)o=e.eye;else if(e.look)n=e.look;else{let s=e;if((a.isNumeric(s)||a.isString(s))&&(h=s,s=this.scene.components[h],!s))return this.error("Component not found: "+a.inQuotes(h)),void(t&&(i?t.call(i):t()));r=s.aabb||this.scene.aabb}const u=e.poi;if(r){if(r[3]<r[0]||r[4]<r[1]||r[5]<r[2])return;if(r[3]===r[0]&&r[4]===r[1]&&r[5]===r[2])return;!1!==e.showAABB&&(this._aabbHelper.geometry.targetAABB=r),r=r.slice();const t=d.getAABB3Center(r);this._look2=u||t;const i=d.subVec3(this._eye1,this._look1,Mi),s=d.normalizeVec3(i),a=u?d.getAABB3DiagPoint(r,u):d.getAABB3Diag(r),o=e.fitFOV||this._fitFOV,n=Math.abs(a/Math.tan(o*d.DEGTORAD));this._orthoScale2=1.1*a,this._eye2[0]=this._look2[0]+s[0]*n,this._eye2[1]=this._look2[1]+s[1]*n,this._eye2[2]=this._look2[2]+s[2]*n,this._up2[0]=this._up1[0],this._up2[1]=this._up1[1],this._up2[2]=this._up1[2],this._flyEyeLookUp=!1}else(o||n||l)&&(this._flyEyeLookUp=!!o&&!!n&&!!l,this._flyingEye=!!o&&!n,this._flyingLook=!!n&&!o,n&&(this._look2[0]=n[0],this._look2[1]=n[1],this._look2[2]=n[2]),o&&(this._eye2[0]=o[0],this._eye2[1]=o[1],this._eye2[2]=o[2]),l&&(this._up2[0]=l[0],this._up2[1]=l[1],this._up2[2]=l[2]));this.fire("started",e,!0),this._time1=Date.now(),this._time2=this._time1+(e.duration?1e3*e.duration:this._duration),this._flying=!0,_.scheduleTask(this._update,this)}jumpTo(e){this._jumpTo(e)}_jumpTo(e){this._flying&&this.stop();const t=this.scene.camera;var i,s,r,o,n;if(e.aabb)i=e.aabb;else if(6===e.length)i=e;else if(e.eye||e.look||e.up)r=e.eye,o=e.look,n=e.up;else{let t=e;if((a.isNumeric(t)||a.isString(t))&&(s=t,t=this.scene.components[s],!t))return void this.error("Component not found: "+a.inQuotes(s));i=t.aabb||this.scene.aabb}const l=e.poi;if(i){if(i[3]<=i[0]||i[4]<=i[1]||i[5]<=i[2])return;var h=l?d.getAABB3DiagPoint(i,l):d.getAABB3Diag(i);let s;o=l||d.getAABB3Center(i,o),this._trail?d.subVec3(t.look,o,wi):d.subVec3(t.eye,t.look,wi),d.normalizeVec3(wi);s=(void 0!==e.fit?e.fit:this._fit)?Math.abs(h/Math.tan((e.fitFOV||this._fitFOV)*d.DEGTORAD)):d.lenVec3(d.subVec3(t.eye,t.look,Mi)),d.mulVec3Scalar(wi,s),t.eye=d.addVec3(o,wi,Mi),t.look=o}else(r||o||n)&&(r&&(t.eye=r),o&&(t.look=o),n&&(t.up=n))}_update(){if(!this._flying)return;let e=(Date.now()-this._time1)/(this._time2-this._time1);const t=e>=1;e>1&&(e=1),e=this.easing?this._ease(e,0,1,1):e;const i=this.scene.camera;if(this._flyingEye||this._flyingLook)this._flyingEye?(d.subVec3(i.eye,i.look,wi),i.eye=d.lerpVec3(e,0,1,this._eye1,this._eye2,xi),i.look=d.subVec3(xi,wi,yi)):this._flyingLook&&(i.look=d.lerpVec3(e,0,1,this._look1,this._look2,yi),i.up=d.lerpVec3(e,0,1,this._up1,this._up2,bi));else if(this._flyEyeLookUp)i.eye=d.lerpVec3(e,0,1,this._eye1,this._eye2,xi),i.look=d.lerpVec3(e,0,1,this._look1,this._look2,yi),i.up=d.lerpVec3(e,0,1,this._up1,this._up2,bi);else{let t;d.lerpVec3(e,0,1,this._look1,this._look2,yi),this._trail?d.subVec3(yi,i.look,wi):d.subVec3(i.eye,i.look,wi),d.normalizeVec3(wi),d.lerpVec3(e,0,1,this._eye1,this._eye2,xi),d.subVec3(xi,yi,Ai),t=d.lenVec3(Ai),d.mulVec3Scalar(wi,t),i.eye=d.addVec3(yi,wi,xi),i.look=yi}this.scene.camera.ortho.scale=this._orthoScale1+e*(this._orthoScale2-this._orthoScale1),t?this.stop():_.scheduleTask(this._update,this)}_ease(e,t,i,s){return-i*(e/=s)*(e-2)+t}stop(){if(!this._flying)return;this._aabbHelper.visible=!1,this._flying=!1,this._time1=null,this._time2=null;const e=this._callback;e&&(this._callback=null,this._callbackScope?e.call(this._callbackScope):e()),this.fire("stopped",!0,!0)}cancel(){this._flying&&(this._aabbHelper.visible=!1,this._flying=!1,this._time1=null,this._time2=null,this._callback&&(this._callback=null),this.fire("canceled",!0,!0))}set duration(e){this._duration=e?1e3*e:500,this.stop()}get duration(){return this._duration/1e3}set fit(e){this._fit=!1!==e}get fit(){return this._fit}set fitFOV(e){this._fitFOV=e||45}get fitFOV(){return this._fitFOV}set trail(e){this._trail=!!e}get trail(){return this._trail}}m[vi]=Ei;class Ci extends g{get type(){return"xeogl.Clip"}init(e){super.init(e),this._state=new D({active:!0,pos:new Float32Array(3),dir:new Float32Array(3)}),this.active=e.active,this.pos=e.pos,this.dir=e.dir,this.scene._clipCreated(this)}set active(e){this._state.active=!1!==e,this._renderer.imageDirty(),this.fire("active",this._state.active)}get active(){return this._state.active}set pos(e){this._state.pos.set(e||[0,0,0]),this._renderer.imageDirty(),this.fire("pos",this._state.pos)}get pos(){return this._state.pos}set dir(e){this._state.dir.set(e||[0,0,-1]),this._renderer.imageDirty(),this.fire("dir",this._state.dir)}get dir(){return this._state.dir}destroy(){this._state.destroy(),this.scene._clipDestroyed(this),super.destroy()}}m["xeogl.Clip"]=Ci;class Pi extends g{get type(){return"xeogl.CameraControl"}init(e){super.init(e);const t=this;this._boundaryHelper=new Je(this,{geometry:new q(this),material:new ee(this,{diffuse:[0,0,0],ambient:[0,0,0],specular:[0,0,0],emissive:[1,1,.6],lineWidth:4}),visible:!1,collidable:!1}),this._pivoter=new function(){const e=t.scene,i=e.camera,s=e.canvas,r=new Float32Array(3);let a,o=0,n=0,l=0,h=!1;const u=document.createElement("div");u.innerText=" ",u.style.color="#ffffff",u.style.position="absolute",u.style.width="25px",u.style.height="25px",u.style.left="0px",u.style.top="0px",u.style["border-radius"]="15px",u.style.border="2px solid #ffffff",u.style.background="black",u.style.visibility="hidden",u.style["box-shadow"]="5px 5px 15px 1px #000000",u.style["z-index"]=0,u.style["pointer-events"]="none",document.body.appendChild(u),function(){const t=d.vec4(),a=d.vec4(),o=d.vec2();let n=!0;i.on("viewMatrix",(function(){n=!0})),i.on("projMatrix",(function(){n=!0})),e.on("tick",(function(){if(h&&n){d.transformPoint3(i.viewMatrix,r,t),t[3]=1,d.transformPoint4(i.projMatrix,t,a);const e=s.boundary;o[0]=Math.floor((1+a[0]/a[3])*e[2]/2),o[1]=Math.floor((1-a[1]/a[3])*e[3]/2);const l=s.canvas.getBoundingClientRect();u.style.left=Math.floor(l.left+o[0])-12+"px",u.style.top=Math.floor(l.top+o[1])-12+"px",u.style.visibility="visible",n=!1}}))}(),this.startPivot=function(e){e&&r.set(e);let t=d.lookAtMat4v(i.eye,i.look,i.worldUp);a=d.transformPoint3(t,r),a[2]+=d.distVec3(i.eye,r),t=d.inverseMat4(t);const s=d.transformVec3(t,a),u=d.vec3();if(d.subVec3(i.eye,r,u),d.addVec3(u,s),1===i.worldUp[2]){const e=u[1];u[1]=u[2],u[2]=e}l=d.lenVec3(u),n=Math.acos(u[1]/l),o=Math.atan2(u[0],u[2]),h=!0},this.getPivoting=function(){return h},this.getPivotPos=function(){return r},this.continuePivot=function(e,t){if(!h)return;if(0===e&&0===t)return;1===i.worldUp[2]&&(s=-s);var s=-e;o+=.01*-s,n+=.01*-t,n=d.clamp(n,.001,Math.PI-.001);const c=[l*Math.sin(n)*Math.sin(o),l*Math.cos(n),l*Math.sin(n)*Math.cos(o)];if(1===i.worldUp[2]){const e=c[1];c[1]=c[2],c[2]=e}const p=d.lenVec3(d.subVec3(i.look,i.eye,d.vec3()));d.addVec3(c,r);let _=d.lookAtMat4v(c,r,i.worldUp);_=d.inverseMat4(_);const m=d.transformVec3(_,a);_[12]-=m[0],_[13]-=m[1],_[14]-=m[2];const f=[_[8],_[9],_[10]];i.eye=[_[12],_[13],_[14]],d.subVec3(i.eye,d.mulVec3Scalar(f,p),i.look),i.up=[_[4],_[5],_[6]],u.style.visibility="visible"},this.endPivot=function(){u.style.visibility="hidden",h=!1}},this._cameraFlight=new Ei(this,{duration:.5}),this.firstPerson=e.firstPerson,this.walking=e.walking,this.keyboardLayout=e.keyboardLayout,this.doublePickFlyTo=e.doublePickFlyTo,this.active=e.active,this.pivoting=e.pivoting,this.panToPointer=e.panToPointer,this.panToPivot=e.panToPivot,this.inertia=e.inertia,this._initEvents()}set active(e){this._active=!1!==e}get active(){return this._active}set pivoting(e){this._pivoting=!!e}get pivoting(){return this._pivoting}set panToPointer(e){this._panToPointer=!!e,this._panToPointer&&(this._panToPivot=!1)}get panToPointer(){return this._panToPointer}set panToPivot(e){this._panToPivot=!!e,this._panToPivot&&(this._panToPointer=!1)}get panToPivot(){return this._panToPivot}set firstPerson(e){this._firstPerson=!!e}get firstPerson(){return this._firstPerson}set walking(e){this._walking=!!e}get walking(){return this._walking}set doublePickFlyTo(e){this._doublePickFlyTo=!1!==e}get doublePickFlyTo(){return this._doublePickFlyTo}set inertia(e){this._inertia=void 0===e?.5:e}get inertia(){return this._inertia}set keyboardLayout(e){this._keyboardLayout=e||"qwerty"}get keyboardLayout(){return this._keyboardLayout}_initEvents(){const e=this,t=this.scene,i=t.input,s=t.camera,r=this.scene.canvas.canvas;let a=!1;r.oncontextmenu=function(e){e.preventDefault()};const o=function(e,t){if(e){let i=e.target,s=0,r=0;for(;i.offsetParent;)s+=i.offsetLeft,r+=i.offsetTop,i=i.offsetParent;t[0]=e.pageX-s,t[1]=e.pageY-r}else e=window.event,t[0]=e.x,t[1]=e.y;return t},n=[0,0];let l,h,u=!1,c=!1,p=!1;function _(){if(u||c){if(p=!1,h=c||e.hasSubs("hoverSurface")?t.pick({pickSurface:!0,canvasPos:n}):t.pick({canvasPos:n}),h){const i=h.mesh.id;l!==i&&(void 0!==l&&e.fire("hoverOut",{mesh:t.meshes[l]}),e.fire("hoverEnter",h),l=i),e.fire("hover",h),h.worldPos&&(p=!0,e.fire("hoverSurface",h))}else void 0!==l&&(e.fire("hoverOut",{mesh:t.meshes[l]}),l=void 0),e.fire("hoverOff",{canvasPos:n});u=!1,c=!1}}t.on("tick",_),function(){let n=0,l=0,u=0,m=0,f=0,g=0;const v=d.vec2();let M=!1,y=!1,x=!1,b=!1;const w={},A=function(){const e=new Float32Array(3);return function(){return d.lenVec3(d.subVec3(s.look,s.eye,e))}}(),E=function(){let e=!0;s.on("projMatrix",(function(){e=!0}));const t=d.mat4();return function(){return e&&d.inverseMat4(s.projMatrix,t),t}}(),C=function(){let e=!0;s.on("projMatrix",(function(){e=!0}));const t=d.mat4();return function(){return e&&d.transposeMat4(s.projMatrix,t),t}}(),P=function(){let e=!0;s.on("viewMatrix",(function(){e=!0}));const t=d.mat4();return function(){return e&&d.inverseMat4(s.viewMatrix,t),t}}(),T=function(){let e=!0,i=1;return t.on("boundary",(function(){e=!0})),function(){return e&&(i=d.getAABB3Diag(t.aabb)),i}}(),D=function(){const e=d.vec4(),i=d.vec4(),r=d.vec4(),a=d.vec3();return function(o,n){const l=E(),h=P(),u=C(),c=u.subarray(8,12),p=u.subarray(12),_=[0,0,-T(),1];!function(i,s,r,a,o,n){const l=t.canvas.canvas,h=l.offsetWidth/2,u=l.offsetHeight/2;e[0]=(r[0]-h)/h,e[1]=(r[1]-u)/u,e[2]=a,e[3]=1,d.mulMat4v4(i,e,o),d.mulVec3Scalar(o,1/o[3]),o[3]=1,o[1]*=-1,d.mulMat4v4(s,o,n)}(l,h,o,d.dotVec4(_,c)/d.dotVec4(_,p),i,r),d.subVec3(r,s.eye,a),d.normalizeVec3(a);const m=a[0]*n,f=a[1]*n,g=a[2]*n,v=s.eye,M=s.look;s.eye=[v[0]+m,v[1]+f,v[2]+g],s.look=[M[0]+m,M[1]+f,M[2]+g]}}(),S=function(){const e=d.vec3();return function(t,i){d.subVec3(t,s.eye,e),d.normalizeVec3(e);const r=e[0]*i,a=e[1]*i,o=e[2]*i,n=s.eye,l=s.look;s.eye=[n[0]+r,n[1]+a,n[2]+o],s.look=[l[0]+r,l[1]+a,l[2]+o]}}();function F(){const e=t.aabb,i=e[3]-e[0],s=e[4]-e[1],r=e[5]-e[2];let a=i>s?i:s;return a=r>a?r:a,a/30}t.on("tick",(function(){const t=e._inertia;if(Math.abs(n)<.001&&(n=0),Math.abs(l)<.001&&(l=0),0===l&&0===n||(e._pivoter.getPivoting()?e._pivoter.continuePivot(l,n):(0!==n&&(e._firstPerson?s.pitch(-n):s.orbitPitch(n)),0!==l&&(e._firstPerson?s.yaw(l):s.orbitYaw(l))),n*=t,l*=t),Math.abs(u)<.001&&(u=0),Math.abs(m)<.001&&(m=0),Math.abs(f)<.001&&(f=0),0!==u||0!==m||0!==f){const t=A()/80;if(e._walking){var i=s.eye[1];s.pan([u*t,m*t,f*t]),(r=s.eye)[1]=i,s.eye=r}else s.pan([u*t,m*t,f*t])}if(u*=t,m*=t,f*=t,Math.abs(g)<.001&&(g=0),0!==g){var r;if(e._firstPerson){if(e._walking&&(i=s.eye[1]),M?D(v,2*-g):s.pan([0,0,g]),e._walking)(r=s.eye)[1]=i,s.eye=r}else e._panToPointer?(_(),p?S(h.worldPos,-g):s.zoom(g)):e._panToPivot?S(e._pivoter.getPivotPos(),-g):s.zoom(g),s.ortho.scale=s.ortho.scale+g;g*=t}})),document.addEventListener("keyDown",(function(t){e._active&&"INPUT"!==t.target.tagName&&"TEXTAREA"!==t.target.tagName&&(y=t.ctrlKey||17===t.keyCode||t.metaKey,x=t.altKey||18===t.keyCode,b=16===t.keyCode,w[t.keyCode]=!0)}),!0),document.addEventListener("keyup",(function(t){e._active&&"INPUT"!==t.target.tagName&&"TEXTAREA"!==t.target.tagName&&((t.ctrlKey||17===t.keyCode)&&(y=!1),(t.altKey||18===t.keyCode)&&(x=!1),16===t.keyCode&&(b=!1),w[t.keyCode]=!1)})),function(){let s,h,d,p=0,_=0,y=!1;r.addEventListener("mousedown",(function(t){if(e._active)switch(a=!0,t.which){case 1:y=!0,p=0,_=0,o(t,v),s=v[0],h=v[1];break;case 2:break;case 3:d=!0,y=!0,p=0,_=0,o(t,v),s=v[0],h=v[1]}})),r.addEventListener("mouseup",(function(t){if(e._active){switch(t.which){case 1:case 2:break;case 3:d=!1}y=!1,p=0,_=0}})),document.addEventListener("mouseup",(function(t){if(e._active){switch(t.which){case 1:case 2:break;case 3:d=!1}y=!1,p=0,_=0}})),r.addEventListener("mouseenter",(function(){e._active&&(a=!0,p=0,_=0)})),r.addEventListener("mouseleave",(function(){e._active&&(a=!1,p=0,_=0)})),r.addEventListener("mousemove",(function(t){if(!e._active)return;if(!a)return;if(o(t,v),M=!0,!y)return;const i=v[0],r=v[1];p+=.4*(i-s),_+=.4*(r-h),s=i,h=r})),t.on("tick",(function(){if(!e._active)return;if(0===Math.abs(p)&&0===Math.abs(_))return;b||d?(u=.4*p,m=.4*_):(l=.4*-p,n=.4*_),p=0,_=0})),r.addEventListener("wheel",(function(t){if(!e._active)return;e._panToPointer&&(c=!0);const i=Math.max(-1,Math.min(1,40*-t.deltaY));if(0===i)return;const s=i/Math.abs(i);g=-s*F()*.8,t.preventDefault()})),t.on("tick",(function(t){if(!e._active)return;if(!a)return;const s=t.deltaTime;if(!e.ctrlDown&&!e.altDown){const e=i.keyDown[i.KEY_ADD],t=i.keyDown[i.KEY_SUBTRACT];(e||t)&&(t?g=s*F()*.02:e&&(g=-s*F()*.02))}})),t.on("tick",(function(t){if(!e._active)return;if(!a)return;const s=t.deltaTime;let r,o,n,l,h,c;"azerty"==e._keyboardLayout?(r=i.keyDown[i.KEY_Z],o=i.keyDown[i.KEY_S],n=i.keyDown[i.KEY_Q],l=i.keyDown[i.KEY_D],h=i.keyDown[i.KEY_W],c=i.keyDown[i.KEY_X]):(r=i.keyDown[i.KEY_W],o=i.keyDown[i.KEY_S],n=i.keyDown[i.KEY_A],l=i.keyDown[i.KEY_D],h=i.keyDown[i.KEY_Z],c=i.keyDown[i.KEY_X]),(r||o||n||l||h||c)&&(c?m+=.02*s:h&&(m-=.02*-s),l?u+=.02*-s:n&&(u=.02*s),o?f=.02*s:r&&(f=.02*-s))}))}(),function(){const t=new Float32Array(2),i=[];let s=0;const a=new Float32Array(2),o=new Float32Array(2);let h=0,c=Date.now();function p(e){const t=Date.now();return 0===h?(h=e,!0):h===e?t-c>50:(h=e,c=t,!1)}r.addEventListener("touchstart",(function(r){if(!e._active)return;const a=r.touches,o=r.changedTouches;for(1===a.length&&1===o.length&&(t[0]=a[0].pageX,t[1]=a[0].pageY);i.length<a.length;)i.push(new Float32Array(2));for(let e=0,t=a.length;e<t;++e)i[e][0]=a[e].pageX,i[e][1]=a[e].pageY;h=0,s=a.length,r.stopPropagation()}),{passive:!0}),r.addEventListener("touchmove",(function(t){if(!e._active)return;const r=t.touches;if(1===s){var h=r[0];if(p(1)){const e=h.pageX-i[0][0],t=h.pageY-i[0][1];n=.3*t,l=-(.3*e)}}else if(2===s){h=r[0];const e=r[1];d.subVec2([h.pageX,h.pageY],i[0],a),d.subVec2([e.pageX,e.pageY],i[1],o);const t=d.dotVec2(a,o)>0;if(t&&p(2)&&(d.subVec2([h.pageX,h.pageY],i[0],a),u=.2*a[0],m=.2*a[1]),!t&&p(4)){const t=d.distVec2([h.pageX,h.pageY],[e.pageX,e.pageY]),s=d.distVec2(i[0],i[1]);g=(s-t)*F()*.05}}for(let e=0;e<s;++e)i[e][0]=r[e].pageX,i[e][1]=r[e].pageY;t.stopPropagation()}),{passive:!0})}(),t.on("tick",(function(t){if(!e._active)return;if(!a)return;const s=t.deltaTime,r=i.keyDown[i.KEY_LEFT_ARROW],o=i.keyDown[i.KEY_RIGHT_ARROW],h=i.keyDown[i.KEY_UP_ARROW],u=i.keyDown[i.KEY_DOWN_ARROW];(r||o||h||u)&&(o?l+=.02*-s:r&&(l+=.02*s),u?n+=.02*s:h&&(n+=.02*-s))})),t.on("tick",(function(t){if(!e._active)return;if(!a)return;const s=t.deltaTime;let r,o;"azerty"==e._keyboardLayout?(r=i.keyDown[i.KEY_A],o=i.keyDown[i.KEY_E]):(r=i.keyDown[i.KEY_Q],o=i.keyDown[i.KEY_E]),(o||r)&&(r?l+=.02*s:o&&(l+=.02*-s))}))}(),function(){let t,i,s,a;r.addEventListener("mousemove",(function(t){e._active&&(o(t,n),(e.hasSubs("hover")||e.hasSubs("hoverOut")||e.hasSubs("hoverOff")||e.hasSubs("hoverSurface"))&&(u=!0))})),r.addEventListener("mousedown",(function(r){e._active&&(t=r.clientX,i=r.clientY,s=n[0],a=n[1],c=e._pivoting,_(),e._pivoting&&(h?e._pivoter.startPivot(h.worldPos):e._pivoter.startPivot()))})),r.addEventListener("mouseup",function(r){let o,l=0;return function(r){if(e._active&&(e._pivoter.endPivot(),!(Math.abs(r.clientX-t)>3||Math.abs(r.clientY-i)>3))){if(!(e._doublePickFlyTo||e.hasSubs("doublePicked")||e.hasSubs("doublePickedSurface")||e.hasSubs("doublePickedNothing")))return c=!!e.hasSubs("pickedSurface"),_(),void(h?(e.fire("picked",h),p&&e.fire("pickedSurface",h)):e.fire("pickedNothing"));l++,1==l?o=setTimeout((function(){u=e._doublePickFlyTo,c=u||!!e.hasSubs("pickedSurface"),n[0]=s,n[1]=a,_(),h?(e.fire("picked",h),p&&e.fire("pickedSurface",h)):e.fire("pickedNothing"),l=0}),250):(clearTimeout(o),u=e._doublePickFlyTo,c=u&&!!e.hasSubs("doublePickedSurface"),_(),h?(e.fire("doublePicked",h),p&&e.fire("doublePickedSurface",h),e._doublePickFlyTo&&e._flyTo(h)):(e.fire("doublePickedNothing"),e._doublePickFlyTo&&e._flyTo()),l=0)}}}(),!1)}(),function(){let t;const i=[],s=new Float32Array(2);let a=-1,o=-1;r.addEventListener("touchstart",(function(r){if(!e._active)return;const o=r.touches,n=r.changedTouches;for(t=Date.now(),1===o.length&&1===n.length?(a=t,s[0]=o[0].pageX,s[1]=o[0].pageY):a=-1;i.length<o.length;)i.push(new Float32Array(2));for(let e=0,t=o.length;e<t;++e)i[e][0]=o[e].pageX,i[e][1]=o[e].pageY;i.length=o.length,r.stopPropagation()}),{passive:!0}),r.addEventListener("touchend",(function(t){if(!e._active)return;const r=Date.now(),l=t.touches,m=t.changedTouches;0===l.length&&1===m.length&&a>-1&&r-a<150&&(o>-1&&a-o<325?(n[0]=Math.round(m[0].clientX),n[1]=Math.round(m[0].clientY),u=!0,c=!!e.hasSubs("pickedSurface"),_(),h?(e.fire("doublePicked",h),p&&e.fire("doublePickedSurface",h),e._doublePickFlyTo&&e._flyTo(h)):(e.fire("doublePickedNothing"),e._doublePickFlyTo&&e._flyTo()),o=-1):d.distVec2(i[0],s)<4&&(n[0]=Math.round(m[0].clientX),n[1]=Math.round(m[0].clientY),u=!0,c=!!e.hasSubs("pickedSurface"),_(),h?(e.fire("picked",h),p&&e.fire("pickedSurface",h)):e.fire("pickedNothing"),o=r),a=-1),i.length=l.length;for(let e=0,t=l.length;e<t;++e)i[e][0]=l[e].pageX,i[e][1]=l[e].pageY;t.stopPropagation()}),{passive:!0})}(),function(){const i=d.vec3(),r=d.vec3(),o=d.vec3(),n=d.vec3(),l={eye:new Float32Array(3),look:new Float32Array(3),up:new Float32Array(3)};document.addEventListener("keydown",(function(h){if(!e._active)return;if(!a)return;const u=h.keyCode;if(49!==u&&50!==u&&51!==u&&52!==u&&53!==u&&54!==u)return;const c=t.aabb,p=d.getAABB3Diag(c);i[0]=c[0]+c[3]/2,i[1]=c[1]+c[4]/2,i[2]=c[2]+c[5]/2;const _=Math.abs(p/Math.tan(e._cameraFlight.fitFOV/2));switch(u){case 49:l.eye.set(d.mulVec3Scalar(s.worldRight,_,r)),l.look.set(i),l.up.set(s.worldUp);break;case 50:l.eye.set(d.mulVec3Scalar(s.worldForward,_,r)),l.look.set(i),l.up.set(s.worldUp);break;case 51:l.eye.set(d.mulVec3Scalar(s.worldRight,-_,r)),l.look.set(i),l.up.set(s.worldUp);break;case 52:l.eye.set(d.mulVec3Scalar(s.worldForward,-_,r)),l.look.set(i),l.up.set(s.worldUp);break;case 53:l.eye.set(d.mulVec3Scalar(s.worldUp,_,r)),l.look.set(i),l.up.set(d.normalizeVec3(d.mulVec3Scalar(s.worldForward,1,o),n));break;case 54:l.eye.set(d.mulVec3Scalar(s.worldUp,-_,r)),l.look.set(i),l.up.set(d.normalizeVec3(d.mulVec3Scalar(s.worldForward,-1,o)));break;default:return}e._cameraFlight.duration>0?e._cameraFlight.flyTo(l):e._cameraFlight.jumpTo(l)}))}()}_flyTo(e){let t;e&&e.worldPos&&(t=e.worldPos);const i=e?e.mesh.aabb:this.scene.aabb;if(this._boundaryHelper.geometry.targetAABB=i,t){const e=this.scene.camera;d.subVec3(e.eye,e.look,[]);this._cameraFlight.flyTo({aabb:i},this._hideBoundary,this)}else this._cameraFlight.flyTo({aabb:i},this._hideBoundary,this)}_hideBoundary(){}destroy(){this.active=!1,super.destroy()}}m["xeogl.CameraControl"]=Pi;class Ti extends z{get type(){return"xeogl.TorusGeometry"}init(e){let t=e.radius||1;t<0&&(this.error("negative radius not allowed - will invert"),t*=-1),t*=.5;let i=e.tube||.3;i<0&&(this.error("negative tube not allowed - will invert"),i*=-1);let s=e.radialSegments||32;s<0&&(this.error("negative radialSegments not allowed - will invert"),s*=-1),s<4&&(s=4);let r=e.tubeSegments||24;r<0&&(this.error("negative tubeSegments not allowed - will invert"),r*=-1),r<4&&(r=4);let o=e.arc||2*Math.PI;o<0&&(this.warn("negative arc not allowed - will invert"),o*=-1),o>360&&(o=360);const n=e.center;let l=n?n[0]:0,h=n?n[1]:0;const u=n?n[2]:0,c=[],p=[],_=[],m=[];let f,g,v,M,y,x,b,w,A,E,C,P;for(w=0;w<=r;w++)for(b=0;b<=s;b++)f=b/s*o,g=.785398+w/r*Math.PI*2,l=t*Math.cos(f),h=t*Math.sin(f),v=(t+i*Math.cos(g))*Math.cos(f),M=(t+i*Math.cos(g))*Math.sin(f),y=i*Math.sin(g),c.push(v+l),c.push(M+h),c.push(y+u),_.push(1-b/s),_.push(w/r),x=d.normalizeVec3(d.subVec3([v,M,y],[l,h,u],[]),[]),p.push(x[0]),p.push(x[1]),p.push(x[2]);for(w=1;w<=r;w++)for(b=1;b<=s;b++)A=(s+1)*w+b-1,E=(s+1)*(w-1)+b-1,C=(s+1)*(w-1)+b,P=(s+1)*w+b,m.push(A),m.push(E),m.push(C),m.push(C),m.push(P),m.push(A);super.init(a.apply(e,{positions:c,normals:p,uv:_,indices:m}))}}m["xeogl.TorusGeometry"]=Ti;class Di extends z{get type(){return"xeogl.SphereGeometry"}init(e){const t=e.lod||1,i=e.center?e.center[0]:0,s=e.center?e.center[1]:0,r=e.center?e.center[2]:0;let o=e.radius||1;o<0&&(this.warn("negative radius not allowed - will invert"),o*=-1);let n=e.heightSegments||18;n<0&&(this.warn("negative heightSegments not allowed - will invert"),n*=-1),n=Math.floor(t*n),n<18&&(n=18);let l=e.widthSegments||18;l<0&&(this.warn("negative widthSegments not allowed - will invert"),l*=-1),l=Math.floor(t*l),l<18&&(l=18);const h=[],u=[],c=[],d=[];let p,_,m,f,g,v,M,y,x,b,w,A,E,C,P;for(p=0;p<=n;p++)for(m=p*Math.PI/n,f=Math.sin(m),g=Math.cos(m),_=0;_<=l;_++)v=2*_*Math.PI/l,M=Math.sin(v),y=Math.cos(v),x=y*f,b=g,w=M*f,A=1-_/l,E=p/n,u.push(x),u.push(b),u.push(w),c.push(A),c.push(E),h.push(i+o*x),h.push(s+o*b),h.push(r+o*w);for(p=0;p<n;p++)for(_=0;_<l;_++)C=p*(l+1)+_,P=C+l+1,d.push(C+1),d.push(P+1),d.push(P),d.push(C+1),d.push(P),d.push(C);super.init(a.apply(e,{positions:h,normals:u,uv:c,indices:d}))}}m["xeogl.SphereGeometry"]=Di;class Si extends z{get type(){return"xeogl.OBBGeometry"}init(e){super.init(a.apply(e,{combined:!0,quantized:!1,primitive:e.primitive||"lines",positions:e.positions||[1,1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1],indices:[0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]})),e.target?this.target=e.target:e.targetOBB&&(this.targetOBB=e.targetOBB)}set target(e){let t=!1;const i=this;this._attach({name:"target",type:"xeogl.Component",component:e,sceneDefault:!1,on:{boundary:function(){t||(t=!0,_.scheduleTask((function(){i._setPositionsFromOBB(i._attached.target.obb),t=!1})))}},onAttached:function(){i._setPositionsFromOBB(i._attached.target.obb)}})}get target(){return this._attached.target}set targetOBB(e){e&&(this._attached.target&&(this.target=null),this._setPositionsFromOBB(e))}_setPositionsFromOBB(e){this.positions=[e[0],e[1],e[2],e[4],e[5],e[6],e[8],e[9],e[10],e[12],e[13],e[14],e[16],e[17],e[18],e[20],e[21],e[22],e[24],e[25],e[26],e[28],e[29],e[30]]}}m["xeogl.OBBGeometry"]=Si;const Fi="xeogl.CylinderGeometry";class Li extends z{get type(){return Fi}init(e){let t=e.radiusTop||1;t<0&&(this.error("negative radiusTop not allowed - will invert"),t*=-1);let i=e.radiusBottom||1;i<0&&(this.error("negative radiusBottom not allowed - will invert"),i*=-1);let s=e.height||1;s<0&&(this.error("negative height not allowed - will invert"),s*=-1);let r=e.radialSegments||32;r<0&&(this.error("negative radialSegments not allowed - will invert"),r*=-1),r<3&&(r=3);let o=e.heightSegments||1;o<0&&(this.error("negative heightSegments not allowed - will invert"),o*=-1),o<1&&(o=1);const n=!!e.openEnded;let l=e.center;const h=l?l[0]:0,u=l?l[1]:0,c=l?l[2]:0,d=s/2,p=s/o,_=2*Math.PI/r,m=1/r,f=(t-i)/o,g=[],v=[],M=[],y=[];let x,b,w,A,E,C,P,T,D,S,F;const L=(90-180*Math.atan(s/(i-t))/Math.PI)/90;for(x=0;x<=o;x++)for(E=t-x*f,C=d-x*p,b=0;b<=r;b++)w=Math.sin(b*_),A=Math.cos(b*_),v.push(E*w),v.push(L),v.push(E*A),M.push(b*m),M.push(1*x/o),g.push(E*w+h),g.push(C+u),g.push(E*A+c);for(x=0;x<o;x++)for(b=0;b<=r;b++)P=x*(r+1)+b,T=P+r,y.push(P),y.push(T),y.push(T+1),y.push(P),y.push(T+1),y.push(P+1);if(!n&&t>0){for(D=g.length/3,v.push(0),v.push(1),v.push(0),M.push(.5),M.push(.5),g.push(0+h),g.push(d+u),g.push(0+c),b=0;b<=r;b++)w=Math.sin(b*_),A=Math.cos(b*_),S=.5*Math.sin(b*_)+.5,F=.5*Math.cos(b*_)+.5,v.push(t*w),v.push(1),v.push(t*A),M.push(S),M.push(F),g.push(t*w+h),g.push(d+u),g.push(t*A+c);for(b=0;b<r;b++)l=D,P=D+1+b,y.push(P),y.push(P+1),y.push(l)}if(!n&&i>0){for(D=g.length/3,v.push(0),v.push(-1),v.push(0),M.push(.5),M.push(.5),g.push(0+h),g.push(0-d+u),g.push(0+c),b=0;b<=r;b++)w=Math.sin(b*_),A=Math.cos(b*_),S=.5*Math.sin(b*_)+.5,F=.5*Math.cos(b*_)+.5,v.push(i*w),v.push(-1),v.push(i*A),M.push(S),M.push(F),g.push(i*w+h),g.push(0-d+u),g.push(i*A+c);for(b=0;b<r;b++)l=D,P=D+1+b,y.push(l),y.push(P+1),y.push(P)}super.init(a.apply(e,{positions:g,normals:v,uv:M,indices:y}))}}m[Fi]=Li;class Bi extends z{get type(){return"xeogl.PlaneGeometry"}init(e){let t=e.xSize||1;t<0&&(this.error("negative xSize not allowed - will invert"),t*=-1);let i=e.zSize||1;i<0&&(this.error("negative zSize not allowed - will invert"),i*=-1);let s=e.xSegments||1;s<0&&(this.error("negative xSegments not allowed - will invert"),s*=-1),s<1&&(s=1);let r=e.xSegments||1;r<0&&(this.error("negative zSegments not allowed - will invert"),r*=-1),r<1&&(r=1);const o=e.center,n=o?o[0]:0,l=o?o[1]:0,h=o?o[2]:0,u=t/2,c=i/2,d=Math.floor(s)||1,p=Math.floor(r)||1,_=d+1,m=p+1,f=t/d,g=i/p,v=new Float32Array(_*m*3),M=new Float32Array(_*m*3),y=new Float32Array(_*m*2);let x,b,w,A,E,C,P,T=0,D=0;for(x=0;x<m;x++){const e=x*g-c;for(b=0;b<_;b++)w=b*f-u,v[T]=w+n,v[T+1]=l,v[T+2]=-e+h,M[T+2]=-1,y[D]=(d-b)/d,y[D+1]=(p-x)/p,T+=3,D+=2}T=0;const S=new(v.length/3>65535?Uint32Array:Uint16Array)(d*p*6);for(x=0;x<p;x++)for(b=0;b<d;b++)A=b+_*x,E=b+_*(x+1),C=b+1+_*(x+1),P=b+1+_*x,S[T]=P,S[T+1]=E,S[T+2]=A,S[T+3]=P,S[T+4]=C,S[T+5]=E,T+=6;super.init(a.apply(e,{positions:v,normals:M,uv:y,indices:S}))}}m["xeogl.PlaneGeometry"]=Bi;class Ri extends g{get type(){return"xeogl.AmbientLight"}init(e){super.init(e),this._state={type:"ambient",color:d.vec3([.7,.7,.7]),intensity:1},this.color=e.color,this.intensity=e.intensity,this.scene._lightCreated(this)}set color(e){this._state.color.set(e||[.7,.7,.8]),this._renderer.setImageForceDirty()}get color(){return this._state.color}set intensity(e){this._state.intensity=void 0!==e?e:1,this._renderer.setImageForceDirty()}get intensity(){return this._state.intensity}destroy(){super.destroy(),this._state.destroy()}}m["xeogl.AmbientLight"]=Ri;class ki extends g{get type(){return"xeogl.PointLight"}init(e){super.init(e);const t=this;this._shadowRenderBuf=null,this._shadowViewMatrix=null,this._shadowProjMatrix=null,this._shadowViewMatrixDirty=!0,this._shadowProjMatrixDirty=!0,this._state=new D({type:"point",pos:d.vec3([1,1,1]),color:d.vec3([.7,.7,.8]),intensity:1,attenuation:[0,0,0],space:e.space||"view",shadow:!1,shadowDirty:!0,getShadowViewMatrix:function(){const e=d.vec3([0,0,0]),i=d.vec3([0,1,0]);return function(){return t._shadowViewMatrixDirty&&(t._shadowViewMatrix||(t._shadowViewMatrix=d.identityMat4()),d.lookAtMat4v(t._state.pos,e,i,t._shadowViewMatrix),t._shadowViewMatrixDirty=!1),t._shadowViewMatrix}}(),getShadowProjMatrix:function(){if(t._shadowProjMatrixDirty){t._shadowProjMatrix||(t._shadowProjMatrix=d.identityMat4());const e=t.scene.canvas.canvas;d.perspectiveMat4(Math.PI/180*70,e.clientWidth/e.clientHeight,.1,500,t._shadowProjMatrix),t._shadowProjMatrixDirty=!1}return t._shadowProjMatrix},getShadowRenderBuf:function(){return t._shadowRenderBuf||(t._shadowRenderBuf=new P(t.scene.canvas.canvas,t.scene.canvas.gl)),t._shadowRenderBuf}}),this.pos=e.pos,this.color=e.color,this.intensity=e.intensity,this.constantAttenuation=e.constantAttenuation,this.linearAttenuation=e.linearAttenuation,this.quadraticAttenuation=e.quadraticAttenuation,this.shadow=e.shadow,this.scene._lightCreated(this)}set pos(e){this._state.pos.set(e||[1,1,1]),this._shadowViewMatrixDirty=!0,this._renderer.imageDirty()}get pos(){return this._state.pos}set color(e){this._state.color.set(e||[.7,.7,.8]),this._renderer.imageDirty()}get color(){return this._state.color}set intensity(e){e=void 0!==e?e:1,this._state.intensity=e,this._renderer.imageDirty()}get intensity(){return this._state.intensity}set constantAttenuation(e){this._state.attenuation[0]=e||0,this._renderer.imageDirty()}get constantAttenuation(){return this._state.attenuation[0]}set linearAttenuation(e){this._state.attenuation[1]=e||0,this._renderer.imageDirty()}get linearAttenuation(){return this._state.attenuation[1]}set quadraticAttenuation(e){this._state.attenuation[2]=e||0,this._renderer.imageDirty()}get quadraticAttenuation(){return this._state.attenuation[2]}set shadow(e){e=!!e,this._state.shadow!==e&&(this._state.shadow=e,this._shadowViewMatrixDirty=!0,this._renderer.imageDirty())}get shadow(){return this._state.shadow}destroy(){super.destroy(),this._state.destroy(),this._shadowRenderBuf&&this._shadowRenderBuf.destroy(),this.scene._lightDestroyed(this)}}m["xeogl.PointLight"]=ki;class Ii extends g{get type(){return"xeogl.SpotLight"}init(e){super.init(e);const t=this;this._shadowRenderBuf=null,this._shadowViewMatrix=null,this._shadowProjMatrix=null,this._shadowViewMatrixDirty=!0,this._shadowProjMatrixDirty=!0,this._state=new D({type:"spot",pos:d.vec3([1,1,1]),dir:d.vec3([0,-1,0]),color:d.vec3([.7,.7,.8]),intensity:1,attenuation:[0,0,0],space:e.space||"view",shadow:!1,shadowDirty:!0,getShadowViewMatrix:function(){const e=d.vec3(),i=d.vec3([0,1,0]);return function(){return t._shadowViewMatrixDirty&&(t._shadowViewMatrix||(t._shadowViewMatrix=d.identityMat4()),d.addVec3(t._state.pos,t._state.dir,e),d.lookAtMat4v(t._state.pos,e,i,t._shadowViewMatrix),t._shadowViewMatrixDirty=!1),t._shadowViewMatrix}}(),getShadowProjMatrix:function(){if(t._shadowProjMatrixDirty){t._shadowProjMatrix||(t._shadowProjMatrix=d.identityMat4());const e=t.scene.canvas.canvas;d.perspectiveMat4(Math.PI/180*60,e.clientWidth/e.clientHeight,.1,400,t._shadowProjMatrix),t._shadowProjMatrixDirty=!1}return t._shadowProjMatrix},getShadowRenderBuf:function(){return t._shadowRenderBuf||(t._shadowRenderBuf=new P(t.scene.canvas.canvas,t.scene.canvas.gl)),t._shadowRenderBuf}}),this.pos=e.pos,this.color=e.color,this.intensity=e.intensity,this.constantAttenuation=e.constantAttenuation,this.linearAttenuation=e.linearAttenuation,this.quadraticAttenuation=e.quadraticAttenuation,this.shadow=e.shadow,this.scene._lightCreated(this)}set pos(e){this._state.pos.set(e||[1,1,1]),this._shadowViewMatrixDirty=!0,this._renderer.imageDirty()}get pos(){return this._state.pos}set dir(e){this._state.dir.set(e||[1,1,1]),this._shadowViewMatrixDirty=!0,this._renderer.imageDirty()}get dir(){return this._state.dir}set color(e){this._state.color.set(e||[.7,.7,.8]),this._renderer.imageDirty()}get color(){return this._state.color}set intensity(e){e=void 0!==e?e:1,this._state.intensity=e,this._renderer.imageDirty()}get intensity(){return this._state.intensity}set constantAttenuation(e){this._state.attenuation[0]=e||0,this._renderer.imageDirty()}get constantAttenuation(){return this._state.attenuation[0]}set linearAttenuation(e){this._state.attenuation[1]=e||0,this._renderer.imageDirty()}get linearAttenuation(){return this._state.attenuation[1]}set quadraticAttenuation(e){this._state.attenuation[2]=e||0,this._renderer.imageDirty()}get quadraticAttenuation(){return this._state.attenuation[2]}set shadow(e){e=!!e,this._state.shadow!==e&&(this._state.shadow=e,this._shadowViewMatrixDirty=!0,this._renderer.imageDirty(),this.fire("dirty",!0))}get shadow(){return this._state.shadow}destroy(){super.destroy(),this._state.destroy(),this._shadowRenderBuf&&this._shadowRenderBuf.destroy(),this.scene._lightDestroyed(this)}}m["xeogl.SpotLight"]=Ii;const Vi={funcAdd:"FUNC_ADD",funcSubtract:"FUNC_SUBTRACT",funcReverseSubtract:"FUNC_REVERSE_SUBTRACT",zero:"ZERO",one:"ONE",srcColor:"SRC_COLOR",oneMinusSrcColor:"ONE_MINUS_SRC_COLOR",dstColor:"DST_COLOR",oneMinusDstColor:"ONE_MINUS_DST_COLOR",srcAlpha:"SRC_ALPHA",oneMinusSrcAlpha:"ONE_MINUS_SRC_ALPHA",dstAlpha:"DST_ALPHA",oneMinusDstAlpha:"ONE_MINUS_DST_ALPHA",contantColor:"CONSTANT_COLOR",oneMinusConstantColor:"ONE_MINUS_CONSTANT_COLOR",constantAlpha:"CONSTANT_ALPHA",oneMinusConstantAlpha:"ONE_MINUS_CONSTANT_ALPHA",srcAlphaSaturate:"SRC_ALPHA_SATURATE",front:"FRONT",back:"BACK",frontAndBack:"FRONT_AND_BACK",never:"NEVER",less:"LESS",equal:"EQUAL",lequal:"LEQUAL",greater:"GREATER",notequal:"NOTEQUAL",gequal:"GEQUAL",always:"ALWAYS",cw:"CW",ccw:"CCW",linear:"LINEAR",nearest:"NEAREST",linearMipmapNearest:"LINEAR_MIPMAP_NEAREST",nearestMipmapNearest:"NEAREST_MIPMAP_NEAREST",nearestMipmapLinear:"NEAREST_MIPMAP_LINEAR",linearMipmapLinear:"LINEAR_MIPMAP_LINEAR",repeat:"REPEAT",clampToEdge:"CLAMP_TO_EDGE",mirroredRepeat:"MIRRORED_REPEAT",alpha:"ALPHA",rgb:"RGB",rgba:"RGBA",luminance:"LUMINANCE",luminanceAlpha:"LUMINANCE_ALPHA",textureBinding2D:"TEXTURE_BINDING_2D",textureBindingCubeMap:"TEXTURE_BINDING_CUBE_MAP",compareRToTexture:"COMPARE_R_TO_TEXTURE",unsignedByte:"UNSIGNED_BYTE"};function Ni(e,t,i){if(void 0===t)return i;const s=Vi[t];return void 0===s?i:e[s]}const Ui=new Uint8Array([0,0,0,1]);class Oi{constructor(e,t){this.gl=e,this.target=t||e.TEXTURE_2D,this.texture=e.createTexture(),this.setPreloadColor([0,0,0,0]),this.allocated=!0}setPreloadColor(e){e?(Ui[0]=Math.floor(255*e[0]),Ui[1]=Math.floor(255*e[1]),Ui[2]=Math.floor(255*e[2]),Ui[3]=Math.floor(255*(void 0!==e[3]?e[3]:1))):(Ui[0]=0,Ui[1]=0,Ui[2]=0,Ui[3]=255);const t=this.gl;if(t.bindTexture(this.target,this.texture),t.texParameteri(this.target,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(this.target,t.TEXTURE_MIN_FILTER,t.NEAREST),this.target===t.TEXTURE_CUBE_MAP){const e=[t.TEXTURE_CUBE_MAP_POSITIVE_X,t.TEXTURE_CUBE_MAP_NEGATIVE_X,t.TEXTURE_CUBE_MAP_POSITIVE_Y,t.TEXTURE_CUBE_MAP_NEGATIVE_Y,t.TEXTURE_CUBE_MAP_POSITIVE_Z,t.TEXTURE_CUBE_MAP_NEGATIVE_Z];for(let i=0,s=e.length;i<s;i++)t.texImage2D(e[i],0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,Ui)}else t.texImage2D(this.target,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,Ui);t.bindTexture(this.target,null)}setTarget(e){this.target=e||this.gl.TEXTURE_2D}setImage(e,t){const i=this.gl;if(i.bindTexture(this.target,this.texture),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,t.flipY),this.target===i.TEXTURE_CUBE_MAP){if(a.isArray(e)){const t=e,s=[i.TEXTURE_CUBE_MAP_POSITIVE_X,i.TEXTURE_CUBE_MAP_NEGATIVE_X,i.TEXTURE_CUBE_MAP_POSITIVE_Y,i.TEXTURE_CUBE_MAP_NEGATIVE_Y,i.TEXTURE_CUBE_MAP_POSITIVE_Z,i.TEXTURE_CUBE_MAP_NEGATIVE_Z];for(let e=0,r=s.length;e<r;e++)i.texImage2D(s[e],0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,t[e])}}else i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,e);i.bindTexture(this.target,null)}setProps(e){const t=this.gl;if(t.bindTexture(this.target,this.texture),e.minFilter){const i=Ni(t,e.minFilter);i&&(t.texParameteri(this.target,t.TEXTURE_MIN_FILTER,i),i!==t.NEAREST_MIPMAP_NEAREST&&i!==t.LINEAR_MIPMAP_NEAREST&&i!==t.NEAREST_MIPMAP_LINEAR&&i!==t.LINEAR_MIPMAP_LINEAR||t.generateMipmap(this.target))}if(e.magFilter){const i=Ni(t,e.magFilter);i&&t.texParameteri(this.target,t.TEXTURE_MAG_FILTER,i)}if(e.wrapS){const i=Ni(t,e.wrapS);i&&t.texParameteri(this.target,t.TEXTURE_WRAP_S,i)}if(e.wrapT){const i=Ni(t,e.wrapT);i&&t.texParameteri(this.target,t.TEXTURE_WRAP_T,i)}t.bindTexture(this.target,null)}bind(e){if(this.allocated){if(this.texture){const t=this.gl;return t.activeTexture(t["TEXTURE"+e]),t.bindTexture(this.target,this.texture),!0}return!1}}unbind(e){if(this.allocated&&this.texture){const t=this.gl;t.activeTexture(t["TEXTURE"+e]),t.bindTexture(this.target,null)}}destroy(){this.allocated&&this.texture&&(this.gl.deleteTexture(this.texture),this.texture=null)}}function zi(e){if(!Gi(e.width)||!Gi(e.height)){const t=document.createElement("canvas");t.width=ji(e.width),t.height=ji(e.height);t.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,t.width,t.height),e=t}return e}function Gi(e){return 0==(e&e-1)}function ji(e){--e;for(let t=1;t<32;t<<=1)e|=e>>t;return e+1}class Yi extends g{get type(){return"xeogl.CubeTexture"}init(e){super.init(e);const t=this.scene.canvas.gl;this._state=new D({texture:new Oi(t,t.TEXTURE_CUBE_MAP),flipY:this._checkFlipY(e.minFilter),encoding:this._checkEncoding(e.encoding),minFilter:"linearMipmapLinear",magFilter:"linear",wrapS:"clampToEdge",wrapT:"clampToEdge",mipmaps:!0}),this._src=e.src,this._images=[],this._loadSrc(e.src),r.memory.textures++}_checkFlipY(e){return!!e}_checkEncoding(e){return"linear"!==(e=e||"linear")&&"sRGB"!==e&&"gamma"!==e&&(this.error("Unsupported value for 'encoding': '"+e+"' - supported values are 'linear', 'sRGB', 'gamma'. Defaulting to 'linear'."),e="linear"),e}_webglContextRestored(){this.scene.canvas.gl;this._state.texture=null,this._src&&this._loadSrc(this._src)}_loadSrc(e){const t=this,i=this.scene.canvas.gl;this._images=[];let s=!1,r=0;for(let a=0;a<e.length;a++){const o=new Image;o.onload=function(){let e=o;const n=a;return function(){if(!s&&(e=zi(e),t._images[n]=e,r++,6===r)){let e=t._state.texture;e||(e=new Oi(i,i.TEXTURE_CUBE_MAP),t._state.texture=e),e.setImage(t._images,t._state),e.setProps(t._state),t.fire("loaded",t._src)}}}(),o.onerror=function(){s=!0},o.src=e[a]}}destroy(){super.destroy(),this._state.texture&&this._state.texture.destroy(),r.memory.textures--,this._state.destroy()}}m["xeogl.CubeTexture"]=Yi;class Wi extends Yi{get type(){return"xeogl.LightMap"}init(e){super.init(e),this.scene._lightMapCreated(this)}destroy(){super.destroy(),this.scene._lightMapDestroyed(this)}}m["xeogl.LightMap"]=Wi;class Ki extends Yi{get type(){return"xeogl.ReflectionMap"}init(e){super.init(e),this.scene._lightsState.addReflectionMap(this._state),this.scene._reflectionMapCreated(this)}destroy(){super.destroy(),this.scene._reflectionMapDestroyed(this)}}m["xeogl.ReflectionMap"]=Ki;class Xi extends g{get type(){return"xeogl.Shadow"}init(e){super.init(e),this._state={resolution:d.vec3([1e3,1e3]),intensity:1},this.resolution=e.resolution,this.intensity=e.intensity}set resolution(e){this._state.resolution.set(e||[1e3,1e3]),this._renderer.imageDirty(),this.fire("resolution",this._state.resolution)}get resolution(){return this._state.resolution}set intensity(e){e=void 0!==e?e:1,this._state.intensity=e,this._renderer.imageDirty(),this.fire("intensity",this._state.intensity)}get intensity(){return this._state.intensity}destroy(){super.destroy()}}m["xeogl.Shadow"]=Xi;class Hi extends ue{get type(){return"xeogl.Group"}init(e){super.init(e)}}m["xeogl.Group"]=Hi;class qi extends Hi{get type(){return"xeogl.Model"}init(e){this.components={},this.numComponents=0,this.types={},this.objects={},this.guidObjects={},this.meshes={},this.entities={},this.entityTypes={},this._objectGUIDs=null,this._entityIds=null,super.init(e),this.scene._modelCreated(this)}_addComponent(e){let t;if(a.isNumeric(e)||a.isString(e)){if(!(e=this.scene.components[e]))return void this.warn("Component not found: "+a.inQuotes(e))}else if(a.isObject(e)){const t=e.type||"xeogl.Component";if(!ui.isComponentType(t))return void this.error("Not a xeogl component type: "+t);e=new window[t](this.scene,e)}if(e.scene===this.scene){if(!this.components[e.id]){if(e.model&&e.model.id!==this.id&&e.model._removeComponent(e),this.components[e.id]=e,t=this.types[e.type],t||(t=this.types[e.type]={}),t[e.id]=e,e.isType("xeogl.Object")){const t=e;if(this.objects[t.id]=t,t.entityType){this.entities[t.id]=t;let e=this.entityTypes[t.entityType];e||(e={},this.entityTypes[t.entityType]=e),e[t.id]=t,this._entityIds=null,this._entityTypeIds=null}t.guid&&(this.guidObjects[t.id]=t,this._objectGUIDs=null),e.isType("xeogl.Mesh")&&(this.meshes[e.id]=e)}return this.numComponents++,e._addedToModel(this),e}}else this.error("Attempted to add component from different xeogl.Scene: "+a.inQuotes(e.id))}_removeComponent(e){const t=e.id;if(delete this.components[t],delete this.meshes[t],delete this.objects[t],e.entityType){delete this.entities[t];const i=this.entityTypes[e.entityType];i&&delete i[t],this._entityIds=null,this._entityTypeIds=null}e.guid&&(delete this.guidObjects[e.guid],this._objectGUIDs=null)}clear(){for(var e in this.meshes)this.meshes.hasOwnProperty(e)&&this.meshes[e].destroy();for(var e in this.components)this.components.hasOwnProperty(e)&&this.components[e].destroy();this.components={},this.numComponents=0,this.types={},this.objects={},this.meshes={},this.entities={}}get objectGUIDs(){return this._objectGUIDs||(this._objectGUIDs=Object.keys(this.guidObjects)),this._objectGUIDs}get entityTypeIds(){return this._entityTypeIds||(this._entityTypeIds=Object.keys(this.entityTypes)),this._entityTypeIds}get entityIds(){return this._entityIds||(this._entityIds=Object.keys(this.entities)),this._entityIds}destroyAll(){this.clear()}destroy(){super.destroy(),this.clear(),this.scene._modelDestroyed(this)}}m["xeogl.Model"]=qi;class Qi extends Q{get type(){return"xeogl.LambertMaterial"}init(e){super.init(e),this._state=new D({type:"LambertMaterial",ambient:d.vec3([1,1,1]),color:d.vec3([1,1,1]),emissive:d.vec3([0,0,0]),alpha:null,alphaMode:0,lineWidth:null,pointSize:null,backfaces:null,frontface:null,hash:"/lam;"}),this.ambient=e.ambient,this.color=e.color,this.emissive=e.emissive,this.alpha=e.alpha,this.lineWidth=e.lineWidth,this.pointSize=e.pointSize,this.backfaces=e.backfaces,this.frontface=e.frontface}set ambient(e){let t=this._state.ambient;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.ambient=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=.2,t[1]=.2,t[2]=.2),this._renderer.imageDirty()}get ambient(){return this._state.ambient}set color(e){let t=this._state.color;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.color=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1),this._renderer.imageDirty()}get color(){return this._state.color}set emissive(e){let t=this._state.emissive;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.emissive=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=0,t[1]=0,t[2]=0),this._renderer.imageDirty()}get emissive(){return this._state.emissive}set alpha(e){e=null!=e?e:1,this._state.alpha!==e&&(this._state.alpha=e,this._state.alphaMode=e<1?2:0,this._renderer.imageDirty())}get alpha(){return this._state.alpha}set lineWidth(e){this._state.lineWidth=e||1,this._renderer.imageDirty()}get lineWidth(){return this._state.lineWidth}set pointSize(e){this._state.pointSize=e||1,this._renderer.imageDirty()}get pointSize(){return this._state.pointSize}set backfaces(e){e=!!e,this._state.backfaces!==e&&(this._state.backfaces=e,this._renderer.imageDirty())}get backfaces(){return this._state.backfaces}set frontface(e){e="cw"!==e,this._state.frontface!==e&&(this._state.frontface=e,this._renderer.imageDirty())}get frontface(){return this._state.frontface?"ccw":"cw"}_getState(){return this._state}destroy(){super.destroy(),this._state.destroy()}}m["xeogl.LambertMaterial"]=Qi;const Zi="xeogl.SpecularMaterial",$i={opaque:0,mask:1,blend:2},Ji=["opaque","mask","blend"];class es extends Q{get type(){return Zi}init(e){super.init(e),this._state=new D({type:"SpecularMaterial",diffuse:d.vec3([1,1,1]),emissive:d.vec3([0,0,0]),specular:d.vec3([1,1,1]),glossiness:null,specularF0:null,alpha:null,alphaMode:null,alphaCutoff:null,lineWidth:null,pointSize:null,backfaces:null,frontface:null,hash:null}),this.diffuse=e.diffuse,this.specular=e.specular,this.glossiness=e.glossiness,this.specularF0=e.specularF0,this.emissive=e.emissive,this.alpha=e.alpha,e.diffuseMap&&(this._diffuseMap=this._checkComponent("xeogl.Texture",e.diffuseMap)),e.emissiveMap&&(this._emissiveMap=this._checkComponent("xeogl.Texture",e.emissiveMap)),e.specularMap&&(this._specularMap=this._checkComponent("xeogl.Texture",e.specularMap)),e.glossinessMap&&(this._glossinessMap=this._checkComponent("xeogl.Texture",e.glossinessMap)),e.specularGlossinessMap&&(this._specularGlossinessMap=this._checkComponent("xeogl.Texture",e.specularGlossinessMap)),e.occlusionMap&&(this._occlusionMap=this._checkComponent("xeogl.Texture",e.occlusionMap)),e.alphaMap&&(this._alphaMap=this._checkComponent("xeogl.Texture",e.alphaMap)),e.normalMap&&(this._normalMap=this._checkComponent("xeogl.Texture",e.normalMap)),this.alphaMode=e.alphaMode,this.alphaCutoff=e.alphaCutoff,this.backfaces=e.backfaces,this.frontface=e.frontface,this.lineWidth=e.lineWidth,this.pointSize=e.pointSize,this._makeHash()}_makeHash(){const e=this._state,t=["/spe"];this._diffuseMap&&(t.push("/dm"),this._diffuseMap.hasMatrix&&t.push("/mat"),t.push("/"+this._diffuseMap.encoding)),this._emissiveMap&&(t.push("/em"),this._emissiveMap.hasMatrix&&t.push("/mat")),this._glossinessMap&&(t.push("/gm"),this._glossinessMap.hasMatrix&&t.push("/mat")),this._specularMap&&(t.push("/sm"),this._specularMap.hasMatrix&&t.push("/mat")),this._specularGlossinessMap&&(t.push("/sgm"),this._specularGlossinessMap.hasMatrix&&t.push("/mat")),this._occlusionMap&&(t.push("/ocm"),this._occlusionMap.hasMatrix&&t.push("/mat")),this._normalMap&&(t.push("/nm"),this._normalMap.hasMatrix&&t.push("/mat")),this._alphaMap&&(t.push("/opm"),this._alphaMap.hasMatrix&&t.push("/mat")),t.push(";"),e.hash=t.join("")}set diffuse(e){let t=this._state.diffuse;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.diffuse=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1),this._renderer.imageDirty()}get diffuse(){return this._state.diffuse}get diffuseMap(){return this._diffuseMap}set specular(e){let t=this._state.specular;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.specular=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1),this._renderer.imageDirty()}get specular(){return this._state.specular}get specularMap(){return this._specularMap}get specularGlossinessMap(){return this._specularGlossinessMap}set glossiness(e){e=null!=e?e:1,this._state.glossiness!==e&&(this._state.glossiness=e,this._renderer.imageDirty())}get glossiness(){return this._state.glossiness}get glossinessMap(){return this._glossinessMap}set specularF0(e){e=null!=e?e:0,this._state.specularF0!==e&&(this._state.specularF0=e,this._renderer.imageDirty())}get specularF0(){return this._state.specularF0}set emissive(e){let t=this._state.emissive;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.emissive=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=0,t[1]=0,t[2]=0),this._renderer.imageDirty()}get emissive(){return this._state.emissive}get emissiveMap(){return this._emissiveMap}set alpha(e){e=null!=e?e:1,this._state.alpha!==e&&(this._state.alpha=e,this._renderer.imageDirty())}get alpha(){return this._state.alpha}get alphaMap(){return this._alphaMap}get normalMap(){return this._normalMap}get occlusionMap(){return this._occlusionMap}set alphaMode(e){let t=$i[e=e||"opaque"];void 0===t&&(this.error("Unsupported value for 'alphaMode': "+e+" defaulting to 'opaque'"),t="opaque"),this._state.alphaMode!==t&&(this._state.alphaMode=t,this._renderer.imageDirty())}get alphaMode(){return Ji[this._state.alphaMode]}set alphaCutoff(e){null==e&&(e=.5),this._state.alphaCutoff!==e&&(this._state.alphaCutoff=e)}get alphaCutoff(){return this._state.alphaCutoff}set backfaces(e){e=!!e,this._state.backfaces!==e&&(this._state.backfaces=e,this._renderer.imageDirty())}get backfaces(){return this._state.backfaces}set frontface(e){e="cw"!==e,this._state.frontface!==e&&(this._state.frontface=e,this._renderer.imageDirty())}get frontface(){return this._state.frontface?"ccw":"cw"}set lineWidth(e){this._state.lineWidth=e||1,this._renderer.imageDirty()}get lineWidth(){return this._state.lineWidth}set pointSize(e){this._state.pointSize=e||1,this._renderer.imageDirty()}get pointSize(){return this._state.pointSize}destroy(){super.destroy(),this._state.destroy()}}m[Zi]=es;const ts={opaque:0,mask:1,blend:2},is=["opaque","mask","blend"],ss="xeogl.MetallicMaterial";class rs extends Q{get type(){return ss}init(e){super.init(e),this._state=new D({type:"MetallicMaterial",baseColor:d.vec4([1,1,1]),emissive:d.vec4([0,0,0]),metallic:null,roughness:null,specularF0:null,alpha:null,alphaMode:null,alphaCutoff:null,lineWidth:null,pointSize:null,backfaces:null,frontface:null,hash:null}),this.baseColor=e.baseColor,this.metallic=e.metallic,this.roughness=e.roughness,this.specularF0=e.specularF0,this.emissive=e.emissive,this.alpha=e.alpha,e.baseColorMap&&(this._baseColorMap=this._checkComponent("xeogl.Texture",e.baseColorMap)),e.metallicMap&&(this._metallicMap=this._checkComponent("xeogl.Texture",e.metallicMap)),e.roughnessMap&&(this._roughnessMap=this._checkComponent("xeogl.Texture",e.roughnessMap)),e.metallicRoughnessMap&&(this._metallicRoughnessMap=this._checkComponent("xeogl.Texture",e.metallicRoughnessMap)),e.emissiveMap&&(this._emissiveMap=this._checkComponent("xeogl.Texture",e.emissiveMap)),e.occlusionMap&&(this._occlusionMap=this._checkComponent("xeogl.Texture",e.occlusionMap)),e.alphaMap&&(this._alphaMap=this._checkComponent("xeogl.Texture",e.alphaMap)),e.normalMap&&(this._normalMap=this._checkComponent("xeogl.Texture",e.normalMap)),this.alphaMode=e.alphaMode,this.alphaCutoff=e.alphaCutoff,this.backfaces=e.backfaces,this.frontface=e.frontface,this.lineWidth=e.lineWidth,this.pointSize=e.pointSize,this._makeHash()}_makeHash(){const e=this._state,t=["/met"];this._baseColorMap&&(t.push("/bm"),this._baseColorMap._state.hasMatrix&&t.push("/mat"),t.push("/"+this._baseColorMap._state.encoding)),this._metallicMap&&(t.push("/mm"),this._metallicMap._state.hasMatrix&&t.push("/mat")),this._roughnessMap&&(t.push("/rm"),this._roughnessMap._state.hasMatrix&&t.push("/mat")),this._metallicRoughnessMap&&(t.push("/mrm"),this._metallicRoughnessMap._state.hasMatrix&&t.push("/mat")),this._emissiveMap&&(t.push("/em"),this._emissiveMap._state.hasMatrix&&t.push("/mat")),this._occlusionMap&&(t.push("/ocm"),this._occlusionMap._state.hasMatrix&&t.push("/mat")),this._alphaMap&&(t.push("/am"),this._alphaMap._state.hasMatrix&&t.push("/mat")),this._normalMap&&(t.push("/nm"),this._normalMap._state.hasMatrix&&t.push("/mat")),t.push(";"),e.hash=t.join("")}set baseColor(e){let t=this._state.baseColor;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.baseColor=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1),this._renderer.imageDirty()}get baseColor(){return this._state.baseColor}get baseColorMap(){return this._baseColorMap}set metallic(e){e=null!=e?e:1,this._state.metallic!==e&&(this._state.metallic=e,this._renderer.imageDirty())}get metallic(){return this._state.metallic}get metallicMap(){return this._attached.metallicMap}set roughness(e){e=null!=e?e:1,this._state.roughness!==e&&(this._state.roughness=e,this._renderer.imageDirty())}get roughness(){return this._state.roughness}get roughnessMap(){return this._attached.roughnessMap}get metallicRoughnessMap(){return this._attached.metallicRoughnessMap}set specularF0(e){e=null!=e?e:0,this._state.specularF0!==e&&(this._state.specularF0=e,this._renderer.imageDirty())}get specularF0(){return this._state.specularF0}set emissive(e){let t=this._state.emissive;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.emissive=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=0,t[1]=0,t[2]=0),this._renderer.imageDirty()}get emissive(){return this._state.emissive}get emissiveMap(){return this._attached.emissiveMap}get occlusionMap(){return this._attached.occlusionMap}set alpha(e){e=null!=e?e:1,this._state.alpha!==e&&(this._state.alpha=e,this._renderer.imageDirty())}get alpha(){return this._state.alpha}get alphaMap(){return this._attached.alphaMap}get normalMap(){return this._attached.normalMap}set alphaMode(e){let t=ts[e=e||"opaque"];void 0===t&&(this.error("Unsupported value for 'alphaMode': "+e+" defaulting to 'opaque'"),t="opaque"),this._state.alphaMode!==t&&(this._state.alphaMode=t,this._renderer.imageDirty())}get alphaMode(){return is[this._state.alphaMode]}set alphaCutoff(e){null==e&&(e=.5),this._state.alphaCutoff!==e&&(this._state.alphaCutoff=e)}get alphaCutoff(){return this._state.alphaCutoff}set backfaces(e){e=!!e,this._state.backfaces!==e&&(this._state.backfaces=e,this._renderer.imageDirty())}get backfaces(){return this._state.backfaces}set frontface(e){e="cw"!==e,this._state.frontface!==e&&(this._state.frontface=e,this._renderer.imageDirty())}get frontface(){return this._state.frontface?"ccw":"cw"}set lineWidth(e){this._state.lineWidth=e||1,this._renderer.imageDirty()}get lineWidth(){return this._state.lineWidth}set pointSize(e){this._state.pointSize=e||1,this._renderer.imageDirty()}get pointSize(){return this._state.pointSize}destroy(){super.destroy(),this._state.destroy()}}m[ss]=rs;function as(e){if(!os(e.width)||!os(e.height)){const t=document.createElement("canvas");t.width=ns(e.width),t.height=ns(e.height);t.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,t.width,t.height),e=t}return e}function os(e){return 0==(e&e-1)}function ns(e){--e;for(let t=1;t<32;t<<=1)e|=e>>t;return e+1}class ls extends g{get type(){return"xeogl.Texture"}init(e){super.init(e),this._state=new D({texture:new Oi(this.scene.canvas.gl),matrix:d.identityMat4(),hasMatrix:e.translate&&(0!==e.translate[0]||0!==e.translate[1])||!!e.rotate||e.scale&&(0!==e.scale[0]||0!==e.scale[1]),minFilter:this._checkMinFilter(e.minFilter),magFilter:this._checkMagFilter(e.minFilter),wrapS:this._checkWrapS(e.wrapS),wrapT:this._checkWrapT(e.wrapT),flipY:this._checkFlipY(e.flipY),encoding:this._checkEncoding(e.encoding)}),this._src=null,this._image=null,this._translate=d.vec2([0,0]),this._scale=d.vec2([1,1]),this._rotate=d.vec2([0,0]),this._matrixDirty=!1,this.translate=e.translate,this.scale=e.scale,this.rotate=e.rotate,e.src?this.src=e.src:e.image&&(this.image=e.image),r.memory.textures++}_checkMinFilter(e){return"linear"!==(e=e||"linearMipmapLinear")&&"linearMipmapNearest"!==e&&"linearMipmapLinear"!==e&&"nearestMipmapLinear"!==e&&"nearestMipmapNearest"!==e&&(this.error("Unsupported value for 'minFilter': '"+e+"' - supported values are 'linear', 'linearMipmapNearest', 'nearestMipmapNearest', 'nearestMipmapLinear' and 'linearMipmapLinear'. Defaulting to 'linearMipmapLinear'."),e="linearMipmapLinear"),e}_checkMagFilter(e){return"linear"!==(e=e||"linear")&&"nearest"!==e&&(this.error("Unsupported value for 'magFilter': '"+e+"' - supported values are 'linear' and 'nearest'. Defaulting to 'linear'."),e="linear"),e}_checkFilter(e){return"linear"!==(e=e||"linear")&&"nearest"!==e&&(this.error("Unsupported value for 'magFilter': '"+e+"' - supported values are 'linear' and 'nearest'. Defaulting to 'linear'."),e="linear"),e}_checkWrapS(e){return"clampToEdge"!==(e=e||"repeat")&&"mirroredRepeat"!==e&&"repeat"!==e&&(this.error("Unsupported value for 'wrapS': '"+e+"' - supported values are 'clampToEdge', 'mirroredRepeat' and 'repeat'. Defaulting to 'repeat'."),e="repeat"),e}_checkWrapT(e){return"clampToEdge"!==(e=e||"repeat")&&"mirroredRepeat"!==e&&"repeat"!==e&&(this.error("Unsupported value for 'wrapT': '"+e+"' - supported values are 'clampToEdge', 'mirroredRepeat' and 'repeat'. Defaulting to 'repeat'."),e="repeat"),e}_checkFlipY(e){return!!e}_checkEncoding(e){return"linear"!==(e=e||"linear")&&"sRGB"!==e&&"gamma"!==e&&(this.error("Unsupported value for 'encoding': '"+e+"' - supported values are 'linear', 'sRGB', 'gamma'. Defaulting to 'linear'."),e="linear"),e}_webglContextRestored(){this._state.texture=new Oi(this.scene.canvas.gl),this._image?this.image=this._image:this._src&&(this.src=this._src)}_update(){const e=this._state;if(this._matrixDirty){let t,i;0===this._translate[0]&&0===this._translate[1]||(t=d.translationMat4v([this._translate[0],this._translate[1],0],this._state.matrix)),1===this._scale[0]&&1===this._scale[1]||(i=d.scalingMat4v([this._scale[0],this._scale[1],1]),t=t?d.mulMat4(t,i):i),0!==this._rotate&&(i=d.rotationMat4v(.0174532925*this._rotate,[0,0,1]),t=t?d.mulMat4(t,i):i),t&&(e.matrix=t),this._matrixDirty=!1}this._renderer.imageDirty()}set image(e){this._image=as(e),this._image.crossOrigin="Anonymous",this._state.texture.setImage(this._image,this._state),this._state.texture.setProps(this._state),this._src=null,this._renderer.imageDirty()}get image(){return this._image}set src(e){this.scene.loading++,this.scene.canvas.spinner.processes++;const t=this;let i=new Image;i.onload=function(){i=as(i),t._state.texture.setImage(i,t._state),t._state.texture.setProps(t._state),t.scene.loading--,t.scene.canvas.spinner.processes--,t._renderer.imageDirty()},i.src=e,this._src=e,this._image=null}get src(){return this._src}set translate(e){this._translate.set(e||[0,0]),this._matrixDirty=!0,this._needUpdate()}get translate(){return this._translate}set scale(e){this._scale.set(e||[1,1]),this._matrixDirty=!0,this._needUpdate()}get scale(){return this._scale}set rotate(e){e=e||0,this._rotate!==e&&(this._rotate=e,this._matrixDirty=!0,this._needUpdate())}get rotate(){return this._rotate}get minFilter(){return this._state.minFilter}get magFilter(){return this._state.magFilter}get wrapS(){return this._state.wrapS}get wrapT(){return this._state.wrapT}get flipY(){return this._state.flipY}get encoding(){return this._state.encoding}destroy(){super.destroy(),this._state.texture&&this._state.texture.destroy(),this._state.destroy(),r.memory.textures--}}m["xeogl.Texture"]=ls;class hs extends g{get type(){return"xeogl.Fresnel"}init(e){super.init(e),this._state=new D({edgeColor:d.vec3([0,0,0]),centerColor:d.vec3([1,1,1]),edgeBias:0,centerBias:1,power:1}),this.edgeColor=e.edgeColor,this.centerColor=e.centerColor,this.edgeBias=e.edgeBias,this.centerBias=e.centerBias,this.power=e.power}set edgeColor(e){this._state.edgeColor.set(e||[0,0,0]),this._renderer.imageDirty()}get edgeColor(){return this._state.edgeColor}set centerColor(e){this._state.centerColor.set(e||[1,1,1]),this._renderer.imageDirty()}get centerColor(){return this._state.centerColor}set edgeBias(e){this._state.edgeBias=e||0,this._renderer.imageDirty()}get edgeBias(){return this._state.edgeBias}set centerBias(e){this._state.centerBias=null!=e?e:1,this._renderer.imageDirty()}get centerBias(){return this._state.centerBias}set power(e){this._state.power=null!=e?e:1,this._renderer.imageDirty()}get power(){return this._state.power}destroy(){super.destroy(),this._state.destroy()}}m["xeogl.Fresnel"]=hs;const us=ui.scenes,cs=ui.getDefaultScene,ds=ui.setDefaultScene,ps=_.scheduleTask,_s=ui.clear,ms=a.isString,fs=a.apply,gs=a.isNumeric},998:(e,t,i)=>{var{xeogl:s}=i(66);window.GLTFExplorer||(window.GLTFExplorer=function(e,t,i,r){window.onload=function(){document.getElementById(e)},new s.AmbientLight({color:[.9,.92,.9],intensity:.99}),new s.DirLight({dir:[.8,-.6,-.8],color:[1,1,1],intensity:1,space:"view",shadow:new s.Shadow({resolution:[1e3,1e3],intensity:.7,sampling:"stratified"})}),new s.DirLight({dir:[-.8,-.4,-.4],color:[1,1,1],intensity:1,space:"view",shadow:new s.Shadow({resolution:[1e3,1e3],intensity:.7,sampling:"stratified"})}),new s.DirLight({dir:[.2,-.8,.8],color:[.6,.6,.6],intensity:1,space:"view",shadow:new s.Shadow({resolution:[1e3,1e3],intensity:.7,sampling:"stratified"})});var a,o,n,l,h,u,c=new s.GLTFModel({id:"Object",srcId:t,ghosted:i,edgeThreshold:20,lambertMaterials:!1,objects:!0,replaceColor:r,scale:[100,100,100],handleNode:(a=0,o=0,n=0,l="Body ",function(t,i){if(void 0===this.model.nodeRoot&&(this.model.nodeRoot={}),void 0===t.mesh&&void 0!==t.children&&void 0===t.name&&(t.name="Node "+n++),void 0!==t.name){l=t.name;var s=document.createElement("li");this.model.nodeRoot[l]=t.children?t.children:[t.mesh],s.innerHTML=`<icon class='bodySelect checked' data-name='${l}'></icon><a href='#'>${l}</a>`,document.querySelector(`#${e} ul`).insertBefore(s,null),o=0}return void 0!==t.mesh&&(i.createObject={id:"Body "+a},l in this.model.nodeRoot?this.model.nodeRoot[l][o++]=a:this.model.nodeRoot[l]=[a],a++),!0})}),d=new s.CameraFlightAnimation;window.selectObject=function(e){var t,i,s=!1===e;if(Object.keys(c.scene.objects).forEach((e,t)=>{if(0!=t){var i=c.scene.objects[e];i.ghosted=!s,i.highlighted=!1}}),void 0!==u){for(var r=0;r<u.length;r++)"Body "+u[r]in c.scene.objects&&((o=c.scene.objects["Body "+u[r]]).visible=!1);u=void 0}if(e){e.preventDefault(),h=c.nodeRoot[e.target.text],u=e.target.parentNode.children[0].classList.contains("checked")?void 0:h;var a=new Float32Array([1e12,1e12,1e12,-1e12,-1e12,-1e12]);for(r=0;r<h.length;r++){var o;"Body "+h[r]in c.scene.objects&&((o=c.scene.objects["Body "+h[r]]).ghosted=!1,o.highlighted=!0,o.visible=!0,t=a,i=o.aabb,a=new Float32Array([Math.min(t[0],i[0]),Math.min(t[1],i[1]),Math.min(t[2],i[2]),Math.max(t[3],i[3]),Math.max(t[4],i[4]),Math.max(t[5],i[5])]))}d.flyTo({aabb:a,fitFOV:25,duration:1,showAABB:!1})}},window.bodyVisibilityChanged=function(e){for(var t=c.nodeRoot[e.target.getAttribute("data-name")],i=0;i<t.length;i++)"Body "+t[i]in c.scene.objects&&(c.scene.objects["Body "+t[i]].visible=!e.target.classList.contains("checked"));e.target.classList.toggle("checked")};var p=[[.8,.8,.8],[.9,.6,.6],[.6,.9,.6],[.6,.6,.9],[.9,.2,.6],[.8,.6,.2],[.7,.7,.2],[.2,.8,.8],[.8,.2,.8],[.8,.8,.2],[.2,.8,.8]];c.on("loaded",(function(){var e=0;for(var t in c.objects)if(c.objects.hasOwnProperty(t)){var i=c.objects[t];e++,i.castShadow=!0,i.receiveShadow=!0,"material"in i||(i.material=new s.Material),this.replaceColor&&(i.material.baseColor=p[e%p.length]),i.material.metallic=.9,i.material.roughness=.1}e=0,document.querySelectorAll(".bodySelect").forEach(e=>e.addEventListener("click",bodyVisibilityChanged)),document.querySelectorAll(".bodySelect + a").forEach(e=>e.addEventListener("click",selectObject)),d.jumpTo({aabb:c.aabb,fit:!0,fitFOV:50})})),new s.CameraControl})},66:(e,t,i)=>{"use strict";i.r(t),i.d(t,{xeogl:()=>s});var s=i(57);s.GLTFModel=class extends s.Model{init(e){if(super.init(e),this._src=null,this._options={ignoreMaterials:!!e.ignoreMaterials,combineGeometry:!1!==e.combineGeometry,quantizeGeometry:!1!==e.quantizeGeometry,edgeThreshold:e.edgeThreshold||20,lambertMaterials:!!e.lambertMaterials,handleNode:e.handleNode},this.loaded=e.loaded,"src"in e)this.src=e.src;else if("srcId"in e){var t=document.getElementById(e.srcId).text;try{var i=JSON.parse(t),r=this.scene.canvas.spinner;r.processes++,this._options.basePath="./";var o=this;a(i,this._options.basePath,this._options,o,(function(){r.processes--,s.scheduleTask((function(){o.fire("loaded",!0,!0)}))}),(function(e){r.processes--,o.error(e),o.fire("error",e)}))}catch(e){console.log(e)}}}set loaded(e){e=!1!==e,this._loaded!==e&&(this._loaded=e,this.clear(),this._loaded&&this._src&&s.GLTFModel.load(this,this._src,this._options))}get loaded(){return this._loaded}set src(e){if(!e)return this.clear(),void(this._src=null);s._isString(e)?e!==this._src?(this.clear(),this._src=e,this._loaded&&s.GLTFModel.load(this,this._src,this._options)):this.fire("loaded",!0,!0):this.error("Value for 'src' should be a string")}get src(){return this._src}static load(e,t,i,a,o){var n=e.scene.canvas.spinner;n.processes++,r(e,t,i,(function(){n.processes--,s.scheduleTask((function(){e.fire("loaded",!0,!0)})),a&&a()}),(function(t){n.processes--,e.error(t),o&&o(t),e.fire("error",t)}))}static parse(e,t,i,s,r){i=i||{};var o=e.scene.canvas.spinner;o.processes++,a(t,"",i,e,(function(){o.processes--,e.fire("loaded",!0,!0),s&&s()}),(function(t){o.processes--,e.error(t),e.fire("error",t),r&&r(t)}))}};var r=function(e,t,i,s,r){!function(e,t,i){var s=new XMLHttpRequest;s.overrideMimeType("application/json"),s.open("GET",e,!0),s.addEventListener("load",(function(e){var s=e.target.response;200===this.status?t&&t(s):0===this.status?(console.warn("loadFile: HTTP Status 0 received."),t&&t(s)):i&&i(e)}),!1),s.addEventListener("error",(function(e){i&&i(e)}),!1),s.send(null)}(t,(function(o){var n;try{n=JSON.parse(o)}catch(e){r(e)}i.basePath=function(e){var t=e.lastIndexOf("/");return 0!==t?e.substring(0,t+1):""}(t),a(n,t,i,e,s,r)}),r)},a=function(){const e={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},t={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};return function(e,t,s,d,p){d.clear();var _={src:t,loadBuffer:s.loadBuffer,basePath:s.basePath,handleNode:s.handleNode,ignoreMaterials:!!s.ignoreMaterials,combineGeometry:s.combineGeometry,quantizeGeometry:s.quantizeGeometry,edgeThreshold:s.edgeThreshold,lambertMaterials:!!s.lambertMaterials,json:e,scene:d.scene,model:d,modelProps:{visible:d.visible,culled:d.culled,ghosted:d.ghosted,highlighted:d.highlighted,selected:d.selected,outlined:d.outlined,clippable:d.clippable,pickable:d.pickable,collidable:d.collidable,castShadow:d.castShadow,receiveShadow:d.receiveShadow,colorize:d.colorize,opacity:d.opacity,edges:d.edges},numObjects:0};d.scene.loading++,function(e,t){var s=e.json.buffers;if(s)for(var r=s.length,a=0,o=s.length;a<o;a++)i(e,s[a],(function(){0==--r&&t()}),(function(i){e.model.error(i),0==--r&&t()}));else t()}(_,(function(){!function(e){var t=e.json.bufferViews;if(t)for(var i=0,s=t.length;i<s;i++)r(e,t[i])}(_),function(e){var t=e.json.accessors;if(t)for(var i=0,s=t.length;i<s;i++)a(e,t[i])}(_),_.lambertMaterials||function(e){var t=e.json.textures;if(t)for(var i=0,s=t.length;i<s;i++)o(e,t[i])}(_),_.ignoreMaterials||function(e){var t,i,s=e.json.materials;if(s)for(var r=0,a=s.length;r<a;r++)t=s[r],e.lambertMaterials?i=l(e,t):(i=n(e,t),e.model._addComponent(i)),t._material=i}(_),function(e){var t=e.json.meshes;if(t)for(var i=0,s=t.length;i<s;i++)h(e,t[i])}(_),function(e){var t=e.json,i=t.scene||0,s=t.scenes[i];if(!s)return void c(e,"glTF has no default scene");!function(e,t){var i=t.nodes;if(!i)return;for(var s,r=e.json,a=0,o=i.length;a<o;a++)(s=r.nodes[i[a]])?u(e,a,s,null,null):c(e,"Node not found: "+a)}(e,s)}(_),d.scene.loading--,p()}))};function i(e,t,i,s){var r=t.uri;r?function(e,t,i,s){var r=t.match(/^data:(.*?)(;base64)?,(.*)$/);if(r){r[1];var a=!!r[2],o=r[3];o=window.decodeURIComponent(o),a&&(o=window.atob(o));try{for(var n=new ArrayBuffer(o.length),l=new Uint8Array(n),h=0;h<o.length;h++)l[h]=o.charCodeAt(h);window.setTimeout((function(){i(n)}),0)}catch(e){window.setTimeout((function(){s(e)}),0)}}else if(e.loadBuffer)e.loadBuffer(t,i,s);else{var u=new XMLHttpRequest;u.open("GET",e.basePath+t,!0),u.responseType="arraybuffer",u.onreadystatechange=function(){4===u.readyState&&("200"===u.status||200===u.status?i(u.response):s("loadArrayBuffer error : "+u.response))},u.send(null)}}(e,r,(function(e){t._buffer=e,i()}),s):s("gltf/handleBuffer missing uri in "+JSON.stringify(t))}function r(e,t){var i=e.json.buffers[t.buffer];t._typedArray=null;var s=t.byteLength||0,r=t.byteOffset||0;t._buffer=i._buffer.slice(r,r+s),34963===t.target?t._typedArray=new Uint16Array(t._buffer):34962===t.target&&(t._typedArray=new Float32Array(t._buffer))}function a(i,s){var r=i.json.bufferViews[s.bufferView],a=t[s.type],o=e[s.componentType],n=o.BYTES_PER_ELEMENT*a;s.byteStride&&s.byteStride!==n||(s._typedArray=new o(r._buffer,s.byteOffset||0,s.count*a),s._itemSize=a)}function o(e,t){var i=new s.Texture(e.scene,{src:e.json.images[t.source].uri?e.basePath+e.json.images[t.source].uri:void 0,flipY:!!t.flipY});e.model._addComponent(i),t._texture=i}function n(e,t){var i,r=e.json,a={},o=t.normalTexture;o&&(i=r.textures[o.index])&&(a.normalMap=i._texture,a.normalMap.encoding="linear");var n=t.occlusionTexture;n&&(i=r.textures[n.index])&&(a.occlusionMap=i._texture);var l=t.emissiveTexture;l&&(i=r.textures[l.index])&&(a.emissiveMap=i._texture,a.emissiveMap.encoding="sRGB");var h=t.emissiveFactor;switch(h&&(a.emissive=h),a.backfaces=!!t.doubleSided,t.alphaMode){case"OPAQUE":a.alphaMode="opaque";break;case"MASK":a.alphaMode="mask";break;case"BLEND":a.alphaMode="blend"}var u=t.alphaCutoff;void 0!==u&&(a.alphaCutoff=u);var c=t.extensions;if(c){var d=c.KHR_materials_pbrSpecularGlossiness;if(d){var p=d.diffuseFactor;null!=p&&(a.diffuse=p.slice(0,3),a.alpha=p[3]);var _=d.diffuseTexture;_&&(i=r.textures[_.index])&&(a.diffuseMap=i._texture,a.diffuseMap.encoding="sRGB");var m=d.specularFactor;null!=m&&(a.specular=m.slice(0,3));var f=d.glossinessFactor;null!=f&&(a.glossiness=f);var g=d.specularGlossinessTexture;return g&&(i=r.textures[g.index])&&(a.specularGlossinessMap=i._texture,a.specularGlossinessMap.encoding="linear"),new s.SpecularMaterial(e.scene,a)}var v=c.KHR_materials_common;if(v){var M,y=v.technique,x=v.values||{},b="BLINN"===y,w="PHONG"===y,A="LAMBERT"===y,E=x.shininess;a.shininess=(b||w)&&null!=E?E:0;var C=x.diffuse;C&&(b||w||A)?s._isString(C)?(M=e.textures[C])&&(a.diffuseMap=M,a.diffuseMap.encoding="sRGB"):a.diffuse=C.slice(0,3):a.diffuse=[0,0,0];var P=x.specular;P&&(b||w)?s._isString(P)?(M=e.textures[P])&&(a.specularMap=M):a.specular=P.slice(0,3):a.specular=[0,0,0];var T=x.emission;T?s._isString(T)?(M=e.textures[T])&&(a.emissiveMap=M):a.emissive=T.slice(0,3):a.emissive=[0,0,0];var D=x.transparency;a.alpha=null!=D?D:1;x.transparent;return new s.PhongMaterial(e.scene,a)}}var S=t.pbrMetallicRoughness;if(S){var F=S.baseColorFactor;F&&(a.baseColor=F.slice(0,3),a.alpha=F[3]);var L=S.baseColorTexture;L&&(i=r.textures[L.index])&&(a.baseColorMap=i._texture,a.baseColorMap.encoding="sRGB");var B=S.metallicFactor;null!=B&&(a.metallic=B);var R=S.roughnessFactor;null!=R&&(a.roughness=R);var k=S.metallicRoughnessTexture;return k&&(i=r.textures[k.index])&&(a.metallicRoughnessMap=i._texture,a.metallicRoughnessMap.encoding="linear"),new s.MetallicMaterial(e.scene,a)}return new s.PhongMaterial(e.scene,a)}function l(e,t){e.json;var i=new Float32Array([1,1,1,1]),r=t.extensions;if(r){var a=r.KHR_materials_pbrSpecularGlossiness;if(a){var o=a.diffuseFactor;null!=o&&i.set(o)}var n=r.KHR_materials_common;if(n){var l=n.technique,h=n.values||{},u="BLINN"===l,c="PHONG"===l,d="LAMBERT"===l,p=h.diffuse;p&&(u||c||d)&&(s._isString(p)||i.set(p));var _=h.transparency;null!=_&&(i[3]=_);var m=h.transparent;null!=m&&(i[3]=m)}}var f=t.pbrMetallicRoughness;if(f){var g=f.baseColorFactor;g&&i.set(g)}return i}function h(e,t){var i,r,a,o,n=e.json,l=[],h=t.primitives;if(h)for(var u,c,d,p,_,m,f,g,v=0,M=h.length;v<M;v++)m={primitive:"triangles",combined:e.combineGeometry,quantized:e.quantizeGeometry,edgeThreshold:e.edgeThreshold},null!=(c=(u=h[v]).indices)&&(a=n.accessors[c],n.bufferViews[a.bufferView],m.indices=a._typedArray),(o=u.attributes)&&(null!=(d=o.POSITION)&&(a=n.accessors[d],n.bufferViews[a.bufferView],m.positions=a._typedArray),null!=(p=o.NORMAL)&&(a=n.accessors[p],n.bufferViews[a.bufferView],m.normals=a._typedArray),null!=(_=o.TEXCOORD_0)&&(a=n.accessors[_],n.bufferViews[a.bufferView],m.uv=a._typedArray),f={},g=new s.Geometry(e.scene,m),e.model._addComponent(g),f.geometry=g,null!=(i=u.material)&&(r=n.materials[i])&&(f.material=r._material),l.push(f));t._mesh=l}function u(e,t,i,r,a,o){var n;if(a=a||e.model,e.handleNode){var l={};if(!e.handleNode(i,l))return;l.createObject&&(n=l.createObject)}var h,d=e.json,p=e.model,_=s.math,m=i.children&&i.children.length>0;if(i.matrix&&(h=i.matrix,r=r?_.mulMat4(r,h,_.mat4()):h),i.translation&&(h=_.translationMat4v(i.translation),r=r?_.mulMat4(r,h,h):h),i.rotation&&(h=_.quaternionToMat4(i.rotation),r=r?_.mulMat4(r,h,h):h),i.scale&&(h=_.scalingMat4v(i.scale),r=r?_.mulMat4(r,h,h):h),e.numObjects++,void 0!==i.mesh){var f=d.meshes[i.mesh];if(f){var g,v,M=f._mesh,y=M.length;if(!n&&y>0&&!m){for(var x=0,b=y;x<b;x++){var w={geometry:(g=M[x]).geometry,matrix:r};s._apply(e.modelProps,w),e.lambertMaterials?(p.material||(p.material=new s.LambertMaterial(e.scene,{backfaces:!0})),w.material=p.material,w.colorize=g.material,w.opacity=g.material[3]):w.material=g.material,v=new s.Mesh(e.scene,w),a.addChild(v,!1),p._addComponent(v)}return}if(n&&1===y&&!m){w={geometry:(g=M[0]).geometry,matrix:r};return s._apply(e.modelProps,w),e.lambertMaterials?(p.material||(p.material=new s.LambertMaterial(e.scene,{backfaces:!0})),w.material=p.material,w.colorize=g.material,w.opacity=g.material[3]):w.material=g.material,s._apply(n,w),v=new s.Mesh(e.scene,w),a.addChild(v,!1),void p._addComponent(v)}if(n&&y>0&&!m){var A={matrix:r};s._apply(e.modelProps,A),s._apply(n,A);var E=new s.Group(e.scene,A);a.addChild(E,!1),p._addComponent(E);for(x=0,b=y;x<b;x++){w={geometry:(g=M[x]).geometry};s._apply(e.modelProps,w),e.lambertMaterials?(p.material||(p.material=new s.LambertMaterial(e.scene,{backfaces:!0})),w.material=p.material,w.colorize=g.material,w.opacity=g.material[3]):w.material=g.material,s._apply(n,w),w.id=n.id+"."+x,w.entityType=null,v=new s.Mesh(e.scene,w),E.addChild(v,!1),p._addComponent(v)}return}if(!n&&y>0&&m){A={matrix:r};s._apply(e.modelProps,A);E=new s.Group(e.scene,A);a.addChild(E,!1),p._addComponent(E);for(x=0,b=y;x<b;x++){w={geometry:(g=M[x]).geometry};s._apply(A,w),w.entityType=null,w.matrix=null,e.lambertMaterials?(p.material||(p.material=new s.LambertMaterial(e.scene,{backfaces:!0})),w.material=p.material,w.colorize=g.material,w.opacity=g.material[3]):w.material=g.material,v=new s.Mesh(e.scene,w),E.addChild(v,!1),p._addComponent(v)}r=null,a=E,o=A}if(n&&0===y&&m){A={matrix:r};s._apply(e.modelProps,A),s._apply(n,A),n.matrix=r;E=new s.Group(e.scene,A);a.addChild(E,!1),p._addComponent(E),r=null,a=E,o=A}if(n&&y>0||m){console.log("Case 6");A={matrix:r};s._apply(e.modelProps,A),n&&s._apply(n,A);E=new s.Group(e.scene,A);a.addChild(E,!1),p._addComponent(E);for(x=0,b=y;x<b;x++){w={geometry:(g=M[x]).geometry};s._apply(e.modelProps,w),e.lambertMaterials?(p.material||(p.material=new s.LambertMaterial(e.scene,{backfaces:!0})),w.material=p.material,w.colorize=g.material,w.opacity=g.material[3]):w.material=g.material,n&&(s._apply(n,w),w.id=n.id+"."+x),w.entityType=null,v=new s.Mesh(e.scene,w),E.addChild(v,!1),p._addComponent(v)}r=null,a=E,o=A}}}if(i.children){var C,P,T=i.children;for(x=0,b=T.length;x<b;x++)P=T[x],(C=d.nodes[P])?u(e,t,C,r,a,o):c(e,"Node not found: "+x)}}function c(e,t){e.model.error(t)}}()}},t={};function i(s){if(t[s])return t[s].exports;var r=t[s]={exports:{}};return e[s](r,r.exports,i),r.exports}i.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return i.d(t,{a:t}),t},i.d=(e,t)=>{for(var s in t)i.o(t,s)&&!i.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{"use strict";i(998)})()})();</script>
<script id="data" type="application/json">